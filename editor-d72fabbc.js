import{a5 as e,m as t,o,p as n,y as s,r as i,ba as a,bb as r,aQ as c,cg as l,a4 as h,ck as u,cl as d,cm as g,be as p,g as m,a7 as v,c9 as f,cn as b,a8 as k,cd as F,ce as w,aJ as P,aN as y,bY as C,s as O,aL as _,G as E,aM as T}from"./main.js";import{c as S,s as x,C as N}from"./variant-c1af828f.js";import{S as U}from"./index-c70fdca8.js";import{B as A}from"./Board-0ecb6fca.js";import{l as L}from"./layout-ae040024.js";import"./fen-f2d95e2d.js";var R={controller(e){let o=!1;function n(e){"backbutton"!==e&&o&&t.backbutton.stack.pop(),o=!1}return{open:function(){t.backbutton.stack.push(n),o=!0},close:n,isOpen:()=>o,root:e}},view:t=>e("editorMenu",void 0,(()=>function(e){return o("div.editorMenu",[j(e),q(e)])}(t.root)),t.isOpen(),t.close)};function j(e){const t=e.getFen();return o("div.editorSelectors",[o("div.select_input",[o("select.positions",{id:"select_editor_positions",onchange(t){e.loadNewFen(t.target.value)}},[D(n("setTheBoard"),[K(t,{name:`-- ${n("popularOpenings")} --`,fen:"",eco:""}),e.extraPositions.map((e=>K(t,e)))]),D(n("popularOpenings"),e.positions.map((e=>K(t,e,!0))))])]),o("div.select_input",[o("select.positions",{id:"select_editor_endgames",onchange(t){e.loadNewFen(t.target.value)}},[K(t,{name:`-- ${n("endgame")} --`,fen:"",eco:""}),D(n("endgame"),e.endgamesPositions.map((e=>K(t,e))))])]),o("div.select_input",[o("select",{id:"select_editor_color",value:e.turn,onchange(t){e.setTurn(t.target.value)}},[o("option[value=white]",n("whitePlays")),o("option[value=black]",n("blackPlays"))])])])}function q(e){return o("div.editor-castling",[o("h3",n("castling")),o("div.form-multipleChoice",[B(e,"K",n("whiteCastlingKingside")),B(e,"Q",n("O-O-O"))]),o("div.form-multipleChoice",[B(e,"k",n("blackCastlingKingside")),B(e,"q",n("O-O-O"))])])}function B(e,t,n){return o("div",{className:e.castlingToggles[t]?"selected":"",oncreate:s((()=>e.setCastlingToggle(t,!e.castlingToggles[t])))},n)}function K(e,t,n=!1){return o("option",{value:t.fen,selected:e===t.fen},(n?t.eco+" ":"")+t.name)}function D(e,t){return o("optgroup",{label:e},t)}var I={controller(e){const o={isOpen:!1,fenError:null};function n(e){"backbutton"!==e&&o.isOpen&&t.backbutton.stack.pop(),o.isOpen=!1}return{open:function(){t.backbutton.stack.push(n),o.isOpen=!0,o.fenError=null},close:n,isOpen:()=>o.isOpen,root:e,data:o}},view:t=>e("pasteFenPopup",void 0,(()=>o("form",{onsubmit(e){e.preventDefault();const o=e.target[0].value;if(o&&o.length){t.root.loadNewFen(o)?(t.data.fenError=null,t.close()):t.data.fenError=n("invalidFen"),i()}}},[o("input[type=text]",{placeholder:n("pasteTheFenStringHere")}),t.data.fenError?o("div.error",t.data.fenError):null,o("button[data-icon=E].withIcon.popupAction",n("loadPosition"))])),t.isOpen(),t.close)};const H=["K","Q","k","q"];class EditorCtrl{constructor(e){this.turn="white",this.castlingToggles={K:!1,Q:!1,k:!1,q:!1},this.rules="chess",this.halfmoves=0,this.fullmoves=0,this.positions=[],this.endgamesPositions=[],this.extraPositions=[],this.onChange=()=>{const e=this.getFen(),t=`/editor/${encodeURIComponent(e)}`;window.history.replaceState(window.history.state,"","?="+t),i()},this.onstart=e=>function(e,t){if(t.touches&&t.touches.length>1)return;const o=t.target.getAttribute("data-role"),n=t.target.getAttribute("data-color");if(!o||!n)return;t.stopPropagation(),t.preventDefault();const s={role:o,color:n};e.chessground.dragNewPiece(t,s,!0)}(this,e),this.onmove=e=>a(this.chessground,e),this.onend=e=>r(this.chessground,e),this.editorOnCreate=e=>{if(!e.dom)return;const t=document.getElementById("boardEditor");t&&(t.addEventListener("touchstart",this.onstart),t.addEventListener("touchmove",this.onmove),t.addEventListener("touchend",this.onend))},this.editorOnRemove=()=>{const e=document.getElementById("boardEditor");e&&(e.removeEventListener("touchstart",this.onstart),e.removeEventListener("touchmove",this.onmove),e.removeEventListener("touchend",this.onend))},this.loadNewFen=e=>this.setFen(e),this.loadPeripheralFen=()=>{const e=c.state();return this.setFen(l.convertPeripheralPiecesToFen(e.peripheral.pieces))},this.goToAnalyse=()=>{const e=this.getState();e.legalFen&&t.set(this.makeAnalysisUrl(e.legalFen))},this.continueFromHere=()=>{const e=this.getState();e.legalFen&&e.playable?this.continuePopup.open(e.legalFen,"standard"):h.show({text:n("invalidFen"),position:"center",duration:"short"})},this.initFen=e||u,this.menu=R.controller(this),this.pasteFenPopup=I.controller(this),this.continuePopup=S.controller(),this.extraPositions=[{fen:u,name:n("startPosition"),eco:""},{fen:d,name:n("clearBoard"),eco:""}],Promise.all([g("data/positions.json"),g("data/endgames.json")]).then((([e,t])=>{this.positions=e.reduce(((e,t)=>e.concat(t.positions)),[]),this.endgamesPositions=t,i()})),this.chessground=new p({fen:this.initFen,orientation:"white",edit:!0,movable:{free:!0,color:"both"},highlight:{lastMove:!1,check:!1},animation:{duration:300},premovable:{enabled:!1},draggable:{magnified:m.game.magnified(),deleteOnDropOff:!0},events:{change:this.onChange}}),this.setFen(this.initFen)}bottomColor(){return this.chessground?this.chessground.state.orientation:"white"}setCastlingToggle(e,t){this.castlingToggles[e]!==t&&(this.unmovedRooks=void 0),this.castlingToggles[e]=t,this.onChange()}setTurn(e){this.turn=e,this.onChange()}castlingToggleFen(){let e="";for(const t of H)this.castlingToggles[t]&&(e+=t);return e}getSetup(){const e=this.chessground?this.chessground.getFen():this.initFen,t=v(e).unwrap((e=>e.board),(()=>f.empty()));return{board:t,pockets:this.pockets,turn:this.turn,unmovedRooks:this.unmovedRooks||b(t,this.castlingToggleFen()).unwrap(),epSquare:this.epSquare,remainingChecks:this.remainingChecks,halfmoves:this.halfmoves,fullmoves:this.fullmoves}}getFen(){return k(this.getSetup(),{promoted:"crazyhouse"===this.rules})}getLegalFen(){return x(this.rules,this.getSetup()).unwrap((e=>k(e.toSetup(),{promoted:"crazyhouse"===e.rules})),(()=>{}))}isPlayable(){return x(this.rules,this.getSetup()).unwrap((e=>!e.isEnd()),(()=>!1))}getState(){return{fen:this.getFen(),legalFen:this.getLegalFen(),playable:"chess"===this.rules&&this.isPlayable()}}makeAnalysisUrl(e){switch(this.rules){case"chess":return this.makeUrl("/analyse/fen/",e);case"3check":return this.makeUrl("/analyse/variant/threeCheck/fen/",e);case"kingofthehill":return this.makeUrl("/analyse/variant/kingOfTheHill/fen/",e);case"racingkings":return this.makeUrl("/analyse/variant/racingKings/fen/",e);case"antichess":case"atomic":case"horde":case"crazyhouse":return this.makeUrl(`/analyse/variant/${this.rules}/fen/`,e)}}makeUrl(e,t){return e+encodeURIComponent(t)}setFen(e){return v(e).unwrap((t=>{this.chessground&&this.chessground.set({fen:e}),this.pockets=t.pockets,this.turn=t.turn,this.unmovedRooks=t.unmovedRooks,this.epSquare=t.epSquare,this.remainingChecks=t.remainingChecks,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves;const o=N.fromSetup(t);return this.castlingToggles.K=void 0!==o.rook.white.h,this.castlingToggles.Q=void 0!==o.rook.white.a,this.castlingToggles.k=void 0!==o.rook.black.h,this.castlingToggles.q=void 0!==o.rook.black.a,this.onChange(),!0}),(()=>!1))}setRules(e){this.rules=e,"crazyhouse"!==e?this.pockets=void 0:this.pockets||(this.pockets=F.empty()),"3check"!==e?this.remainingChecks=void 0:this.remainingChecks||(this.remainingChecks=w.default()),this.onChange()}}function Q(e,t,n){return o("div",{className:["sparePieces",n,"orientation-"+t,e].join(" ")},o("div.sparePiecesInner",["king","queen","rook","bishop","knight","pawn"].map((t=>o("div.sparePiece",o("piece",{className:e+" "+t,"data-color":e,"data-role":t}))))))}function z(e){const t=e.getState();return o("section.actions_bar",[P()||!C()?o("button.action_bar_button.fa.fa-gear",{oncreate:s(e.menu.open)}):null,o("button.action_bar_button[data-icon=B]",{oncreate:s(e.chessground.toggleOrientation)}),o("button.action_bar_button[data-icon=U]",{disabled:!t.playable,oncreate:s(e.continueFromHere,(()=>h.show({text:n("continueFromHere"),duration:"short",position:"bottom"})))}),o("button.action_bar_button[data-icon=A]",{disabled:void 0===t.legalFen,oncreate:s(e.goToAnalyse,(()=>h.show({text:n("analysis"),duration:"short",position:"bottom"})))}),c.features().getState?o("button.action_bar_button.fa.fa-clone",{disabled:!c.state().peripheral.isGettable,oncreate:s(e.loadPeripheralFen,(()=>h.show({text:n("loadAPositionFromDevice"),duration:"short",position:"bottom"})))}):null,o("button.action_bar_button.fa.fa-upload",{oncreate:s(e.pasteFenPopup.open,(()=>h.show({text:n("loadAPositionFromFen"),duration:"short",position:"bottom"})))}),o("button.action_bar_button.fa.fa-share-alt",{oncreate:s((()=>U.share({text:e.getLegalFen()})),(()=>h.show({text:"Share FEN",duration:"short",position:"bottom"})))})])}const M={oninit({attrs:e}){O.createDefault(),_(),this.editor=new EditorCtrl(e.fen)},oncreate:E,onremove(){T()},view(){return function(e){const t=e.chessground.state.orientation,s="white"===t?"black":"white",i=P(),a=o(A,{variant:"standard",chessground:e.chessground,wrapperClasses:"editor-board"});return L.board(y(n("boardEditor")),[a,o("div.editor-wrapper",[o("div#boardEditor.editor-table.box",{className:m.general.theme.piece(),oncreate:e.editorOnCreate,onremove:e.editorOnRemove},[o("div.editor-piecesDrawer",[Q(s,t,"top"),Q(t,t,"bottom")]),!i&&C()?o("div.editor-menu",[j(e),q(e)]):null]),z(e)])],void 0,[R.view(e.menu),S.view(e.continuePopup),I.view(e.pasteFenPopup)])}(this.editor)}};export{M as default};
