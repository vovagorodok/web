import{f as e,r as a,m as t,d as s,ac as r,aN as n,o,p as c,y as i,g as l,q as d,aO as h,cx as u,cy as p,u as m,B as b,E as f,s as y,F as g,G as _}from"./main.js";import{l as v}from"./layout-ae040024.js";import{b as N}from"./perfs-d8ca398c.js";import{T as S,a as w}from"./TabView-408b9801.js";class PlayersCtrl{constructor(n){this.isSearchOpen=!1,this.searchResults=[],this.onTabChange=e=>{const t=window.location.search.replace(/\?tab=\w+$/,"");try{window.history.replaceState(window.history.state,"",t+"?tab="+e)}catch(e){}this.currentTab=e,a()},this.closeSearch=e=>{"backbutton"!==e&&this.isSearchOpen&&t.backbutton.stack.pop(),this.isSearchOpen=!1},this.onSearchInput=e=>{const a=e.target.value.trim();/^[a-z0-9][\w-]{2,29}$/i.exec(a)&&a.length>=3&&this.searchXhr(a)},this.searchXhr=s((t=>{(async function(a){return(await e("/api/player/autocomplete?friend=1&object=1",{query:{term:a}})).result})(t).then((e=>{this.searchResults=e,a()}))}),300),this.goSearch=()=>{t.backbutton.stack.push(this.closeSearch),this.isSearchOpen=!0},this.goToProfile=e=>{t.set("/@/"+e)},this.currentTab=n||0,async function(){const a=await e("/player/online",{query:{nb:50}});return a.forEach((e=>e.online=!0)),a}().then((e=>{this.players=e,a()})).catch(r),e("/player").then((e=>{this.leaderboard=e,a()})).catch(r)}}function T(e){const a=[{id:"leaderboard",f:()=>function(e){const a=e.leaderboard;if(!a)return o("div",{className:"loader_container"},m.getVdom("monochrome"));const s=Object.keys(a).filter((e=>"online"!==e)).map((e=>function(e,a){return o("section",{className:"leaderboard_section "+a},o("h3",{className:"leaderboard_title"},o("span",{className:"perfIcon","data-icon":b(a)}),N(a)),o("ul",{className:"leaderboard"},e[a].map((e=>function(e,a){return o("li",{className:"list_item leaderboard_player",oncreate:d((()=>t.set("/@/"+e.id)))},h(e),o("span",{className:"rating"},e.perfs[a].rating))}(e,a)))))}(a,e)));return o("div",{className:"native_scroller page leaderboard_wrapper"},s)}(e)},{id:"players",f:()=>function(e){return e.players?o("ul",{className:"playersSuggestion native_scroller page",oncreate:d(j,void 0,f)},e.players.map(k)):o("div",{className:"loader_container"},m.getVdom("monochrome"))}(e)}];return[o("div.tabs-nav-header.subHeader",o(S,{buttons:[{label:c("leaderboard")},{label:c("onlinePlayers")}],selectedIndex:e.currentTab,onTabChange:e.onTabChange})),o(w,{selectedIndex:e.currentTab,tabs:a,onTabChange:e.onTabChange})]}function j(e){const a=f(e);if(a){const e=a.dataset;e.id&&t.set("/@/"+e.id)}}function k(e,a){const t=a%2==0?"even":"odd",s=Object.keys(e.perfs).reduce(((a,t)=>a?"opening"===t||"puzzle"===t?a:e.perfs[a].rating<e.perfs[t].rating?t:a:t));return o("li",{className:`list_item playerSuggestion nav ${t}`,"data-id":e.id},h(e),o("span",{className:"rating","data-icon":b(s)},e.perfs[s].rating))}var O={oninit({attrs:e}){y.createDefault(),this.ctrl=new PlayersCtrl(g(e.tab))},oncreate:_,view(){const e=this.ctrl,a=function(e){return n(o("div.players_main_header",[o("div.main_header_title",c("players")),o("button.main_header_button[data-icon=y]",{oncreate:i(e.goSearch)})]))}(e),t=T(e),s=function(e){if(!e.isSearchOpen)return null;const a=["modal","show",l.general.theme.background()].join(" ");return o("div",{id:"searchPlayersModal",className:a},o("header",{class:"main_header"},o("button",{className:"main_header_button",oncreate:i((()=>e.closeSearch()))},u),o("div",{className:"search_input allow_select"},o("input",{id:"searchPlayers",type:"search",placeholder:"Search players",oninput:e.onSearchInput,autocapitalize:"off",autocomplete:"off",oncreate:p}))),o("ul",{id:"playersSearchResults",className:"modal_content native_scroller"},e.searchResults.map(((a,t)=>o("li",{className:"list_item nav "+(t%2==0?"even":"odd"),key:a.id,oncreate:d((()=>e.goToProfile(a.id)))},h(Object.assign({username:a.name},a)))))))}(e);return v.free(a,t,void 0,s)}};export{O as default};
