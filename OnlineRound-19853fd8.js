import{be as t,bA as e,bB as s,g as a,bf as i,r as o,aE as n,h as r,s as h,a4 as c,p as l,m as d,bC as p,k as m,b as u,aM as k,bD as g,ac as v,A as b,a as f,bl as y,I as w,bE as M}from"./main.js";import{v as C}from"./vibrate-2d0ad158.js";import{l as T,q as D,c as S,s as P,v as x,w as A,x as j,k as R,g as U}from"./game-b6f212b0.js";import{C as I}from"./chat-2370f74a.js";import{f as B,h as F,p as O,c as L,a as z}from"./crazyValid-02be4753.js";import{a as N,r as V,N as E}from"./toInteger-da417924.js";import{c as G}from"./promotion-070b22ca.js";class TransientMove{constructor(t){this.ctrl=t,this.register=()=>{this.current=setTimeout(this.expire,1e4)},this.clear=()=>{clearTimeout(this.current)},this.expire=()=>{this.ctrl.reloadGameData()}}}function W(t,n,r=!1){const h=t.steps[t.steps.length-1],c=t.game.lastMove?e(t.game.lastMove):"crazyhouse"===t.game.variant.key&&h&&null!==h.uci?s(h.uci):null,l=a.game.pieceMove();return{variant:t.game.variant.key,fen:n,orientation:i(t,r),turnColor:t.game.player,lastMove:c,check:h.check,coordinates:a.game.coords(),autoCastle:!0,highlight:{lastMove:a.game.highlights(),check:a.game.highlights()},movable:{free:!1,color:T(t)?t.player.color:null,dests:T(t)?D(t.possibleMoves):{},showDests:a.game.pieceDestinations(),rookCastle:1===a.game.rookCastle()},animation:{enabled:!!a.game.animations(),duration:t.pref.animationDuration},premovable:{enabled:t.pref.enablePremove,showDests:a.game.pieceDestinations(),castle:"antichess"!==t.game.variant.key,events:{set:()=>o(),unset:o}},predroppable:{enabled:t.pref.enablePremove&&"crazyhouse"===t.game.variant.key,events:{set:()=>o(),unset:o}},draggable:{enabled:"drag"===l||"both"===l,distance:3,magnified:a.game.magnified(),preventDefault:"crazyhouse"!==t.game.variant.key},selectable:{enabled:"tap"===l||"both"===l}}}var q={make:function(e,s,a,i,o,n){const r=W(e,s);return r.movable.events={after:a,afterNewPiece:i},r.events={move:o,dropNewPiece:n},r.viewOnly=e.player.spectator,new t(r)},reload:function(t,e,s,a){t.reconfigure(W(e,s,a))}};class ClockCtrl{constructor(t,e){this.opts=e,this.emergSound={play:n.lowtime,delay:2e4,playable:{white:!0,black:!0}},this.elements={white:null,black:null},this.setClock=(t,e,s,a=0)=>{const i=S(t)&&(P(t)>1||t.clock.running),o=10*a;this.times={white:1e3*e,black:1e3*s,activeColor:i?t.game.player:void 0,lastUpdate:performance.now()+o},i&&this.scheduleTick(this.times[t.game.player],o)},this.addTime=(t,e)=>{this.times[t]+=10*e},this.stopClock=()=>{const t=this.times.activeColor;if(t){const e=this.elapsed();this.times[t]=Math.max(0,this.times[t]-e),this.times.activeColor=void 0}},this.millisOf=t=>this.times.activeColor===t?Math.max(0,this.times[t]-this.elapsed()):this.times[t],this.isRunning=()=>void 0!==this.times.activeColor,this.unload=()=>{clearTimeout(this.tickTimeoutID),this.times.activeColor=void 0},this.scheduleTick=(t,e)=>{void 0!==this.tickTimeoutID&&clearTimeout(this.tickTimeoutID),this.tickTimeoutID=setTimeout(this.tick,t%(this.showTenths(t)?100:500)+1+e)},this.tick=()=>{this.tickTimeoutID=void 0;const t=this.times.activeColor;if(!t)return;const e=performance.now(),s=Math.max(0,this.times[t]-this.elapsed(e));this.scheduleTick(s,0),0===s?this.opts.onFlag():this.updateElement(t,s),this.opts.soundColor===t&&(this.emergSound.playable[t]?s<this.emergMs&&!(e<this.emergSound.next)&&(this.emergSound.play(),this.emergSound.next=e+this.emergSound.delay,this.emergSound.playable[t]=!1):s>1.5*this.emergMs&&(this.emergSound.playable[t]=!0))},this.elapsed=(t=performance.now())=>Math.max(0,t-this.times.lastUpdate);const s=t.clock;if(0===e.showTenths)this.showTenths=()=>!1;else{const t=1===e.showTenths?1e4:36e5;this.showTenths=e=>e<t}this.emergMs=1e3*Math.min(60,Math.max(10,.125*s.initial)),this.setClock(t,s.white,s.black)}updateElement(t,e){const s=this.elements[t];if(s){const a=this.showTenths(e),i=B(e,a,this.times.activeColor===t);a?s.innerHTML=i:s.textContent=i,e<this.emergMs?s.classList.add("emerg"):s.classList.remove("emerg")}}}class CorresClockCtrl{constructor(t,e){this.lastUpdate={white:t.white,black:t.black,at:Date.now()},this.els={black:null,white:null},this.data=t,this.onFlag=e}setLastUpdate(t){this.lastUpdate.white=t.white,this.lastUpdate.black=t.black,this.lastUpdate.at=Date.now()}update(t,e){this.data.white=t,this.data.black=e,this.setLastUpdate(this.data)}tick(t){this.data[t]=Math.max(0,this.lastUpdate[t]-(Date.now()-this.lastUpdate.at)/1e3),0===this.data[t]&&this.onFlag();const e=1e3*this.data[t],s=this.els[t];s&&(s.textContent=F(e))}}class RoundSocket{constructor(t,e){this.ctrl=t,this.moreTime=r((()=>{this.iface.send("moretime")}),300),this.outoftime=function(t,e,s){let a,i=0;return(...o)=>{const n=performance.now()-i,r=()=>{a=void 0,i=performance.now(),t*=e,s(...o)};a&&clearTimeout(a),n>t?r():a=setTimeout(r,t-n)}}(500,1.1,(()=>{this.iface.send("flag",this.ctrl.data.game.player)})),this.berserk=r((()=>{this.iface.send("berserk",null,{ackable:!0})}),200);const s={takebackOffers(e){!t.data.player.proposingTakeback&&e[t.data.player.color]&&(n.dong(),C.quick()),!t.data.opponent.proposingTakeback&&e[t.data.opponent.color]&&(n.dong(),C.quick()),t.data.player.proposingTakeback=e[t.data.player.color],t.data.opponent.proposingTakeback=e[t.data.opponent.color],o()},move(e){e.isMove=!0,t.apiMove(e),o()},drop(e){e.isDrop=!0,t.apiMove(e),o()},clockInc(e){t.clock&&(t.clock.addTime(e.color,e.time),o())},cclock(e){t.data.correspondence&&t.correspondenceClock&&(t.data.correspondence.white=e.white,t.data.correspondence.black=e.black,t.correspondenceClock.update(e.white,e.black),o())},checkCount(e){const s="white"===t.data.player.color;t.data.player.checks=s?e.white:e.black,t.data.opponent.checks=s?e.black:e.white,o()},berserk(e){t.setBerserk(e)},redirect(t){h.redirectToGame(t)},reload:function(e){e&&e.t&&s[e.t]?s[e.t](e.d):t.reloadGameData()},endData(e){t.endWithData(e),o()},rematchOffer(e){t.data.player.offeringRematch=e===t.data.player.color;(t.data.opponent.offeringRematch=e===t.data.opponent.color)&&c.show({text:l("yourOpponentWantsToPlayANewGameWithYou"),position:"center",duration:"short"}),o()},rematchTaken(e){t.data.game.rematch=e},drawOffer(e){t.data.player.offeringDraw=e===t.data.player.color;(t.data.opponent.offeringDraw=e===t.data.opponent.color)&&c.show({text:l("yourOpponentOffersADraw"),position:"center",duration:"short"}),o()},gone(e){t.data.opponent.ai||"correspondence"===t.data.game.speed||(x(t.data,t.data.opponent.color,e),t.chat&&t.chat.showing||o())},message(e){t.chat&&t.chat.append(e)},tvSelect(s){t.data.tv&&s.channel===t.data.tv&&e&&e()},crowd(e){A(t.data,"white",e.white),A(t.data,"black",e.black),t.data.watchers=e.watchers,t.chat&&t.chat.showing||o()}};this.iface=h.createGame(t.data.url.socket,t.data.player.version,s,t.data.url.round,t.data.userTV)}}class OnlineRound{constructor(t,s,r,l=!1,y,w,M){this.goingBack=t,this.id=s,this.onFeatured=y,this.promoting=null,this.player=()=>this.data.player.color,this.zenAvailable=()=>!this.data.player.spectator&&S(this.data),this.isZen=()=>this.zenAvailable()&&this.zenModeEnabled,this.toggleZenMode=()=>{this.zenModeEnabled=!this.zenModeEnabled,o()},this.goToAnalysis=()=>{const t=this.data;d.set(`/analyse/online/${t.game.id}/${i(t)}?ply=${this.vm.ply}&curFen=${t.game.fen}`)},this.openUserPopup=(t,e)=>{if(void 0===this.score){const t=this.data;if(!t||!t.player.user||!t.opponent.user)return;N(t.player.user.id,t.opponent.user.id).then((t=>{this.score=t,o()}))}this.vm.miniUser[t].data||p(e).then((e=>{this.vm.miniUser[t].data=e,o()})).catch((()=>{this.vm.miniUser[t].showing=!1,o()})),this.vm.miniUser[t].showing=!0},this.closeUserPopup=t=>{this.vm.miniUser[t].showing=!1},this.showActions=()=>{d.backbutton.stack.push(this.hideActions),this.vm.showingActions=!0,this.vm.showingShareActions=!1},this.showShareActions=()=>{this.vm.showingShareActions=!0},this.hideActions=t=>{"backbutton"!==t&&this.vm.showingActions&&d.backbutton.stack.pop(),this.vm.showingActions=!1,this.vm.showingShareActions=!1},this.flip=()=>{this.vm.flip=!this.vm.flip,this.data.tv?this.vm.flip?d.set("/tv?flip=1",!0):d.set("/tv",!0):this.chessground.set({orientation:i(this.data,this.vm.flip)})},this.canOfferDraw=()=>j(this.data)&&(this.lastDrawOfferAtPly||-99)<this.vm.ply-20,this.offerDraw=()=>{this.canOfferDraw()&&(this.lastDrawOfferAtPly=this.vm.ply,this.socket.iface.send("draw-yes",null))},this.canDrop=()=>!this.replaying()&&T(this.data),this.jump=(t,s)=>{if(t<this.firstPly()||t>this.lastPly())return!1;const a=this.replaying(),i=t>this.vm.ply;this.vm.ply=t;const o=this.plyStep(t),r={variant:this.data.game.variant.key,fen:o.fen,lastMove:o.uci?e(o.uci):null,check:o.check,turnColor:this.vm.ply%2==0?"white":"black",shiftView:s};return this.replaying()||(r.movableColor=T(this.data)?this.data.player.color:null,r.dests=D(this.data.possibleMoves)),this.chessground.set(r),!a&&this.replaying()&&this.chessground.stop(),o.san&&i&&(-1!==o.san.indexOf("x")?n.throttledCapture():n.throttledMove()),!0},this.userJump=t=>{this.cancelMove(),this.chessground.selectSquare(null),this.jump(t)},this.jumpNext=()=>this.jump(this.vm.ply+1,"redo"),this.jumpPrev=()=>this.jump(this.vm.ply-1,"undo"),this.jumpFirst=()=>this.jump(this.firstPly(),"undo"),this.jumpLast=()=>this.jump(this.lastPly(),"redo"),this.cancelMove=t=>{"backbutton"!==t&&d.backbutton.stack.pop(),this.vm.moveToSubmit=null,this.vm.dropToSubmit=null,this.jump(this.vm.ply)},this.submitMove=t=>{t&&(this.vm.moveToSubmit||this.vm.dropToSubmit)&&!this.vm.submitFeedback?(this.vm.moveToSubmit?this.actualSendMove(this.vm.moveToSubmit):this.vm.dropToSubmit&&this.actualSendMove(this.vm.dropToSubmit),"correspondence"!==this.data.game.speed||m()||c.show({text:"You need to be connected to Internet to send your move.",position:"bottom",duration:"short"}),this.vm.moveToSubmit=null,this.vm.dropToSubmit=null,this.vm.submitFeedback=[this.data.game.turns,performance.now()]):this.cancelMove()},this.onReload=t=>{t.steps.length!==this.data.steps.length&&(this.vm.ply=t.steps[t.steps.length-1].ply),this.chat&&this.chat.onReload(t.chat),this.data.tv&&(t.tv=this.data.tv),this.data.userTV&&(t.userTV=this.data.userTV),this.setData(t),this.makeCorrespondenceClock(),this.clock&&this.data.clock&&this.clock.setClock(this.data,this.data.clock.white,this.data.clock.black),this.lastMoveMillis=void 0,this.replaying()||q.reload(this.chessground,this.data,t.game.fen,this.vm.flip),o()},this.reloadGameData=(t=!1)=>{Promise.all([V(this),h.getVersion()]).then((([e,s])=>{null===s||s>e.player.version?t?d.reload():this.reloadGameData(!0):this.onReload(e)})).catch(d.reload)},this.endWithData=t=>{const e=this.data;e.game.winner=t.winner,e.game.status=t.status,e.game.boosted=t.boosted,e.opponent.offeringDraw=!1,this.userJump(this.lastPly()),this.chessground.stop(t.status),this.vm.submitFeedback&&(this.vm.submitFeedback=void 0),t.ratingDiff&&(e.player.ratingDiff=t.ratingDiff[e.player.color],e.opponent.ratingDiff=t.ratingDiff[e.opponent.color]),this.clock&&t.clock&&this.clock.setClock(e,.01*t.clock.wc,.01*t.clock.bc),e.game.turns>1&&(n.dong(),e.player.color===e.game.winner?C.good():C.bad()),this.data.player.spectator||(u.backgroundRefresh(),k(),c.show({text:this.gameStatus(),position:"center",duration:"short"})),this.score},this.toggleBookmark=()=>g(this.data.game.id).then((()=>{this.data.bookmarked=!this.data.bookmarked,o()})).catch(v),this.correspondenceClockTick=()=>{this.correspondenceClock&&S(this.data)&&this.correspondenceClock.tick(this.data.game.player)},this.userMove=(t,e,s)=>{const a=!!s.premove;s.promote&&G(this.chessground.state,e)?this.sendMove(t,e,s.promote,a):O.start(this,t,e,a)||this.sendMove(t,e,void 0,a)},this.onUserNewPiece=(t,e,s)=>{!this.replaying()&&L.drop(this.data,t,e,this.data.possibleDrops)?this.sendNewPiece(t,e,!!s.predrop):this.jump(this.vm.ply)},this.onMove=(t,e,s)=>{s?("atomic"===this.data.game.variant.key?(z.capture(this.chessground,e),n.explosion()):n.capture(),this.data.player.spectator||C.heavy()):(n.move(),this.data.player.spectator||C.tap())},this.onNewPiece=()=>{n.move()},this.onResume=()=>{this.blur=!0,V(this).then((t=>{h.setVersion(t.player.version),this.onReload(t)}))},this.setData(r),this.data.userTV=w,this.zenModeEnabled=a.game.zenMode(),this.blur=!1,this.vm={ply:this.lastPly(),flip:l,miniUser:{player:{showing:!1,data:null},opponent:{showing:!1,data:null}},clockPosition:a.game.clockPosition()||"right",showCaptured:!!this.data.pref.showCaptured,moveList:a.game.moveList(),showingActions:!1,showingShareActions:!1,confirmResign:!1,confirmDraw:!1,goneBerserk:{[this.data.player.color]:!!this.data.player.berserk,[this.data.opponent.color]:!!this.data.opponent.berserk},moveToSubmit:null,dropToSubmit:null,tClockEl:null,offlineWatcher:!m()},this.socket=new RoundSocket(this,this.onFeatured),this.chat=u.isKidMode()||!u.isConnected()||this.data.tv||!this.data.player.spectator&&(this.data.game.tournamentId||this.data.opponent.ai)?null:new I(this.socket.iface,this.data.game.id,this.data.chat||[],this.data.player.spectator?void 0:this.data.player,u.isConnected()||"friend"===this.data.game.source,u.isShadowban(),"correspondence"===this.data.game.speed?"Corres":"Game"),this.notes="correspondence"===this.data.game.speed?new E(this.data):null,this.chessground=q.make(this.data,r.game.fen,this.userMove,this.onUserNewPiece,this.onMove,this.onNewPiece),this.clock=this.data.clock?new ClockCtrl(this.data,{onFlag:this.socket.outoftime,soundColor:this.data.player.spectator||!this.data.pref.clockSound?null:this.data.player.color,showTenths:this.data.pref.clockTenths}):null,this.makeCorrespondenceClock(),this.correspondenceClock&&(this.clockIntervId=setInterval(this.correspondenceClockTick,6e3)),b.addListener("appStateChange",(t=>{t.isActive&&this.onResume()})).then((t=>this.appStateListener=t)),f.gameBackButton.add((()=>{0!==d.backbutton.stack.length||T(this.data)||d.backHistory()})),this.transientMove=new TransientMove(this),void 0!==M&&this.jump(M),o()}replaying(){return this.vm.ply!==this.lastPly()}firstPly(){return this.data.steps[0].ply}lastPly(){return this.data.steps[this.data.steps.length-1].ply}plyStep(t){return this.data.steps[t-this.firstPly()]}isClockRunning(){return!!this.data.clock&&S(this.data)&&(this.data.game.turns-this.data.game.startedAtTurn>1||this.data.clock.running)}sendMove(t,e,s,a=!1){const i={u:t+e};s&&(i.u+="knight"===s?"n":s[0]),this.chessground.setLastPromotion(s);const n=this.getBlurAndReset();this.data.pref.submitMove&&!a?(d.backbutton.stack.push(this.cancelMove),this.vm.moveToSubmit=i,o()):(this.actualSendMove(i,a,n),"correspondence"!==this.data.game.speed||m()||c.show({text:"You need to be connected to Internet to send your move.",position:"bottom",duration:"short"}))}sendNewPiece(t,e,s){const a={role:t,pos:e},i=this.getBlurAndReset();this.data.pref.submitMove&&!s?setTimeout((()=>{d.backbutton.stack.push(this.cancelMove),this.vm.dropToSubmit=a,o()}),this.data.pref.animationDuration||0):this.actualSendMove(a,s,i)}getBlurAndReset(){return!!this.blur&&(this.blur=!1,!0)}apiMove(t){var s,a;const i=this.data,r=T(i);if(r&&(this.lastMoveMillis=performance.now()),this.vm.submitFeedback&&this.vm.submitFeedback[0]+1===t.ply){const t="correspondence"===this.data.game.speed?Math.max(500-(performance.now()-this.vm.submitFeedback[1]),0):0;setTimeout((()=>{this.vm.submitFeedback=void 0,r&&(n.confirmation(),C.tap()),o()}),t)}i.game.turns=t.ply,i.game.player=t.ply%2==0?"white":"black";const h=t.ply%2==0?"black":"white",c="white"===i.player.color?i.player:i.opponent,l="black"===i.player.color?i.player:i.opponent,d=i.player.color===i.game.player;t.status&&(i.game.status=t.status),t.winner&&(i.game.winner=t.winner),t.check&&C.doubleTap();const p=c.offeringDraw,m=l.offeringDraw;if(!p&&t.wDraw&&(n.dong(),C.warn()),!m&&t.bDraw&&(n.dong(),C.warn()),c.offeringDraw=t.wDraw,l.offeringDraw=t.bDraw,i.possibleMoves=d?t.dests:void 0,i.possibleDrops=d?t.drops:void 0,!this.replaying()){this.vm.ply++;const o={turnColor:i.game.player,dests:r?D(i.possibleMoves):{},check:!!t.check};if(function(t){return t.isMove}(t)){const i=new Map;if(t.enpassant){const e=t.enpassant;i.set(e.key,null)}const n=new Map;if(t.castle&&!this.chessground.state.autoCastle){const e=t.castle;n.set(e.king[0],null),n.set(e.rook[0],null),n.set(e.king[1],{role:"king",color:e.color}),n.set(e.rook[1],{role:"rook",color:e.color})}const r=new Map([...i,...n]),h=e(t.uci),c=this.chessground.state.pieces;!t.castle||"king"===(null===(s=c.get(t.castle.king[0]))||void 0===s?void 0:s.role)&&"rook"===(null===(a=c.get(t.castle.rook[0]))||void 0===a?void 0:a.role)?this.chessground.apiMove(h[0],h[1],r,o):this.chessground.set(o)}else(function(t){return t.isDrop})(t)&&this.chessground.apiNewPiece({role:t.role,color:h},y(t.uci),o);if(t.promotion&&this.chessground.promote(t.promotion.key,t.promotion.pieceClass),this.chessground.setLastPromotion(t.promotion?t.promotion.pieceClass:void 0),t.enpassant){const e=t.enpassant;"atomic"===i.game.variant.key?z.enpassant(this.chessground,e.key,e.color):n.capture()}}if(t.clock){const e=t.clock;if(this.clock){const t=r&&d?0:e.lag||1;this.clock.setClock(i,e.white,e.black,t)}else this.correspondenceClock&&this.correspondenceClock.update(e.white,e.black)}if(i.game.threefold=!!t.threefold,i.steps.push({ply:this.lastPly()+1,fen:t.fen,san:t.san,uci:t.uci,check:t.check,crazy:t.crazyhouse}),A(i,h,!0),this.data.expiration&&(this.data.steps.length>2?this.data.expiration=void 0:this.data.expiration.movedAt=Date.now()),r&&h===i.player.color&&this.transientMove.clear(),!this.replaying()&&h!==i.player.color&&(this.chessground.state.premovable.current||this.chessground.state.predroppable.current)){const t="atomic"===i.game.variant.key?100:1;setTimeout((()=>{this.chessground.playPremove(),this.playPredrop()}),t)}"correspondence"===this.data.game.speed&&u.refresh().then((()=>{"ios"===w.getPlatform()&&M.setNumber({badge:u.myTurnGames().length})}))}gameStatus(){const t=R(this.data,this.data.game.winner);return U.toLabel(this.data.game.status.name,this.data.game.turns,this.data.game.winner,this.data.game.variant.key)+(t?". "+l("white"===t.color?"whiteIsVictorious":"blackIsVictorious")+".":"")}goBerserk(){this.socket.berserk(),n.berserk()}setBerserk(t){this.vm.goneBerserk[t]||(this.vm.goneBerserk[t]=!0,t!==this.data.player.color&&n.berserk(),o())}unload(){var t;this.transientMove.clear(),this.clock&&this.clock.unload(),clearInterval(this.clockIntervId),null===(t=this.appStateListener)||void 0===t||t.remove(),f.gameBackButton.removeAll()}acceptTakeback(){this.chessground.cancelPremove(),this.socket.iface.send("takeback-yes")}makeCorrespondenceClock(){this.data.correspondence&&!this.correspondenceClock&&(this.correspondenceClock=new CorresClockCtrl(this.data.correspondence,this.socket.outoftime))}actualSendMove(t,e=!1,s=!1){var a;const i=e?0:void 0!==this.lastMoveMillis?performance.now()-this.lastMoveMillis:void 0,n={ackable:!0,withLag:!(!this.clock||void 0!==i&&this.isClockRunning()),millis:i,blur:s};null===(a=this.clock)||void 0===a||a.stopClock(),o(),void 0!==t.u?this.socket.iface.send("move",t,n):function(t){return void 0!==t.role}(t)&&this.socket.iface.send("drop",t,n),this.transientMove.register()}playPredrop(){return this.chessground.playPredrop((t=>L.drop(this.data,t.role,t.key,this.data.possibleDrops)))}setData(t){t.expiration&&(t.expiration.movedAt=Date.now()-t.expiration.idleMillis),this.data=t}}export{OnlineRound as O};
