import{V as t,m as e,$ as o,o as s,X as a,g as i,r as n,k as r,au as l,av as c,a0 as p,a7 as h,d as u,at as d,A as m,aw as v,ax as f,a9 as b,ay as y,x as k,az as g,ak as w,aA as P,v as j,aB as C,aC as _}from"./main.js";import{s as N,g as M}from"./offlineGames-9509d7c8.js";import{e as G,p as x}from"./fen-f2d95e2d.js";import{l as F}from"./layout-b3635a82.js";import{a as S,c as T,v as A}from"./crazyValid-6d95db62.js";import{G as O}from"./GameTitle-46b0cab9.js";import{S as R}from"./index-38489b13.js";import{i as E}from"./chess-1c1bcc98.js";import{g as I}from"./game-51118656.js";import{c as L,p as B,v as $}from"./promotion-87163dc0.js";import{r as U,a as D,g as V,s as W,R as z,d as H,b as X,c as q,e as J,f as K,h as Q,i as Y}from"./view-dc49a302.js";import{c as Z,a as tt}from"./clockSet-92fe743e.js";import{I as et}from"./ImporterCtrl-85c9665e.js";import{B as ot}from"./Board-591a9bd0.js";import"./perfs-d8ca398c.js";import"./countries-a19495bf.js";import"./CountdownTimer-c0405f18.js";import"./tournamentXhr-ac80abd2.js";import"./toInteger-62ca6ec9.js";import"./chat-bb3d94b0.js";var st={controller(t){let e=!1;function o(t){"backbutton"!==t&&e&&r.backbutton.stack.pop(),e=!1}return{open:function(){r.backbutton.stack.push(o),e=!0},close:o,isOpen:function(){return e},root:t}},view:function(r){return r.isOpen()?t("offline_actions",void 0,(function(){return[U(r.root)].concat(D(r.root),function(t){return[e("div",[e("button[data-icon=A]",{oncreate:o(t.goToAnalysis)},s("analysis"))]),e("div.action",a.renderCheckbox(s("otbFlipPiecesAndInfoAfterMove"),"flipPieces",i.otb.flipPieces,(e=>V.changeOTBMode(t.chessground,e)))),e("div.action",a.renderCheckbox(s("otbUseSymmetricPieces"),"useSymmetric",i.otb.useSymmetric,n))]}(r.root))}),r.isOpen(),r.close):null}},at={controller(t){const e=h(!1);function o(t){"backbutton"!==t&&!0===e()&&r.backbutton.stack.pop(),e(!1)}return{open:function(){r.backbutton.stack.push(o),e(!0)},close:o,isOpen:e,root:t}},view:function(n){return n.isOpen()?t("new_offline_game",void 0,(function(){const t=i.otb.availableVariants,h=n.root.vm.setupFen?t.filter((t=>!l.has(t[1]))):t,u=i.otb.variant(),d=n.root.vm.setupFen&&l.has(u);return e("div",null,e("div",{className:"action"},d?e("div",{className:"select_input disabled"},e("label",{for:"variant"},s("variant")),e("select",{disabled:!0,id:"variant"},e("option",{value:u,selected:!0},c(u).name))):e("div",{className:"select_input"},a.renderSelect("variant","variant",h,i.otb.variant)),n.root.vm.setupFen?e("div",{className:"from_position_wrapper"},e("p",null,s("fromPosition")),e("div",{className:"from_position"},e("div",{style:{width:"130px",height:"130px"},oncreate:o((()=>{n.root.vm.setupFen&&r.set(`/editor/${encodeURIComponent(n.root.vm.setupFen)}`)}))},e(p,{fen:n.root.vm.setupFen,orientation:"white"})))):null,e("div",{className:"select_input"},a.renderSelect(s("clock"),"clock",i.otb.availableClocks,i.otb.clockType,!1,it)),Z(i.otb.clockType(),it)),e("div",{className:"popupActionWrapper"},e("button",{className:"defaultButton",oncreate:o((()=>{n.close(),n.root.startNewGame(i.otb.variant(),n.root.vm.setupFen,i.otb.clockType())}))},s("play"))))}),n.isOpen(),(()=>{n.root.vm.setupFen&&r.set("/otb"),n.close()})):null}};function it(){n()}var nt={controller(t){let e=!1;function o(t){"backbutton"!==t&&e&&r.backbutton.stack.pop(),e=!1}return{open:function(){r.backbutton.stack.push(o),e=!0},close:o,isOpen:function(){return e},root:t,importer:et()}},view:a=>t("OtbImportGamePopup",void 0,(()=>{const t=i.otb.whitePlayer,n=i.otb.blackPlayer;return e("div",[e("p","Import current game state with following player names on lichess?"),e("form",[e("div.exchange",{oncreate:o((()=>{const e=t(),o=n();t(o),n(e)}))},e("span.fa.fa-exchange.fa-rotate-90")),e("div.importMeta.text_input_container",[e("label",s("white")),e("input[type=text]",{value:t(),oninput:u((e=>{const o=e.target.value.trim();t(o)}),300),onfocus(){this.select()},spellcheck:!1})]),e("div.importMeta.text_input_container",[e("label",s("black")),e("input[type=text]",{value:n(),oninput:u((t=>{const e=t.target.value.trim();n(e)}),300),onfocus(){this.select()},spellcheck:!1})])]),e("div.popupActionWrapper",[a.importer.importing()?e("div",[e("span.fa.fa-hourglass-half"),e("span","Importing...")]):e("button.popupAction.withIcon[data-icon=E]",{oncreate:o((()=>{var t;const e=i.otb.whitePlayer,o=i.otb.blackPlayer;null===(t=a.root.replay)||void 0===t||t.pgn(e(),o()).then((t=>{a.importer.importGame(t.pgn)}))}))},"Import on lichess")])])}),a.isOpen(),a.close)};class OtbRound{constructor(t,e,o){this.promoting=null,this.goToAnalysis=()=>{this.replay&&r.set(`/analyse/offline/otb/${this.data.player.color}?ply=${this.replay.ply}&curFen=${this.replay.situation().fen}`)},this.save=()=>{this.replay&&N({data:this.data,situations:this.replay.situations,ply:this.replay.ply})},this.saveClock=()=>{this.clock&&this.clock.isRunning()&&this.clock.startStop(),this.save()},this.isClockEnabled=()=>!!this.clock&&void 0===this.clock.flagged()&&void 0!==this.clock.activeSide(),this.toggleClockPlay=()=>{this.clock&&this.isClockEnabled()&&this.clock.startStop()},this.sharePGN=()=>{var t;null===(t=this.replay)||void 0===t||t.pgn("White","Black").then((t=>R.share({text:t.pgn})))},this.addMove=(t,e,o)=>{var s;null===(s=this.replay)||void 0===s||s.addMove(t,e,o),this.chessground.setLastPromotion(o)},this.onPromotion=(t,e,o)=>{this.addMove(t,e,o)},this.userMove=(t,e,o)=>{o.promote&&L(this.chessground.state,e)?this.addMove(t,e,o.promote):B.start(this,t,e,this.onPromotion)||this.addMove(t,e)},this.onMove=(t,e,o)=>{o?"atomic"===this.data.game.variant.key?(S.capture(this.chessground,e),d.explosion()):d.capture():d.move()},this.onUserNewPiece=(t,e)=>{var o;const s=this.replay.situation();T.drop(this.data,t,e,s.drops)?null===(o=this.replay)||void 0===o||o.addDrop(t,e):this.apply(this.replay.situation())},this.onNewPiece=()=>{d.move()},this.onFlag=t=>{const e={id:35,name:"outoftime"};W(this,e,"white"===t?"black":"white"),d.dong(),this.onGameEnd(e),this.save()},this.onReplayAdded=t=>{const e="white"===t.player?"black":"white";this.clock&&this.clock.clockHit(e),this.data.game.fen=t.fen,this.apply(t),W(this,t.status),I.finished(this.data)&&this.onGameEnd(t.status),this.save(),n()},this.onThreefoldRepetition=t=>{W(this,t),this.save(),this.onGameEnd(t)},this.onGameEnd=t=>{this.clock&&this.clock.isRunning()&&this.clock.startStop(),this.chessground.stop(t),setTimeout((()=>{this.actions.open(),n()}),500)},this.player=()=>{var t;return(null===(t=this.replay)||void 0===t?void 0:t.situation().player)||"white"},this.jump=(t,e)=>(this.chessground.cancelMove(),t<0||t>=this.replay.situations.length||(this.replay.ply=t,this.apply(this.replay.situation(),e)),!1),this.jumpNext=()=>this.jump(this.replay.ply+1,"redo"),this.jumpPrev=()=>this.jump(this.replay.ply-1,"undo"),this.jumpFirst=()=>this.jump(this.firstPly(),"undo"),this.jumpLast=()=>this.jump(this.lastPly(),"redo"),this.firstPly=()=>0,this.lastPly=()=>this.replay.situations.length-1,this.replaying=()=>this.replay.ply!==this.lastPly(),this.canDrop=()=>!0,this.setupFen=e,this.actions=st.controller(this),this.importGamePopup=nt.controller(this),this.newGameMenu=at.controller(this),this.vm={flip:!1,setupFen:e,savedFen:t?t.data.game.fen:void 0},this.moveList=!!i.game.moveList(),e?(this.newGameMenu.isOpen(!0),o&&i.otb.variant(o),n()):t&&0!==t.ply||this.newGameMenu.open();const s=i.otb.variant();if(!e)if(t)try{this.init(t.data,t.situations,t.ply)}catch(t){this.startNewGame(s,void 0,i.otb.clockType())}else this.startNewGame(s,void 0,i.otb.clockType());m.addListener("appStateChange",(t=>{t.isActive||this.saveClock()})).then((t=>this.appStateListener=t))}unload(){var t;null===(t=this.appStateListener)||void 0===t||t.remove(),this.saveClock()}init(t,e,o){this.actions.close(),this.data=t;const s=this.data.game.variant.key,a=this.data.game.initialFen;if(this.replay?this.replay.init(s,a,e,o):this.replay=new z(s,a,e,o,this.onReplayAdded,this.onThreefoldRepetition),t.offlineClock){const e=t.offlineClock.clockType;this.clock=tt[e](this.onFlag),this.clock.setState(t.offlineClock)}else this.clock=void 0;this.chessground?V.reload(this.chessground,this.data,this.replay.situation()):this.chessground=V.make(this.data,this.replay.situation(),this.userMove,this.onUserNewPiece,this.onMove,this.onNewPiece),n()}startNewGame(t,e,o){const s={variant:t};e&&(s.fen=e);const a=o&&"none"!==o?tt[o](this.onFlag):null;E(s).then((t=>{this.init(H({id:"offline_otb",variant:t.variant,initialFen:t.setup.fen,fen:t.setup.fen,player:t.setup.player,color:this.data&&v(this.data.player.color)||t.setup.player,pref:{centerPiece:!0},clock:a?a.getState():null}),[t.setup],0)})).then((()=>{e&&(this.vm.setupFen=void 0,r.History.replaceState(void 0,"/otb"))}))}apply(t,e){if(t){this.clock&&this.clock.activeSide()!==t.player&&this.clock.toggleActiveSide();const o=t.uciMoves.length?t.uciMoves[t.uciMoves.length-1]:null;this.chessground.set({fen:t.fen,turnColor:t.player,lastMove:o?f(o):null,dests:t.dests,movableColor:t.player,check:t.check,shift:e})}}}function rt(t){return e("section",{className:"actions_bar"},e("button",{className:"action_bar_button fa fa-ellipsis-v",oncreate:o(t.actions.open)}),e("button",{className:"action_bar_button fa fa-plus-circle",oncreate:o((()=>{t.saveClock(),t.newGameMenu.open()}),(()=>w.show({text:s("createAGame"),duration:"short",position:"bottom"})))}),e("button",{className:"fa fa-share-alt action_bar_button",oncreate:o(t.sharePGN,(()=>w.show({text:s("sharePgn"),duration:"short",position:"bottom"})))}),t.clock?e("button",{className:"fa action_bar_button "+(t.clock.isRunning()?"fa-pause":"fa-play")+(t.isClockEnabled()?"":" disabled"),oncreate:o(t.toggleClockPlay,(()=>w.show({text:s("chessClock"),duration:"short",position:"bottom"})))}):null,null,Y(t),Q(t),K(t))}var lt={oninit({attrs:t}){M().then((e=>{this.round=new OtbRound(e,t.fen,t.variant),window.addEventListener("unload",this.round.saveClock)})),P()},oncreate:j,onremove(){C(),this.round&&(this.round.unload(),window.removeEventListener("unload",this.round.saveClock))},view({attrs:t}){let o,a;const n=i.otb.useSymmetric()?"symmetric":void 0;if(this.round&&this.round.data&&this.round.chessground)a=_(e(O,{data:this.round.data})),o=function(t,o){const a=i.otb.flipPieces(),n=b({otb:!0,mode_flip:a,mode_facing:!a,turn_white:"white"===t.chessground.state.turnColor,turn_black:"black"===t.chessground.state.turnColor}),r=t.chessground.getMaterialDiff(),l=s(t.data.player.color),c=s(t.data.opponent.color),p=X(t),h=y(),u=k(),d=e(ot,{variant:t.data.game.variant.key,chessground:t.chessground,wrapperClasses:n,customPieceTheme:o}),m=t.clock;return h?[g(u,h)?q(t):null,J(t,c,r[t.data.opponent.color],"opponent",a,o,m),d,J(t,l,r[t.data.player.color],"player",a,o,m),rt(t)]:[d,e("section",{className:"table"},J(t,c,r[t.data.opponent.color],"opponent",a,o,m),p,rt(t),J(t,l,r[t.data.player.color],"player",a,o,m))]}(this.round,n);else{const e=t.fen||G,i=e?x(e):"white";a=_(s("overTheBoard")),o=A(e,i,void 0,"standard",void 0,n)}return F.board(a,o,void 0,this.round&&(r=this.round,[st.view(r.actions),at.view(r.newGameMenu),nt.view(r.importGamePopup),$(r)]),void 0,this.round&&this.round.data&&this.round.data.player.color||"white");var r}};export{lt as default};
