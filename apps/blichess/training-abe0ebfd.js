import{V as t,k as i,r as e,ao as a,m as n,o as s,$ as o,b as r,ab as d,aR as h,aC as l,G as c,g as u,bn as v,ak as p,bR as g,bU as m,bV as f,at as b,h as z,d as w,a3 as y,a as k,bY as P,bs as M,b5 as S,q as _,cI as C,aA as j,v as B,aB as T,ay as N,a0 as x}from"./main.js";import{e as O}from"./fen-f2d95e2d.js";import{l as V}from"./layout-b3635a82.js";import{B as F}from"./Board-591a9bd0.js";import{v as R,p as U}from"./promotion-87163dc0.js";import{s as A,p as G,n as J,v as $,g as I,a as L,b as W,r as q,c as Y,d as D}from"./offlineService-ac6544bf.js";import{S as E}from"./index-38489b13.js";import{c as X,s as H,t as K,l as Q,m as Z,i as tt,b as it,a as et,f as at,u as nt,e as st,g as ot}from"./tree-3ccd4e65.js";import{s as rt,m as dt}from"./chess-1c1bcc98.js";var ht={controller(t){let a=!1,n=null;function s(t){"backbutton"!==t&&a&&i.backbutton.stack.pop(),a=!1}return{open:function(){i.backbutton.stack.push(s),a=!0;const o=r.get();o&&t.database.fetch(o.id).then((t=>{t&&(n={username:o.username,data:t.user},e())}))},close:s,isOpen:()=>a,user:()=>n,root:t}},view:i=>t("trainingMenu",void 0,(()=>function(t){const i=t.user();return t.root.data&&t.root.data.user&&a()?lt(t.root.data.user):null!==i&&a()?lt(i.data):null!==i?function(t,i){const e=t.data.rating;return n("div.training-offlineInfos",[n("p",["You are currently offline. Your last recorded rating as ",n("strong",t.username)," is ",n("strong",e),"."]),n("p","You still have ",n("strong",i.root.nbUnsolved)," saved puzzles to solve."),n("p","Puzzles are automatically downloaded by batches so you can solve them seamlessly while having bad network conditions or when you are offline."),n("p","Your puzzle history and rating will be updated as soon as you are back online.")])}(i,t):n("div.trainingMenuContent",[n("p",s("toGetPersonalizedPuzzles")),n("p.signin",n("button.defaultButton",{oncreate:o(d.open)},[n("span.fa.fa-user"),s("signIn")]))])}(i)),i.isOpen(),i.close)};function lt(t){const i=t.rating;return[n("p.trainingRatingHeader",n.trust(s("xRating",`<strong>${i}</strong>`)))]}function ct(t){return n("section#training_actions.actions_bar",[n("button.action_bar_button.training_action.fa.fa-area-chart",{oncreate:o(t.menu.open)}),n("button.action_bar_button.training_action.fa.fa-share-alt",{oncreate:o(t.share,(()=>p.show({text:"Share this puzzle",duration:"short",position:"bottom"})))}),n("button.action_bar_button.training_action[data-icon=A]",{oncreate:o(t.goToAnalysis,(()=>p.show({text:s("analysis"),duration:"short",position:"bottom"}))),disabled:"view"!==t.vm.mode}),r.isConnected()?n("button.action_bar_button.training_action.fa.fa-random",{oncreate:o(t.resync,(()=>p.show({text:"Sync and refresh saved puzzles",duration:"short",position:"bottom"})))}):null,n("button.action_bar_button.training_action.fa.fa-backward",{oncreate:o(t.rewind,void 0,t.rewind),disabled:!t.canGoBackward()}),n("button.action_bar_button.training_action.fa.fa-forward",{oncreate:o(t.fastforward,void 0,t.fastforward),disabled:!t.canGoForward()})])}function ut(t){return[n("button.li-button.training-control.retry",{oncreate:o(t.retry),className:t.vm.loading?"disabled":""},[n("span.fa.fa-refresh"),n("span",s("retry"))]),n("button.li-button.training-control.continue",{oncreate:o(t.newPuzzle),className:t.vm.loading?"disabled":""},[n("span.fa.fa-play"),n("span",s("continueTraining"))])]}function vt(t){switch(t.vm.lastFeedback){case"init":return n("div.training-explanation",[n("div.player",[n("div.piece-no-square",{className:u.general.theme.piece()},n("piece.king."+t.data.puzzle.color)),n("div.training-instruction",[n("strong",s("yourTurn")),n("p",s("white"===t.data.puzzle.color?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]),pt(t)]);case"retry":return n("div.training-explanation",[n("div.player",[n("div.training-icon","!"),n("div.training-instruction",[n("strong",s("goodMove")),n("span","But you can do better")])]),pt(t)]);case"good":return n("div.training-explanation",[n("div.player",[n("div.training-icon.win","✓"),n("div.training-instruction",[n("strong",s("bestMove")),n("span",s("keepGoing"))])]),pt(t)]);case"fail":return n("div.training-explanation",[n("div.player",[n("div.training-icon.loss","✗"),n("div.training-instruction",[n("strong",s("notTheMove")),n("span",s("trySomethingElse"))])]),pt(t)])}}function pt(t){return t.vm.canViewSolution?n("button.fatButton",{oncreate:i=>{v(i.dom,1500,"0","0.8"),o(t.viewSolution)(i)}},s("viewTheSolution")):n("div.buttonPlaceholder","")}function gt(t){return[n("div.buttons",[n("span.fa.fa-caret-up",{oncreate:o(t.upvote),className:!0===t.vm.voted?"voted":""}),n("span.fa.fa-caret-down",{oncreate:o(t.downvote),className:!1===t.vm.voted?"voted":""})])]}function mt(t){return"win"===t.vm.lastFeedback?[n("div.training-half",[n("div.training-icon.win","✓"),n("strong",[s("puzzleSuccess")]),r.isConnected()?n("div.training-vote",gt(t)):null]),n("div.training-half",ut(t))]:[n("div.training-half",[n("strong",s("puzzleComplete")),r.isConnected()?n("div.training-vote",gt(t)):null]),n("div.training-half",ut(t))]}function ft(t){return"string"==typeof t}class TrainingCtrl{constructor(t,a){this.promoting=null,this.player=()=>this.data.puzzle.color,this.viewSolution=()=>{if(!this.vm.canViewSolution)return;this.sendResult(!1),this.vm.mode="view",this.mergeSolution(this.data.puzzle.branch,this.data.puzzle.color);const t=this.node.children[0];if(t&&"good"===t.puzzle)this.userJump(this.path+t.id,!0);else{const t=K(this.mainline,(t=>"good"!==t.puzzle));t&&this.userJump(t+this.tree.nodeAtPath(t).children[0].id,!0)}e()},this.setPath=t=>{this.path=t,this.nodeList=this.tree.getNodeList(t),this.node=Q(this.nodeList),this.mainline=Z(this.tree.root)},this.jump=(t,i=!1)=>{const e=t!==this.path;this.setPath(t),this.updateBoard(),e&&i&&(this.node.san&&-1!==this.node.san.indexOf("x")?b.throttledCapture():b.throttledMove()),U.cancel(this)},this.userJump=(t,i)=>{this.jump(t,i)},this.canGoForward=()=>!this.vm.initializing&&this.node.children.length>0,this.fastforward=()=>{if(0===this.node.children.length)return!1;const t=this.node.children[0];return this.userJump(this.path+t.id,!0),!0},this.canGoBackward=()=>!this.vm.moveValidationPending&&""!==this.path,this.resync=()=>{r.get()},this.rewind=()=>!!this.canGoBackward()&&(this.userJump(tt(this.path),!1),!0),this.newPuzzle=()=>{if(this.vm.loading)return;this.vm.loading=!0,e();const t=t=>{this.vm.loading=!1,this.init(t),e()},i=r.get();i?A(this.database,i).then(t).catch((t=>{this.vm.loading=!1,e(),G(t)})):J().then(t).catch(this.onXhrError)},this.retry=()=>{this.vm.loading||this.init(this.initialData)},this.upvote=()=>{this.vote(!0)},this.downvote=()=>{this.vote(!1)},this.vote=z((t=>{this.vm.voted=t,$(this.data.puzzle.id,t).then(e)}),1e3),this.share=()=>{E.share({url:`https://lichess.org/training/${this.data.puzzle.id}`})},this.goToAnalysis=()=>{const t=this.data.puzzle;i.set(`/analyse/variant/standard/fen/${encodeURIComponent(this.initialNode.fen)}?color=${t.color}&goBack=1`)},this.getNodeSituation=w((()=>{this.node&&!this.node.dests&&rt({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path}).then((({situation:t,path:i})=>{this.tree.updateAt(i,(i=>{i.dests=t.dests,i.end=t.end,i.player=t.player})),i===this.path&&(this.updateBoard(),e())})).catch((t=>{}))}),50),this.sendMove=(t,i,e)=>{const a={orig:t,dest:i,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path,pgnMoves:this.node.pgnMoves};e&&(a.promotion=e),this.sendMoveRequest(a,!0)},this.sendMoveRequest=(t,i=!1)=>{dt(t).then((({situation:t,path:a})=>{const n={id:t.id,ply:t.ply,fen:t.fen,uci:t.uci,children:[],dests:t.dests,check:t.check,end:t.end,player:t.player,san:t.san,pgnMoves:t.pgnMoves};if(void 0===a)return;const s=this.tree.addNode(n,a);if(!s)return;i&&(this.vm.moveValidationPending=!0),this.jump(s,!i),e();if((this.node.ply%2==1?"white":"black")===this.data.puzzle.color){const t=function(t,i,e,a,n,s){var o;if("view"===t)return null;if(!X(e,a))return null;const r=n.slice(H(a)+1).map((t=>({uci:t.uci,castle:t.san.startsWith("O-O")}))),d=r.reduce(((t,i)=>{if(t)return ft(t)?t:t[i.uci]||i.castle&&t[g[i.uci]]}),s.lines);if(null===(o=i.san)||void 0===o?void 0:o.endsWith("#")){const t="win";return i.puzzle=t,t}if(d){if(ft(d))return i.puzzle=d,d;{const t=Object.keys(d)[0];if("win"===d[t])return i.puzzle="win","win";{i.puzzle="good";const a=m(t),n=a[2]?f[a[2].toUpperCase()]:null,s={variant:"standard",orig:a[0],dest:a[1],fen:i.fen,path:e};return n&&(s.promotion=n),s}}}{const t="fail";return i.puzzle=t,t}}(this.vm.mode,this.node,this.path,this.initialPath,this.nodeList,this.data.puzzle);t&&this.applyProgress(t)}})).catch((t=>{}))},this.userMove=(t,i,e)=>{e?b.capture():b.move(),U.start(this,t,i,this.sendMove)||this.sendMove(t,i)},this.revertUserMove=t=>{setTimeout((()=>{this.vm.moveValidationPending=!1,this.userJump(tt(t),!1),this.tree.deleteNodeAt(t),e()}),500)},this.applyProgress=t=>{"fail"===t?(this.vm.lastFeedback="fail",this.revertUserMove(this.path),"play"===this.vm.mode&&(this.vm.canViewSolution=!0,this.vm.mode="try",this.sendResult(!1))):"retry"===t?(this.vm.lastFeedback="retry",this.revertUserMove(this.path)):"win"===t?(this.vm.moveValidationPending=!1,"view"!==this.vm.mode&&("play"===this.vm.mode&&this.sendResult(!0),this.vm.lastFeedback="win",this.vm.mode="view")):void 0!==t.variant&&(this.vm.moveValidationPending=!1,this.vm.lastFeedback="good",setTimeout((()=>{this.sendMoveRequest(t)}),500))},this.sendResult=t=>{if(this.vm.resultSent)return;this.vm.resultSent=!0;const i=r.get(),a={id:this.data.puzzle.id,win:t},n=()=>{q(a).then((t=>{this.vm.voted=t.voted,this.data.user=t.user,e()})).catch((t=>{this.vm.resultSent=!1}))};i?I(this.database,i).then((t=>{t.find((t=>t.puzzle.id===this.data.puzzle.id))?L(this.database,i,a).then((t=>{t&&t.user&&(this.data.user=t.user,e())})):n()})):n()},this.onXhrError=t=>{this.vm.loading=!1,e(),y(t)},this.menu=ht.controller(this),this.database=a,this.init(t),k.afterLogin.add(this.retry)}init(t){this.initialData=t,i.History.replaceState({puzzleId:t.puzzle.id},`/training/${t.puzzle.id}`),this.vm={mode:"play",initializing:!0,lastFeedback:"init",moveValidationPending:!1,loading:!1,canViewSolution:!1,resultSent:!1,voted:null};const a=r.get();a&&W(this.database,a).then((t=>{this.nbUnsolved=t,e()}));const n=JSON.parse(JSON.stringify(t)),s=Object.assign(Object.assign({},n.game),{variant:{key:"standard"}}),o=Object.assign(Object.assign({},n),{game:s});this.data=o,this.tree=it(et([{fen:this.data.puzzle.fen,ply:this.data.puzzle.initialPly-1,id:""},this.data.game.treeParts])),this.initialPath=at(Z(this.tree.root)),this.initialNode=this.tree.nodeAtPath(this.initialPath),this.setPath(tt(this.initialPath)),this.updateBoard(),setTimeout((()=>{this.jump(this.initialPath,!0),this.vm.initializing=!1}),1e3),setTimeout((()=>{this.vm.canViewSolution=!0,e()}),5e3),e()}updateBoard(){var t;const i=this.node,e=i.ply%2==0?"white":"black",a=P(i.dests),n={fen:i.fen,turnColor:e,orientation:this.data.puzzle.color,movableColor:this.gameOver()?null:this.data.puzzle.color,dests:a||null,check:!(!i.check&&!(null===(t=i.san)||void 0===t?void 0:t.endsWith("+"))),lastMove:i.uci?M(i.uci):null};this.chessground?this.chessground.set(n):this.chessground=new S(function(t,i){const e=u.game.pieceMove();return{fen:t.data.puzzle.fen,orientation:t.data.puzzle.color,coordinates:u.game.coords(),turnColor:t.node.ply%2==0?"white":"black",highlight:{lastMove:u.game.highlights(),check:u.game.highlights()},movable:{free:!1,color:t.data.puzzle.color,showDests:u.game.pieceDestinations(),rookCastle:1===u.game.rookCastle()},events:{move:i},animation:{enabled:!0,duration:300},premovable:{enabled:!1},draggable:{enabled:"drag"===e||"both"===e,distance:3,magnified:u.game.magnified()},selectable:{enabled:"tap"===e||"both"===e}}}(this,this.userMove)),a||this.getNodeSituation()}gameOver(){return!!this.node&&("view"===this.vm.mode||!!this.node.end)}mergeSolution(t,i){nt(t,(t=>{"white"===i==(t.ply%2==1)&&(t.puzzle="good")}));const e=st(this.initialNode,t.id);e?ot(e,t):this.initialNode.children.push(t)}}const bt={};var zt={oninit({attrs:t}){var i;const a=()=>{const t=r.get();t?A(D,t).catch(J).then((t=>{this.ctrl=new TrainingCtrl(t,D),bt.ctrl=this.ctrl})).catch(G):J().then((t=>{this.ctrl=new TrainingCtrl(t,D),bt.ctrl=this.ctrl})).catch(y)},n=null!==(i=_(t.id))&&void 0!==i?i:C(t.id);void 0!==n?bt.ctrl&&window.history.state.puzzleId===n?(this.ctrl=bt.ctrl,e()):Y(n).then((t=>{this.ctrl=new TrainingCtrl(t,D),bt.ctrl=this.ctrl})).catch((t=>{404===t.status?(p.show({text:"Puzzle not found.",duration:"short"}),a()):y(t)})):a(),j()},oncreate:B,onremove(){this.ctrl&&k.afterLogin.remove(this.ctrl.retry),T()},view({attrs:t}){const i=N()?"o-portrait":"o-landscape";return this.ctrl?V.board(function(t){const i=u.training.puzzleBufferLen;return t.vm.loading?h():l(n("div.main_header_title.withSub",[n("h1",s("puzzleId",t.data.puzzle.id)),n("h2.header-subTitle",[s("rating")," "+("view"===t.vm.mode?t.data.puzzle.rating:"?")," • ",c("playedXTimes",t.data.puzzle.attempts)].concat([" • ",n("span.fa.fa-database"),`${t.nbUnsolved}/${i}`]))]))}(this.ctrl),function(t,i){const e=n(F,{variant:t.data.game.variant.key,chessground:t.chessground});return n.fragment({key:i},[e,n("div.table.training-tableWrapper",[n("div.training-table.native_scroller.box","view"===t.vm.mode?mt(t):vt(t)),ct(t)])])}(this.ctrl,i),void 0,(e=this.ctrl,[R(e),ht.view(e.menu)])):V.board(h(),[n("section.board_wrapper",[n(x,{fen:t.initFen||O,orientation:t.initColor||"white"})]),n("div.table.training-tableWrapper")],void 0);var e}};export{zt as default};
