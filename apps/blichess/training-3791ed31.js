import{a5 as t,m as i,r as e,k as a,o as n,p as s,y as o,b as r,_ as d,a_ as h,aN as l,z as c,g as u,bv as v,a4 as p,bZ as g,c0 as m,c1 as f,aE as b,h as z,d as w,ac as y,a as k,c5 as P,bA as M,be as S,F as _,cP as j,s as C,aL as N,G as T,aM as B,aJ as x,a9 as F}from"./main.js";import{e as O}from"./fen-f2d95e2d.js";import{l as $}from"./layout-ae040024.js";import{B as V}from"./Board-0ecb6fca.js";import{v as R,p as J}from"./promotion-070b22ca.js";import{s as A,p as G,a as L,n as U,v as I,g as W,b as D,c as q,r as E,e as Y,d as X}from"./offlineService-da906b18.js";import{S as H}from"./index-c70fdca8.js";import{c as Z,s as K,t as Q,l as tt,m as it,i as et,b as at,a as nt,f as st,u as ot,e as rt,g as dt}from"./tree-3ccd4e65.js";import{s as ht,m as lt}from"./chess-a4e99343.js";var ct={controller(t){let a=!1,n=null;function s(t){"backbutton"!==t&&a&&i.backbutton.stack.pop(),a=!1}return{open:function(){i.backbutton.stack.push(s),a=!0;const o=r.get();o&&t.database.fetch(o.id).then((t=>{t&&(n={username:o.username,data:t.user},e())}))},close:s,isOpen:()=>a,user:()=>n,root:t}},view:i=>t("trainingMenu",void 0,(()=>function(t){const i=t.user();return t.root.data&&t.root.data.user&&a()?ut(t.root.data.user):null!==i&&a()?ut(i.data):null!==i?function(t,i){const e=t.data.rating;return n("div.training-offlineInfos",[n("p",["You are currently offline. Your last recorded rating as ",n("strong",t.username)," is ",n("strong",e),"."]),n("p","You still have ",n("strong",i.root.nbUnsolved)," saved puzzles to solve."),n("p","Puzzles are automatically downloaded by batches so you can solve them seamlessly while having bad network conditions or when you are offline."),n("p","Your puzzle history and rating will be updated as soon as you are back online.")])}(i,t):n("div.trainingMenuContent",[n("p",s("toGetPersonalizedPuzzles")),n("p.signin",n("button.defaultButton",{oncreate:o(d.open)},[n("span.fa.fa-user"),s("signIn")]))])}(i)),i.isOpen(),i.close)};function ut(t){const i=t.rating;return[n("p.trainingRatingHeader",n.trust(s("xRating",`<strong>${i}</strong>`)))]}function vt(t){return n("section#training_actions.actions_bar",[n("button.action_bar_button.training_action.fa.fa-area-chart",{oncreate:o(t.menu.open)}),n("button.action_bar_button.training_action.fa.fa-share-alt",{oncreate:o(t.share,(()=>p.show({text:"Share this puzzle",duration:"short",position:"bottom"})))}),n("button.action_bar_button.training_action[data-icon=A]",{oncreate:o(t.goToAnalysis,(()=>p.show({text:s("analysis"),duration:"short",position:"bottom"}))),disabled:"view"!==t.vm.mode}),r.isConnected()?n("button.action_bar_button.training_action.fa.fa-random",{oncreate:o(t.resync,(()=>p.show({text:"Sync and refresh saved puzzles",duration:"short",position:"bottom"})))}):null,n("button.action_bar_button.training_action.fa.fa-backward",{oncreate:o(t.rewind,void 0,t.rewind),disabled:!t.canGoBackward()}),n("button.action_bar_button.training_action.fa.fa-forward",{oncreate:o(t.fastforward,void 0,t.fastforward),disabled:!t.canGoForward()})])}function pt(t){return[n("button.li-button.training-control.retry",{oncreate:o(t.retry),className:t.vm.loading?"disabled":""},[n("span.fa.fa-refresh"),n("span",s("retry"))]),n("button.li-button.training-control.continue",{oncreate:o(t.newPuzzle),className:t.vm.loading?"disabled":""},[n("span.fa.fa-play"),n("span",s("continueTraining"))])]}function gt(t){switch(t.vm.lastFeedback){case"init":return n("div.training-explanation",[n("div.player",[n("div.piece-no-square",{className:u.general.theme.piece()},n("piece.king."+t.data.puzzle.color)),n("div.training-instruction",[n("strong",s("yourTurn")),n("p",s("white"===t.data.puzzle.color?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]),mt(t)]);case"retry":return n("div.training-explanation",[n("div.player",[n("div.training-icon","!"),n("div.training-instruction",[n("strong",s("goodMove")),n("span","But you can do better")])]),mt(t)]);case"good":return n("div.training-explanation",[n("div.player",[n("div.training-icon.win","✓"),n("div.training-instruction",[n("strong",s("bestMove")),n("span",s("keepGoing"))])]),mt(t)]);case"fail":return n("div.training-explanation",[n("div.player",[n("div.training-icon.loss","✗"),n("div.training-instruction",[n("strong",s("notTheMove")),n("span",s("trySomethingElse"))])]),mt(t)])}}function mt(t){return t.vm.canViewSolution?n("button.fatButton",{oncreate:i=>{v(i.dom,1500,"0","0.8"),o(t.viewSolution)(i)}},s("viewTheSolution")):n("div.buttonPlaceholder","")}function ft(t){return[n("div.buttons",[n("span.fa.fa-caret-up",{oncreate:o(t.upvote),className:!0===t.vm.voted?"voted":""}),n("span.fa.fa-caret-down",{oncreate:o(t.downvote),className:!1===t.vm.voted?"voted":""})])]}function bt(t){return"win"===t.vm.lastFeedback?[n("div.training-half",[n("div.training-icon.win","✓"),n("strong",[s("puzzleSuccess")]),r.isConnected()?n("div.training-vote",ft(t)):null]),n("div.training-half",pt(t))]:[n("div.training-half",[n("strong",s("puzzleComplete")),r.isConnected()?n("div.training-vote",ft(t)):null]),n("div.training-half",pt(t))]}function zt(t){return"string"==typeof t}class TrainingCtrl{constructor(t,n){this.promoting=null,this.player=()=>this.data.puzzle.color,this.viewSolution=()=>{if(!this.vm.canViewSolution)return;this.sendResult(!1),this.vm.mode="view",this.mergeSolution(this.data.puzzle.branch,this.data.puzzle.color);const t=this.node.children[0];if(t&&"good"===t.puzzle)this.userJump(this.path+t.id,!0);else{const t=Q(this.mainline,(t=>"good"!==t.puzzle));t&&this.userJump(t+this.tree.nodeAtPath(t).children[0].id,!0)}e()},this.setPath=t=>{this.path=t,this.nodeList=this.tree.getNodeList(t),this.node=tt(this.nodeList),this.mainline=it(this.tree.root)},this.jump=(t,i=!1)=>{const e=t!==this.path;this.setPath(t),this.updateBoard(),e&&i&&(this.node.san&&-1!==this.node.san.indexOf("x")?b.throttledCapture():b.throttledMove()),J.cancel(this)},this.userJump=(t,i)=>{this.jump(t,i)},this.canGoForward=()=>!this.vm.initializing&&this.node.children.length>0,this.fastforward=()=>{if(0===this.node.children.length)return!1;const t=this.node.children[0];return this.userJump(this.path+t.id,!0),!0},this.canGoBackward=()=>!this.vm.moveValidationPending&&""!==this.path,this.resync=()=>{const t=r.get();if(a()&&t){if(this.vm.loading)return;this.vm.loading=!0,e();const i=t=>{this.vm.loading=!1,this.init(t),e()};A(this.database,t).then(i).catch((t=>{this.vm.loading=!1,e(),G(t)}))}},this.rewind=()=>!!this.canGoBackward()&&(this.userJump(et(this.path),!1),!0),this.newPuzzle=()=>{if(this.vm.loading)return;this.vm.loading=!0,e();const t=t=>{this.vm.loading=!1,this.init(t),e()},i=r.get();i?L(this.database,i).then(t).catch((t=>{this.vm.loading=!1,e(),G(t)})):U().then(t).catch(this.onXhrError)},this.retry=()=>{this.vm.loading||this.init(this.initialData)},this.upvote=()=>{this.vote(!0)},this.downvote=()=>{this.vote(!1)},this.vote=z((t=>{this.vm.voted=t,I(this.data.puzzle.id,t).then(e)}),1e3),this.share=()=>{H.share({url:`https://lichess.org/training/${this.data.puzzle.id}`})},this.goToAnalysis=()=>{const t=this.data.puzzle;a()?i.set(`/analyse/online/${t.gameId}/${t.color}?ply=${t.initialPly}&curFen=${this.initialNode.fen}&color=${t.color}&fallback=1`):i.set(`/analyse/variant/standard/fen/${encodeURIComponent(this.initialNode.fen)}?color=${t.color}&goBack=1`)},this.getNodeSituation=w((()=>{this.node&&!this.node.dests&&ht({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path}).then((({situation:t,path:i})=>{this.tree.updateAt(i,(i=>{i.dests=t.dests,i.end=t.end,i.player=t.player})),i===this.path&&(this.updateBoard(),e())})).catch((t=>{}))}),50),this.sendMove=(t,i,e)=>{const a={orig:t,dest:i,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path,pgnMoves:this.node.pgnMoves};e&&(a.promotion=e),this.sendMoveRequest(a,!0)},this.sendMoveRequest=(t,i=!1)=>{lt(t).then((({situation:t,path:a})=>{const n={id:t.id,ply:t.ply,fen:t.fen,uci:t.uci,children:[],dests:t.dests,check:t.check,end:t.end,player:t.player,san:t.san,pgnMoves:t.pgnMoves};if(void 0===a)return;const s=this.tree.addNode(n,a);if(!s)return;i&&(this.vm.moveValidationPending=!0),this.jump(s,!i),e();if((this.node.ply%2==1?"white":"black")===this.data.puzzle.color){const t=function(t,i,e,a,n,s){var o;if("view"===t)return null;if(!Z(e,a))return null;const r=n.slice(K(a)+1).map((t=>({uci:t.uci,castle:t.san.startsWith("O-O")}))),d=r.reduce(((t,i)=>{if(t)return zt(t)?t:t[i.uci]||i.castle&&t[g[i.uci]]}),s.lines);if(null===(o=i.san)||void 0===o?void 0:o.endsWith("#")){const t="win";return i.puzzle=t,t}if(d){if(zt(d))return i.puzzle=d,d;{const t=Object.keys(d)[0];if("win"===d[t])return i.puzzle="win","win";{i.puzzle="good";const a=m(t),n=a[2]?f[a[2].toUpperCase()]:null,s={variant:"standard",orig:a[0],dest:a[1],fen:i.fen,path:e};return n&&(s.promotion=n),s}}}{const t="fail";return i.puzzle=t,t}}(this.vm.mode,this.node,this.path,this.initialPath,this.nodeList,this.data.puzzle);t&&this.applyProgress(t)}})).catch((t=>{}))},this.userMove=(t,i,e)=>{e?b.capture():b.move(),J.start(this,t,i,this.sendMove)||this.sendMove(t,i)},this.revertUserMove=t=>{setTimeout((()=>{this.vm.moveValidationPending=!1,this.userJump(et(t),!1),this.tree.deleteNodeAt(t),e()}),500)},this.applyProgress=t=>{"fail"===t?(this.vm.lastFeedback="fail",this.revertUserMove(this.path),"play"===this.vm.mode&&(this.vm.canViewSolution=!0,this.vm.mode="try",this.sendResult(!1))):"retry"===t?(this.vm.lastFeedback="retry",this.revertUserMove(this.path)):"win"===t?(this.vm.moveValidationPending=!1,"view"!==this.vm.mode&&("play"===this.vm.mode&&this.sendResult(!0),this.vm.lastFeedback="win",this.vm.mode="view")):void 0!==t.variant&&(this.vm.moveValidationPending=!1,this.vm.lastFeedback="good",setTimeout((()=>{this.sendMoveRequest(t)}),500))},this.sendResult=t=>{if(this.vm.resultSent)return;this.vm.resultSent=!0;const i=r.get(),n={id:this.data.puzzle.id,win:t},s=()=>{E(n).then((t=>{this.vm.voted=t.voted,this.data.user=t.user,e()})).catch((t=>{a()&&y(t),this.vm.resultSent=!1}))};i?W(this.database,i).then((t=>{t.find((t=>t.puzzle.id===this.data.puzzle.id))?D(this.database,i,n).then((t=>{t&&t.user&&(this.data.user=t.user,e())})):s()})):s()},this.onXhrError=t=>{this.vm.loading=!1,e(),y(t)},this.menu=ct.controller(this),this.database=n,this.init(t),k.afterLogin.add(this.retry)}init(t){this.initialData=t,i.History.replaceState({puzzleId:t.puzzle.id},`/training/${t.puzzle.id}`),this.vm={mode:"play",initializing:!0,lastFeedback:"init",moveValidationPending:!1,loading:!1,canViewSolution:!1,resultSent:!1,voted:null};const a=r.get();a&&q(this.database,a).then((t=>{this.nbUnsolved=t,e()}));const n=JSON.parse(JSON.stringify(t)),s=Object.assign(Object.assign({},n.game),{variant:{key:"standard"}}),o=Object.assign(Object.assign({},n),{game:s});this.data=o,this.tree=at(nt([{fen:this.data.puzzle.fen,ply:this.data.puzzle.initialPly-1,id:""},this.data.game.treeParts])),this.initialPath=st(it(this.tree.root)),this.initialNode=this.tree.nodeAtPath(this.initialPath),this.setPath(et(this.initialPath)),this.updateBoard(),setTimeout((()=>{this.jump(this.initialPath,!0),this.vm.initializing=!1}),1e3),setTimeout((()=>{this.vm.canViewSolution=!0,e()}),5e3),e()}updateBoard(){var t;const i=this.node,e=i.ply%2==0?"white":"black",a=P(i.dests),n={fen:i.fen,turnColor:e,orientation:this.data.puzzle.color,movableColor:this.gameOver()?null:this.data.puzzle.color,dests:a||null,check:!(!i.check&&!(null===(t=i.san)||void 0===t?void 0:t.endsWith("+"))),lastMove:i.uci?M(i.uci):null};this.chessground?this.chessground.set(n):this.chessground=new S(function(t,i){const e=u.game.pieceMove();return{fen:t.data.puzzle.fen,orientation:t.data.puzzle.color,coordinates:u.game.coords(),turnColor:t.node.ply%2==0?"white":"black",highlight:{lastMove:u.game.highlights(),check:u.game.highlights()},movable:{free:!1,color:t.data.puzzle.color,showDests:u.game.pieceDestinations(),rookCastle:1===u.game.rookCastle()},events:{move:i},animation:{enabled:!0,duration:300},premovable:{enabled:!1},draggable:{enabled:"drag"===e||"both"===e,distance:3,magnified:u.game.magnified()},selectable:{enabled:"tap"===e||"both"===e}}}(this,this.userMove)),a||this.getNodeSituation()}gameOver(){return!!this.node&&("view"===this.vm.mode||!!this.node.end)}mergeSolution(t,i){ot(t,(t=>{"white"===i==(t.ply%2==1)&&(t.puzzle="good")}));const e=rt(this.initialNode,t.id);e?dt(e,t):this.initialNode.children.push(t)}}const wt={};var yt={oninit({attrs:t}){var i;const a=()=>{const t=r.get();t?L(X,t).catch(U).then((t=>{this.ctrl=new TrainingCtrl(t,X),wt.ctrl=this.ctrl})).catch(G):U().then((t=>{this.ctrl=new TrainingCtrl(t,X),wt.ctrl=this.ctrl})).catch(y)},n=null!==(i=_(t.id))&&void 0!==i?i:j(t.id);void 0!==n?wt.ctrl&&window.history.state.puzzleId===n?(this.ctrl=wt.ctrl,e()):Y(n).then((t=>{this.ctrl=new TrainingCtrl(t,X),wt.ctrl=this.ctrl})).catch((t=>{404===t.status?(p.show({text:"Puzzle not found.",duration:"short"}),a()):y(t)})):a(),C.createDefault(),N()},oncreate:T,onremove(){this.ctrl&&k.afterLogin.remove(this.ctrl.retry),B()},view({attrs:t}){const i=x()?"o-portrait":"o-landscape";return this.ctrl?$.board(function(t){const i=u.training.puzzleBufferLen;return t.vm.loading?h():l(n("div.main_header_title.withSub",[n("h1",s("puzzleId",t.data.puzzle.id)),n("h2.header-subTitle",[s("rating")," "+("view"===t.vm.mode?t.data.puzzle.rating:"?")," • ",c("playedXTimes",t.data.puzzle.attempts)].concat(a()?[]:[" • ",n("span.fa.fa-database"),`${t.nbUnsolved}/${i}`]))]))}(this.ctrl),function(t,i){const e=n(V,{variant:t.data.game.variant.key,chessground:t.chessground});return n.fragment({key:i},[e,n("div.table.training-tableWrapper",[n("div.training-table.native_scroller.box","view"===t.vm.mode?bt(t):gt(t)),vt(t)])])}(this.ctrl,i),void 0,(e=this.ctrl,[R(e),ct.view(e.menu)])):$.board(h(),[n("section.board_wrapper",[n(F,{fen:t.initFen||O,orientation:t.initColor||"white"})]),n("div.table.training-tableWrapper")],void 0);var e}};export{yt as default};
