import{f as e,d as t,r as s,i,s as a,l as r,a as o,b as n,n as l,t as c,c as h,Z as d,e as m,g as f,h as u,j as p,N as g,A as b,k as w,m as k,o as v,p as S,q as y,v as z,u as P,C}from"./main.js";import{l as j}from"./layout-b3635a82.js";import{supportedTypes as G}from"./timeline-d414b2c8.js";import{l as N,d as O}from"./offlineService-ac6544bf.js";import"./userView-00e33bc7.js";import"./perfs-d8ca398c.js";import{M as T}from"./miniBoard-470b1ed0.js";import"./html-1975aa10.js";import"./countries-a19495bf.js";import"./userXhr-e893d0da.js";import"./CountdownTimer-c0405f18.js";class HomeCtrl{constructor(w){this.isScrolling=!1,this.afterScroll=t((()=>{this.isScrolling=!1,s()}),200),this.onScroll=()=>{this.isScrolling=!0,this.afterScroll()},this.redrawIfNotScrolling=()=>{this.isScrolling||s()},this.socketSend=(e,t)=>{this.socket&&this.socket.send(e,t)},this.unload=()=>{var e,t;null===(e=this.networkListener)||void 0===e||e.remove(),null===(t=this.appStateListener)||void 0===t||t.remove()},this.init=()=>{i()&&(this.socket=a.createLobby("homeLobby",(()=>{this.reloadCorresPool(),this.getFeatured()}),{redirect:a.redirectToGame,reload_seeks:this.reloadCorresPool,resync:()=>r().then((e=>{a.setVersion(e.lobby.version)})),n:(e,t)=>{o.homePong.dispatch(t)},featured:()=>{this.getFeatured()},fen:e=>{this.featuredGame&&this.featuredGame.id===e.id&&(this.featuredGame.fen=e.fen,this.featuredGame.lastMove=e.lm,this.featuredGame.c={black:e.bc,white:e.wc},s())},finish:e=>{this.featuredGame&&this.featuredGame.id===e.id&&(this.featuredGame.finished=!0,"b"===e.win?this.featuredGame.winner="black":"w"===e.win&&(this.featuredGame.winner="white"),s())}}),Promise.all([e("/tournament/featured",void 0),n.refresh().then((()=>n.isKidMode()||!n.isConnected()?Promise.resolve([]):e("/api/streamer/featured",void 0)))]).then((e=>{const[t,i]=e;this.featuredTournaments=t.featured,this.featuredStreamers=i,s()})).catch(l),e("/training/daily",void 0).then((e=>{this.dailyPuzzle=e,s()})),c().then((e=>{this.timelineData={users:e.users,entries:e.entries.filter((e=>-1!==G.indexOf(e.type))).slice(0,15).map((e=>(e.fromNow=h(new Date(e.date)),e)))},s()})).catch((()=>{this.timelineData={entries:[],users:{}}})))},this.loadOfflinePuzzle=()=>{const e=n.get();e&&N(O,e).then((e=>{this.offlinePuzzle=e,s()}))},this.onTabChange=e=>{const t=window.location.search.replace(/\?tab=\w+$/,"");try{window.history.replaceState(window.history.state,"",t+"?tab="+e)}catch(e){}this.selectedTab=e,1===this.selectedTab&&this.reloadCorresPool(),s()},this.cancelCorresSeek=e=>{const t=document.getElementById(e);t&&d(t,"opacity","0",300,"ease-out").then((()=>this.socketSend("cancelSeek",e))).catch(console.log.bind(console))},this.joinCorresSeek=e=>{this.socketSend("joinSeek",e)},this.reloadCorresPool=()=>{1===this.selectedTab&&m(!1).then((e=>{this.corresPool=function(e){const t=n.getUserId();t&&e.sort(((e,s)=>L(e)===t?-1:L(s)===t?1:0));return[...e.map((e=>[e,(L(e)===t?e.id:e.username)+e.mode+e.perf.key+e.days+e.color])).filter((([e,t],s,i)=>i.map((e=>e[1])).indexOf(t)===s)).map((([e])=>e))]}(e).filter((e=>f.game.supportedVariants.includes(e.variant.key))).sort(((e,t)=>e.rating>t.rating?-1:1)),this.redrawIfNotScrolling()}))},this.getFeatured=u((()=>{p("best",!1).then((e=>{const t=M(e.opponent),s=M(e.player);this.featuredGame={c:e.clock?{white:Math.round(e.clock.white),black:Math.round(e.clock.black)}:void 0,black:"white"===e.game.player?t:s,orientation:e.orientation,fen:e.game.fen,id:e.game.id,lastMove:e.game.lastMove,white:"white"===e.game.player?s:t},this.socketSend("startWatching",e.game.id),this.redrawIfNotScrolling()}))}),1e3),this.corresPool=[],this.selectedTab=w||0,this.loadOfflinePuzzle(),g.addListener("networkStatusChange",(e=>{e.connected&&this.init()})).then((e=>this.networkListener=e)),b.addListener("appStateChange",(e=>{e.isActive&&this.init()})).then((e=>this.appStateListener=e))}}function L(e){return e.username.toLowerCase()}function M(e){return{name:e.name||e.username||e.user&&e.user.username||"",rating:e.rating||0,ratingDiff:e.ratingDiff||0,berserk:e.berserk,title:e.user&&e.user.title}}function B(e){return function(e){const t=e.offlinePuzzle,s=t?{fixed:!0,fen:t.puzzle.fen,orientation:t.puzzle.color,link:()=>w.set("/training")}:null;return k("div",{className:"homeOfflineWrapper"+(s?" withBoard":"")},k("div",{className:"home homeOffline"},k("section",{className:"playOffline"},k("h2",null,v("playOffline")),k("button",{className:"fatButton",oncreate:S((()=>w.set("/ai")))},v("computer")),k("button",{className:"fatButton",oncreate:S((()=>w.set("/otb")))},v("overTheBoard"))),s?k("section",{className:"home__miniPuzzle"},k("h2",{className:"homeTitle"},v("puzzles")),k(T,s)):void 0))}(e)}var D={oninit({attrs:e}){this.ctrl=new HomeCtrl(y(e.tab)),o.sessionRestored.add(this.ctrl.loadOfflinePuzzle)},oncreate:z,onremove(){a.destroy(),this.ctrl.unload(),o.sessionRestored.remove(this.ctrl.loadOfflinePuzzle)},view(){const e=P("lichess.org");return j.free(e,B(this.ctrl),void 0,void 0,"ios"===C.getPlatform()?this.ctrl.onScroll:void 0)}};export{D as default};
