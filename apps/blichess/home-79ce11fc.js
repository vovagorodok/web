import{f as e,d as t,r as a,i as n,s,l as o,a as r,b as i,n as l,t as c,c as u,Z as d,e as m,g as h,h as f,j as p,k as b,N as g,A as v,m as w,o as y,p as _,q as k,u as z,v as P,w as T,x as S,y as C,z as N,B as G,C as j,D as M,E as x,F as I,G as O,H as L,I as D}from"./main.js";import{p as B,l as F}from"./layout-ae040024.js";import{supportedTypes as A,renderTimelineEntry as V,timelineOnTap as W}from"./timeline-d73f4077.js";import{l as E,d as R}from"./offlineService-da906b18.js";import{o as $}from"./userView-405da2bd.js";import{e as q}from"./fen-f2d95e2d.js";import{M as H}from"./miniBoard-2e2fcf0b.js";import{T as Y,a as U}from"./TabView-408b9801.js";import{r as X}from"./tournamentsListView-f84d954f.js";import"./html-1975aa10.js";import"./perfs-d8ca398c.js";import"./countries-a19495bf.js";import"./userXhr-d3b3ac60.js";import"./CountdownTimer-c8587446.js";import"./tournamentXhr-291e93e6.js";class HomeCtrl{constructor(w){this.isScrolling=!1,this.afterScroll=t((()=>{this.isScrolling=!1,a()}),200),this.onScroll=()=>{this.isScrolling=!0,this.afterScroll()},this.redrawIfNotScrolling=()=>{this.isScrolling||a()},this.socketSend=(e,t)=>{this.socket&&this.socket.send(e,t)},this.unload=()=>{var e,t;null===(e=this.networkListener)||void 0===e||e.remove(),null===(t=this.appStateListener)||void 0===t||t.remove()},this.init=()=>{n()&&(this.socket=s.createLobby("homeLobby",(()=>{this.reloadCorresPool(),this.getFeatured()}),{redirect:s.redirectToGame,reload_seeks:this.reloadCorresPool,resync:()=>o().then((e=>{s.setVersion(e.lobby.version)})),n:(e,t)=>{r.homePong.dispatch(t)},featured:()=>{this.getFeatured()},fen:e=>{this.featuredGame&&this.featuredGame.id===e.id&&(this.featuredGame.fen=e.fen,this.featuredGame.lastMove=e.lm,this.featuredGame.c={black:e.bc,white:e.wc},a())},finish:e=>{this.featuredGame&&this.featuredGame.id===e.id&&(this.featuredGame.finished=!0,"b"===e.win?this.featuredGame.winner="black":"w"===e.win&&(this.featuredGame.winner="white"),a())}}),Promise.all([e("/tournament/featured",void 0),i.refresh().then((()=>i.isKidMode()||!i.isConnected()?Promise.resolve([]):e("/api/streamer/featured",void 0)))]).then((e=>{const[t,n]=e;this.featuredTournaments=t.featured,this.featuredStreamers=n,a()})).catch(l),e("/training/daily",void 0).then((e=>{this.dailyPuzzle=e,a()})),c().then((e=>{this.timelineData={users:e.users,entries:e.entries.filter((e=>-1!==A.indexOf(e.type))).slice(0,15).map((e=>(e.fromNow=u(new Date(e.date)),e)))},a()})).catch((()=>{this.timelineData={entries:[],users:{}}})))},this.loadOfflinePuzzle=()=>{const e=i.get();e&&E(R,e).then((e=>{this.offlinePuzzle=e,a()}))},this.onTabChange=e=>{const t=window.location.search.replace(/\?tab=\w+$/,"");try{window.history.replaceState(window.history.state,"",t+"?tab="+e)}catch(e){}this.selectedTab=e,1===this.selectedTab&&this.reloadCorresPool(),a()},this.cancelCorresSeek=e=>{const t=document.getElementById(e);t&&d(t,"opacity","0",300,"ease-out").then((()=>this.socketSend("cancelSeek",e))).catch(console.log.bind(console))},this.joinCorresSeek=e=>{this.socketSend("joinSeek",e)},this.reloadCorresPool=()=>{1===this.selectedTab&&m(!1).then((e=>{this.corresPool=function(e){const t=i.getUserId();t&&e.sort(((e,a)=>K(e)===t?-1:K(a)===t?1:0));return[...e.map((e=>[e,(K(e)===t?e.id:e.username)+e.mode+e.perf.key+e.days+e.color])).filter((([e,t],a,n)=>n.map((e=>e[1])).indexOf(t)===a)).map((([e])=>e))]}(e).filter((e=>h.game.supportedVariants.includes(e.variant.key))).sort(((e,t)=>e.rating>t.rating?-1:1)),this.redrawIfNotScrolling()}))},this.getFeatured=f((()=>{p("best",!1).then((e=>{const t=Z(e.opponent),a=Z(e.player);this.featuredGame={c:e.clock?{white:Math.round(e.clock.white),black:Math.round(e.clock.black)}:void 0,black:"white"===e.game.player?t:a,orientation:e.orientation,fen:e.game.fen,id:e.game.id,lastMove:e.game.lastMove,white:"white"===e.game.player?a:t},this.socketSend("startWatching",e.game.id),this.redrawIfNotScrolling()}))}),1e3),this.corresPool=[],this.selectedTab=w||0,b()?this.init():this.loadOfflinePuzzle(),g.addListener("networkStatusChange",(e=>{e.connected&&this.init()})).then((e=>this.networkListener=e)),v.addListener("appStateChange",(e=>{e.isActive&&this.init()})).then((e=>this.appStateListener=e))}}function K(e){return e.username.toLowerCase()}function Z(e){return{name:e.name||e.username||e.user&&e.user.username||"",rating:e.rating||0,ratingDiff:e.ratingDiff||0,berserk:e.berserk,title:e.user&&e.user.title}}function J(e){return b()?function(e){var t;const a=null===(t=i.get())||void 0===t?void 0:t.playban,n=a&&new Date(a.date+6e4*a.mins);return y("div",{className:"home"},n&&(n.valueOf()-Date.now())/1e3>1?(s=n,y("div",{className:"home-playbanInfo"},y("h2",null,_("sorry")),y("p",null,_("weHadToTimeYouOutForAWhile")),y("br",null),y("p",null,y.trust(_("timeoutExpires",`<strong>${P(s)}</strong>`))),y("h2",null,_("why")),y("p",null,_("pleasantChessExperience"),y("br",null),_("goodPractice"),y("br",null),_("potentialProblem")),y("h2",null,_("howToAvoidThis")),y("ul",null,y("li",null,_("playEveryGame")),y("li",null,_("tryToWin")),y("li",null,_("resignLostGames"))),y("br",null),y("p",null,_("temporaryInconvenience"),y("br",null),_("wishYouGreatGames"),y("br",null),_("thankYouForReading")))):function(e){const t=[{id:"quick",f:()=>S((()=>j.openRealTime("custom")))},{id:"corres",f:()=>function(e){return y("div.corresPoolWrapper.native_scroller",[y("table.corres_seeks",[y("thead",[y("tr",[y("th",""),y("th",_("player")),y("th",_("rating")),y("th",_("time")),y("th",_("mode"))])]),y("tbody",e.corresPool.map((t=>function(e,t){const a=t.username.toLowerCase()===i.getUserId()?"cancelCorresSeek":"joinCorresSeek",n=""===t.color?"random":"white"===t.color?"white":"black";return y("tr",{key:"seek"+t.id,id:t.id,className:"corres_seek "+a,oncreate:k((()=>e[a](t.id)))},[y("td",y("span.color-icon."+n)),y("td",t.username),y("td",t.rating+(t.provisional?"?":"")),y("td",t.days?N("nbDays",t.days):"∞"),y("td",y("span.withIcon",{"data-icon":G(t.perf.key)},_(1===t.mode?"rated":"casual")))])}(e,t))))]),y("div.corres_create",[y("button.defaultButton",{oncreate:C(j.openCorrespondence)},_("createAGame"))])])}(e)}];return y("div.home__lobby",[y(Y,{buttons:[{label:_("quickPairing")},{label:_("correspondence")}],selectedIndex:e.selectedTab,onTabChange:e.onTabChange,wrapperClass:"homeSetup",withBottomBorder:!0}),y(U,{selectedIndex:e.selectedTab,tabs:t,onTabChange:e.onTabChange,className:"home__setupTabView"})])}(e),function(e){return y("div",{className:"home__start"},y("div",{className:"home__buttons"},y("button",{className:"buttonMetal",oncreate:k((()=>j.openRealTime("custom")))},_("createAGame")),y("button",{className:"buttonMetal",oncreate:k((()=>M.open()))},_("playWithAFriend")),y("button",{className:"buttonMetal",oncreate:k(B.open)},_("playWithTheMachine"))),y(Q,{ctrl:e}))}(e),y("div",{className:"home__side"},function(e){var t;return(null===(t=e.featuredStreamers)||void 0===t?void 0:t.length)?y("ul.home__streamers",e.featuredStreamers.map((e=>y("li.home__streamer",{oncreate:k((()=>$(e.url)))},[y("strong[data-icon=]",(e.user.title?e.user.title+" ":"")+e.user.name),y("span.status"," "+e.status)])))):null}(e),function(e){var t;return(null===(t=e.featuredTournaments)||void 0===t?void 0:t.length)?y("div",{className:"home__tournament"},X(e.featuredTournaments)):null}(e),function(e){const t=e.timelineData;if(void 0===t)return y("section",{className:"home__timeline loading"},z.getVdom("monochrome"));if(0===t.entries.length)return y("section",{className:"home__timeline"});return y("section",{className:"home__timeline"},y("ul",{oncreate:k(W,void 0,x)},t.entries.map((e=>V(e,t.users)))),y("div",{className:"more"},y("button",{oncreate:k((()=>w.set("/timeline")))},_("more")," »")))}(e)),function(e){const t=e.featuredGame,a=t?{fixed:!1,fen:t.fen,orientation:t.orientation,lastMove:t.lastMove,link:()=>{h.tv.channel("best"),w.set("/tv")},gameObj:t}:{fixed:!1,orientation:"white",fen:q};return y("section",{className:"home__featured"},y(H,a))}(e),function(e){const t=e.dailyPuzzle,a=t&&t.puzzle&&t.game&&t.game.treeParts?{fixed:!0,fen:t.game.treeParts.fen,lastMove:t.game.treeParts.uci,orientation:t.puzzle.color,link:()=>w.set(`/training/${t.puzzle.id}?initFen=${t.puzzle.fen}&initColor=${t.puzzle.color}`),topText:_("puzzleOfTheDay"),bottomText:"white"===t.puzzle.color?_("whitePlays"):_("blackPlays")}:{fixed:!0,orientation:"white",fen:q};return y("section",{className:"home__miniPuzzle"},y(H,a))}(e));var s}(e):function(e){const t=e.offlinePuzzle,a=t?{fixed:!0,fen:t.puzzle.fen,orientation:t.puzzle.color,link:()=>w.set("/training")}:null;return y("div",{className:"homeOfflineWrapper"+(a?" withBoard":"")},y("div",{className:"home homeOffline"},y("section",{className:"playOffline"},y("h2",null,_("playOffline")),y("button",{className:"fatButton",oncreate:k((()=>w.set("/ai")))},_("computer")),y("button",{className:"fatButton",oncreate:k((()=>w.set("/otb")))},_("overTheBoard"))),a?y("section",{className:"home__miniPuzzle"},y("h2",{className:"homeTitle"},_("puzzles")),y(H,a)):void 0))}(e)}const Q={oncreate({attrs:e}){const t=ee(e.ctrl,"#nb_games_in_play > strong",8,s.getCurrentPingInterval),a=ee(e.ctrl,"#nb_connected_players > strong",10,s.getCurrentPingInterval);this.render=e=>{a(e.d),setTimeout((()=>{t(e.r)}),s.getCurrentPingInterval()/2)},r.homePong.add(this.render)},onremove(){r.homePong.remove(this.render)},view:()=>y("div.home__stats",[y("div#nb_connected_players",y.trust(_("nbPlayers:other","<strong>?</strong>"))),y("div#nb_games_in_play",y.trust(_("nbGames:other","<strong>?</strong>")))])};function ee(e,t,a,n){let s,o;function r(t,n,s,r){const i=T(Math.round((n*(a-1-r)+s*(r+1))/a));t&&i!==o&&(e.isScrolling||(t.textContent=i,o=i))}let i=[];return function(e,o){const l=document.querySelector(t);if(!l||!e&&0!==e)return;o&&(a=Math.abs(o)),i.forEach(clearTimeout),i=[];const c=0===s?0:s||e;s=e;const u=Math.abs(n()/a);for(let t=0;t<a;t++)i.push(setTimeout((()=>r(l,c,e,t)),Math.round(t*u)))}}var te={oninit({attrs:e}){this.ctrl=new HomeCtrl(I(e.tab)),r.sessionRestored.add(this.ctrl.loadOfflinePuzzle)},oncreate:O,onremove(){s.destroy(),this.ctrl.unload(),r.sessionRestored.remove(this.ctrl.loadOfflinePuzzle)},view(){const e=L("lichess.org");return F.free(e,J(this.ctrl),void 0,void 0,"ios"===D.getPlatform()?this.ctrl.onScroll:void 0)}};export{te as default};
