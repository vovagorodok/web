import{f as e,b8 as t,a5 as a,m as n,o as s,y as i,p as o,ah as r,u as l,r as c,ac as d,b as u,g as h,bH as p,bI as m,aH as v,bi as f,a6 as g,bJ as y,bK as b,bL as w,bM as k,bN as x,bO as M,bP as C,bQ as P,bR as N,a4 as T,a7 as S,bS as _,S as I,E as O,q as A,af as E,bT as B,z as G,aT as z,ax as D,an as j,aR as U,bU as $,aP as F,aX as W,aI as L,bl as R,bm as q,bA as H,bk as V,bV as J,bW as X,bX as K,bx as Y,bY as Q,a9 as Z,B as ee,I as te,bh as ae,b5 as ne,bZ as se,b9 as ie,d as oe,be as re,bg as le,b_ as ce,b$ as de,s as ue,k as he,aE as pe,bD as me,c0 as ve,c1 as fe,c2 as ge,n as ye,c3 as be,c4 as we,bz as ke,c5 as xe}from"./main.js";import{e as Me,c as Ce,r as Pe}from"./fen-f2d95e2d.js";import{k as Ne,q as Te,r as Se,b as _e,a as Ie,s as Oe,c as Ae}from"./variant-c1af828f.js";import{v as Ee,p as Be}from"./promotion-070b22ca.js";import{g as Ge,C as ze,t as De,n as je,N as Ue}from"./toInteger-da417924.js";import{a as $e,T as Fe}from"./TabView-408b9801.js";import{l as We}from"./layout-ae040024.js";import{c as Le,C as Re}from"./chat-2370f74a.js";import{l as qe}from"./html-1975aa10.js";import{c as He,y as Ve,z as Je,A as Xe,B as Ke,C as Ye,D as Qe,E as Ze,F as et,k as tt,g as at,G as nt,H as st,I as it,a as ot,J as rt,K as lt,L as ct,M as dt}from"./game-b6f212b0.js";import{h as ut,c as ht,i as pt,l as mt,m as vt,r as ft,b as gt,a as yt,f as bt,t as wt,d as kt,w as xt}from"./tree-3ccd4e65.js";import{c as Mt,x as Ct,y as Pt,a as Nt,p as Tt,l as St,s as _t,b as It,d as Ot}from"./axis-de48d5f2.js";import{B as At}from"./Board-0ecb6fca.js";import{p as Et,m as Bt,d as Gt,s as zt}from"./chess-a4e99343.js";import{v as Dt}from"./vibrate-2d0ad158.js";import{S as jt}from"./index-c70fdca8.js";import{s as Ut,a as $t}from"./studyXhr-058f9d1a.js";function Ft(t,a){return e(`/${t}/${a}/analysis`)}function Wt(e){return void 0!==e.url}var Lt={controller(e){let t=!1;function a(e){"backbutton"!==e&&t&&n.backbutton.stack.pop(),t=!1,s.showShareMenu=!1}const s={showShareMenu:!1,computingPGN:!1,computingPGNAnnotated:!1};return{open:function(){n.backbutton.stack.push(a),t=!0},close:a,isOpen:()=>t,root:e,s:s}},view:e=>a("analyse_menu",void 0,(()=>e.s.showShareMenu?function(e){return s("div.analyseMenu",s.fragment({key:"shareMenu"},[Wt(e.data)?s("button",{oncreate:i((()=>{e.menu.close(),jt.share({url:Ve(e.data)})}))},[o("shareGameUrl")]):null,"offline"===e.source?s("button",{oncreate:i((()=>{!function(e){if(!e.menu.s.computingPGN){e.menu.s.computingPGN=!0;const t=e.tree.lastNode(),a="white"===e.data.player.color?"offline_ai"===e.data.game.id?u.appUser("Anonymous"):"Anonymous":"offline_ai"===e.data.game.id?e.data.opponent.username:"Anonymous",n="black"===e.data.player.color?"offline_ai"===e.data.game.id?u.appUser("Anonymous"):"Anonymous":"offline_ai"===e.data.game.id?e.data.opponent.username:"Anonymous";Et({variant:e.data.game.variant.key,initialFen:e.data.game.initialFen,pgnMoves:t.pgnMoves||[],white:a,black:n}).then((t=>{e.menu.s.computingPGN=!1,e.menu.close(),c(),jt.share({text:t.pgn})})).catch((t=>{e.menu.s.computingPGN=!1,c()}))}}(e)}))},e.menu.s.computingPGN?l.getVdom("monochrome"):[o("sharePgn")]):null,"online"!==e.source||He(e.data)?null:s("button",{oncreate:i((()=>{Rt(e,!1)}))},e.menu.s.computingPGNAnnotated?l.getVdom("monochrome"):"Share annotated PGN"),"online"!==e.source||He(e.data)?null:s("button",{oncreate:i((()=>{Rt(e,!0)}))},e.menu.s.computingPGN?l.getVdom("monochrome"):"Share raw PGN"),Wt(e.data)?s("button",{oncreate:i((()=>{e.menu.close(),jt.share({url:Je(e.data)})}))},["Share game GIF"]):null,e.isOfflineOrNotPlayable()?s("button",{oncreate:i((()=>{e.menu.close(),jt.share({text:e.node.fen})}))},"Share current FEN"):null]))}(e.root):function(e){return s("div.analyseMenu",s.fragment({key:"analyseMenu"},[s("button",{oncreate:i((()=>{e.menu.s.showShareMenu=!0}))},[s("span.fa.fa-share"),o("shareAndExport")]),e.isOfflineOrNotPlayable()?s("button[data-icon=U]",{oncreate:i((()=>{e.menu.close(),e.continuePopup.open(e.node.fen,e.data.game.variant.key,e.data.player.color)}))},o("continueFromHere")):null,e.isOfflineOrNotPlayable()?s("button",{oncreate:i((()=>n.set(`/editor/${encodeURIComponent(e.node.fen)}`)))},[s("span.fa.fa-pencil"),o("boardEditor")]):null,e.data.analysis?s("button",{oncreate:i((()=>{e.menu.close(),e.toggleRetro()})),disabled:!!e.retro},[s("span.fa.fa-play"),o("learnFromYourMistakes")]):null,e.ceval.allowed?s("button",{oncreate:i((()=>{e.menu.close(),e.togglePractice()}))},[s("span.fa.fa-bullseye"),o("practiceWithComputer")]):null,e.ceval.allowed?s("button",{className:r({on:e.showThreat}),oncreate:i((()=>{e.menu.close(),e.toggleShowThreat()}))},[s("span.fa.fa-crosshairs"),o("showThreat")]):null,e.notes?s("button",{oncreate:i((()=>{e.notes&&(e.menu.close(),e.notes.open())}))},[s("span.fa.fa-pencil"),o("notes")]):null]))}(e.root)),e.isOpen(),e.close)};function Rt(e,t){(t&&!e.menu.s.computingPGN||!t&&!e.menu.s.computingPGNAnnotated)&&(t?e.menu.s.computingPGN=!0:e.menu.s.computingPGNAnnotated=!0,Ge(e.data.game.id,t).then((t=>{e.menu.s.computingPGN=!1,e.menu.s.computingPGNAnnotated=!1,e.menu.close(),c(),jt.share({text:t})})).catch((t=>{e.menu.s.computingPGN=!1,e.menu.s.computingPGNAnnotated=!1,c(),d(t)})))}function qt(e){(function(){const e="light"===h.general.theme.background()?"shepherd-theme-dark":"shepherd-theme-default";return p(`vendor/shepherd/css/${e}.css`).then((()=>p("vendor/shepherd/css/shepherd.css"))).then((()=>m("vendor/shepherd/js/tether.js"))).then((()=>m("vendor/shepherd/js/shepherd.min.js"))).then((()=>e))})().then((t=>{const a=new window.Shepherd.Tour({defaults:{classes:"shepherd-element "+t,showCancelLink:!0}});a.addStep("welcome",{title:"Welcome to lichess study!",text:"This is a shared analysis board.<br><br>Use it to analyse games,<br>discuss positions with friends,<br>and of course for chess lessons!"}),a.addStep("members",{title:"Study members",text:"<i data-icon='v'></i> Spectators can view the study and talk in the chat.<br><br><i class='fa fa-user'></i> Contributors can make moves and update the study.<br><br>Studies are for now read-only in the application, so you must go to lichess.org to contribute to them. More features will come later in lichess app.",when:{"before-show":()=>{e.sideMenu.open()}}}),a.addStep("chapters",{title:"Study chapters",text:"A study can contain several chapters.<br>Each chapter has a distinct initial position and move tree.",when:{"before-show":()=>{e.sideMenu.open()}},buttons:[{text:"Done",action:a.next}]}),a.start()}))}var Ht={controller(e){let t=!1;const a={showShareMenu:!1,loadingStudyPGN:!1,loadingChapterPGN:!1};function s(e){"backbutton"!==e&&t&&n.backbutton.stack.pop(),t=!1,a.showShareMenu=!1}return{open:function(){n.backbutton.stack.push(s),t=!0},close:s,isOpen:()=>t,root:e,s:a}},view:e=>a("analyse_menu",void 0,(()=>e.s.showShareMenu?function(e){function t(t){e.study.actionMenu.s.loadingChapterPGN=!1,e.study.actionMenu.s.loadingStudyPGN=!1,c(),jt.share({text:t})}function a(t){e.study.actionMenu.s.loadingChapterPGN=!1,e.study.actionMenu.s.loadingStudyPGN=!1,c(),d(t)}return s("div.analyseMenu",{key:"shareMenu"},[s("button",{oncreate:i((()=>{const t=Vt+`study/${e.study.data.id}`;jt.share({url:t})}))},[o("studyUrl")]),s("button",{oncreate:i((()=>{const t=Vt+`study/${e.study.data.id}/${e.study.data.chapter.id}`;jt.share({url:t})}))},[o("currentChapterUrl")]),s("button",{oncreate:i((()=>{e.study.actionMenu.s.loadingStudyPGN=!0,Ut(e.study.data.id).then(t).catch(a)}))},e.study.actionMenu.s.loadingStudyPGN?l.getVdom("monochrome"):[o("studyPgn")]),s("button",{oncreate:i((()=>{e.study.actionMenu.s.loadingChapterPGN=!0,$t(e.study.data.id,e.study.data.chapter.id).then(t).catch(a)}))},e.study.actionMenu.s.loadingChapterPGN?l.getVdom("monochrome"):[o("chapterPgn")])])}(e.root):function(e){return s("div.analyseMenu",{key:"studyMenu"},[s("button",{oncreate:i((()=>{e.study.actionMenu.s.showShareMenu=!0}))},[s("span.fa.fa-share"),o("shareAndExport")]),s("button",{oncreate:i(e.study.toggleLike)},[s.trust("&nbsp;"),s("span.fa",{className:e.study.data.liked?"fa-heart":"fa-heart-o"}),`Like (${e.study.data.likes})`]),e.study&&e.study.chat?s("button[data-icon=B]",{oncreate:i(e.settings.flip)},o("flipBoard")):null,s("button[data-icon=U]",{oncreate:i((()=>{e.menu.close(),e.continuePopup.open(e.node.fen,e.data.game.variant.key,e.data.player.color)}))},o("continueFromHere")),e.ceval.allowed?s("button",{oncreate:i((()=>{e.menu.close(),e.togglePractice()}))},[s("span.fa.fa-bullseye"),o("practiceWithComputer")]):null,s("button",{oncreate:i((()=>n.set(`/editor/${encodeURIComponent(e.node.fen)}`)))},[s("span.fa.fa-pencil"),o("boardEditor")]),s("button",{oncreate:i((()=>{e.study.actionMenu.close(),qt(e.study)}))},[s("span.fa.fa-question-circle"),"Help"])])}(e.root)),e.isOpen(),e.close)};const Vt="https://lichess.org/";const Jt={view:({attrs:{text:e}})=>e.split("\n").map((e=>s.fragment({},[s.trust(qe(e)),s("br")])))};var Xt={controller(e){let t=!1,a=h.analyse.cevalCores(),s=h.analyse.cevalHashSize(),i=h.analyse.cevalUseNNUE();function o(e){"backbutton"!==e&&t&&n.backbutton.stack.pop(),t=!1,h.analyse.cevalCores()===a&&h.analyse.cevalHashSize()===s&&h.analyse.cevalUseNNUE()===i||n.reload()}const r={smallBoard:h.analyse.smallBoard(),showBestMove:h.analyse.showBestMove(),showComments:h.analyse.showComments(),flip:!1};return{root:e,open:function(){n.backbutton.stack.push(o),a=h.analyse.cevalCores(),s=h.analyse.cevalHashSize(),i=h.analyse.cevalUseNNUE(),t=!0},close:o,isOpen:()=>t,s:r,toggleBoardSize(){const e=!r.smallBoard;h.analyse.smallBoard(e),r.smallBoard=e},toggleBestMove(){const e=!r.showBestMove;r.showBestMove=e},toggleComments(){const e=!r.showComments;r.showComments=e},flip(){r.flip=!r.flip,e.chessground.set({orientation:r.flip?v(e.orientation):e.orientation}),e.retro&&e.toggleRetro(),e.practice&&e.restartPractice()},cevalSetMultiPv(t){h.analyse.cevalMultiPvs(t),e.ceval.setMultiPv(t)},cevalToggleInfinite(){e.ceval.toggleInfinite()}}},view:e=>a("analyse_menu",void 0,(()=>function(e){const t=f(),a=window.deviceInfo.stockfishMaxMemory;return s("div.analyseSettings",[s("div.action",{className:!e.ceval.allowed||e.retro?"disabled":""},[g.renderCheckbox(o("toggleLocalEvaluation"),"allowCeval",h.analyse.enableCeval,(t=>{e.ceval.toggle(),t?e.initCeval():(e.ceval.destroy(),e.resetTabs(),e.retro&&(e.retro.close(),e.retro=null))}),!e.ceval.allowed||!!e.retro),s("small.caution",o("localEvalCaution"))]),e.study||e.ceval.allowed?s("div.action",[g.renderCheckbox(o("bestMoveArrow"),"showBestMove",h.analyse.showBestMove,e.settings.toggleBestMove)]):null,e.study||"online"===e.source&&Wt(e.data)&&Xe(e.data)?s("div.action",[g.renderCheckbox(o("keyShowOrHideComments"),"showComments",h.analyse.showComments,e.settings.toggleComments)]):null,s("div.action",[g.renderCheckbox(o("infiniteAnalysis"),"ceval.infinite",h.analyse.cevalInfinite,e.settings.cevalToggleInfinite,!e.ceval.allowed)]),y()?s("div.action",[g.renderCheckbox(o("Use NNUE"),"ceval.useNNUE",h.analyse.cevalUseNNUE,void 0,!e.ceval.allowed)]):null,s("div.action",[g.renderSlider(o("multipleLines"),"ceval.multipv",1,5,1,h.analyse.cevalMultiPvs,e.settings.cevalSetMultiPv,!e.ceval.allowed)]),t>1?s("div.action",[g.renderSlider(o("cpus"),"ceval.cores",1,t,1,h.analyse.cevalCores,void 0,!e.ceval.allowed)]):null,a>32?s("div.action",[g.renderSlider(o("memory"),"ceval.hashSize",16,a,16,h.analyse.cevalHashSize,void 0,!e.ceval.allowed)]):null])}(e.root)),e.isOpen(),e.close)};function Kt(e,t){let a="";if(b(t))"pawn"!==t.role&&(a=w(t.role).toUpperCase()),a+="@"+k(t.to);else{const n=e.board.getRole(t.from);if(!n)return"--";if("king"!==n||!e.board[e.turn].has(t.to)&&2!==Math.abs(t.to-t.from)){const s=e.board.occupied.has(t.to)||"pawn"===n&&x(t.from)!==x(t.to);if("pawn"!==n){let s;if(a=w(n).toUpperCase(),s="king"===n?Ne(t.to).intersect(e.board.king):"queen"===n?Te(t.to,e.board.occupied).intersect(e.board.queen):"rook"===n?Se(t.to,e.board.occupied).intersect(e.board.rook):"bishop"===n?_e(t.to,e.board.occupied).intersect(e.board.bishop):Ie(t.to).intersect(e.board.knight),s=s.intersect(e.board[e.turn]).without(t.from),s.nonEmpty()){const n=e.ctx();for(const a of s)e.dests(a,n).has(t.to)||(s=s.without(a));if(s.nonEmpty()){let e=!1,n=s.intersects(M.fromRank(C(t.from)));s.intersects(M.fromFile(x(t.from)))?e=!0:n=!0,n&&(a+=P[x(t.from)]),e&&(a+=N[C(t.from)])}}}else s&&(a=P[x(t.from)]);s&&(a+="x"),a+=k(t.to),t.promotion&&(a+="="+w(t.promotion).toUpperCase())}else a=t.to>t.from?"O-O":"O-O-O"}return a}function Yt(e,t){return function(e,t){var a;const n=Kt(e,t);return e.play(t),(null===(a=e.outcome())||void 0===a?void 0:a.winner)?n+"#":e.isCheck()?n+"+":n}(e.clone(),t)}function Qt(e){switch(e){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return e}}function Zt(e){const t=e.node,a=t.threat||t.ceval,n=h.analyse.cevalInfinite();return a?s("div.analyse-fixedBar.ceval-infos",{className:a.cloud?"cloud":""},[s("div.depth",[s("span",o("depthX",a.depth+(n||void 0===a.maxDepth?"":`/${a.maxDepth}`))),e.ceval.canGoDeeper()?s("button.fa.fa-plus-square",{oncreate:i(e.ceval.goDeeper,(()=>{T.show({text:o("goDeeper"),position:"center",duration:"short"})}))}):null]),void 0!==a.millis?s("div.time",[o("time")," ",ea(a.millis)]):null,void 0!==a.knps?s("div.knps",["kn/s ",Math.round(a.knps)]):null,a.cloud?s("span.ceval-cloud","Cloud"):null]):null}function ea(e){const t=Math.round(e/1e3);if(t<60)return t+"s";return`${Math.round(t/60)}min ${t%60}s`}function ta(e){const t=e.ceval.getMultiPv(),a=e.node,n=a.threat||a.ceval;if(n&&!e.gameOver()){const i=n.pvs;return s("ul.ceval-pv_box.native_scroller",{oncreate:I((t=>function(e,t){const a=O(t),n=a&&a.dataset.uci;!e.showThreat&&n&&e.playUci(n)}(e,t)),void 0,O)},[...Array(t).keys()].map((t=>{if(!i[t])return s("li.pv");const n=Oe(Qt(e.ceval.variant),S(a.fen).unwrap());return s("li.ceval-pv",{"data-uci":i[t].moves[0],className:t%2==0?"even":"odd"},[s("strong.ceval-pv_eval",void 0!==i[t].mate?"#"+i[t].mate:Ke(i[t].cp)),s("div.ceval-pv-line",n.unwrap((e=>function(e,t){var a;e=e.clone();const n=[];for(let s=0;s<t.length;s++){0!==s&&n.push(" "),"white"===e.turn?n.push(e.fullmoves,". "):0===s&&n.push(e.fullmoves,"... ");const i=Kt(e,t[s]);if(e.play(t[s]),n.push(i),"--"===i)return n.join("");s===t.length-1&&(null===(a=e.outcome())||void 0===a?void 0:a.winner)?n.push("#"):e.isCheck()&&n.push("+")}return n.join("")}(e,i[t].moves.slice(0,12).map((e=>_(e))))),(e=>"--")))])})))}return e.gameOver()?s("div.ceval-pv_box.native_scroller.loading.gameOver",[s("i.withIcon[data-icon=]"),o("gameOver")]):s("div.ceval-pv_box.native_scroller.loading",na())}const aa={onbeforeupdate:({attrs:e})=>!e.ctrl.replaying,view({attrs:e}){const{ctrl:t}=e,a=t.node,n=t.showThreat&&t.node.threat||Ye({client:a.ceval,server:a.eval});if(!t.ceval.enabled()&&!n)return null;let i;return i=n&&void 0!==n.cp?Ke(n.cp):n&&void 0!==n.mate?"#"+n.mate:t.gameOver()?"-":t.replaying?"":na(),s("div",{className:"ceval-curEval"},i)}};function na(){return s("div.spinner.fa.fa-hourglass-half")}var sa={controller(e,t){const a=["lichess"];"standard"!==e.key&&"fromPosition"!==e.key||a.push("masters");const s=E(!1),i={db:{available:a,selected:a.length>1?h.analyse.explorer.db:function(){return a[0]}},rating:{available:h.analyse.explorer.availableRatings,selected:h.analyse.explorer.rating},speed:{available:h.analyse.explorer.availableSpeeds,selected:h.analyse.explorer.speed}};let o;function r(){return JSON.stringify([i.db.selected(),i.rating.selected(),i.speed.selected()])}function l(e){"backbutton"!==e&&s()&&n.backbutton.stack.pop(),s(!1),t(o!==r())}function c(e,t){-1===e().indexOf(t)?e(e().concat([t])):e().length>1&&e(e().filter((e=>e!==t)))}return{open:s,data:i,toggleOpen(){s()?l():(n.backbutton.stack.push(l),o=r(),s(!0))},toggleDb(e){i.db.selected(e)},toggleRating:e=>c(i.rating.selected,e),toggleSpeed:e=>c(i.speed.selected,e),fullHouse:()=>"masters"===i.db.selected()||i.rating.selected().length===i.rating.available.length&&i.speed.selected().length===i.speed.available.length,serialize:r}},view(e){const t=e.data;return[s("section.db",[s("label",o("database")),s("div.form-multipleChoice",t.db.available.map((a=>s("div",{className:t.db.selected()===a?"selected":"",oncreate:A((()=>e.toggleDb(a)))},a))))]),"masters"===t.db.selected()?s("div.masters.message",[s("i[data-icon=C]"),s("p",o("masterDbExplanation","2200","1952","2020"))]):s("div",[s("section.rating",[s("label",o("averageElo")),s("div.form-multipleChoice",t.rating.available.map((a=>s("div",{className:t.rating.selected().indexOf(a)>-1?"selected":"",oncreate:A((()=>e.toggleRating(a)))},a))))]),s("section.speed",[s("label",o("timeControl")),s("div.form-multipleChoice",t.speed.available.map((a=>s("div",{className:t.speed.selected().indexOf(a)>-1?"selected":"",oncreate:A((()=>e.toggleSpeed(a)))},a))))])]),s("section.save",s("button.text[data-icon=E]",{oncreate:A(e.toggleOpen)},o("allSet")))]}};function ia(e,t){return"loss"===t||"maybe-loss"===t||"blessed-loss"===t?e:"win"===t||"maybe-win"===t||"cursed-win"===t?v(e):void 0}const oa={onbeforeupdate:({attrs:e},{attrs:t})=>e.data!==t.data,view({attrs:e}){const{ctrl:t,data:a}=e,n=function(e,t){if(!t.length)return null;const a=h.game.pieceNotation();return s("table",{className:"moves",oncreate:I((t=>function(e,t){const a=la(t),n=a&&a.dataset.uci;n&&e.playUci(n)}(e,t)),void 0,la)},s("thead",null,s("tr",null,s("th",{className:"explorerMove-move"},o("move")),s("th",{className:"explorerMove-games"},o("games")),s("th",{className:"explorerMove-result"},o("whiteDrawBlack")))),s("tbody",{className:a?"displayPieces":""},t.map((e=>s("tr",{key:e.uci,"data-uci":e.uci},s("td",{className:"explorerMove-move"},"P"===e.san[0]?e.san.slice(1):e.san),s("td",{className:"explorerMove-games"},e.white+e.draws+e.black),s("td",{className:"explorerMove-result"},function(e){const t=e.white+e.draws+e.black;function a(a){const n=e[a],i=100*n/t,o=Math.round(1e3*n/t)/10+"%";return 0===i?null:s("span",{className:"explorerBar "+a,style:{width:o}},i>12?Math.round(i)+(i>20?"%":""):null)}return["white","draws","black"].map(a)}(e)))))))}(t,a.moves),i=ca(t,o("recentGames"),a.recentGames||[]),r=ca(t,o("topGames"),a.topGames||[]);return n||i||r?s("div",{className:"explorer-data"},n,r,i):ra(t)}};function ra(e){return s("div",{className:"explorer-data empty"},s("div",{className:"message"},s("h3",null,s("i",{className:"withIcon","data-icon":""}),o("noGameFound")),e.explorer.config.fullHouse()?null:s("p",null,o("maybeIncludeMoreGamesFromThePreferencesMenu"))))}function la(e){const t=e.target;return"TR"===t.tagName?t:t.closest("tr")}function ca(e,t,a){return e.explorer.withGames&&a.length?s("table",{className:"games",oncreate:I((t=>function(e,t){const a=e.chessground.state.orientation,s=la(t),i=s&&s.dataset.id;i&&"lichess"===e.explorer.config.data.db.selected()?n.set(`/analyse/online/${i}/${a}`):i&&B(i,a).then((e=>n.set(`/analyse/online/${e.game.id}/${a}`)))}(e,t)),void 0,la)},s("thead",null,s("tr",null,s("th",{colspan:"4"},t))),s("tbody",null,a.map((e=>{return s("tr",{key:e.id,"data-id":e.id},s("td",null,[e.white,e.black].map((e=>s("span",null,e.rating)))),s("td",null,[e.white,e.black].map((e=>s("span",null,e.name)))),s("td",null,"white"===(t=e.winner)?s("result",{className:"white"},"1-0"):"black"===t?s("result",{className:"black"},"0-1"):s("result",{className:"draws"},"½-½")),s("td",null,e.year));var t})))):null}function da(e){return"standard"===e.data.game.variant.key||"fromPosition"===e.data.game.variant.key?o("openingExplorer"):o("xOpeningExplorer",e.data.game.variant.name)}function ua(e,t,a,n){if(!a.length)return null;const i=function(e){return"w"===e.split(" ")[1]?"white":"black"}(n);return[s("div",{className:"title"},t),s("table",{className:"explorerTablebase",oncreate:I((t=>function(e,t){const a=la(t),n=a&&a.dataset.uci;n&&e.playUci(n)}(e,t)),void 0,la)},s("tbody",null,a.map((e=>s("tr",{"data-uci":e.uci,key:e.uci},s("td",null,e.san),s("td",null,function(e,t){if(t.checkmate)return s("result."+ia(e,t.category),o("checkmate"));if(t.stalemate)return s("result.draws",o("stalemate"));if(t.variant_win)return s("result."+ia(e,t.category),o("variantWin"));if(t.variant_loss)return s("result."+ia(e,t.category),o("variantLoss"));if(t.insufficient_material)return s("result.draws",o("insufficientMaterial"));if(null===t.dtz)return null;if(0===t.dtz)return s("result.draws",o("draw"));if(t.zeroing){const a=-1!==t.san.indexOf("x");return s("result."+ia(e,t.category),o(a?"capture":"pawnMove"))}return s("result."+ia(e,t.category),{title:o("dtzWithRounding")+" (Distance To Zeroing)"},"DTZ "+Math.abs(t.dtz))}(i,e),function(e,t){return t.dtm?s("result."+ia(e,t.category),{title:G("mateInXHalfMoves",Math.abs(t.dtm))},"DTM "+Math.abs(t.dtm)):null}(i,e)))))))]}function ha(e){return s("div.explorer-data.empty",[s("div.message",[s("h3",[s("i.withIcon[data-icon=]"),e])])])}function pa(e){return e.node.crazyhouse?s("div.analyse-crazyPockets",[ma(e),va(e)]):null}function ma(e){const t=e.node.crazyhouse;return t?s(ze,{ctrl:e,crazyData:t,color:e.orientation}):null}function va(e){const t=e.node.crazyhouse;return t?s(ze,{ctrl:e,crazyData:t,color:v(e.orientation)}):null}function fa(e){if(!e.contextMenu)return null;const t=e.contextMenu,n=e.tree.nodeAtPath(t),s=e.tree.pathIsMainline(t);return a("analyse-cm",(()=>Qe(n)),(()=>[s?null:ga("S",o("promoteVariation"),(()=>e.promote(t,!1))),s?null:ga("E",o("makeMainLine"),(()=>e.promote(t,!0))),ga("q",o("deleteFromHere"),(()=>e.deleteNode(t)))]),!0,(()=>{e.contextMenu=null,c()}))}function ga(e,t,a){return s("button.withIcon",{"data-icon":e,oncreate:I(a)},t)}const ya=6;function ba(e,t){return!e.ctrl.settings.s.showComments||Ze(t.comments)?[]:t.comments.map((t=>"lichess"!==t.by||e.showComputer?s("comment",s(Jt,{text:t.text})):null)).filter((e=>!!e))}function wa(e,t,a){const n=t.children,i=n[0];return i?a.isMainline?n[1]?ka(e,n,a)||[Na(e,i,{parentPath:a.parentPath,isMainline:!0,withIndex:a.withIndex}),ba(e,i),s("interrupt",xa(e,n.slice(1),{parentPath:a.parentPath,isMainline:!0})),wa(e,i,{parentPath:a.parentPath+i.id,isMainline:!0,withIndex:!0})||[]]:Ma(e,i,{parentPath:a.parentPath,isMainline:!0,withIndex:a.withIndex}):n[1]?ka(e,n,a)||[xa(e,n,a)]:Ma(e,i,a):null}function ka(e,t,a){return!t[1]||t[2]||ut(t[1],6)?null:Ma(e,t[0],{parentPath:a.parentPath,isMainline:a.isMainline,inline:t[1]})}function xa(e,t,a){return s("lines",t.map((t=>s("line",Ma(e,t,{parentPath:a.parentPath,isMainline:!1,withIndex:!0,truncate:t.comp&&!ht(e.ctrl.path,a.parentPath+t.id)?ya:void 0})))))}function Ma(e,t,a){const n=a.parentPath+t.id,i=ba(e,t);return 0===a.truncate?[s("move",{"data-path":n},"[...]")]:[Na(e,t,a)].concat(i).concat(a.inline?function(e,t,a){return s("inline",Ma(e,t,{withIndex:!0,parentPath:a.parentPath,isMainline:!1}))}(e,a.inline,a):null).concat(wa(e,t,{parentPath:n,isMainline:a.isMainline,truncate:a.truncate?a.truncate-1:void 0,withIndex:!!i[0]})||[])}function Ca(e,t,a){const n=e.ctrl,s=!n.study&&a===n.initialPath&&He(n.data),i=e.showGlyphs&&t.glyphs?t.glyphs.map((e=>e.id)):[];return{current:a===n.path,currentPlayable:s,nongame:!s&&!!n.gamePath&&ht(a,n.gamePath)&&a!==n.gamePath,inaccuracy:i.includes(6),mistake:i.includes(2),blunder:i.includes(4)}}function Pa(e,t){return s("index",function(e,t){return et(e)+(t?e%2==1?".":"...":"")}(e,t))}function Na(e,t,a){const n=a.parentPath+t.id,i=[a.withIndex||1&t.ply?Pa(t.ply,!0):null,z(t.san)];var o;return t.glyphs&&(o=t.glyphs,o.map((e=>s("glyph",e.symbol)))).forEach((e=>i.push(e))),s("move",{"data-path":n,className:r(Ca(e,t,n))},i)}var Ta={onbeforeupdate:({attrs:e})=>!e.ctrl.replaying,view({attrs:e}){const{ctrl:t,rightTabActive:a}=e,n=[h.game.pieceNotation()?"displayPieces":"",a?"rta":""].join(" ");return s("div#replay.analyse-replay.native_scroller",{className:n,oncreate:I((e=>function(e,t){const a=Sa(t);a&&a.dataset.path&&e.jump(a.dataset.path)}(t,e)),(e=>{const a=Sa(e),n=a.dataset;a&&n.path&&(t.contextMenu=n.path,c())}),Sa,!1)},function(e){const t=e.tree.root,a={ctrl:e,truncateComments:!1,showComputer:e.settings.s.showComments,showGlyphs:!0,showEval:!0},n=ba(a,t);return s("div.analyse-moveList",{className:"ios"===window.deviceInfo.platform?"ios":""},[n,wa(a,t,{parentPath:"",isMainline:!0})||[]])}(t))}};function Sa(e){const t=e.target;return"MOVE"===t.tagName?t:D(t,"move")}function _a(e){return s("eval",e)}function Ia(e,t){return function(e){return Math.floor((e-1)/2)+1}(e)+(t?e%2==1?".":"...":"")}function Oa(e,t){const a=Ye({client:t.ceval,server:t.eval})||{};return[s("san",z(t.san))].concat(t.glyphs&&e.showGlyphs?(n=t.glyphs,n.map((e=>s("glyph",{title:e.name},e.symbol)))):[]).concat(e.showEval?void 0!==a.cp?[_a(Ke(a.cp))]:void 0!==a.mate?[_a("#"+a.mate)]:[]:[]);var n}function Aa(e,t){return t.uci?[(a=t.ply,n=e.withDots,s("index",Ia(a,n)))].concat(Oa(e,t)):[s("span.init","Initial position")];var a,n}function Ea(e){const t=e.retro;if(!t)return;const a=t.vm.feedback;return s("div.analyse-training_box.analyse-retro_box.box",{className:t.vm.minimized?"minimized":""},[ja(t),s("div.analyse-training_feedback.native_scroller."+a,Da(e,a))])}function Ba(e){return s("div.choices",[s("button",{oncreate:i(e.viewSolution)},o("viewTheSolution")),s("button",{oncreate:i(e.nextMistake)},o("skipThisMove"))])}function Ga(e){return s("div.li-button.retro-half.retro-continue",{oncreate:i(e.nextMistake)},[s("i[data-icon=G]"),o("next")])}const za={find:e=>[s("div.analyse-training_player",[s("div.piece-no-square",{className:e.pieceTheme},s("piece.king."+e.vm.color)),s("div.retro-instruction",[s("strong",[j("xWasPlayed",s("span",Aa({withDots:!0,showGlyphs:!0,showEval:!1},e.vm.current.fault.node)))]),s("em",o("white"===e.vm.color?"findBetterMoveForWhite":"findBetterMoveForBlack")),Ba(e)])])],offTrack:e=>[s("div.analyse-training_player",[s("div.retro-icon.off","!"),s("div.retro-instruction",[s("strong","You browsed away"),s("div.choices.off",[s("button",{oncreate:i(e.jumpToCurrent)},"Resume learning")])])])],fail:e=>[s("div.analyse-training_player",[s("div.retro-icon","✗"),s("div.retro-instruction",[s("strong",o("youCanDoBetter")),s("em",o("white"===e.vm.color?"tryAnotherMoveForWhite":"tryAnotherMoveForBlack")),Ba(e)])])],win:e=>[s("div.retro-half.top",s("div.analyse-training_player",[s("div.retro-icon","✓"),s("div.retro-instruction",s("strong",o("goodMove")))])),Ga(e)],view:e=>[s("div.retro-half.top",s("div.analyse-training_player",[s("div.retro-icon","✓"),s("div.retro-instruction",[s("strong",o("solution")),s("em",[s("strong",Aa({withDots:!0,showEval:!1},e.vm.current.solution.node))])])])),Ga(e)],eval(e){return[s("div.retro-half.top",s("div.analyse-training_player.center",[s("div.retro-instruction",[s("strong",o("evaluatingYourMove")),(t=e.node(),s("div.analyse-training_progress",s("div",{style:{width:`${t.ceval?100*Math.max(0,t.ceval.depth-8)/10+"%":0}`}})))])]))];var t},end(e,t){if(!t())return[s("div.retro-half.top",s("div.analyse-training_player",[s("div.retro-icon",l.getVdom()),s("div.retro-instruction",o("waitingForAnalysis"))]))];const a=!e.completion()[1];return[s("div.analyse-training_player",[s("div.piece-no-square",{className:e.pieceTheme},s("piece.king."+e.vm.color)),s("div.retro-instruction",[s("em",o(a?"white"===e.vm.color?"noMistakesFoundForWhite":"noMistakesFoundForBlack":"white"===e.vm.color?"doneReviewingWhiteMistakes":"doneReviewingBlackMistakes")),s("div.choices.end",[a?null:s("button",{oncreate:i(e.reset)},o("doItAgain")),s("button",{oncreate:i(e.flip)},o("white"===e.vm.color?"reviewBlackMistakes":"reviewWhiteMistakes"))])])])]}};function Da(e,t){const a=e.retro,n=a.vm.current;return a.isSolving()&&n&&e.path!==n.prev.path?za.offTrack(a):"find"===t?n?za.find(a):za.end(a,e.hasFullComputerAnalysis):za[t](a)}function ja(e){const t=e.completion();return s("div.titleWrapper",[s("div.title",o("learnFromYourMistakes")),s("div.mistakeNb",Math.min(t[0]+1,t[1])+" / "+t[1]),s("div.actions",[s("button.window-button",{oncreate:i(e.toggleWindow)},s("span.fa",{className:e.vm.minimized?"fa-window-maximize":"fa-window-minimize"})),s("button.window-button",{oncreate:i(e.close)},s("span.fa.fa-window-close"))])])}function Ua(e,t){return e.best?j("goodMove"===e.verdict?"anotherWasX":"bestWasX",s("move",{oncreate:i(t.playCommentBest)},e.best.san)):[]}function $a(e){return s("div.analyse-training_player.off",[s("div.icon.off","!"),s("div.analyse-training_box_instruction",[s("strong",o("youBrowsedAway")),s("div.choices",[s("button",{oncreate:i(e.resume)},o("resumePractice"))])])])}function Fa(e,t,a){const n="checkmate"===a,i=n?v(e.turnColor()):e.turnColor();return s("div.analyse-training_player",[i?s("div.piece-no-square",{className:t.pieceTheme},s("piece.king."+i)):s("div.icon.off","!"),s("div.analyse-training_box_instruction",[s("strong",o(a)),s("em",n?s("color",o("white"===i?"whiteWinsGame":"blackWinsGame")):o("theGameIsADraw"))])])}const Wa=8;function La(e,t){const a=e.ceval?100*Math.max(0,e.ceval.depth-Wa)/(t-Wa)+"%":0;return s("div.analyse-training_progress",s("div",{style:`width: ${a}`}))}function Ra(e,t){const a=t.hinting();return s("div.analyse-training_player.running",[s("div.piece-no-square",{className:t.pieceTheme},s("piece.king."+e.turnColor())),s("div.analyse-training_box_instruction",(t.isMyTurn()?[s("strong",o("yourTurn"))]:[s("strong",o("computerThinking")),La(t.currentNode(),t.playableDepth())]).concat(s("div.choices",[t.isMyTurn()?s("button",{oncreate:i(t.hint)},o(a?"piece"===a.mode?"seeBestMove":"hideBestMove":"getAHint")):""])))])}function qa(e,t){return s("div.titleWrapper",[s("div.title",o("practiceWithComputer")),s("div.actions",[s("button.window-button",{oncreate:i(t.toggleWindow)},s("span.fa",{className:t.minimized()?"fa-window-maximize":"fa-window-minimize"})),s("button.window-button",{oncreate:i(e.togglePractice)},s("span.fa.fa-window-close"))])])}function Ha(e){const t=e.practice;if(!t)return;const a=t.comment(),n=t.running(),i=t.currentNode().threefold?"threefoldRepetition":e.gameOver();return s("div.analyse-practice_box.analyse-training_box.box."+(a?a.verdict:"no-verdict"),{className:t.minimized()?"minimized":""},[qa(e,t),s("div.analyse-training_feedback.native_scroller",n?i?Fa(e,t,i):Ra(e,t):$a(t)),n?s("div.comment",a?[s("span.verdict",o(a.verdict))," "].concat(Ua(a,t)):[t.isMyTurn()||i?"":s("span.wait",o("evaluatingYourMove"))]):n?s("div.comment"):null])}function Va(e,t){const a=e.chapter.tags.find((e=>e[0].toLowerCase()===t));return a&&a[1]}function Ja(){var e=Ct,t=null,a=Mt(0),n=Pt,s=Mt(!0),i=null,o=Nt,r=null;function l(l){var c,d,u,h,p,m=l.length,v=!1,f=new Array(m),g=new Array(m);for(null==i&&(r=o(p=Tt())),c=0;c<=m;++c){if(!(c<m&&s(h=l[c],c,l))===v)if(v=!v)d=c,r.areaStart(),r.lineStart();else{for(r.lineEnd(),r.lineStart(),u=c-1;u>=d;--u)r.point(f[u],g[u]);r.lineEnd(),r.areaEnd()}v&&(f[c]=+e(h,c,l),g[c]=+a(h,c,l),r.point(t?+t(h,c,l):f[c],n?+n(h,c,l):g[c]))}if(p)return r=null,p+""||null}function c(){return St().defined(s).curve(o).context(i)}return l.x=function(a){return arguments.length?(e="function"==typeof a?a:Mt(+a),t=null,l):e},l.x0=function(t){return arguments.length?(e="function"==typeof t?t:Mt(+t),l):e},l.x1=function(e){return arguments.length?(t=null==e?null:"function"==typeof e?e:Mt(+e),l):t},l.y=function(e){return arguments.length?(a="function"==typeof e?e:Mt(+e),n=null,l):a},l.y0=function(e){return arguments.length?(a="function"==typeof e?e:Mt(+e),l):a},l.y1=function(e){return arguments.length?(n=null==e?null:"function"==typeof e?e:Mt(+e),l):n},l.lineX0=l.lineY0=function(){return c().x(e).y(a)},l.lineY1=function(){return c().x(e).y(n)},l.lineX1=function(){return c().x(t).y(a)},l.defined=function(e){return arguments.length?(s="function"==typeof e?e:Mt(!!e),l):s},l.curve=function(e){return arguments.length?(o=e,null!=i&&(r=o(i)),l):o},l.context=function(e){return arguments.length?(null==e?i=r=null:r=o(i=e),l):i},l}function Xa(e,t,a){const n=t.game.division,s=e.getBoundingClientRect(),i=_t(e).append("svg").attr("viewBox",`0 0 ${s.width} ${s.height}`),r=(l=t).treeParts.slice(1).reduce(((e,t)=>{const a=1&t.ply;let n;if(t.eval&&t.eval.mate)n=t.eval.mate>0?1/0:-1/0;else if(t.san&&t.san.indexOf("#")>0)n=1===a?1/0:-1/0,"antichess"===l.game.variant.key&&(n=-n);else{if(!t.eval||void 0===t.eval.cp)return e;n=t.eval.cp}const s={acpl:2/(1+Math.exp(-.004*n))-1};return e.concat([s])}),[]);var l;const c=10,d=10,u=10,h=10,p=s.width-h-d,m=s.height-c-u,v=i.append("g").attr("transform","translate("+h+","+c+")");function f(e,t){v.append("line").attr("class","division "+t).attr("x1",e).attr("x2",e).attr("y1",w(-1)).attr("y2",w(1)),v.append("text").attr("class","chart-legend").attr("transform","rotate(90)").attr("y",-e).attr("dy","-0.4em").text(o(t))}const g=t.treeParts[0].ply||0;function y(e){if(v.selectAll(".dot").remove(),null!==e){const t=e-1-g,a=r[t];a&&v.append("circle").attr("class","dot").attr("cx",b(t)).attr("cy",w(a.acpl)).attr("r",3)}}const b=It().domain([0,r.length]).rangeRound([0,p]),w=It().domain([-1,1]).rangeRound([m,0]),k=Ja().x(((e,t)=>b(t))).y((e=>w(e.acpl))),x=Ja().x(((e,t)=>b(t))).y1((e=>e.acpl>=0?w(e.acpl):w(0)));return v.datum(r),v.append("line").attr("class","zeroline").attr("x1",0).attr("x2",p).attr("y1",w(0)).attr("y2",w(0)),v.append("clipPath").attr("id","clip-below").append("path").attr("d",x.y0((e=>w(e.acpl)))),v.append("clipPath").attr("id","clip-above").append("path").attr("d",x.y0(w(0))),v.append("path").attr("class","area above").attr("clip-path","url(#clip-above)").attr("d",x),v.append("path").attr("class","area below").attr("clip-path","url(#clip-below)").attr("d",x.y0((e=>e.acpl<=0?w(e.acpl):w(0)))),v.append("path").attr("class","line").attr("d",k),n&&(n.middle||n.end)&&(f(b(0),"opening"),n.middle&&f(b(n.middle),"middlegame"),n.end&&f(b(n.end),"endgame")),y(a),y}function Ka(e,t,a,n){const s=t.game.division,i=e.getBoundingClientRect(),r=_t(e).append("svg").attr("viewBox",`0 0 ${i.width} ${i.height}`),l=10,c=10,d=10,u=25,h=i.width-u-c,p=i.height-l-d,m=r.append("g").attr("transform","translate("+u+","+l+")"),{max:v,series:f}=function(e,t){const a={white:[],black:[]},n=e.treeParts,s=Math.pow(Math.log(3),2);let i=0,o=0;return t.forEach(((e,t)=>{const r=n[t+1];i=r?r.ply:i+1;const l=!!(1&i),c=Math.pow(Math.log(.005*Math.min(e,12e4)+3),2)-s;o=Math.max(c,o);const d={ply:i,y:l?c:-c};l?a.white.push(d):a.black.push(d)})),{max:o,series:a}}(t,a);function g(e,t){m.append("line").attr("class","division "+t).attr("x1",e).attr("x2",e).attr("y1",w(-v)).attr("y2",w(v)),m.append("text").attr("class","chart-legend").attr("transform","rotate(90)").attr("y",-e).attr("dy","-0.4em").text(o(t))}function y(e){if(m.selectAll(".dot").remove(),null!==e){const t=!!(1&e)?f.white.find((t=>t.ply===e)):f.black.find((t=>t.ply===e));t&&m.append("circle").attr("class","dot").attr("cx",b(e)).attr("cy",w(t.y)).attr("r",3)}}const b=It().domain([0,f.white.length+f.black.length]).rangeRound([0,h]),w=It().domain([-v,v]).rangeRound([p,0]),k=Ja().x((e=>b(e.ply))).y((e=>w(e.y))),x=Ja().x((e=>b(e.ply))).y0(w(0)).y1((e=>w(e.y))),M=Math.max(...a)/100,C=It().domain([-M,M]).rangeRound([p,0]),P=Ot(C).tickFormat((e=>String(Math.abs(e))));return m.append("g").call(P).append("text").attr("class","legend").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("text-anchor","end").text("Seconds"),m.append("path").datum(f.white).attr("class","area above").attr("d",x),m.append("path").datum(f.black).attr("class","area below").attr("d",x),m.append("path").attr("class","line").datum(f.white).attr("d",k),m.append("path").attr("class","line").datum(f.black).attr("d",k),s&&(s.middle||s.end)&&(s.middle&&g(b(s.middle),"middlegame"),s.end&&g(b(s.end),"endgame")),y(n),y}function Ya(e){return s("div.analyse-computerAnalysis",[s("strong.title",o("computerAnalysis")),e.analysisProgress?s("div.analyse-gameAnalysis_chartPlaceholder",l.getVdom("monochrome")):s("div.analyse-chart",{oncreate({dom:t}){U((()=>{this.updateCurPly=Xa(t,e.data,e.node.ply)}))},onupdate({dom:t}){this.updateCurPly?U((()=>{this.updateCurPly(e.onMainline?e.node.ply:null)})):U((()=>{const a=t;for(;a.lastElementChild;)a.removeChild(a.lastElementChild);this.updateCurPly=Xa(a,e.data,e.node.ply)}))}}),s(Qa,{d:e.data,analysis:e.data.analysis,study:e.study&&e.study.data})])}const Qa={onbeforeupdate:({attrs:e},{attrs:t})=>!$(e.analysis,t.analysis),view({attrs:e}){const{d:t,analysis:a,study:n}=e;return s("div.analyse-evalSummary",["white","black"].map((e=>{const i=tt(t,e),r=n?Va(n,e)||"Anonymous":F(i);return s("div.analyse-evalSummary__side",[s("div.analyse-evalSummary__player",[s("span.color-icon."+e),s("span",[r,i?W(i):null])]),s("div",[an.map((t=>{const n=a&&a[e][t[0]];return s("div.analyse-evalSummary__summary",[s.trust(G(t[1],n,`<strong>${n}</strong>`))])})),s("div.analyse-evalSummary__summary",[s("strong",a&&a[e].acpl),s("span",o("averageCentipawnLoss"))])])])})))}};function Za(e){return s("div.analyse-computerAnalysis.request",[e.analysisProgress?s("div.analyse-requestProgress",[s("span",o("waitingForAnalysis")),l.getVdom("monochrome")]):s("button.fatButton",{oncreate:I((()=>{return(a=e.data.game.id,t(`/${a}/request-analysis`,{method:"POST"},!0)).then((()=>{e.analysisProgress=!0,c()})).catch(d);var a}))},[o("requestAComputerAnalysis")])])}function en(e){return s("div.analyse-computerAnalysis.request",e.mainline.length<5?s("p","The study is too short to be analysed."):e.study.canContribute()?[s("p",["Get a full server-side computer analysis of the main line.",s("br"),"Make sure the chapter is complete, for you can only request analysis once."]),e.analysisProgress?s("div.analyse-requestProgress",[s("span",o("waitingForAnalysis")),l.getVdom("monochrome")]):s("button.fatButton",{oncreate:I((()=>{e.socket.send("requestAnalysis",e.study.data.chapter.id),e.analysisProgress=!0,c()}))},[o("requestAComputerAnalysis")])]:s("p","Only the study contributors can request a computer analysis"))}function tn(e,t){return s("div.analyse-moveTimes",[s("strong.title",o("moveTimes")),s("div.analyse-chart",{oncreate({dom:a}){setTimeout((()=>{this.updateCurPly=Ka(a,e.data,t,e.node.ply)}),200)},onupdate(){this.updateCurPly&&U((()=>{e.onMainline?this.updateCurPly(e.node.ply):this.updateCurPly(null)}))}})])}const an=[["inaccuracy","nbInaccuracies"],["mistake","nbMistakes"],["blunder","nbBlunders"]];var nn={onbeforeupdate:({attrs:e},{attrs:t})=>e.color!==t.color||!e.ctrl.replaying,view({attrs:e}){const{ctrl:t,color:a}=e,n=t.node,i=n.clock;if(void 0===i)return;const o=t.tree.getParentClock(n,t.path);let r,l;const c=n.ply%2==0;c?(r=o,l=i):(r=i,l=o);return s("span.analyse-clock",{className:("white"===a?c:!c)?"current":""},function(e){if(void 0===e)return s("span.time",["-"]);const t=new Date(10*e),a=t.getUTCMilliseconds(),n=":",i=sn(t.getUTCMinutes())+n+sn(t.getUTCSeconds());if(e>=36e4)return s("span.time",[Math.floor(e/36e4)+n+i]);const o=Math.floor(a/100).toString();return s("span.time",[i,s("tenths","."+o)])}("white"===a?r:l))}};function sn(e){return(e<10?"0":"")+e}function on(e,t){return function(e,t){return"white"===e?t:-t}(e,function(e){return void 0!==e.mate?function(e){const t=100*(21-Math.min(10,Math.abs(e)));return ln(t*(e>0?1:-1))}(e.mate):(t=e.cp,ln(Math.min(Math.max(-1e3,t),1e3)));var t}(t))}function rn(e,t,a){return(on(e,t)-on(e,a))/2}function ln(e){return 2/(1+Math.exp(-.004*e))-1}function cn(e){return s("div.analyse-boardWrapper",[dn(e,e.topColor()),s(At,{variant:e.data.game.variant.key,chessground:e.chessground,shapes:un(e),clearableShapes:e.node.shapes,wrapperClasses:e.settings.s.smallBoard?"halfsize":"",canClearShapes:!0}),dn(e,e.bottomColor())])}function dn(e,t){const a=e.playerName(t),n="Anonymous"===a;if(e.study&&n||!e.study&&e.synthetic)return null;const i=e.study&&e.study.data;let o,r,l;if(i)o=Va(i,`${t}title`),r=Va(i,`${t}elo`),l=function(e,t){switch(Va(e,"result")){case"1-0":return t?"1":"0";case"0-1":return t?"0":"1";case"1/2-1/2":return"1/2";default:return}}(i,"white"===t);else if(at.finished(e.data)){const a=e.data.game.winner;l=void 0===a?"½":a===t?"1":"0"}const c=e.node.checkCount,d=e.node.clock||c;return s("div.analyse-player_bar",{className:e.settings.s.smallBoard?"halfsize":""},[s("div.info",n?s.trust("&nbsp"):[l?s("span.result",l):null,s("span.name",(o?o+" ":"")+a+(r?` (${r})`:""))]),d?s("div.player_bar_clock",[s(nn,{ctrl:e,color:t}),c?hn("white"===e.bottomColor(),c):null]):null])}function un(e){const t=e.data.game.player,a=e.node&&e.node.ceval,n=e.node&&e.node.eval,s=e.node&&e.node.threat;let i=[],o=[],r=[],l=[];if(e.practice){const a=e.practice.hinting();a&&(i="move"===a.mode?pn(a.uci,"paleBlue",t):[{orig:L(a.uci)[0],brush:"paleBlue"}])}if(!e.retro&&!e.practice&&e.settings.s.showBestMove){const s=e.nextNodeBest()||a&&a.best;s&&(i=pn(s,"paleBlue",t)),a&&a.pvs.length>1&&a.pvs.slice(1).forEach((e=>{const n=rn(t,a.pvs[0],e);if(n>=0&&n<.2){const a=Math.round(12-50*n);i=i.concat(pn(e.moves[0],"paleBlue"+a,t))}})),n&&n.best&&(o=pn(n.best,"paleGreen",J(t)))}!e.retro&&!e.practice&&e.showThreat&&s&&(l=pn(s.pvs[0].moves[0],"paleRed",J(t)));const{uci:c,glyphs:d}=e.node;if(c&&d&&d.length>0){const e=d[0];r=[{orig:L(c)[1],glyph:e}]}const u=e.retro&&e.retro.showBadNode(),h=u&&u.uci?pn(u.uci,"paleRed2",t):[];return[...o,...i,...l,...h,...r]}function hn(e,t){const a=s("span.color-icon.white","+"+t.black),n=s("span.color-icon.black","+"+t.white);return s("div.analyse-checkCount",e?[a,n]:[n,a])}function pn(e,t,a){if(e.includes("@")){const n=R(e);return[{brush:t,orig:n},{orig:n,piece:{role:q(e),color:a},brush:t}]}{const n=H(e),s=V(e),i=[{brush:t,orig:n[0],dest:n[1]}];return s&&i.push({brush:t,orig:n[1],piece:{role:s,color:a}}),i}}const mn=[{name:"fast",delay:1e3},{name:"slow",delay:5e3}],vn={name:"realtimeReplay",delay:"realtime"},fn={name:"byCPL",delay:"cpl"};function gn(e,t){return s("section",{className:"actions_bar analyse_actions_bar"},s("button",{className:"action_bar_button fa "+(e.retroGlowing?"fa-play glow":"fa-list"),oncreate:i(e.study?e.study.actionMenu.open:e.menu.open)}),s("button",{className:"action_bar_button fa fa-gear",oncreate:i(e.settings.open)}),e.study&&e.study.chat?null:s("button",{className:"action_bar_button","data-icon":"B",oncreate:i(e.settings.flip)}),e.study&&e.study.chat?s("button",{className:"action_bar_button fa fa-comments withChip",oncreate:i(e.study.chat.open)},e.study.chat.nbUnread>0?s("span",{className:"chip"},e.study.chat.nbUnread<=99?e.study.chat.nbUnread:99):null):null,t?s("button",{className:"action_bar_button fa fa-"+(e.settings.s.smallBoard?"expand":"compress"),oncreate:i(e.settings.toggleBoardSize,(()=>T.show({text:"Expand/compress board",duration:"short",position:"bottom"})))}):null,s("button",{className:"action_bar_button fa fa-backward",oncreate:i(e.stoprewind,void 0,e.rewind)}),s("button",{className:"action_bar_button fa fa-forward",disabled:!!e.retro,oncreate:i(e.stopff,void 0,e.fastforward)}),e.study?s("button",{className:"action_bar_button fa fa-bars",oncreate:i(e.study.sideMenu.open)}):null)}function yn(e){return e.reduce(((e,t)=>e.set(bn(t),t)),new Map)}function bn(e){return e.map((e=>e.ply+":"+e.uci)).join(",")}class ForecastCtrl{constructor(e){var t;this.focusKey=null,this.loading=!1,this._minimized=!1;const a=e.forecast;this._lines=yn((null==a?void 0:a.steps)||[]);const n=null==a?void 0:a.onMyTurn;this.isMyTurn=!!n,this._gameId=e.game.id,this._playerId=(null===(t=e.player)||void 0===t?void 0:t.id)||null}truncate(e){const t=this.isMyTurn?1:0;return(e.length%2!==t?e.slice(0,-1):e).slice(0,30)}isCandidate(e){const t=this.truncate(e);if(!this.isLongEnough(t))return!1;for(const e of this._lines.values())if(this.isPrefix(e,t))return!1;return!0}removeForecast(e){this._lines.delete(e),this.focusKey=null,this.save()}add(e){const t=this.truncate(e);this.isCandidate(t)&&(this._lines.set(bn(t),t),this.fixAll(),this.save())}save(){const t=this._playerId,a=this._gameId;!this.isMyTurn&&t&&(this.loading=!0,c(),function(t,a,n){return e(`/${t}${a}/forecasts`,{method:"POST",body:JSON.stringify(n)})}(a,t,this.lines).then((e=>{e.reload?this.reloadToLastPly():(this.loading=!1,this._lines=yn(e.steps||[]),c())})))}playAndSave(t){const a=this._playerId,n=this._gameId;if(!this.isMyTurn||!a)return;const s=this.findStartingWithNode(t).filter((e=>e.length>0)).map((e=>e.slice(1)));this.loading=!0,c(),function(t,a,n,s){return e(`/${t}${a}/forecasts/${n.uci}`,{method:"POST",body:JSON.stringify(s)})}(n,a,t,s).then((e=>{e.reload?this.reloadToLastPly():(this.loading=!1,this._lines=yn(e.steps||[]),c())}))}findStartingWithNode(e){return this.lines.filter((t=>this.isPrefix(t,[e])))}reloadToLastPly(){n.deleteQueryParam("ply",!0)}get lines(){return Array.from(this._lines.values())}isPrefix(e,t){return e.length>=t.length&&bn(e).startsWith(bn(t))}collides(e,t){for(let a=0,n=Math.min(e.length,t.length);a<n;a++)if(e[a].uci!==t[a].uci)return this.isMyTurn?0!==a&&a%2==0:a%2==1;return!1}toggleMinimized(){this._minimized=!this._minimized}get minimized(){return this._minimized}isLongEnough(e){return e.length>=(this.isMyTurn?1:2)}fixAll(){for(const[e,t]of this._lines.entries())for(const[a,n]of this._lines.entries())if(e!==a&&this.isPrefix(n,t)||this.collides(t,n)){this._lines.delete(e);break}}}var wn=9007199254740991,kn=/^(?:0|[1-9]\d*)$/;var xn=9007199254740991;function Mn(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=xn}(e.length)&&!X(e)}function Cn(e,t,a){if(!K(a))return!1;var n=typeof t;return!!("number"==n?Mn(a)&&function(e,t){var a=typeof e;return!!(t=null==t?wn:t)&&("number"==a||"symbol"!=a&&kn.test(e))&&e>-1&&e%1==0&&e<t}(t,a.length):"string"==n&&t in a)&&function(e,t){return e===t||e!=e&&t!=t}(a[t],e)}function Pn(e,t,a){var n=-1,s=e.length;t<0&&(t=-t>s?0:s+t),(a=a>s?s:a)<0&&(a+=s),s=t>a?0:a-t>>>0,t>>>=0;for(var i=Array(s);++n<s;)i[n]=e[n+t];return i}var Nn=Math.ceil,Tn=Math.max;function Sn(e){const t=[];return e[0].ply%2==0&&(t.push({index:Math.floor((e[0].ply+1)/2),black:e[0].san,white:null}),e=e.slice(1)),function(e,t,a){t=(a?Cn(e,t,a):void 0===t)?1:Tn(De(t),0);var n=null==e?0:e.length;if(!n||t<1)return[];for(var s=0,i=0,o=Array(Nn(n/t));s<n;)o[i++]=Pn(e,s,s+=t);return o}(e,2).forEach((([e,a])=>{t.push({index:(e.ply+1)/2,white:e.san,black:null==a?void 0:a.san})})),t}function _n(e){const t=e.forecast;if(!t||e.synthetic||!He(e.data))return null;const a=In(e,t),n=t.isCandidate(a);return s("div.analyse-training_box.analyse-forecast_box.box",{className:t.minimized?"minimized":"",oncreate:i((()=>{t.focusKey=null}))},[En(t),s("div.forecasts-wrapper.native_scroller",[s("div.forecasts-list",{className:h.game.pieceNotation()?"displayPieces":""},[...t.lines.map((e=>{const a=bn(e);return s("div.forecast[data-icon=G]",{key:a,oncreate:i((e=>{e.stopPropagation(),t.focusKey=a}))},[s("sans",On(e)),t.focusKey===a?s("span.fa.fa-times-circle.delete",{oncreate:i((e=>{e.stopPropagation(),t.removeForecast(a)}))}):null])}))]),s("div.add",{className:n?"enabled":"","data-icon":n?"O":"",oncreate:i((()=>{const a=In(e,t);t.add(a)}))},[n?s("div",[s("span",o("addCurrentVariation")),s("sans",On(a))]):s("span",o("playVariationToCreateConditionalPremoves"))]),An(e,a),t.loading?s("div.spinner_overlay",s("div.spinner.fa.fa-hourglass-half")):null])])}function In(e,t){const a=e.tree.getCurrentNodesAfterPly(e.nodeList,e.mainline,e.data.game.turns);return t.truncate(a.map((e=>({ply:e.ply,fen:e.fen,uci:e.uci,san:e.san}))))}function On(e){return e[0]?(e[0].san||(e=e.slice(1)),e[0]?Sn(e).map((({black:e,white:t,index:a})=>s("move",[s("index",a+(t?".":"...")),t?s("san",t):null,e?s("san",e):null]))):[]):[]}function An(e,t){var a;if(!(null===(a=e.forecast)||void 0===a?void 0:a.isMyTurn))return;const n=t[0];if(!n)return;const r=e.forecast.findStartingWithNode(n);if(!r.length)return;const l=r.filter((e=>e.length>1)).length;return s("div.on-my-turn",s("button.defaultButton",{oncreate:i((()=>e.forecast.playAndSave(n)))},[s("span.fa.fa-check"),s("span",[s("strong",o("playX",t[0].san))," ",l?s("span",G("andSaveNbPremoveLines",l)):null])]))}function En(e){return s("div.titleWrapper",[s("div.title",[o("conditionalPremoves"),e.lines.length>0?` (${e.lines.length})`:null]),s("div.actions",[s("button.window-button",{oncreate:i((()=>e.toggleMinimized()))},s("span.fa",{className:e.minimized?"fa-window-maximize":"fa-window-minimize"}))])])}function Bn(e,t,a){const n=h.analyse.smallBoard();return We.board(Y(),[jn(t||"white",n,a||Me),s("div.analyse-tableWrapper",l.getVdom("monochrome")),e?s("section.analyse_actions_bar"):null])}function Gn(e,t){const a=e.availableTabs(),n=Q();return s.fragment({key:"size"+e.settings.s.smallBoard},[cn(e),s("div.analyse-tableWrapper",["crazyhouse"!==e.data.game.variant.key||!t&&n?null:pa(e),!t&&n?ma(e):null,Wn(e,a),t?null:gn(e,t),!t&&n?va(e):null]),t?gn(e,t):null])}function zn(e){return[Ee(e),e.study?Ht.view(e.study.actionMenu):Lt.view(e.menu),e.study&&e.study.chat?Le(e.study.chat):null,Xt.view(e.settings),e.notes?je(e.notes):null,Ae.view(e.continuePopup),fa(e)]}function Dn(e){const t=e.data.game.variant.key,a=ee(t);let i=h.analyse.availableVariants;return"fromPosition"===t&&(i=i.concat([["From position","fromPosition"]])),s("div.select_input.main_header-selector.header-subTitle",[s("label",{for:"variant_selector"},s(`i[data-icon=${a}]`)),s("select",{id:"variant_selector",value:t,onchange:e=>{const t=e.target.value;h.analyse.syntheticVariant(t),n.set(`/analyse/variant/${t}`)}},i.map((e=>s("option",{key:e[1],value:e[1]},e[0]))))])}function jn(e,t,a){return s("section.board_wrapper.analyse-boardWrapper",{className:t?"halfsize ":""},s(Z,{orientation:e,fen:a}))}function Un(e,t){const a=e.currentTab(t),n=t.map((t=>{var a;return"comments"===t.id&&e.node.comments&&e.node.comments.length>0?Object.assign(Object.assign({},t),{chip:e.node.comments.length}):"forecasts"===t.id&&(null===(a=e.forecast)||void 0===a?void 0:a.lines)&&e.forecast.lines.length>0?Object.assign(Object.assign({},t),{chip:e.forecast.lines.length}):t}));return s("div.analyse-header",["ceval"!==a.id?s(aa,{ctrl:e}):null,s("div.analyse-tabs",[s("div.tab-title",$n(e,a)),s(Fe,{buttons:n,selectedIndex:e.currentTabIndex(t),onTabChange:e.onTabChange,wrapperClass:"analyse"})])])}function $n(e,t){const a=o(t.title);let n;if("moves"===t.id){const t=function(e){const t=e.tree.getOpening(e.nodeList)||e.data.game.opening;if(t)return s("div",[s("strong",t.eco)," "+t.name])}(e);n=[t||a]}else n="ceval"===t.id?[s("span",e.ceval.getEngineName()+(e.ceval.getEngineEvaluation()?` (${e.ceval.getEngineEvaluation()})`:"")),e.ceval.isSearching()?s("div.ceval-spinner",s("span.fa.fa-spinner.fa-pulse")):null]:"explorer"===t.id?[da(e)]:[a];return s.fragment({},n)}const Fn={infos:function(e){const t=e.data.player,a=e.data.opponent;return t&&a?s("div",{className:"analyse-gameInfos native_scroller"},s("div",{className:"analyseOpponent li-button",oncreate:I((()=>t.user&&n.set(`/@/${t.user.id}/`)))},s("div",{className:"analysePlayerName"},s("span",{className:"color-icon "+t.color}),F(t,!0),W(t),t.berserk?s("span",{"data-icon":"`"}):null)),s("div",{className:"analyseOpponent li-button",oncreate:I((()=>a.user&&n.set(`/@/${a.user.id}/`)))},s("div",{className:"analysePlayerName"},s("span",{className:"color-icon "+a.color}),F(a,!0),W(a),a.berserk?s("span",{"data-icon":"`"}):null)),s("div",{className:"gameInfos"},e.formattedDate?e.formattedDate:null,"import"===e.data.game.source&&e.data.game.importedBy?s("div",null,"Imported by ",e.data.game.importedBy):null),at.finished(e.data)?function(e){const t=tt(e.data,e.data.game.winner);return s("div",{className:"status"},at.toLabel(e.data.game.status.name,e.data.game.turns,e.data.game.winner,e.data.game.variant.key),t?". "+o("white"===t.color?"whiteIsVictorious":"blackIsVictorious")+".":null)}(e):null,e.data.tournament?s("div",{className:"analyse-tournamentInfo li-button",oncreate:I((()=>e.data.tournament&&n.set(`/tournament/${e.data.tournament.id}`)))},s("span",{className:"fa fa-trophy"}),e.data.tournament.name+" Arena"):null,s("h2",{className:"analyse-tabContentTitle"},o("replayMode")),function(e){const t=e.data,a="correspondence"!==t.game.speed&&t.game.moveCentis&&0!==t.game.moveCentis.length,n=[...mn,...a?[vn]:[],...t.analysis?[fn]:[]];return s("div.analyse-autoplay",n.map((t=>s("button.buttonMetal",{oncreate:i((()=>e.autoplay.toggle(t.delay)))},o(t.name)))))}(e)):null},moves:function(e){return s("div.analyse-replayWrapper",[s(Ta,{ctrl:e,rightTabActive:!1})])},explorer:function(e){const t=e.explorer.current(),a=e.explorer.config,n=a.open(),l=!n&&e.explorer.loading(),c=r({explorerTable:!0,loading:l}),d=e.tree.getOpening(e.nodeList)||e.data.game.opening;return s("div",{id:"explorerTable",className:c},t&&t.isOpening?s("div",{className:"explorer-fixedTitle"},s("span",null,d?d.eco+" "+d.name:""),n||t&&t.isOpening?s("div",{className:"toconf","data-icon":n?"L":"%",oncreate:i(a.toggleOpen)}):null):null,l?s("div",{className:"spinner_overlay"},s("div",{className:"spinner fa fa-hourglass-half"})):null,n?function(e){return s("div.explorerConfig",{},sa.view(e.explorer.config))}(e):null,!n&&e.explorer.failing()?s("div.explorer-data.empty",{},s("div.failing.message",[s("h3",[s("i.withIcon[data-icon=,]"),"Oops, sorry!"]),s("p","The explorer is temporarily"),s("p","out of service. Try again soon!")])):null,n||e.explorer.failing()?null:function(e){const t=e.explorer.current();if(t&&function(e){return!!e.isOpening}(t))return s(oa,{data:t,ctrl:e});if(t&&function(e){return!!e.tablebase}(t)){const a=t.moves;return a.length?s("div",{className:"explorer-data"},ua(e,o("winning"),a.filter((e=>"loss"===e.category)),t.fen),ua(e,o("unknown"),a.filter((e=>"unknown"===e.category)),t.fen),ua(e,o("winOr50MovesByPriorMistake"),a.filter((e=>"maybe-loss"===e.category)),t.fen),ua(e,o("winPreventedBy50MoveRule"),a.filter((e=>"blessed-loss"===e.category)),t.fen),ua(e,o("drawn"),a.filter((e=>"draw"===e.category)),t.fen),ua(e,o("lossSavedBy50MoveRule"),a.filter((e=>"cursed-win"===e.category)),t.fen),ua(e,o("lossOr50MovesByPriorMistake"),a.filter((e=>"maybe-win"===e.category)),t.fen),ua(e,o("losing"),a.filter((e=>"win"===e.category)),t.fen)):t.checkmate?ha(o("checkmate")):t.stalemate?ha(o("stalemate")):t.variant_win||t.variant_loss?ha(o("variantEnding")):ra(e)}return s("div",null)}(e))},analysis:function(e){const t=e.data;return s("div.analyse-gameAnalysis.native_scroller",[t.analysis?Ya(e):e.study?en(e):Za(e),t.game.moveCentis?tn(e,t.game.moveCentis):null])},ceval:function(e){return e.ceval.enabled()?s("div.ceval-Wrapper",[Zt(e),ta(e)]):s("div.ceval-notEnabled","Computer eval is disabled")},pgnTags:function(e){const t=e.study;return t?s("div.native_scroller",[s("table.study-tags",[s("tbody",t.data.chapter.tags.map((([e,t])=>s("tr.study-tag",[s("th",e),s("td",s.trust(qe(t)))]))))])]):s("div","oops! nothing to see here")},comments:function(e){const t=e.node.comments||[];return s("div.native_scroller.study-comments",t.map((e=>s("div.study-comment",[s("div.by",("string"==typeof e.by?e.by:e.by.name)+":"),s("div",s(Jt,{text:e.text}))]))))}};function Wn(e,t){const a=e.retro||e.practice||e.forecast;return s("div.analyse-table.box",[Un(e,t),s($e,{className:"analyse-tabsContent"+(a?" withTrainingBox":""),selectedIndex:e.currentTabIndex(t),tabs:t.map((t=>({id:t.id,f:()=>Fn[t.id](e)}))),onTabChange:e.onTabChange,boardView:!0}),e.retro?Ea(e):null,e.practice?Ha(e):null,e.forecast?_n(e):null])}class Autoplay{constructor(e){this.ctrl=e}move(){return this.ctrl.canGoForward()?(this.ctrl.next(),c(),!0):(this.stop(),c(),!1)}evalToCp(e){return e.eval?e.eval.mate?e.eval.mate>0?990:-990:e.eval.cp:e.ply%2?990:-990}nextDelay(){if("string"!=typeof this.delay||this.ctrl.onMainline){if("realtime"===this.delay){if(this.ctrl.node.ply<2)return 1e3;const e=this.ctrl.data.game.moveCentis;if(!e)return 1500;return 10*e[this.ctrl.node.ply-this.ctrl.tree.root.ply]+130||2e3}if("cpl"===this.delay){const e=30;if(this.ctrl.node.ply>=this.ctrl.mainline.length-1)return 0;const t=this.evalToCp(this.ctrl.node),a=this.evalToCp(this.ctrl.node.children[0]);return Math.max(500,Math.min(1e4,Math.abs(t-a)*e))}return this.delay}return 1500}schedule(){this.timeoutId=setTimeout((()=>{this.move()&&this.schedule()}),this.nextDelay())}start(e){this.delay=e,this.stop(),this.schedule()}stop(){clearTimeout(this.timeoutId),this.timeoutId=void 0}toggle(e){this.active(e)?this.stop():(this.active()||this.move()||this.ctrl.jump(""),this.start(e))}active(e){return!(e&&e!==this.delay||!this.timeoutId)}}function Ln(){const e={state:"pending"};return e.promise=new Promise(((t,a)=>{e.resolve=a=>{e.state="fulfilled",t(a)},e.reject=()=>{e.state="rejected",a()}})),e}const Rn=new RegExp(""+/^info depth (\d+) seldepth \d+ multipv (\d+) /.source+/score (cp|mate) ([-\d]+) /.source+/(?:(upper|lower)bound )?nodes (\d+) nps \S+ /.source+/(?:hashfull \d+ )?(?:tbhits \d+ )?time (\S+) /.source+/pv (.+)/.source);class StockfishClient{constructor(e,t,a){this.threads=t,this.hash=a,this.expectedPvs=1,this.startQueue=[],this.stopped=!1,this.engineName="Stockfish",this.init=async()=>{try{window.addEventListener("stockfish",this.listener,{passive:!0});const e=await this.stockfish.start();this.engineName=e.engineName,await this.stockfish.setVariant(),await this.stockfish.setOption("UCI_AnalyseMode","true"),await this.stockfish.setOption("Threads",this.threads),"web"!==te.getPlatform()&&await this.stockfish.setOption("Hash",this.hash)}catch(e){}},this.start=e=>{this.stop(),this.startQueue.push(e),clearTimeout(this.stopTimeoutId);const t=new Promise(((e,t)=>{this.stopTimeoutId=setTimeout(t,1e4)}));return Promise.race([this.ready.promise,t]).then(this.search).catch((()=>{this.reset().then(this.search)}))},this.stop=()=>{this.stopped||(this.stopped=!0,this.stockfish.send("stop"))},this.exit=()=>(window.removeEventListener("stockfish",this.listener,!1),this.stockfish.exit()),this.reset=()=>this.exit().then(this.init),this.search=async()=>{const e=this.startQueue.pop();e&&(this.work=e,this.curEval=void 0,this.expectedPvs=1,this.stopped=!1,this.startQueue=[],this.ready=Ln(),await this.stockfish.setOption("MultiPV",e.multiPv),await this.stockfish.send(["position","fen",e.initialFen,"moves"].concat(e.moves).join(" ")),e.maxDepth>=99?await this.stockfish.send("go depth 99"):await this.stockfish.send("go movetime 90000 depth "+e.maxDepth))},this.listener=e=>{this.processOutput(e.output)},this.stockfish=new ae(e),this.ready=Ln(),this.ready.resolve()}isSearching(){return"pending"===this.ready.state}processOutput(e){var t;const a=/^info string (classical|NNUE) evaluation/.exec(e);if(a&&(this.evaluation=a[1]),0===e.indexOf("bestmove")&&(this.ready.resolve(),null===(t=this.work)||void 0===t||t.emit()),this.stopped||void 0===this.work)return;const n=Rn.exec(e);if(!n)return;const s=parseInt(n[1]),i=parseInt(n[2]),o="mate"===n[3],r=parseInt(n[4]),l=n[5],c=parseInt(n[6]),d=parseInt(n[7]),u=n[8].split(" ");if(o&&!r)return;this.expectedPvs<i&&(this.expectedPvs=i);const h=this.work.threatMode?0:1,p=this.work.ply%2===h?-r:r;if(l&&1===i)return;const m={moves:u,cp:o?void 0:p,mate:o?p:void 0,depth:s};1===i?this.curEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:s,knps:c/d,nodes:c,cp:m.cp,mate:m.mate,pvs:[m],millis:d}:this.curEval&&(this.curEval.pvs.push(m),this.curEval.depth=Math.min(this.curEval.depth,s)),i===this.expectedPvs&&this.curEval&&this.work.emit(this.curEval)}}class CevalCtrl{constructor(e,t){this.opts=e,this.emit=t,this.minDepth=6,this.initialized=!1,this.started=!1,this.isDeeper=!1,this.lastStarted=void 0,this.init=()=>this.engine.init().then((()=>{this.initialized=!0})),this.destroy=()=>{this.initialized&&this.engine.exit().then((()=>{this.initialized=!1,this.started=!1})).catch((()=>{this.initialized=!1,this.started=!1}))},this.stop=()=>{this.enabled()&&this.started&&(this.engine.stop(),this.started=!1)},this.toggle=()=>{this.isEnabled=!this.isEnabled},this.disable=()=>{this.isEnabled=!1},this.toggleInfinite=()=>{this.opts.infinite=!this.opts.infinite,this.restart()},this.goDeeper=()=>{this.lastStarted&&this.start(this.lastStarted.threatMode,this.lastStarted.path,this.lastStarted.nodes,!1,!0)},this.onEmit=(e,t)=>{var a,n;t&&(a=t.pvs,n=e.ply%2==0?"white":"black",a.sort(((e,t)=>on(n,t)-on(n,e)))),t&&qn(t),this.emit(e.path,t,e.threatMode)},this.allowed=e.allowed,this.variant=e.variant,this.isEnabled=h.analyse.enableCeval(),this.engine=new StockfishClient(e.variant,e.cores,e.hashSize)}enabled(){return this.opts.allowed&&this.isEnabled}async start(e,t,a,n,s){if(!this.enabled())return;this.isDeeper=s;const i=a[a.length-1],o=this.effectiveMaxDepth(s),r=e?i.threat:i.ceval;if(r&&r.depth>=o)return;const l={initialFen:a[0].fen,currentFen:i.fen,moves:[],maxDepth:n?h.analyse.cevalMaxDepth():this.effectiveMaxDepth(s),path:t,ply:i.ply,multiPv:n?1:this.opts.multiPv,threatMode:e,emit:e=>{this.enabled()&&this.onEmit(l,e)}};if(e){const e=i.ply%2==1?"w":"b",t=i.fen.replace(/ (w|b) /," "+e+" ");l.currentFen=t,l.initialFen=t}else for(let e=1;e<a.length;e++){const t=a[e];Hn(this.variant,t.san)?(l.moves=[],l.initialFen=t.fen):l.moves.push(t.uci)}this.engine.start(l),this.started=!0,this.lastStarted={threatMode:e,path:t,nodes:a}}restart(){this.lastStarted&&this.start(this.lastStarted.threatMode,this.lastStarted.path,this.lastStarted.nodes,!1,!1)}isInit(){return this.initialized}isSearching(){return this.engine.isSearching()}setMultiPv(e){this.opts.multiPv=e,this.restart()}getMultiPv(){return this.opts.multiPv}canGoDeeper(){return!this.isDeeper&&!this.opts.infinite&&!this.engine.isSearching()}getEngineName(){return this.engine.engineName}getEngineEvaluation(){return this.engine.evaluation}effectiveMaxDepth(e=!1){return e||this.opts.infinite?99:h.analyse.cevalMaxDepth()}}const qn=(()=>{const e=[];return t=>{if((e=>e.knps&&e.depth>=16&&void 0!==e.cp&&Math.abs(e.cp)<500&&e.fen.split(/\s/)[0].split(/[nbrqkp]/i).length-1>=10)(t)&&(e.push(t.knps),e.length>9)){const t=function(e){e.sort(((e,t)=>e-t));const t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(e)||0;let a=18;t>100&&(a=19),t>150&&(a=20),t>250&&(a=21),t>500&&(a=22),t>1e3&&(a=23),t>2e3&&(a=24),t>3500&&(a=25),t>5e3&&(a=26),t>7e3&&(a=27),h.analyse.cevalMaxDepth()!==a&&h.analyse.cevalMaxDepth(a),e.length>40&&e.shift()}}})();function Hn(e,t){return!!t.startsWith("O-O")||"crazyhouse"!==e&&(!!t.includes("x")||(t.toLowerCase()===t||"threeCheck"===e&&t.includes("+")))}function Vn(e){return!!e.children.find((function(e){return!!e.comp}))}function Jn(e){return e.split(" ").slice(0,4).join(" ")}function Xn(e){const t=e.data.game;let a=[];const n=[];let s=[];const i={current:null,feedback:"find",minimized:!1,color:e.bottomColor()};function o(e){return s.includes(e)}function r(){const t="white"===e.bottomColor()?1:0;return a=function(e,t){const a=[];for(let n=1;n<e.length;n++){const s=e[n],i=e[n-1];t(s)&&s.eval&&i.eval&&Math.abs(rn("white",i.eval,s.eval))>.075&&Vn(i)&&a.push(s)}return a}(e.mainline,(e=>e.ply%2===t&&!n.includes(e.ply))),a.find((e=>!o(e.ply)))}function l(){i.feedback="find";const a=r();if(!a)return i.current=null,c();const s={node:a,path:e.mainlinePathToPly(a.ply)},o=pt(s.path),d={node:e.tree.nodeAtPath(o),path:o},u=d.node.children.find((e=>!!e.comp));i.current={fault:s,prev:d,solution:{node:u,path:o+u.id},openingUcis:[]},"standard"===t.variant.key&&t.division&&(!t.division.middle||s.node.ply<t.division.middle)&&e.explorer.fetchMasterOpening(d.node.fen).then((e=>{const t=i.current,a=[];e.moves.forEach((e=>{e.white+e.draws+e.black>1&&a.push(e.uci)})),a.find((e=>s.node.uci===e))?(n.push(s.node.ply),setTimeout(l,100)):(t.openingUcis=a,i.current=t)})),e.userJump(d.path),c()}function d(){const t=e.node,a=i.current;if(a&&"eval"===i.feedback&&a.fault.node.ply===t.ply&&function(e){return!!e.ceval&&(e.ceval.depth>=18||e.ceval.depth>=14&&void 0!==e.ceval.millis&&e.ceval.millis>7e3)}(t)){e.stopCevalImmediately();rn(i.color,t.ceval,a.prev.node.eval)>-.035?u():p()}}function u(){i.feedback="win",c()}function p(){i.feedback="fail";const t={node:e.node,path:e.path};e.userJump(i.current.prev.path),!e.tree.pathIsMainline(t.path)&&Ze(t.node.children)&&e.tree.deleteNodeAt(t.path),c()}function m(){const e=i.feedback;return"find"===e||"fail"===e}function v(){s=[],l()}return{vm:i,isPlySolved:o,onJump:function(){const t=e.node,a=i.feedback,n=i.current;n&&("eval"!==a||n.fault.node.ply===t.ply?m()&&n.fault.node.ply===t.ply&&(n.openingUcis.some((e=>t.uci===e))||t.comp?u():t.eval?p():(i.feedback="eval",e.ceval.enabled()||(e.ceval.toggle(),e.initCeval()),d())):i.feedback="find")},jumpToCurrent:l,nextMistake:function(){s.push(i.current.fault.node.ply),l()},viewSolution:function(){i.feedback="view",e.userJump(i.current.solution.path)},hideComputerLine:function(e){return e.ply%2==0!=("white"===i.color)&&!o(e.ply)},showBadNode:function(){const t=i.current;if(t&&m()&&t.prev.path===e.path)return t.fault.node},onCeval:d,onMergeAnalysisData:function(){m()&&!i.current&&l()},isSolving:m,completion:()=>[s.length,a.length],flip(){e.settings.flip(),i.color=e.bottomColor(),v()},reset:v,pieceTheme:h.general.theme.piece(),close:e.toggleRetro,toggleWindow(){i.minimized=!i.minimized},node:()=>e.node}}function Kn(e,t){const a=e.data.game.variant.key,n=E(!1),s=E(!0),i=E(null),o=E(null),r=E(!1);function l(){e.ceval.enabled()||(e.ceval.toggle(),e.initCeval())}function d(t,a=0){if(e.gameOver(t)||t.tbhit)return!0;const n=t.ceval;return!!n&&(n.depth+a>=15||n.depth>=13&&Number(n.millis)>3e3)}function u(e){return e&&(e.winner?{mate:"white"===e.winner?10:-10}:{cp:0})}function p(e){return e.tbhit&&e.tbhit.best||e.ceval&&e.ceval.pvs[0].moves[0]}function m(t,a,n){let s,i;const o=e.gameOver(a);if("checkmate"===o)s="goodMove";else{const n=u(a.tbhit)||(a.threefold||"draw"===o?{cp:0}:a.ceval),r=u(t.tbhit)||t.ceval,l=-rn(e.bottomColor(),n,r);i=p(t),(i===a.uci||a.san.startsWith("O-O")&&i===se[a.uci])&&(i=null),s=i?l<.025?"goodMove":l<.06?"inaccuracy":l<.14?"mistake":"blunder":"goodMove"}return{prev:t,node:a,path:n,verdict:s,best:i?{uci:i,san:v(t).unwrap((e=>Yt(e,_(i))),(e=>"--"))}:void 0}}function v(t){const a=S(t.fen).unwrap();return Oe(Qt(e.data.game.variant.key),a)}function f(){return e.turnColor()===e.bottomColor()}function g(){const n=e.node;if(!s())return i(null),c();if(!nt(a,n.fen)||st(n.tbhit))if(l(),f()){const e=o();e&&(e.uci=p(n)||e.uci)}else{if(i(null),n.san&&d(n)){const t=e.tree.parentNode(e.path);if(d(t,1))i(m(t,n,e.path));else{const t=e.tree.parentNode(pt(e.path));d(t,1)&&i(m(t,n,e.path))}}!r()&&function(e){const a=e.ceval;return!!a&&(a.depth>=Math.min(a.maxDepth||99,t())||a.depth>=15&&(a.cloud||Number(a.millis)>5e3))}(n)?(e.playUci(p(n)),r(!0)):c()}}function y(){l(),nt(a,e.node.fen)?e.explorer.fetchTablebaseHit(e.node.fen).then((t=>{t&&e.node.fen===t.fen&&(e.node.tbhit=t),g()})).catch((()=>{st(e.node.tbhit)||(e.node.tbhit=null),g()})):g()}function b(){s(!0),y(),c()}return ne(y),{onCeval:g,onJump(){r(!1),o(null),function(e,t){if(void 0!==t.threefold)return;const a=Jn(t.fen);let n=0;for(const t in e)Jn(e[t].fen)===a&&n++;t.threefold=n>2}(e.nodeList,e.node),y()},isMyTurn:f,comment:i,running:s,hinting:o,resume:b,playableDepth:t,reset(){i(null),o(null)},preUserJump(e,t){e!==t&&(s(!1),i(null))},postUserJump(e,t){e!==t&&f()&&b()},onUserMove(){s(!0)},playCommentBest(){const t=i();t&&(e.jump(pt(t.path)),t.best&&e.playUci(t.best.uci))},hint(){const t=e.node.ceval?e.node.ceval.pvs[0].moves[0]:null,a=o();!t||a&&"move"===a.mode?o(null):o({mode:a?"move":"piece",uci:t}),c()},currentNode:()=>e.node,bottomColor:e.bottomColor,pieceTheme:h.general.theme.piece(),minimized:n,toggleWindow(){n(!n())}}}var Yn={drop(e,t,a){if("pawn"===e&&("1"===t[1]||"8"===t[1]))return!1;if(null==a)return!0;return-1!==(Array.isArray(a)?a:a.match(/.{2}/g)||[]).indexOf(t)}};const Qn="https://explorer.lichess.ovh",Zn="https://tablebase.lichess.ovh";function es(t,a,n,s){const i={fen:a,variant:t};return s||(i.topGames=0,i.recentGames=0),"lichess"===n.db&&(n.speeds&&(i.speeds=n.speeds.join(",")),n.ratings&&(i.ratings=n.ratings.join(","))),e(Qn+"/"+n.db,{headers:{Accept:"application/json","X-Requested-With":"__delete",[ie]:"__delete"},credentials:"omit",query:i})}function ts(t,a,n){return e(Zn+"/"+t,{headers:{Accept:"application/json, text/*","X-Requested-With":"__delete",[ie]:"__delete"},credentials:"omit",query:{fen:a},timeout:n})}function as(e,t){const a=E(!0),n=E(!1),s=E({moves:[]});let i={};function o(e,t){i[e]=t,s(t)}const r=!!(it(e.data)||ot(e.data)||e.data.game.offline),l="fromPosition"===e.data.game.variant.key?"standard":e.data.game.variant.key,d=sa.controller(e.data.game.variant,(function(e){e&&(i={},g())})),u=oe((()=>{const e=document.getElementById("explorerTable");e&&(e.scrollTop=0)}),200);function h(){a(!1),n(!0),c()}const p=oe((e=>{const t={db:d.data.db.selected(),speeds:d.data.speed.selected(),ratings:d.data.rating.selected()};return es(l,e,t,r).then((t=>{t.isOpening=!0,t.fen=e,o(e,t),a(!1),n(!1),c()})).catch(h)}),1e3,{leading:!0,trailing:!0}),m=oe((e=>ts(l,e).then((t=>{t.tablebase=!0,t.fen=e,o(e,t),a(!1),n(!1),c()})).catch(h)),500,{leading:!0,trailing:!0});const f={isOpening:!0,moves:[]};function g(){if("explorer"!==e.currentTab(e.availableTabs()).id)return;const t=e.node;t.ply>50&&!ns(l,t.fen)&&o(t.fen,f);const d=i[t.fen];var h;d?(s(d),a(!1),n(!1)):(a(!0),h=t.fen,r&&ns(l,h)?m(h):p(h)),c(),u()}return{allowed:t,setStep:g,loading:a,failing:n,config:d,withGames:r,current:s,fetchMasterOpening:function(){const e={};return function(t){return e[t]?Promise.resolve(e[t]):es("standard",t,{db:"masters"},!1).then((a=>(e[t]=a,a)))}}(),fetchTablebaseHit:e=>ts(l,e,2e3).then((t=>{var a;if("unknown"===t.category)throw"unknown tablebase position";const n=Ce(e);return{fen:e,best:null===(a=t.moves[0])||void 0===a?void 0:a.uci,winner:ia(v(n),t.category)}}))}}function ns(e,t){const a=t.split(/\s/)[0].split(/[nbrqkp]/i).length-1;return"standard"===e||"chess960"===e?a<=8:("atomic"===e||"antichess"===e)&&a<=7}var ss={make:(e,t,a,n)=>new re(function(e,t,a,n){const s=h.game.pieceMove();return{variant:e.variant,fen:e.fen,check:e.check,lastMove:e.lastMove,turnColor:e.turnColor,orientation:t,coordinates:h.game.coords(),otb:e.otb,movable:{free:!1,color:e.movableColor,dests:e.dests,showDests:h.game.pieceDestinations(),rookCastle:1===h.game.rookCastle()},draggable:{enabled:"drag"===s||"both"===s,magnified:h.game.magnified()},selectable:{enabled:"tap"===s||"both"===s},events:{move:a,dropNewPiece:n},premovable:{enabled:!1},highlight:{lastMove:h.game.highlights(),check:h.game.highlights()},animation:{enabled:!!h.game.animations(),duration:le(h.game.animations())}}}(e,t,a,n))};function is(e){return{analysisProgress(t){e.mergeAnalysisData(t)},evalHit(t){e.evalCache.onCloudEval(t)},fen(t){e.forecast&&t.id===e.data.game.id&&0!==mt(e.mainline).fen.indexOf(t.fen)&&e.forecast.reloadToLastPly()}}}const os={id:"infos",title:o("gameInformation"),className:"fa fa-info-circle"},rs={id:"moves",title:o("movesPlayed"),className:"fa fa-list-alt"},ls={id:"ceval",title:"Stockfish",className:"fa fa-cogs"},cs={id:"explorer",title:o("openingExplorer"),className:"fa fa-book"},ds={id:"analysis",title:o("gameAnalysis"),className:"fa fa-area-chart"},us={id:"pgnTags",title:o("pgnTags"),className:"fa fa-tags"},hs={id:"comments",title:o("comments"),className:"fa fa-comment-o"};class StudyCtrl{constructor(e,t){this.data=e,this.rootCtrl=t,this.toggleLike=()=>{this.rootCtrl.socket.send("like",{liked:!this.data.liked})},this.toggleShowComments=()=>{this.vm.showComments=!this.vm.showComments},this.actionMenu=Ht.controller(this.rootCtrl),this.sideMenu=new de("right","studyMenu","studyMenu-backdrop"),this.analyseCtrl=t,e.features.chat&&e.chat&&u.isConnected()&&(this.chat=new Re(t.socket,e.id,e.chat.lines,void 0,e.chat.writeable,u.isShadowban(),"Study")),this.vm={showComments:!1},null===h.study.tour()&&(qt(this),h.study.tour(window.deviceInfo.appVersion))}canContribute(){const e=u.getUserId(),t=e&&this.data.members[e];return!!t&&"w"===t.role}createSocket(){return ue.createStudy(this.data.id,(e=this,Object.assign(Object.assign({},is(e.rootCtrl)),{liking(t){e.data.likes=t.l.likes,t.w&&t.w.s===ce()&&(e.data.liked=t.l.me),c()},message(t){e.chat&&e.chat.append(t)}})));var e}}class AnalyseCtrl{constructor(e,t,a,s,i,o,r){this.data=e,this.source=a,this.orientation=s,this.shouldGoBack=i,this.promoting=null,this.onMainline=!0,this.contextMenu=null,this.replaying=!1,this.analysisProgress=!1,this.retroGlowing=!1,this.showThreat=!1,this._currentTabIndex=0,this.canDrop=()=>!0,this.player=()=>this.data.game.player,this.availableTabs=()=>{let e=[rs];return this.study&&this.study.data.chapter.tags.length>0&&(e=[us,...e]),this.synthetic||(e=[os,...e]),this.study&&(e=[...e,hs]),this.retro||this.practice||!this.ceval.enabled()||(e=[...e,ls]),(this.study||Wt(this.data)&&Xe(this.data))&&(e=[...e,ds]),he()&&this.explorer.allowed&&(e=[...e,cs]),e},this.currentTabIndex=e=>this._currentTabIndex>e.length-1?e.length-1:this._currentTabIndex,this.currentTab=e=>e[this.currentTabIndex(e)],this.onTabChange=e=>{this._currentTabIndex=e;const t=this.currentTab(this.availableTabs());this.updateHref(),"moves"===t.id?this.debouncedScroll():"explorer"===t.id&&this.explorer.setStep(),c()},this.resetTabs=()=>this.onTabChange(this.currentTabIndex(this.availableTabs())),this.setPath=e=>{this.path=e,this.nodeList=this.tree.getNodeList(e),this.node=mt(this.nodeList),this.mainline=vt(this.tree.root),this.onMainline=this.tree.pathIsMainline(e)},this.initCeval=()=>{this.ceval.enabled()&&(this.ceval.isInit()?this.debouncedStartCeval():this.ceval.init().then(this.debouncedStartCeval))},this.startCeval=()=>{if(this.ceval.enabled()&&this.canUseCeval()){const e=!!this.retro||!!this.practice;this.ceval.start(this.showThreat,this.path,this.nodeList,e,!1),this.evalCache.fetch(this.path,e?1:this.ceval.getMultiPv())}},this.stopCevalImmediately=()=>{this.ceval.stop(),this.debouncedStartCeval.cancel()},this.toggleRetro=e=>{this.retro?("backbutton"!==e&&n.backbutton.stack.pop(),this.retro=null,h.analyse.enableCeval()?this.startCeval():this.ceval.disable()):(this.stopCevalImmediately(),this.practice&&(this.practice=null),this.retro=Xn(this),n.backbutton.stack.push(this.toggleRetro),this.retro.jumpToCurrent())},this.togglePractice=()=>{this.practice||!this.ceval.allowed?this.practice=null:(this.retro&&(this.retro=null),this.practice=Kn(this,(()=>18)))},this.toggleShowThreat=()=>{this.ceval.allowed&&(this.ceval.enabled()||this.ceval.toggle(),this.showThreat=!this.showThreat,this.startCeval())},this.debouncedScroll=oe((()=>rt(document.getElementById("replay"))),200),this.jump=(e,t)=>{const a=e!==this.path;this.setPath(e),this.updateBoard(void 0!==t?"forward"===t?"redo":"undo":void 0),this.fetchOpening(),this.node&&this.node.san&&"forward"===t&&(-1!==this.node.san.indexOf("x")?pe.throttledCapture():pe.throttledMove()),this.ceval.stop(),this.debouncedExplorerSetStep(),this.updateHref(),a&&(this.retro&&this.retro.onJump(),this.practice&&this.practice.onJump(),this.debouncedStartCeval())},this.userJump=(e,t)=>{if(this.autoplay.stop(),this.practice){const a=this.path;this.practice.preUserJump(a,e),this.jump(e,t),this.practice.postUserJump(a,this.path)}else this.jump(e,t)},this.jumpToMain=e=>{this.userJump(this.mainlinePathToPly(e))},this.jumpToIndex=e=>{this.jumpToMain(e+1+(this.data.game.startedAtTurn||0))},this.canGoForward=()=>this.node.children.length>0,this.next=()=>{if(!this.canGoForward())return!1;const e=this.node.children[0];return e&&this.userJump(this.path+e.id,"forward"),!0},this.fastforward=()=>{this.replaying=!0;const e=this.next();return e||(this.replaying=!1,this.debouncedScroll()),e},this.stopff=()=>{this.replaying=!1,this.next(),this.debouncedScroll()},this.rewind=()=>{this.replaying=!0;const e=this.prev();return e||(this.replaying=!1,this.debouncedScroll()),e},this.stoprewind=()=>{this.replaying=!1,this.prev(),this.debouncedScroll()},this.toggleBookmark=()=>me(this.data.game.id).then((()=>{this.data.bookmarked=!this.data.bookmarked,c()})).catch(d),this.playUci=e=>{const t=ve(e);"@"===e[1]?this.chessground.apiNewPiece({color:this.chessground.state.movable.color,role:fe[e[0]]},t[1]):t[2]?this.sendMove(t[0],t[1],fe[t[2].toUpperCase()]):this.sendMove(t[0],t[1]),this.explorer.loading(!0)},this.canUseCeval=()=>!this.gameOver(),this.hasAnyComputerAnalysis=()=>this.data.analysis||this.ceval.enabled(),this.hasFullComputerAnalysis=()=>Object.keys(this.mainline[0].eval||{}).length>0,this.isOfflineOrNotPlayable=()=>"offline"===this.source||!(!this.study||!this.study.data)||!He(this.data),this.unload=()=>{this.autoplay.stop(),this.ceval&&this.ceval.destroy()},this._deleteNode=e=>{this.tree.deleteNodeAt(e),this.contextMenu=null,ht(this.path,e)?this.userJump(pt(e)):this.jump(this.path)},this.updateHref=oe((()=>{n.setQueryParams({tabId:this.currentTab(this.availableTabs()).id,ply:String(this.node.ply),curFen:this.node.fen})}),200),this.canEvalGet=e=>e.ply<15,this.sendMove=(e,t,a)=>{const n={orig:e,dest:t,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};a&&(n.promotion=a),this.practice&&this.practice.onUserMove(),Bt(n).then(this.addNode).catch((e=>{}))},this.userMove=(e,t,a)=>{a?pe.capture():pe.move(),Be.start(this,e,t,this.sendMove)||this.sendMove(e,t)},this.userNewPiece=(e,t)=>{if(Yn.drop(e.role,t,this.node.drops)){pe.move();const a={role:e.role,pos:t,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};Gt(a).then(this.addNode).catch((e=>{this.jump(this.path)}))}else this.jump(this.path)},this.addNode=({situation:e,path:t})=>{const a=this.node,n={id:e.id,ply:e.ply,fen:e.fen,children:[],dests:e.dests,drops:e.drops,check:e.check,end:e.end,player:e.player,checkCount:e.checkCount,uci:e.uci,san:e.san,crazyhouse:e.crazyhouse,pgnMoves:a&&a.pgnMoves?a.pgnMoves.concat(e.pgnMoves):e.pgnMoves};if(void 0===t)return;const s=this.tree.addNode(n,t);s&&(this.jump(s),this.debouncedScroll(),c())},this.onCevalMsg=(e,t,a)=>{t?this.tree.updateAt(e,(n=>{var s;if(n.fen===t.fen||a){if(a){const e=t;(!n.threat||lt(e,n.threat)||(null===(s=n.threat)||void 0===s?void 0:s.maxDepth)<e.maxDepth)&&(n.threat=e)}else!n.ceval||lt(t,n.ceval)?n.ceval=t:t.cloud||(n.ceval.cloud&&this.ceval.isDeeper?n.ceval=t:t.maxDepth>n.ceval.maxDepth&&(n.ceval.maxDepth=t.maxDepth));n.ceval&&n.ceval.pvs.length>0&&(n.ceval.best=n.ceval.pvs[0].moves[0]),e===this.path&&(this.retro&&this.retro.onCeval(),this.practice&&this.practice.onCeval(),t.cloud&&t.depth>=this.ceval.effectiveMaxDepth()&&this.ceval.stop(),c())}})):"ceval"===this.currentTab(this.availableTabs()).id&&c()},this.debouncedStartCeval=oe(this.startCeval,500,{trailing:!0}),this.getNodeSituation=oe((()=>{this.node&&!this.node.dests&&zt({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path}).then((({situation:e,path:t})=>{this.tree.updateAt(t,(t=>{t.dests=e.dests,t.end=e.end,t.player=e.player})),t===this.path&&(this.updateBoard(),c(),this.gameOver()&&this.stopCevalImmediately())})).catch((e=>{}))}),50),this.fetchOpening=oe((()=>{if(he()&&this.node&&void 0===this.node.opening&&this.node.ply<=20&&this.node.ply>0&&ge.has(this.data.game.variant.key)){const e={fen:this.node.fen,path:this.path},t=this.data.game.variant.key;"standard"!==t&&(e.variant=t),this.tree.updateAt(this.path,(t=>{t.opening=null,this.socket.ask("opening","opening",e).then((e=>{e.opening&&e.path&&(t.opening=e.opening,e.path===this.path&&c())})).catch(ye)}))}}),50),this.synthetic=it(e),this.ongoing=!this.synthetic&&He(e),this.initialPath=ft,this.study=void 0!==t?new StudyCtrl(t,this):void 0,this.forecast=e.forecast?new ForecastCtrl(e):void 0,this._currentTabIndex=this.study&&0!==this.study.data.chapter.tags.length||!this.synthetic?1:0,-1===h.analyse.supportedVariants.indexOf(this.data.game.variant.key)&&(T.show({text:`Analysis board does not support ${this.data.game.variant.name} variant.`,position:"center",duration:"short"}),n.set("/")),this.tree=gt(yt(this.data.treeParts)),this.settings=Xt.controller(this),this.menu=Lt.controller(this),this.continuePopup=Ae.controller(),this.autoplay=new Autoplay(this),this.notes=u.isConnected()&&"correspondence"===this.data.game.speed?new Ue(this.data):null,this.retro=null,this.practice=null;const l=(()=>{const e=this.study&&this.study.data;if(!ct.includes(this.data.game.variant.key))return!1;if(e&&!e.chapter.features.computer&&!e.chapter.practice)return!1;return!!S(this.data.game.fen).unwrap((e=>Oe(be(this.data.game.variant.key),e).unwrap((()=>!0),(()=>!1))),(()=>!1))&&this.isOfflineOrNotPlayable()})();this.ceval=new CevalCtrl({allowed:l,variant:this.data.game.variant.key,multiPv:h.analyse.cevalMultiPvs(),cores:h.analyse.cevalCores(),hashSize:h.analyse.cevalHashSize(),infinite:h.analyse.cevalInfinite()},this.onCevalMsg);const p=!this.study||this.study.data.chapter.features.explorer;this.explorer=as(this,p),this.debouncedExplorerSetStep=oe(this.explorer.setStep,le(h.game.animations())+50);const m=void 0!==o?o:this.tree.lastPly();this.gamePath=this.synthetic||this.ongoing?void 0:bt(vt(this.tree.root));const v=vt(this.tree.root);if(this.initialPath=wt(v,(e=>e.ply<=m)),this.setPath(this.initialPath),this.data.game.createdAt&&(this.formattedDate=we(new Date(this.data.game.createdAt))),this.study?this.socket=this.study.createSocket():!this.data.analysis&&u.isConnected()&&Wt(this.data)&&Xe(this.data)&&void 0!==this.data.url&&void 0!==this.data.player.version?this.socket=ue.createGame(this.data.url.socket,this.data.player.version,is(this),this.data.url.round):this.socket=ue.createAnalysis(is(this)),this.synthetic||setTimeout((()=>{this.socket.send("startWatching",this.data.game.id)}),1e3),this.evalCache=function({variant:e,canGet:t,getNode:a,receive:n,socketIface:s}){const i=new Set;return{fetch(n,o){const r=a();if(r.ceval&&r.ceval.cloud||!t(r))return;if(i.has(r.fen))return;i.add(r.fen);const l={fen:r.fen,path:n};"standard"!==e&&(l.variant=e),o>1&&(l.mpv=o),s.send("evalGet",l)},onCloudEval(e){n(e.path,function(e){const t={fen:e.fen,nodes:1e3*e.knodes,depth:e.depth,pvs:e.pvs.map((e=>{const t={moves:e.moves.split(" ")};return void 0!==e.cp?t.cp=e.cp:t.mate=e.mate,t})),cloud:!0};return void 0!==t.pvs[0].cp?t.cp=t.pvs[0].cp:t.mate=t.pvs[0].mate,t.cloud=!0,t}(e))}}}({variant:this.data.game.variant.key,canGet:this.canEvalGet,getNode:()=>this.node,receive:this.onCevalMsg,socketIface:this.socket}),this.updateBoard(),r){const e=this.currentTabIndex(this.availableTabs()),t=this.availableTabs().findIndex((e=>e.id===r));t>=0&&e!==t&&this.onTabChange(t)}"explorer"===this.currentTab(this.availableTabs()).id&&this.debouncedExplorerSetStep(),setTimeout(this.debouncedScroll,250),setTimeout(this.initCeval,1e3)}playerName(e){const t=tt(this.data,e);return this.study?Va(this.study.data,e)||"Anonymous":F(t)}topColor(){return v(this.bottomColor())}bottomColor(){return this.settings.s.flip?v(this.data.orientation):this.data.orientation}turnColor(){return dt(this.node.ply)}promote(e,t){this.tree.promoteAt(e,t),this.contextMenu=null,this.jump(e)}deleteNode(e){const t=this.tree.nodeAtPath(e);if(!t)return;const a=kt(t);a.nodes>=10||a.comments>0?ke.confirm({title:"Confirm",message:`Delete ${a.nodes} move(s)`+(a.comments?` and ${a.comments} comment(s)`:"")+"?"}).then((()=>this._deleteNode(e))):this._deleteNode(e)}restartPractice(){this.practice=null,this.togglePractice()}mergeAnalysisData(e){this.analysisProgress||(this.analysisProgress=!0,c()),this.tree.merge(e.tree),this.data.analysis=e.analysis;const t=vt(e.tree);t.every((e=>void 0!==e.eval||!(!e.san||!e.san.includes("#"))))&&(this.data.treeParts=t,this.analysisProgress=!1,this.retroGlowing=!0,setTimeout((()=>{this.retroGlowing=!1,c()}),8e3),pe.dong(),Dt.quick(),c()),this.retro&&this.retro.onMergeAnalysisData(),c()}gameOver(e){const t=e||this.node;if(!t)return!1;if(void 0===t.end){if(t.check){const e=t.san;return!!!(!e||"#"!==e[e.length-1])&&"checkmate"}return!1}return!!t.end&&(t.check?"checkmate":"draw")}nextNodeBest(){return xt(this.node,(e=>e.eval?e.eval.best:void 0))}mainlinePathToPly(e){return wt(this.mainline,(t=>t.ply<=e))}prev(){return this.userJump(pt(this.path),"backward"),!0}updateBoard(e){const t=this.node;"threeCheck"!==this.data.game.variant.key||t.checkCount||(t.checkCount=Pe(t.fen));const a=dt(t.ply),n=xe(t.dests),s={variant:this.data.game.variant.key,fen:t.fen,turnColor:a,orientation:this.settings.s.flip?v(this.orientation):this.orientation,movableColor:this.gameOver()?null:a,dests:n||null,check:!!t.check,lastMove:t.uci?L(t.uci):null,otb:!0,shift:e};this.cgConfig=s,this.data.game.player=a,this.chessground?this.chessground.set(s):this.chessground=ss.make(s,this.orientation,this.userMove,this.userNewPiece),n||this.getNodeSituation()}}export{AnalyseCtrl as A,Gn as a,Ft as g,Bn as l,zn as o,Dn as r};
