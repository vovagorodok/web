import{a5 as t,g as e,o as s,a6 as i,p as a,y as n,m as o,aF as r,aG as h,a9 as l,af as c,aJ as p,K as d,aK as u,bh as m,bi as v,bj as f,I as g,bk as y,r as w,bl as b,bm as k,aZ as M,aE as j,aH as N,aI as P,bn as G,s as O,aL as E,G as F,aM as S,aN as L}from"./main.js";import{a as _,b as T}from"./offlineGames-90731ac9.js";import{p as x,e as A}from"./fen-f2d95e2d.js";import{l as C}from"./layout-ae040024.js";import{a as I,c as R,v as $}from"./crazyValid-02be4753.js";import{G as D}from"./GameTitle-fb417b3c.js";import{B as U}from"./Board-0ecb6fca.js";import{r as B,a as H,c as V,e as K,j as z,b as J,s as Q,R as W,g as X,d as Z}from"./view-b29da5fb.js";import{v as q,c as Y,p as tt}from"./promotion-070b22ca.js";import{c as et,g as st}from"./game-b6f212b0.js";import{S as it}from"./index-c70fdca8.js";import{i as at}from"./chess-a4e99343.js";import{v as nt}from"./vibrate-2d0ad158.js";import"./perfs-d8ca398c.js";import"./countries-a19495bf.js";import"./CountdownTimer-c8587446.js";import"./tournamentXhr-291e93e6.js";import"./toInteger-da417924.js";import"./chat-2370f74a.js";function ot(){const t=e.ai.availableOpponents.map((t=>["aiNameLevelAiLevel",t[1],t[0],t[1]]));return s("div.select_input",i.renderSelect("opponent","opponent",t,e.ai.opponent))}var rt={controller:function(t){let e=!1;function s(t){"backbutton"!==t&&e&&o.backbutton.stack.pop(),e=!1}return{open:function(){o.backbutton.stack.push(s),e=!0},close:s,isOpen:()=>e,root:t}},view:e=>t("offline_actions",void 0,(()=>[B(e.root)].concat(H(e.root),function(t){return et(t.data)?s("button[data-icon=b]",{oncreate:n((()=>{t.actions.close(),t.resign()}))},a("resign")):null}(e.root),function(t){return[s("button[data-icon=A]",{oncreate:n(t.goToAnalysis)},a("analysis")),s("div.action.opponentSelector",[ot()])]}(e.root))),e.isOpen(),e.close)};const ht=[["white","white"],["black","black"],["randomColor","random"]];var lt={controller(t){const e=c(!1);function s(t){"backbutton"!==t&&!0===e()&&o.backbutton.stack.pop(),e(!1)}return{open:function(){o.backbutton.stack.push(s),e(!0)},close:s,isOpen:e,root:t}},view:c=>c.isOpen()?t("new_offline_game",void 0,(function(){const t=e.ai.availableVariants,p=c.root.vm.setupFen?t.filter((t=>!r.has(t[1]))):t,d=e.ai.variant(),u=c.root.vm.setupFen&&r.has(d),m=e.ai.color(),v="random"!==m?m:"white";return s("div",null,s("div",{className:"action"},ot(),s("div",{className:"select_input"},i.renderSelect("side","color",ht,e.ai.color)),u?s("div",{className:"select_input disabled"},s("label",{for:"variant"},a("variant")),s("select",{disabled:!0,id:"variant"},s("option",{value:d,selected:!0},h(d).name))):s("div",{className:"select_input"},i.renderSelect("variant","variant",p,e.ai.variant)),c.root.vm.setupFen?s("div",{className:"from_position_wrapper"},s("p",null,a("fromPosition")),s("div",{className:"from_position"},s("div",{style:{width:"130px",height:"130px"},oncreate:n((()=>{c.root.vm.setupFen&&o.set(`/editor/${encodeURIComponent(c.root.vm.setupFen)}`)}))},s(l,{fen:c.root.vm.setupFen,orientation:v})))):null),s("div",{className:"popupActionWrapper"},s("button",{className:"defaultButton",oncreate:n((()=>{c.root.startNewGame(e.ai.variant(),c.root.vm.setupFen)}))},a("play"))))}),c.isOpen(),(()=>{c.root.vm.setupFen&&o.set("/ai"),c.close()})):null};class Engine{constructor(t,e){this.ctrl=t,this.variant=e,this.level=1,this.isInit=!1,this.listener=t=>{const e=t.output.match(/^bestmove (\w{4,5})|^bestmove ([PNBRQ]@\w{2})/);e&&(e[1]?this.ctrl.onEngineMove(e[1]):e[2]&&this.ctrl.onEngineDrop(e[2]))},this.stockfish=new m(e)}async init(){try{if(!this.isInit){await this.stockfish.start(),this.isInit=!0,window.addEventListener("stockfish",this.listener,{passive:!0}),await this.stockfish.setVariant(),await this.stockfish.setOption("Threads",v());const t=await f();"web"!==g.getPlatform()&&await this.stockfish.setOption("Hash",t),await this.newGame()}}catch(t){}}async newGame(){await this.stockfish.send("ucinewgame"),await this.stockfish.isReady(),await this.stockfish.setOption("UCI_AnalyseMode",!1),await this.stockfish.setOption("UCI_LimitStrength",!0)}async search(t,e){var s;await this.stockfish.send(`position fen ${t} moves ${e}`),await this.stockfish.send(`go movetime ${s=this.level,s*ct/8} depth ${function(t){return dt[t]}(this.level)}`)}async setLevel(t){return this.level=t,"ios"===g.getPlatform()||"android"===g.getPlatform()?this.stockfish.setOption("UCI_Elo",(e=this.level,String(ut[e]))):this.stockfish.setOption("Skill Level",String(function(t){return Math.round(pt/7*(t-1))}(this.level)));var e}async exit(){return window.removeEventListener("stockfish",this.listener,!1),this.stockfish.exit()}}const ct=5e3,pt=20,dt={1:5,2:5,3:5,4:5,5:5,6:8,7:13,8:22},ut={1:1350,2:1500,3:1600,4:1700,5:2e3,6:2300,7:2700,8:2850};class AiRound{constructor(t,s,i,a){if(this.promoting=null,this.goToAnalysis=()=>{this.replay&&o.set(`/analyse/offline/ai/${this.data.player.color}?ply=${this.replay.ply}&curFen=${this.replay.situation().fen}`)},this.sharePGN=()=>{var t;null===(t=this.replay)||void 0===t||t.pgn(this.white(),this.black()).then((t=>it.share({text:t.pgn})))},this.playerName=()=>this.data.player.username,this.onEngineMove=t=>{const e=t.slice(0,2),s=t.slice(2,4),i=y(t);this.vm.engineSearching=!1,this.chessground.apiMove(e,s),this.addMove(e,s,i),w()},this.onEngineDrop=t=>{var e;const s=b(t),i=k(t),a={role:i,color:this.data.opponent.color};this.vm.engineSearching=!1,this.chessground.apiNewPiece(a,s),null===(e=this.replay)||void 0===e||e.addDrop(i,s),w()},this.engineMove=()=>{this.vm.engineSearching=!0;const t=this.replay.situation();setTimeout((()=>{const e=this.getOpponent().level;this.data.opponent.name=M({ai:e}),this.engine.init().then((()=>this.engine.setLevel(e))).then((()=>this.engine.search(this.data.game.initialFen,t.uciMoves.join(" "))))}),500)},this.isEngineToMove=()=>{const t=this.replay.situation();return!t.end&&t.player!==this.data.player.color},this.addMove=(t,e,s)=>{var i;null===(i=this.replay)||void 0===i||i.addMove(t,e,s),this.chessground.setLastPromotion(s)},this.onPromotion=(t,e,s)=>{this.addMove(t,e,s)},this.userMove=(t,e,s)=>{s.promote&&Y(this.chessground.state,e)?this.addMove(t,e,s.promote):tt.start(this,t,e,this.onPromotion)||this.addMove(t,e)},this.onMove=(t,e,s)=>{s?"atomic"===this.data.game.variant.key?(I.capture(this.chessground,e),j.explosion()):j.capture():j.move(),nt.tap()},this.onUserNewPiece=(t,e)=>{var s;const i=this.replay.situation();R.drop(this.data,t,e,i.drops)?null===(s=this.replay)||void 0===s||s.addDrop(t,e):this.apply(this.replay.situation())},this.onNewPiece=()=>{j.move()},this.onReplayAdded=t=>{this.data.game.fen=t.fen,this.apply(t),Q(this,t.status),st.finished(this.data)?this.onGameEnd(t.status):this.isEngineToMove()&&this.engineMove(),this.save(),w()},this.onThreefoldRepetition=t=>{Q(this,t),this.save(),this.onGameEnd(t)},this.onGameEnd=t=>{this.chessground.stop(t),setTimeout((()=>{this.actions.open(),w()}),500)},this.resign=()=>{const t={id:31,name:"resign"};Q(this,t,N(this.data.player.color)),this.save(),this.onGameEnd(t)},this.firstPly=()=>this.data.player.color===N(this.firstPlayerColor())?1:0,this.lastPly=()=>this.replay.situations.length-1,this.jump=(t,e)=>(this.chessground.cancelMove(),this.replay.ply===t||t<0||t>=this.replay.situations.length||(this.replay.ply=t,this.apply(this.replay.situation(),e)),!1),this.jumpFirst=()=>this.jump(this.firstPly(),"undo"),this.jumpPrev=()=>{const t=this.replay.ply;if(this.data.player.color===N(this.firstPlayerColor())){const e=t%2==0?1:2;return this.jump(t-e,"undo")}{const e=t%2==0?2:1;return this.jump(t-e,"undo")}},this.jumpNext=()=>{const t=this.replay.ply;return this.jump(t+(t+2>=this.replay.situations.length?1:2),"redo")},this.jumpLast=()=>this.jump(this.lastPly(),"redo"),this.canDrop=()=>!0,this.actions=rt.controller(this),this.newGameMenu=lt.controller(this),this.moveList=!!e.game.moveList(),this.vm={engineSearching:!1,setupFen:s,savedFen:t?t.data.game.fen:void 0},s)this.newGameMenu.isOpen(!0),a&&e.ai.color(a),i&&e.ai.variant(i),w();else{const s=e.ai.variant();if(t)try{this.init(t.data,t.situations,t.ply)}catch(t){this.startNewGame(s)}else this.startNewGame(s)}}init(t,e,s){this.newGameMenu.close(),this.actions.close(),this.data=t;const i=this.data.game.variant.key,a=this.data.game.initialFen;this.replay?this.replay.init(i,a,e,s):this.replay=new W(i,a,e,s,this.onReplayAdded,this.onThreefoldRepetition),this.chessground?X.reload(this.chessground,this.data,this.replay.situation()):this.chessground=X.make(this.data,this.replay.situation(),this.userMove,this.onUserNewPiece,this.onMove,this.onNewPiece),this.engine&&this.engine.variant===i?this.engine.newGame().then((()=>{this.isEngineToMove()&&this.engineMove()})):(this.engine&&(this.engine.exit(),this.engine=void 0),this.engine=new Engine(this,i),this.engine.init().then((()=>{this.isEngineToMove()&&this.engineMove()}))),this.save(),w()}startNewGame(t,e,s,i){const a={variant:t};e&&(a.fen=e),at(a).then((t=>{this.init(Z({id:"offline_ai",variant:t.variant,initialFen:t.setup.fen,fen:t.setup.fen,color:i||mt(),player:t.setup.player}),[t.setup],0)})).then((()=>{e&&(this.vm.setupFen=void 0,o.History.replaceState(void 0,"/ai"))}))}save(){this.replay&&_({data:this.data,situations:this.replay.situations,ply:this.replay.ply})}white(){return"white"===this.data.player.color?this.data.player.username:this.getOpponent().name}black(){return"black"===this.data.player.color?this.data.player.username:this.getOpponent().name}getOpponent(){const t=e.ai.opponent(),s=e.ai.availableOpponents.find((e=>e[1]===t)),i=s&&s.length&&s[0]||"Stockfish";return{name:a("aiNameLevelAiLevel",i,t),level:parseInt(t)||1}}player(){return this.data.player.color}apply(t,e){if(t){const s=t.uciMoves.length?t.uciMoves[t.uciMoves.length-1]:null;this.chessground.set({fen:t.fen,turnColor:t.player,lastMove:s?P(s):null,dests:t.dests,movableColor:t.player===this.data.player.color?t.player:null,check:t.check,shift:e})}}firstPlayerColor(){return x(this.data.game.initialFen)}}function mt(){let t=e.ai.color();return"random"===t&&(t=G(0,2)>1?"white":"black"),t}var vt={oninit({attrs:t}){O.createDefault(),T().then((e=>{const s=t.fen,i=t.variant,a=t.color;this.round=new AiRound(e,s,i,a)})),E()},oncreate:F,onremove(){var t;S(),this.round&&(null===(t=this.round.engine)||void 0===t||t.exit())},view({attrs:t}){let e,i;if(this.round&&this.round.data&&this.round.chessground&&this.round.engine)i=L(s(D,{data:this.round.data})),e=function(t){const e=t.chessground.getMaterialDiff(),i=p(),a=d(),n=s("h2",null,t.getOpponent().name,t.vm.engineSearching?s("span",{className:"engineSpinner fa fa-hourglass-half"}):null),o=s(U,{variant:t.data.game.variant.key,chessground:t.chessground});return i?[u(a,i)?V(t):null,K(t,n,e[t.data.opponent.color],"opponent"),o,K(t,t.playerName(),e[t.data.player.color],"player"),z(t)]:[o,s("section",{className:"table offline"},K(t,n,e[t.data.opponent.color],"opponent"),J(t),z(t),K(t,t.playerName(),e[t.data.player.color],"player"))]}(this.round);else{const s=t.fen||A,n=x(s);i=L(a("computer")),e=$(s,n,void 0)}return C.board(i,e,void 0,this.round&&(n=this.round,[rt.view(n.actions),lt.view(n.newGameMenu),q(n)]));var n}};export{vt as default};
