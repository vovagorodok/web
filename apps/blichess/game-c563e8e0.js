import{bg as e,k as t,bh as a,bi as n,bj as i,bk as o,s as r,W as s,al as l,aC as c,b8 as d,b as h,m as u,o as g,$ as p,V as b,aD as m,ab as f,ak as v,aA as w,bl as y,r as T,a3 as C,bm as j,bn as I,aB as _,bo as x,bp as k,aR as P,S as A,at as N,av as R,bq as B,br as L}from"./main.js";import{v as O}from"./vibrate-5a029184.js";import{e as U}from"./fen-f2d95e2d.js";import{n as W,l as E,o as D}from"./game-51118656.js";import{v as F,e as G}from"./crazyValid-6d95db62.js";import{l as S}from"./layout-b3635a82.js";import{O as V}from"./OnlineRound-bf34d9a3.js";import{S as H}from"./index-38489b13.js";import"./perfs-d8ca398c.js";import"./countries-a19495bf.js";import"./GameTitle-46b0cab9.js";import"./CountdownTimer-c0405f18.js";import"./Board-591a9bd0.js";import"./promotion-87163dc0.js";import"./tournamentXhr-ac80abd2.js";import"./toInteger-62ca6ec9.js";import"./chat-bb3d94b0.js";class ChallengeCtrl{constructor(s){this.data=s,this.joinChallenge=()=>{const n=this.challenge;return n?e(n.id).then((e=>{clearTimeout(this.pingTimeoutId),t.set("/game"+e.url.round,!0)})).then((()=>a.remove(n.id))):Promise.reject("no challenge")},this.declineChallenge=()=>{const e=this.challenge;return e?n(e.id).then((()=>{clearTimeout(this.pingTimeoutId),a.remove(e.id)})).then(t.backHistory):Promise.reject("no challenge")},this.cancelChallenge=()=>{const e=this.challenge;return e?i(e.id).then((()=>{clearTimeout(this.pingTimeoutId),a.remove(e.id)})).then(t.backHistory):Promise.reject("no challenge")},this.unload=()=>{clearTimeout(this.pingTimeoutId)},this.reloadChallenge=()=>{const e=this.challenge;e&&o(e.id).then((e=>{switch(this.challenge=e.challenge,e.challenge.status){case"accepted":t.set(`/game/${e.challenge.id}`,!0);break;case"declined":t.backHistory()}}))},this.pingNow=()=>{clearTimeout(this.pingTimeoutId),this.pingTimeoutId=setTimeout(this.pingNow,2e3),this.socket&&this.socket.send("ping")},this.onSocketOpen=()=>{this.reloadChallenge(),this.pingNow()},this.challenge=s.challenge,this.socket=r.createChallenge(s.challenge.id,s.socketVersion,this.onSocketOpen,{reload:this.reloadChallenge})}}class ClipboardWeb extends s{async write(e){if("undefined"==typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if(void 0!==e.string)await this.writeText(e.string);else if(e.url)await this.writeText(e.url);else{if(!e.image)throw new Error("Nothing to write");if("undefined"==typeof ClipboardItem)throw this.unavailable("Writing images to the clipboard is not supported in this browser");try{const t=await(await fetch(e.image)).blob(),a=new ClipboardItem({[t.type]:t});await navigator.clipboard.write([a])}catch(e){throw new Error("Failed to write image")}}}async read(){if("undefined"==typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if("undefined"==typeof ClipboardItem)return this.readText();try{const e=await navigator.clipboard.read(),t=e[0].types[0],a=await e[0].getType(t);return{value:await this._getBlobData(a,t),type:t}}catch(e){return this.readText()}}async readText(){if("undefined"==typeof navigator||!navigator.clipboard||!navigator.clipboard.readText)throw this.unavailable("Reading from clipboard not supported in this browser");return{value:await navigator.clipboard.readText(),type:"text/plain"}}async writeText(e){if("undefined"==typeof navigator||!navigator.clipboard||!navigator.clipboard.writeText)throw this.unavailable("Writting to clipboard not supported in this browser");await navigator.clipboard.writeText(e)}_getBlobData(e,t){return new Promise(((a,n)=>{const i=new FileReader;t.includes("image")?i.readAsDataURL(e):i.readAsText(e),i.onloadend=()=>{const e=i.result;a(e)},i.onerror=e=>{n(e)}}))}}const $=l("Clipboard",{web:()=>new ClipboardWeb});function Y(e){let n,i=F(d,"white");const o=e.challenge,r=c("lichess.org");return o&&(i=F(o.initialFen||d,"white"),"in"===o.direction?n=function(e,a){let n;n=a.rated&&!h.isConnected()?u("div.error",[g("thisGameIsRated"),u("br"),u("br"),g("youNeedAnAccountToDoThat"),u("div.go_or_cancel",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p(f.open)},g("signIn")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(t.backHistory)},g("cancel"))])]):h.isConnected()?u("div.go_or_cancel",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p(e.joinChallenge)},g("join")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(e.declineChallenge)},g("decline"))]):u("div",[u("button[data-icon=E].withIcon",{oncreate:p(e.joinChallenge)},g("join"))]);const i=a.challenger?g("playerisInvitingYou",M(a.challenger)):g("playerisInvitingYou","Anonymous");return b("join_url_challenge",void 0,(function(){return u("div.infos",[u("div.challenger",i),u("br"),J(a),u("br"),n])}),!0)}(e,o):"out"===o.direction&&(n=o.destUser?function(e,n){function i(){return u("div.infos",[u("div",g("waitingForOpponent")),u("br"),u("div.user",M(n.destUser)),J(n),u("br"),m.getVdom(),u("br"),u("br"),u("button.withIcon[data-icon=L]",{oncreate:p(e.cancelChallenge)},g("cancel")),a.isPersistent(n)?u("div",[u("br"),u("button",{oncreate:p((()=>t.set("/")))},[u("span.fa.fa-home"),g("Return to home")])]):null])}return b("await_url_challenge",void 0,i,!0)}(e,o):function(e,n){const i=a.isPersistent(n);return b("await_url_challenge",void 0,(function(){return u("div.infos",[J(n),u("br"),u("p.explanation",g("toInviteSomeoneToPlayGiveThisUrl")),u("div.copy_container",[u("div.icon_container",[u("span.fa.fa-clipboard")]),u("input.lichess_game_url",{oncreate:p((function(){$.write({url:q(n)}),v.show({text:"Copied to clipboard",position:"center",duration:"short"})})),value:q(n),readonly:!0})]),u("p.explanation.small",g("theFirstPersonToComeOnThisUrlWillPlayWithYou")),u("div.go_or_cancel.clearfix",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p((function(){H.share({url:q(n)})}))},g("shareGameUrl")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(e.cancelChallenge)},g("cancel"))]),i?u("div",[u("br"),u("button",{oncreate:p((()=>t.set("/")))},[u("span.fa.fa-home"),g("Return to home")])]):null])}),!0)}(e,o))),S.board(r,i,"challenge",n)}function q(e){return"https://lichess.org/"+e.id}function J(e){const t=e.rated?g("rated"):g("casual"),n=a.challengeTime(e);return u("div",{className:"gameInfos"},u("span",{"data-icon":"p"},n)," • ",u("span",null,e.variant.name)," • ",u("span",null,t))}function M(e){const t=e.rating+(e.provisional?"?":"");return`${e.name} (${t})`}var z={oninit(e){w();const a=performance.now();y(e.attrs.id,e.attrs.color).then((n=>{void 0!==n.challenge?(e.state.challenge=new ChallengeCtrl(n),T()):function(e){return void 0!==e.url}(n)&&function(e,a,n){if(n.player.spectator||W(n)){if(E(n)&&0===D(n,n.player.color)){N.dong(),O.quick();const e=R(n.game.variant.key),t=function(e){return"game.variant.prompt."+e}(n.game.variant.key);e.alert&&-1===[1,3].indexOf(e.id)&&!B.get(t)&&L.alert({title:"Alert",message:e.alert}).then((()=>{B.set(t,!0)}))}const t=performance.now()-a;setTimeout((()=>{const t=Number(e.attrs.ply),a=isNaN(t)?void 0:t;e.state.round=new V(!!e.attrs.goingBack,e.attrs.id,n,!1,void 0,void 0,a)}),Math.max(400-t,0)),A.resetLastJoined(),void 0===n.player.user&&B.set("lastPlayedGameURLAsAnon",n.url.round)}else v.show({text:g("unsupportedVariant",n.game.variant.name),position:"center",duration:"short"}),t.set("/")}(e,a,n)})).catch((e=>{C(e),t.set("/")}))},oncreate(e){e.attrs.goingBack?j(e.dom):I(e.dom)},onremove(){_(),r.destroy(),this.round&&this.round.unload(),this.challenge&&this.challenge.unload()},view({attrs:e}){if(this.round)return G(this.round);if(this.challenge)return Y(this.challenge);const t=A.lastJoined();let a;if(t)a=F(t.fen,t.color,t.lastMove,t.variant.key);else{const t=x.get(e.id);a=t?F(t.fen,t.orientation):F(U,"white")}return S.board(e.goingBack?k():P(),a)}};export{z as default};
