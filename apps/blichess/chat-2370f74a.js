import{m as t,b3 as e,b4 as s,r as n,b5 as i,ao as o,o as a,y as r,ae as l,p as h,b6 as c,ah as u,b7 as d}from"./main.js";class Chat{constructor(i,o,a,r,l,h,c){this.socket=i,this.id=o,this.player=r,this.writeable=l,this.isShadowban=h,this.storeKey=c,this.open=()=>{t.backbutton.stack.push(e(this.close,"chat")),this.showing=!0,this.nbUnread=0},this.close=e=>{s.hide(),"backbutton"!==e&&this.showing&&t.backbutton.stack.pop(),this.showing=!1,this.nbUnread=0,this.storeNbLinesRead()},this.onReload=t=>{void 0!==t&&(this.lines=t,this.checkUnreadFromStorage())},this.append=t=>{this.lines.push(t),"lichess"!==t.u&&this.nbUnread++,n()},this.isLegitMsg=t=>{var e,s,n;return!(t.d||t.r&&t.u!==(null===(s=null===(e=this.player)||void 0===e?void 0:e.user)||void 0===s?void 0:s.username)||(n=t.t,/chess-bot/.test(n)))},this.showing=!1,this.lines=a,this.inputValue="",this.nbUnread=0,this.checkUnreadFromStorage()}selectLines(){let t;const e=[];return this.lines.forEach((s=>{var n,i;!this.isLegitMsg(s)||t&&(i=s,(n=t).d&&i.d&&n.u===i.u)||e.push(s),t=s})),e}nbLines(){return this.lines.filter(this.isLegitMsg).length}checkUnreadFromStorage(){(async function(t,e){var s;return await y(t),null===(s=m[t].readCounts)||void 0===s?void 0:s.get(e)})(this.storeKey,this.id).then((t=>{const e=t||0,s=this.nbLines();void 0!==this.lines&&e<s&&(this.nbUnread=this.nbUnread+(s-e),n())}))}storeNbLinesRead(){const t=this.nbLines();t>0&&i((()=>{!async function(t,e,s){await y(t);const n=m[t];n.readCounts&&(n.readCounts.set(e,s),o.set(n.key,n.readCounts.toJSON()))}(this.storeKey,this.id,t)}))}}function p(t,s){return t.showing?a("div#chat.modal",{oncreate:c},[a("header",[a("button.modal_close",{oncreate:r(e(t.close,"chat"))},l),a("h2",s||h("chatRoom"))]),a("div#chat_content.modal_content.chat_content",[a("ul.chat_scroller.native_scroller",{oncreate:({dom:e})=>g(t,e),onupdate:({dom:e})=>g(t,e)},t.selectLines().map(((e,s,n)=>void 0!==t.player?function(t,e,s,n){const i="lichess"===e.u,o=e.c?e.c===t.color:t.user&&e.u===t.user.username;let r=!0;const l=n[s+1];let h;l&&(h=l.c?l.c===t.color:t.user&&l.u===t.user.username);void 0!==h&&(r=h!==o);return a("li.chat_msg.allow_select",{className:u({system:i,player:!!o,opponent:!i&&!o,close_balloon:r})},e.t)}(t.player,e,s,n):function(t){const e="lichess"===t.u;return a("li.spectator_chat_msg.allow_select",{className:u({system:e})},e?t.t:[a("strong",t.u),a.trust("&nbsp;"),a.trust("&nbsp;"),a("span",t.t)])}(e)))),a("form.chat_form",{onsubmit(e){e.preventDefault();const s=e.target[0];s.focus();const n=s.value.trim();if(!b(n))return;t.inputValue="",s.setAttribute("rows","1"),s.style.paddingTop="8px",t.socket.send("talk",n);const i=document.getElementById("chat_send");return i&&i.classList.add("disabled"),!1}},[a("textarea#chat_input.chat_input",{placeholder:t.writeable?h("talkInChat"):"Chat is disabled.",disabled:!t.writeable,rows:1,maxlength:140,value:t.inputValue,style:{lineHeight:"18px",margin:"8px 0 8px 10px",paddingTop:"8px"},oninput(e){const s=e.target;s.value.length>140&&(s.value=s.value.substr(0,140)),t.inputValue=s.value;const n=window.getComputedStyle(s),i=parseInt(n.lineHeight||"18",10),o=function(t,e){const s=t.style.height,n=t.scrollHeight,i=t.style.overflow;let o=t.offsetHeight;if(o>=n&&(t.style.height=o+e+"px",t.style.overflow="hidden",n<t.scrollHeight)){for(;t.offsetHeight>=t.scrollHeight;)t.style.height=(o-=e)+"px";for(;t.offsetHeight<t.scrollHeight;)t.style.height=o+++"px";return t.style.height=s,t.style.overflow=i,o}return n}(s,i),a=Math.ceil(o/i),r=a<=1?1:a>5?5:a-1;s.setAttribute("rows",String(r)),s.style.paddingTop=1===r?"8px":"0";const l=document.getElementById("chat_send");l&&(b(t.inputValue)?l.classList.remove("disabled"):l.classList.add("disabled"))}}),a("button#chat_send.chat_send.fa.fa-telegram.disabled")])])]):null}function g(t,e){if(t.lines.length>5){(0===e.scrollTop||e.scrollTop>e.scrollHeight-e.clientHeight-100)&&(e.scrollTop=999999,setTimeout((()=>e.scrollTop=999999),300))}}function b(t){return!!t&&t.trim().length<=140}const m={Corres:{key:"corresChat"},Game:{key:"gameChat"},Study:{key:"studyChat"},Tournament:{key:"tourChat"}};function y(t){const e=m[t];return e.readCounts?Promise.resolve():o.get(e.key).then((t=>{e.readCounts=t?new d(100,t):new d(100)}))}export{Chat as C,p as c};
