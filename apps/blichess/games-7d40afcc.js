import{m as e,G as a,aD as t,p as s,h as r,P as o,k as n,g as l,d as i,r as c,a3 as m,c as d,aH as u,bv as g,bo as p,b,c8 as f,aC as h,ag as v}from"./main.js";import{l as k}from"./layout-b3635a82.js";import{G as P}from"./GameItem-be98102b.js";import{g as G,u as N}from"./userXhr-e893d0da.js";import{u as j}from"./userView-00e33bc7.js";import"./game-51118656.js";import"./perfs-d8ca398c.js";import"./html-1975aa10.js";import"./countries-a19495bf.js";function y(l){return e("div",{className:"userGamesWrapper"},e("div",{className:"select_input select_games_filter"},e("label",{htmlFor:"filterGames"}),e("select",{id:"filterGames",onchange:l.onFilterChange},l.scrollState.availableFilters.map((t=>e("option",{value:t.key,selected:l.scrollState.currentFilter===t.key},a(t.label,t.count)))))),function(a){const{games:l,paginator:i}=a.scrollState;return e("div",{id:"scroller-wrapper",className:"native_scroller userGame-scroller box",oncreate:s((e=>function(e,a){var t;const s=function(e){const a=e.target;return"BUTTON"===a.tagName?a:void 0}(a),r=null===(t=a.target)||void 0===t?void 0:t.closest(".tournament"),l=o(a),i=null==l?void 0:l.dataset.id,c=null==l?void 0:l.dataset.pid;if(i&&s)e.toggleBookmark(i);else if(r){const e=r.dataset.id;e&&n.set(`/tournament/${e}`)}else i&&e.goToGame(i,c)}(a,e)),void 0,o),onscroll:r(a.onScroll,30)},i?e("ul",{className:"userGames",oncreate:a.onGamesLoaded},l.map(((t,s)=>e(P,{key:t.id,g:t,index:s,boardTheme:a.boardTheme,userId:a.scrollState.userId}))),a.scrollState.isLoadingNextPage?e("li",{className:"list_item loadingNext"},"loading..."):null):e("div",{className:"loader_container"},t.getVdom("monochrome")))}(l))}const F={all:"nbGames",rated:"nbRated",win:"nbWins",loss:"nbLosses",draw:"nbDraws",bookmark:"nbBookmarks",me:"nbGamesWithYou",import:"nbImportedGames",playing:"nbPlaying"};let I;function T(e,a){let t=!1;const s=I&&e===I.userId,r=l.general.theme.board(),o={userId:e,user:void 0,availableFilters:[],currentFilter:a||"all",games:[],paginator:void 0,isLoadingNextPage:!1,scrollPos:0};function f(e){return e.paginator&&e.paginator.currentPageResults&&e.paginator.currentPageResults.forEach((e=>{e.date=d(new Date(e.timestamp))})),e}const h=i((()=>{I=o}),200),v=e=>{o.paginator=e.paginator,o.games=e.paginator.currentPageResults,setTimeout((()=>{const e=document.getElementById("scroller-wrapper");e&&(e.scrollTop=0)}),50),c()};return s?setTimeout((()=>{Object.assign(o,I),c()}),300):Promise.all([G(o.userId,o.currentFilter,1,!1).then(f),N(o.userId,!1)]).then((([e,a])=>{(e=>{o.user=e;const a=Object.keys(e.count).filter((a=>Object.prototype.hasOwnProperty.call(F,a)&&("all"===a||e.count[a]>0))).map((e=>({key:e,label:F[e],count:o.user?o.user.count[e]:0})));o.availableFilters=a})(a),v(e)})).catch((e=>{m(e)})),{scrollState:o,onScroll:e=>{const a=e.target,t=a.firstChild,s=o.paginator,r=s&&s.nextPage;var n;a.scrollTop+a.offsetHeight+50>t.offsetHeight&&!o.isLoadingNextPage&&r&&r<40&&(n=r,o.isLoadingNextPage=!0,G(o.userId,o.currentFilter,n).then(f).then((e=>{o.paginator=e.paginator,o.isLoadingNextPage=!1,o.games=o.games.concat(e.paginator.currentPageResults),h(),c()})),c()),o.scrollPos=a.scrollTop,h()},onGamesLoaded:({dom:e})=>{s&&!t&&u((()=>{e.parentNode.scrollTop=I.scrollPos,t=!0}))},onFilterChange:e=>{o.currentFilter=e.target.value,G(o.userId,o.currentFilter,1,!0).then(f).then(v)},toggleBookmark:e=>{g(e).then((()=>{const a=o.games.findIndex((a=>a.id===e)),t=o.games[a];if(t){const e=Object.assign({},t,{bookmarked:!t.bookmarked});o.games[a]=e,c()}})).catch(m)},boardTheme:r,goToGame:(a,t)=>{const s=o.games.find((e=>e.id===a));if(s){const r=s.players.white.user,o=r&&r.id===e?"white":"black";p.set(s.id,{fen:s.fen,orientation:o});b.getUserId()===e&&void 0!==t?n.set(`/game/${a}${t}?goingBack=1`):n.set(`/analyse/online/${a}/${o}?curFen=${s.fen}&slide=1`)}}}}const w={oncreate:f,oninit(e){this.ctrl=T(e.attrs.id,e.attrs.filter)},view(e){const{id:a,username:t,title:s,patron:r}=e.attrs,o=this.ctrl.scrollState.user,n=o?j(o.online,o.patron,o.username,o.title):j(!1,Boolean(r),t||a,s),l=h(null,v(n));return k.free(l,y(this.ctrl))}};export{w as default};
