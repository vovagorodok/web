import{k as t,aW as e,aX as s,r as n,aY as a,aj as i,m as o,$ as r,a6 as l,o as h,aZ as c,a9 as u,a_ as d}from"./main.js";class Chat{constructor(a,i,o,r,l,h,c){this.socket=a,this.id=i,this.player=r,this.writeable=l,this.isShadowban=h,this.storeKey=c,this.open=()=>{t.backbutton.stack.push(e(this.close,"chat")),this.showing=!0,this.nbUnread=0},this.close=e=>{s.hide(),"backbutton"!==e&&this.showing&&t.backbutton.stack.pop(),this.showing=!1,this.nbUnread=0,this.storeNbLinesRead()},this.onReload=t=>{void 0!==t&&(this.lines=t,this.checkUnreadFromStorage())},this.append=t=>{this.lines.push(t),"lichess"!==t.u&&this.nbUnread++,n()},this.isLegitMsg=t=>{var e,s,n;return!(t.d||t.r&&t.u!==(null===(s=null===(e=this.player)||void 0===e?void 0:e.user)||void 0===s?void 0:s.username)||(n=t.t,/chess-bot/.test(n)))},this.showing=!1,this.lines=o,this.inputValue="",this.nbUnread=0,this.checkUnreadFromStorage()}selectLines(){let t;const e=[];return this.lines.forEach((s=>{var n,a;!this.isLegitMsg(s)||t&&(a=s,(n=t).d&&a.d&&n.u===a.u)||e.push(s),t=s})),e}nbLines(){return this.lines.filter(this.isLegitMsg).length}checkUnreadFromStorage(){(async function(t,e){var s;return await y(t),null===(s=b[t].readCounts)||void 0===s?void 0:s.get(e)})(this.storeKey,this.id).then((t=>{const e=t||0,s=this.nbLines();void 0!==this.lines&&e<s&&(this.nbUnread=this.nbUnread+(s-e),n())}))}storeNbLinesRead(){const t=this.nbLines();t>0&&a((()=>{!async function(t,e,s){await y(t);const n=b[t];n.readCounts&&(n.readCounts.set(e,s),i.set(n.key,n.readCounts.toJSON()))}(this.storeKey,this.id,t)}))}}function p(t,s){return t.showing?o("div#chat.modal",{oncreate:c},[o("header",[o("button.modal_close",{oncreate:r(e(t.close,"chat"))},l),o("h2",s||h("chatRoom"))]),o("div#chat_content.modal_content.chat_content",[o("ul.chat_scroller.native_scroller",{oncreate:({dom:e})=>g(t,e),onupdate:({dom:e})=>g(t,e)},t.selectLines().map(((e,s,n)=>void 0!==t.player?function(t,e,s,n){const a="lichess"===e.u,i=e.c?e.c===t.color:t.user&&e.u===t.user.username;let r=!0;const l=n[s+1];let h;l&&(h=l.c?l.c===t.color:t.user&&l.u===t.user.username);void 0!==h&&(r=h!==i);return o("li.chat_msg.allow_select",{className:u({system:a,player:!!i,opponent:!a&&!i,close_balloon:r})},e.t)}(t.player,e,s,n):function(t){const e="lichess"===t.u;return o("li.spectator_chat_msg.allow_select",{className:u({system:e})},e?t.t:[o("strong",t.u),o.trust("&nbsp;"),o.trust("&nbsp;"),o("span",t.t)])}(e)))),o("form.chat_form",{onsubmit(e){e.preventDefault();const s=e.target[0];s.focus();const n=s.value.trim();if(!m(n))return;t.inputValue="",s.setAttribute("rows","1"),s.style.paddingTop="8px",t.socket.send("talk",n);const a=document.getElementById("chat_send");return a&&a.classList.add("disabled"),!1}},[o("textarea#chat_input.chat_input",{placeholder:t.writeable?h("talkInChat"):"Chat is disabled.",disabled:!t.writeable,rows:1,maxlength:140,value:t.inputValue,style:{lineHeight:"18px",margin:"8px 0 8px 10px",paddingTop:"8px"},oninput(e){const s=e.target;s.value.length>140&&(s.value=s.value.substr(0,140)),t.inputValue=s.value;const n=window.getComputedStyle(s),a=parseInt(n.lineHeight||"18",10),i=function(t,e){const s=t.style.height,n=t.scrollHeight,a=t.style.overflow;let i=t.offsetHeight;if(i>=n&&(t.style.height=i+e+"px",t.style.overflow="hidden",n<t.scrollHeight)){for(;t.offsetHeight>=t.scrollHeight;)t.style.height=(i-=e)+"px";for(;t.offsetHeight<t.scrollHeight;)t.style.height=i+++"px";return t.style.height=s,t.style.overflow=a,i}return n}(s,a),o=Math.ceil(i/a),r=o<=1?1:o>5?5:o-1;s.setAttribute("rows",String(r)),s.style.paddingTop=1===r?"8px":"0";const l=document.getElementById("chat_send");l&&(m(t.inputValue)?l.classList.remove("disabled"):l.classList.add("disabled"))}}),o("button#chat_send.chat_send.fa.fa-telegram.disabled")])])]):null}function g(t,e){if(t.lines.length>5){(0===e.scrollTop||e.scrollTop>e.scrollHeight-e.clientHeight-100)&&(e.scrollTop=999999,setTimeout((()=>e.scrollTop=999999),300))}}function m(t){return!!t&&t.trim().length<=140}const b={Corres:{key:"corresChat"},Game:{key:"gameChat"},Study:{key:"studyChat"},Tournament:{key:"tourChat"}};function y(t){const e=b[t];return e.readCounts?Promise.resolve():i.get(e.key).then((t=>{e.readCounts=t?new d(100,t):new d(100)}))}export{Chat as C,p as c};
