import{bo as e,m as t,bp as a,bq as n,br as i,bs as o,s as r,W as s,ap as l,aN as c,az as d,b as h,o as u,p as g,y as p,a5 as b,u as m,_ as f,a4 as v,aL as w,bt as y,r as T,ac as C,bu as j,bv as I,aM as _,bw as x,bx as k,a_ as P,a2 as A,aE as N,aG as L,by as R,bz as E}from"./main.js";import{v as O}from"./vibrate-2d0ad158.js";import{e as U}from"./fen-f2d95e2d.js";import{n as W,l as B,o as G}from"./game-b6f212b0.js";import{v as F,e as D}from"./crazyValid-02be4753.js";import{l as H}from"./layout-ae040024.js";import{O as S}from"./OnlineRound-19853fd8.js";import{S as V}from"./index-c70fdca8.js";import"./perfs-d8ca398c.js";import"./countries-a19495bf.js";import"./GameTitle-fb417b3c.js";import"./CountdownTimer-c8587446.js";import"./Board-0ecb6fca.js";import"./promotion-070b22ca.js";import"./tournamentXhr-291e93e6.js";import"./toInteger-da417924.js";import"./chat-2370f74a.js";class ChallengeCtrl{constructor(s){this.data=s,this.joinChallenge=()=>{const n=this.challenge;return n?e(n.id).then((e=>{clearTimeout(this.pingTimeoutId),t.set("/game"+e.url.round,!0)})).then((()=>a.remove(n.id))):Promise.reject("no challenge")},this.declineChallenge=()=>{const e=this.challenge;return e?n(e.id).then((()=>{clearTimeout(this.pingTimeoutId),a.remove(e.id)})).then(t.backHistory):Promise.reject("no challenge")},this.cancelChallenge=()=>{const e=this.challenge;return e?i(e.id).then((()=>{clearTimeout(this.pingTimeoutId),a.remove(e.id)})).then(t.backHistory):Promise.reject("no challenge")},this.unload=()=>{clearTimeout(this.pingTimeoutId)},this.reloadChallenge=()=>{const e=this.challenge;e&&o(e.id).then((e=>{switch(this.challenge=e.challenge,e.challenge.status){case"accepted":t.set(`/game/${e.challenge.id}`,!0);break;case"declined":t.backHistory()}}))},this.pingNow=()=>{clearTimeout(this.pingTimeoutId),this.pingTimeoutId=setTimeout(this.pingNow,2e3),this.socket&&this.socket.send("ping")},this.onSocketOpen=()=>{this.reloadChallenge(),this.pingNow()},this.challenge=s.challenge,this.socket=r.createChallenge(s.challenge.id,s.socketVersion,this.onSocketOpen,{reload:this.reloadChallenge})}}class ClipboardWeb extends s{async write(e){if("undefined"==typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if(void 0!==e.string)await this.writeText(e.string);else if(e.url)await this.writeText(e.url);else{if(!e.image)throw new Error("Nothing to write");if("undefined"==typeof ClipboardItem)throw this.unavailable("Writing images to the clipboard is not supported in this browser");try{const t=await(await fetch(e.image)).blob(),a=new ClipboardItem({[t.type]:t});await navigator.clipboard.write([a])}catch(e){throw new Error("Failed to write image")}}}async read(){if("undefined"==typeof navigator||!navigator.clipboard)throw this.unavailable("Clipboard API not available in this browser");if("undefined"==typeof ClipboardItem)return this.readText();try{const e=await navigator.clipboard.read(),t=e[0].types[0],a=await e[0].getType(t);return{value:await this._getBlobData(a,t),type:t}}catch(e){return this.readText()}}async readText(){if("undefined"==typeof navigator||!navigator.clipboard||!navigator.clipboard.readText)throw this.unavailable("Reading from clipboard not supported in this browser");return{value:await navigator.clipboard.readText(),type:"text/plain"}}async writeText(e){if("undefined"==typeof navigator||!navigator.clipboard||!navigator.clipboard.writeText)throw this.unavailable("Writting to clipboard not supported in this browser");await navigator.clipboard.writeText(e)}_getBlobData(e,t){return new Promise(((a,n)=>{const i=new FileReader;t.includes("image")?i.readAsDataURL(e):i.readAsText(e),i.onloadend=()=>{const e=i.result;a(e)},i.onerror=e=>{n(e)}}))}}const z=l("Clipboard",{web:()=>new ClipboardWeb});function M(e){let n,i=F(d,"white");const o=e.challenge,r=c("lichess.org");return o&&(i=F(o.initialFen||d,"white"),"in"===o.direction?n=function(e,a){let n;n=a.rated&&!h.isConnected()?u("div.error",[g("thisGameIsRated"),u("br"),u("br"),g("youNeedAnAccountToDoThat"),u("div.go_or_cancel",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p(f.open)},g("signIn")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(t.backHistory)},g("cancel"))])]):h.isConnected()?u("div.go_or_cancel",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p(e.joinChallenge)},g("join")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(e.declineChallenge)},g("decline"))]):u("div",[u("button[data-icon=E].withIcon",{oncreate:p(e.joinChallenge)},g("join"))]);const i=a.challenger?g("playerisInvitingYou",q(a.challenger)):g("playerisInvitingYou","Anonymous");return b("join_url_challenge",void 0,(function(){return u("div.infos",[u("div.challenger",i),u("br"),$(a),u("br"),n])}),!0)}(e,o):"out"===o.direction&&(n=o.destUser?function(e,n){function i(){return u("div.infos",[u("div",g("waitingForOpponent")),u("br"),u("div.user",q(n.destUser)),$(n),u("br"),m.getVdom(),u("br"),u("br"),u("button.withIcon[data-icon=L]",{oncreate:p(e.cancelChallenge)},g("cancel")),a.isPersistent(n)?u("div",[u("br"),u("button",{oncreate:p((()=>t.set("/")))},[u("span.fa.fa-home"),g("Return to home")])]):null])}return b("await_url_challenge",void 0,i,!0)}(e,o):function(e,n){const i=a.isPersistent(n);return b("await_url_challenge",void 0,(function(){return u("div.infos",[$(n),u("br"),u("p.explanation",g("toInviteSomeoneToPlayGiveThisUrl")),u("div.copy_container",[u("div.icon_container",[u("span.fa.fa-clipboard")]),u("input.lichess_game_url",{oncreate:p((function(){z.write({url:Y(n)}),v.show({text:"Copied to clipboard",position:"center",duration:"short"})})),value:Y(n),readonly:!0})]),u("p.explanation.small",g("theFirstPersonToComeOnThisUrlWillPlayWithYou")),u("div.go_or_cancel.clearfix",[u("button.binary_choice[data-icon=E].withIcon",{oncreate:p((function(){V.share({url:Y(n)})}))},g("shareGameUrl")),u("button.binary_choice[data-icon=L].withIcon",{oncreate:p(e.cancelChallenge)},g("cancel"))]),i?u("div",[u("br"),u("button",{oncreate:p((()=>t.set("/")))},[u("span.fa.fa-home"),g("Return to home")])]):null])}),!0)}(e,o))),H.board(r,i,"challenge",n)}function Y(e){return"https://lichess.org/"+e.id}function $(e){const t=e.rated?g("rated"):g("casual"),n=a.challengeTime(e);return u("div",{className:"gameInfos"},u("span",{"data-icon":"p"},n)," • ",u("span",null,e.variant.name)," • ",u("span",null,t))}function q(e){const t=e.rating+(e.provisional?"?":"");return`${e.name} (${t})`}var J={oninit(e){w();const a=performance.now();y(e.attrs.id,e.attrs.color).then((n=>{void 0!==n.challenge?(e.state.challenge=new ChallengeCtrl(n),T()):function(e){return void 0!==e.url}(n)&&function(e,a,n){if(n.player.spectator||W(n)){if(B(n)&&0===G(n,n.player.color)){N.dong(),O.quick();const e=L(n.game.variant.key),t=function(e){return"game.variant.prompt."+e}(n.game.variant.key);e.alert&&-1===[1,3].indexOf(e.id)&&!R.get(t)&&E.alert({title:"Alert",message:e.alert}).then((()=>{R.set(t,!0)}))}const t=performance.now()-a;setTimeout((()=>{const t=Number(e.attrs.ply),a=isNaN(t)?void 0:t;e.state.round=new S(!!e.attrs.goingBack,e.attrs.id,n,!1,void 0,void 0,a)}),Math.max(400-t,0)),A.resetLastJoined(),void 0===n.player.user&&R.set("lastPlayedGameURLAsAnon",n.url.round)}else v.show({text:g("unsupportedVariant",n.game.variant.name),position:"center",duration:"short"}),t.set("/")}(e,a,n)})).catch((e=>{C(e),t.set("/")}))},oncreate(e){e.attrs.goingBack?j(e.dom):I(e.dom)},onremove(){_(),r.destroy(),this.round&&this.round.unload(),this.challenge&&this.challenge.unload()},view({attrs:e}){if(this.round)return D(this.round);if(this.challenge)return M(this.challenge);const t=A.lastJoined();let a;if(t)a=F(t.fen,t.color,t.lastMove,t.variant.key);else{const t=x.get(e.id);a=t?F(t.fen,t.orientation):F(U,"white")}return H.board(e.goingBack?k():P(),a)}};export{J as default};
