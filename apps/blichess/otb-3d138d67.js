import{a5 as t,o as e,y as o,p as s,a6 as a,g as i,r as n,m as r,aF as l,aG as c,a9 as p,af as h,d as u,aE as d,A as m,aH as v,aI as f,ah as b,aJ as y,K as k,aK as g,k as w,a4 as P,s as j,aL as _,G as C,aM as N,aN as G}from"./main.js";import{s as M,g as F}from"./offlineGames-90731ac9.js";import{e as S,p as x}from"./fen-f2d95e2d.js";import{l as T}from"./layout-ae040024.js";import{a as A,c as O,v as I}from"./crazyValid-02be4753.js";import{G as E}from"./GameTitle-fb417b3c.js";import{S as R}from"./index-c70fdca8.js";import{i as L}from"./chess-a4e99343.js";import{g as B}from"./game-b6f212b0.js";import{c as D,p as U,v as $}from"./promotion-070b22ca.js";import{r as H,a as W,g as K,s as V,R as z,d as J,b as X,c as q,e as Q,f as Y,h as Z,i as tt}from"./view-b29da5fb.js";import{c as et,a as ot}from"./clockSet-be46f3b1.js";import{I as st}from"./ImporterCtrl-9a0112f1.js";import{B as at}from"./Board-0ecb6fca.js";import"./perfs-d8ca398c.js";import"./countries-a19495bf.js";import"./CountdownTimer-c8587446.js";import"./tournamentXhr-291e93e6.js";import"./toInteger-da417924.js";import"./chat-2370f74a.js";var it={controller(t){let e=!1;function o(t){"backbutton"!==t&&e&&r.backbutton.stack.pop(),e=!1}return{open:function(){r.backbutton.stack.push(o),e=!0},close:o,isOpen:function(){return e},root:t}},view:function(r){return r.isOpen()?t("offline_actions",void 0,(function(){return[H(r.root)].concat(W(r.root),function(t){return[e("div",[e("button[data-icon=A]",{oncreate:o(t.goToAnalysis)},s("analysis"))]),e("div.action",a.renderCheckbox(s("otbFlipPiecesAndInfoAfterMove"),"flipPieces",i.otb.flipPieces,(e=>K.changeOTBMode(t.chessground,e)))),e("div.action",a.renderCheckbox(s("otbUseSymmetricPieces"),"useSymmetric",i.otb.useSymmetric,n))]}(r.root))}),r.isOpen(),r.close):null}},nt={controller(t){const e=h(!1);function o(t){"backbutton"!==t&&!0===e()&&r.backbutton.stack.pop(),e(!1)}return{open:function(){r.backbutton.stack.push(o),e(!0)},close:o,isOpen:e,root:t}},view:function(n){return n.isOpen()?t("new_offline_game",void 0,(function(){const t=i.otb.availableVariants,h=n.root.vm.setupFen?t.filter((t=>!l.has(t[1]))):t,u=i.otb.variant(),d=n.root.vm.setupFen&&l.has(u);return e("div",null,e("div",{className:"action"},d?e("div",{className:"select_input disabled"},e("label",{for:"variant"},s("variant")),e("select",{disabled:!0,id:"variant"},e("option",{value:u,selected:!0},c(u).name))):e("div",{className:"select_input"},a.renderSelect("variant","variant",h,i.otb.variant)),n.root.vm.setupFen?e("div",{className:"from_position_wrapper"},e("p",null,s("fromPosition")),e("div",{className:"from_position"},e("div",{style:{width:"130px",height:"130px"},oncreate:o((()=>{n.root.vm.setupFen&&r.set(`/editor/${encodeURIComponent(n.root.vm.setupFen)}`)}))},e(p,{fen:n.root.vm.setupFen,orientation:"white"})))):null,e("div",{className:"select_input"},a.renderSelect(s("clock"),"clock",i.otb.availableClocks,i.otb.clockType,!1,rt)),et(i.otb.clockType(),rt)),e("div",{className:"popupActionWrapper"},e("button",{className:"defaultButton",oncreate:o((()=>{n.close(),n.root.startNewGame(i.otb.variant(),n.root.vm.setupFen,i.otb.clockType())}))},s("play"))))}),n.isOpen(),(()=>{n.root.vm.setupFen&&r.set("/otb"),n.close()})):null}};function rt(){n()}var lt={controller(t){let e=!1;function o(t){"backbutton"!==t&&e&&r.backbutton.stack.pop(),e=!1}return{open:function(){r.backbutton.stack.push(o),e=!0},close:o,isOpen:function(){return e},root:t,importer:st()}},view:a=>t("OtbImportGamePopup",void 0,(()=>{const t=i.otb.whitePlayer,n=i.otb.blackPlayer;return e("div",[e("p","Import current game state with following player names on lichess?"),e("form",[e("div.exchange",{oncreate:o((()=>{const e=t(),o=n();t(o),n(e)}))},e("span.fa.fa-exchange.fa-rotate-90")),e("div.importMeta.text_input_container",[e("label",s("white")),e("input[type=text]",{value:t(),oninput:u((e=>{const o=e.target.value.trim();t(o)}),300),onfocus(){this.select()},spellcheck:!1})]),e("div.importMeta.text_input_container",[e("label",s("black")),e("input[type=text]",{value:n(),oninput:u((t=>{const e=t.target.value.trim();n(e)}),300),onfocus(){this.select()},spellcheck:!1})])]),e("div.popupActionWrapper",[a.importer.importing()?e("div",[e("span.fa.fa-hourglass-half"),e("span","Importing...")]):e("button.popupAction.withIcon[data-icon=E]",{oncreate:o((()=>{var t;const e=i.otb.whitePlayer,o=i.otb.blackPlayer;null===(t=a.root.replay)||void 0===t||t.pgn(e(),o()).then((t=>{a.importer.importGame(t.pgn)}))}))},"Import on lichess")])])}),a.isOpen(),a.close)};class OtbRound{constructor(t,e,o){this.promoting=null,this.goToAnalysis=()=>{this.replay&&r.set(`/analyse/offline/otb/${this.data.player.color}?ply=${this.replay.ply}&curFen=${this.replay.situation().fen}`)},this.save=()=>{this.replay&&M({data:this.data,situations:this.replay.situations,ply:this.replay.ply})},this.saveClock=()=>{this.clock&&this.clock.isRunning()&&this.clock.startStop(),this.save()},this.isClockEnabled=()=>!!this.clock&&void 0===this.clock.flagged()&&void 0!==this.clock.activeSide(),this.toggleClockPlay=()=>{this.clock&&this.isClockEnabled()&&this.clock.startStop()},this.sharePGN=()=>{var t;null===(t=this.replay)||void 0===t||t.pgn("White","Black").then((t=>R.share({text:t.pgn})))},this.addMove=(t,e,o)=>{var s;null===(s=this.replay)||void 0===s||s.addMove(t,e,o),this.chessground.setLastPromotion(o)},this.onPromotion=(t,e,o)=>{this.addMove(t,e,o)},this.userMove=(t,e,o)=>{o.promote&&D(this.chessground.state,e)?this.addMove(t,e,o.promote):U.start(this,t,e,this.onPromotion)||this.addMove(t,e)},this.onMove=(t,e,o)=>{o?"atomic"===this.data.game.variant.key?(A.capture(this.chessground,e),d.explosion()):d.capture():d.move()},this.onUserNewPiece=(t,e)=>{var o;const s=this.replay.situation();O.drop(this.data,t,e,s.drops)?null===(o=this.replay)||void 0===o||o.addDrop(t,e):this.apply(this.replay.situation())},this.onNewPiece=()=>{d.move()},this.onFlag=t=>{const e={id:35,name:"outoftime"};V(this,e,"white"===t?"black":"white"),d.dong(),this.onGameEnd(e),this.save()},this.onReplayAdded=t=>{const e="white"===t.player?"black":"white";this.clock&&this.clock.clockHit(e),this.data.game.fen=t.fen,this.apply(t),V(this,t.status),B.finished(this.data)&&this.onGameEnd(t.status),this.save(),n()},this.onThreefoldRepetition=t=>{V(this,t),this.save(),this.onGameEnd(t)},this.onGameEnd=t=>{this.clock&&this.clock.isRunning()&&this.clock.startStop(),this.chessground.stop(t),setTimeout((()=>{this.actions.open(),n()}),500)},this.player=()=>{var t;return(null===(t=this.replay)||void 0===t?void 0:t.situation().player)||"white"},this.jump=(t,e)=>(this.chessground.cancelMove(),t<0||t>=this.replay.situations.length||(this.replay.ply=t,this.apply(this.replay.situation(),e)),!1),this.jumpNext=()=>this.jump(this.replay.ply+1,"redo"),this.jumpPrev=()=>this.jump(this.replay.ply-1,"undo"),this.jumpFirst=()=>this.jump(this.firstPly(),"undo"),this.jumpLast=()=>this.jump(this.lastPly(),"redo"),this.firstPly=()=>0,this.lastPly=()=>this.replay.situations.length-1,this.replaying=()=>this.replay.ply!==this.lastPly(),this.canDrop=()=>!0,this.setupFen=e,this.actions=it.controller(this),this.importGamePopup=lt.controller(this),this.newGameMenu=nt.controller(this),this.vm={flip:!1,setupFen:e,savedFen:t?t.data.game.fen:void 0},this.moveList=!!i.game.moveList(),e?(this.newGameMenu.isOpen(!0),o&&i.otb.variant(o),n()):t&&0!==t.ply||this.newGameMenu.open();const s=i.otb.variant();if(!e)if(t)try{this.init(t.data,t.situations,t.ply)}catch(t){this.startNewGame(s,void 0,i.otb.clockType())}else this.startNewGame(s,void 0,i.otb.clockType());m.addListener("appStateChange",(t=>{t.isActive||this.saveClock()})).then((t=>this.appStateListener=t))}unload(){var t;null===(t=this.appStateListener)||void 0===t||t.remove(),this.saveClock()}init(t,e,o){this.actions.close(),this.data=t;const s=this.data.game.variant.key,a=this.data.game.initialFen;if(this.replay?this.replay.init(s,a,e,o):this.replay=new z(s,a,e,o,this.onReplayAdded,this.onThreefoldRepetition),t.offlineClock){const e=t.offlineClock.clockType;this.clock=ot[e](this.onFlag),this.clock.setState(t.offlineClock)}else this.clock=void 0;this.chessground?K.reload(this.chessground,this.data,this.replay.situation()):this.chessground=K.make(this.data,this.replay.situation(),this.userMove,this.onUserNewPiece,this.onMove,this.onNewPiece),n()}startNewGame(t,e,o){const s={variant:t};e&&(s.fen=e);const a=o&&"none"!==o?ot[o](this.onFlag):null;L(s).then((t=>{this.init(J({id:"offline_otb",variant:t.variant,initialFen:t.setup.fen,fen:t.setup.fen,player:t.setup.player,color:this.data&&v(this.data.player.color)||t.setup.player,pref:{centerPiece:!0},clock:a?a.getState():null}),[t.setup],0)})).then((()=>{e&&(this.vm.setupFen=void 0,r.History.replaceState(void 0,"/otb"))}))}apply(t,e){if(t){this.clock&&this.clock.activeSide()!==t.player&&this.clock.toggleActiveSide();const o=t.uciMoves.length?t.uciMoves[t.uciMoves.length-1]:null;this.chessground.set({fen:t.fen,turnColor:t.player,lastMove:o?f(o):null,dests:t.dests,movableColor:t.player,check:t.check,shift:e})}}}function ct(t){return e("section",{className:"actions_bar"},e("button",{className:"action_bar_button fa fa-ellipsis-v",oncreate:o(t.actions.open)}),e("button",{className:"action_bar_button fa fa-plus-circle",oncreate:o((()=>{t.saveClock(),t.newGameMenu.open()}),(()=>P.show({text:s("createAGame"),duration:"short",position:"bottom"})))}),e("button",{className:"fa fa-share-alt action_bar_button",oncreate:o(t.sharePGN,(()=>P.show({text:s("sharePgn"),duration:"short",position:"bottom"})))}),t.clock?e("button",{className:"fa action_bar_button "+(t.clock.isRunning()?"fa-pause":"fa-play")+(t.isClockEnabled()?"":" disabled"),oncreate:o(t.toggleClockPlay,(()=>P.show({text:s("chessClock"),duration:"short",position:"bottom"})))}):null,w()?e("button",{className:"fa fa-cloud-upload action_bar_button",oncreate:o(t.importGamePopup.open,(()=>P.show({text:s("Import game on lichess"),duration:"short",position:"bottom"})))}):null,tt(t),Z(t),Y(t))}var pt={oninit({attrs:t}){j.createDefault(),F().then((e=>{this.round=new OtbRound(e,t.fen,t.variant),window.addEventListener("unload",this.round.saveClock)})),_()},oncreate:C,onremove(){N(),this.round&&(this.round.unload(),window.removeEventListener("unload",this.round.saveClock))},view({attrs:t}){let o,a;const n=i.otb.useSymmetric()?"symmetric":void 0;if(this.round&&this.round.data&&this.round.chessground)a=G(e(E,{data:this.round.data})),o=function(t,o){const a=i.otb.flipPieces(),n=b({otb:!0,mode_flip:a,mode_facing:!a,turn_white:"white"===t.chessground.state.turnColor,turn_black:"black"===t.chessground.state.turnColor}),r=t.chessground.getMaterialDiff(),l=s(t.data.player.color),c=s(t.data.opponent.color),p=X(t),h=y(),u=k(),d=e(at,{variant:t.data.game.variant.key,chessground:t.chessground,wrapperClasses:n,customPieceTheme:o}),m=t.clock;return h?[g(u,h)?q(t):null,Q(t,c,r[t.data.opponent.color],"opponent",a,o,m),d,Q(t,l,r[t.data.player.color],"player",a,o,m),ct(t)]:[d,e("section",{className:"table"},Q(t,c,r[t.data.opponent.color],"opponent",a,o,m),p,ct(t),Q(t,l,r[t.data.player.color],"player",a,o,m))]}(this.round,n);else{const e=t.fen||S,i=e?x(e):"white";a=G(s("overTheBoard")),o=I(e,i,void 0,"standard",void 0,n)}return T.board(a,o,void 0,this.round&&(r=this.round,[it.view(r.actions),nt.view(r.newGameMenu),lt.view(r.importGamePopup),$(r)]),void 0,this.round&&this.round.data&&this.round.data.player.color||"white");var r}};export{pt as default};
