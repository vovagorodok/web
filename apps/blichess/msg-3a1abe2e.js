import{h as t,ch as e,k as s,r as o,ci as n,cj as a,ck as i,cl as c,cm as d,cn as r,ao as h,co as _,m as u,aE as l,c as v,cp as m,o as p,$ as g,ak as f,an as b,cq as y,p as k,aD as M,V as w,F as C,v as D,a3 as T,u as x}from"./main.js";import{l as S}from"./layout-b3635a82.js";import{l as L}from"./html-1975aa10.js";const $=new class Scroller{constructor(){this.enabled=!1,this.init=e=>{this.enabled=!0,this.element=e,this.element.addEventListener("scroll",t((()=>{const t=this.element;this.enable(!!t&&t.offsetHeight+t.scrollTop>t.scrollHeight-20)}),500),{passive:!0})},this.auto=()=>{this.element&&this.enabled&&requestAnimationFrame((()=>this.element&&(this.element.scrollTop=9999999)))},this.enable=t=>{this.enabled=t},this.setMarker=()=>{this.marker=this.element&&this.element.querySelector("mine,their")},this.toMarker=()=>!(!this.marker||!this.to(this.marker))&&(this.marker=void 0,!0),this.to=t=>{if(this.element){const e=t.offsetTop-this.element.offsetHeight/2+t.offsetHeight/2;return e>0&&(this.element.scrollTop=e),e>0}return!1}}};class MsgCtrl{constructor(u){this.search={input:""},this.loading=!1,this.confirmDelete=null,this.msgsPerPage=100,this.openConvo=t=>{var n;(null===(n=this.data.convo)||void 0===n?void 0:n.user.id)!==t&&(this.data.convo=void 0,this.loading=!0),e(t).then((t=>{this.data=t,this.search.result=void 0,this.loading=!1,t.convo?(s.History.pushState(`/inbox/${t.convo.user.name}`),this.onLoadConvo(t.convo),o()):this.showSide()})),this.pane="convo",o()},this.showSide=()=>{this.pane="side",s.History.pushState("/inbox"),o()},this.getMore=()=>{this.data.convo&&this.canGetMoreSince&&n(this.data.convo.user.id,this.canGetMoreSince).then((t=>{this.data.convo&&t.convo&&t.convo.user.id===this.data.convo.user.id&&t.convo.msgs[0]&&(t.convo.msgs[0].date>=this.data.convo.msgs[this.data.convo.msgs.length-1].date||(this.data.convo.msgs=this.data.convo.msgs.concat(t.convo.msgs),this.onLoadMsgs(t.convo.msgs),o()))})),this.canGetMoreSince=void 0,o()},this.onLoadConvo=t=>{this.onLoadMsgs(t.msgs),this.typing&&(clearTimeout(this.typing.timeout),this.typing=void 0),setTimeout(this.setRead,500)},this.onLoadMsgs=t=>{const e=t[this.msgsPerPage-1];this.canGetMoreSince=null==e?void 0:e.date},this.post=t=>{if(this.data.convo){this.socket.post(this.data.convo.user.id,t);const e={text:t,user:this.data.me.id,date:new Date,read:!0};this.data.convo.msgs.unshift(e);const s=this.currentContact();s?this.addMsg(e,s):setTimeout((()=>a().then((t=>{this.data.contacts=t.contacts,o()}))),1e3),$.enable(!0),o()}},this.receive=t=>{var e;const s=this.findContact(t.user);if(this.addMsg(t,s),s){let s=!1;t.user===(null===(e=this.data.convo)||void 0===e?void 0:e.user.id)&&(this.data.convo.msgs.unshift(t),s=this.setRead(),this.receiveTyping(t.user,!0)),s||o()}else a().then((t=>{this.data.contacts=t.contacts,o()}))},this.addMsg=(t,e)=>{e&&(e.lastMsg=t,this.data.contacts=[e].concat(this.data.contacts.filter((t=>t.user.id!==e.user.id))))},this.findContact=t=>this.data.contacts.find((e=>e.user.id===t)),this.currentContact=()=>this.data.convo&&this.findContact(this.data.convo.user.id),this.searchInput=t=>{this.search.input=t,t[1]?i(t).then((t=>{this.search.result=this.search.input[1]?t:void 0,o()})):(this.search.result=void 0,o())},this.setRead=()=>{var t;const e=null===(t=this.currentContact())||void 0===t?void 0:t.lastMsg;return!(!e||e.user===this.data.me.id)&&(!e.read&&(e.read=!0,this.socket.setRead(e.user),o(),!0))},this.delete=()=>{var t;const e=null===(t=this.data.convo)||void 0===t?void 0:t.user.id;e&&c(e).then((t=>{this.data=t,this.confirmDelete=null,this.pane="side",o(),s.History.pushState("/inbox")}))},this.block=()=>{var t;const e=null===(t=this.data.convo)||void 0===t?void 0:t.user.id;e&&d(e).then((()=>this.openConvo(e)))},this.unblock=()=>{var t;const e=null===(t=this.data.convo)||void 0===t?void 0:t.user.id;e&&r(e).then((()=>this.openConvo(e)))},this.changeBlockBy=t=>{var e;t===(null===(e=this.data.convo)||void 0===e?void 0:e.user.id)&&this.openConvo(t)},this.sendTyping=t((t=>{this.socket.typing(t)}),3e3),this.receiveTyping=(t,e)=>{var s;this.typing&&(clearTimeout(this.typing.timeout),this.typing=void 0),!0!==e&&(null===(s=this.data.convo)||void 0===s?void 0:s.user.id)===t&&(this.typing={user:t,timeout:setTimeout((()=>{var e;(null===(e=this.data.convo)||void 0===e?void 0:e.user.id)===t&&(this.typing=void 0),o()}),3e3)}),o()},this.onReconnect=()=>{this.data.convo&&this.openConvo(this.data.convo.user.id),o()},this.data=u,this.pane=u.convo?"convo":"side",this.connected=h,this.socket=new _(this),this.data.convo&&this.onLoadConvo(this.data.convo),this.setRead()}}function j(t,e,s){const o=e.user,n=e.lastMsg,a=!n.read&&n.user!==t.data.me.id;return u("div.msg-app__side__contact",{key:`${o.id}${s===o.id?"-active":""}`,className:s===o.id?"active":"","data-userid":o.id},[u("div.msg-app__side__contact__user",[u("div.msg-app__side__contact__head",[l(Object.assign(Object.assign({},o),{username:o.name})),u("div.msg-app__side__contact__date",O(n))]),u("div.msg-app__side__contact__body",[u("div.msg-app__side__contact__msg",{className:a?"msg-app__side__contact__msg--new":""},n.text),a?u("i.msg-app__side__contact__new",{"data-icon":"î€"}):null])])])}function H(t){return m(t,".msg-app__side__contact")}function N(t,e){const s=H(t),o=null==s?void 0:s.dataset;o.userid&&e.openConvo(o.userid)}function O(t){return u("time.timeago",{key:t.date.getTime(),title:t.date.toLocaleString(),datetime:t.date.getTime()},v(t.date))}function E(t,e){return"lichess"===e.user.id?[]:u("button.msg-app__convo__action.button.button-empty.bad",{key:"delete","data-icon":"q",title:p("delete"),oncreate:g((()=>t.confirmDelete=e.user.id))})}let R=0;function q(t,e){const s=t.connected();return u("form.msg-app__convo__post",{onsubmit:e=>{e.preventDefault();const s=Date.now();if(s-1e3<R)return;const o=e.target[0],n=o.value.trim();n.length>8e3?f.show({text:"Message is too long",duration:"short"}):n.length>0&&(R=s,t.post(n),o.value="",o.focus())}},[G(t,e),u("button.msg-app__convo__post__submit.button.fa.fa-telegram",{className:s?"connected":"",type:"submit",disabled:!s})])}function G(e,s){return u("textarea.msg-app__convo__post__text",{rows:1,oncreate:o=>{o.dom.addEventListener("input",t((()=>{e.sendTyping(s.id)}),500))}})}function F(t,e){return u("div.msg-app__convo__msgs.native_scroller",{oncreate(t){$.init(t.dom),$.auto()},onupdate(){$.auto()}},[u("div.msg-app__convo__msgs__content",[t.canGetMoreSince?u("button.msg-app__convo__msgs__more.button.button-empty",{key:"more",oncreate:g((()=>{$.setMarker(),t.getMore()}))},"Load more"):null,...P(t,e.msgs),t.typing?u("div.msg-app__convo__msgs__typing",`${e.user.name} is typing...`):null])])}function P(t,e){const s=function(t){let e=t[0];if(!e)return[{date:new Date,msgs:[]}];const s=[{date:e.date,msgs:[[e]]}];return t.slice(1).forEach((t=>{Y(t.date,e.date)?t.user===e.user?s[0].msgs[0].unshift(t):s[0].msgs.unshift([t]):s.unshift({date:t.date,msgs:[[t]]}),e=t})),s}(e),o=[];return s.forEach((e=>o.push(...function(t,e){return[u("day",U(e.date)),...e.msgs.map((e=>u("group",e.map((e=>function(t,e){const s=e.user===t.data.me.id?"mine":"their";return u(s,[A(e),u("em",`${I(e.date.getHours())}:${I(e.date.getMinutes())}`)])}(t,e))))))]}(t,e)))),o}const I=t=>(t<10?"0":"")+t;const V=new Date,B=new Date;function U(t){return Y(t,V)?p("today").toUpperCase():Y(t,B)?p("yesterday").toUpperCase():b(t)}B.setDate(B.getDate()-1);const Y=(t,e)=>t.getDate()===e.getDate()&&t.getMonth()===e.getMonth()&&t.getFullYear()===e.getFullYear(),A=t=>u("t",u.trust(L(t.text).replace(/\n/g,"<br>")));function z(t,e){const o=e.user;return u("div.msg-app__convo",{key:"convo-loaded"},[u("div.msg-app__convo__head",[u("div.msg-app__convo__head__left",[u("button.msg-app__convo__head__back",{oncreate:g((()=>{t.showSide()}))},y),u("div.user-link",{oncreate:g((()=>s.set(`/@/${o.name}`))),className:o.online?"online":"offline"},l(Object.assign(Object.assign({},o),{username:o.name})))]),u("div.msg-app__convo__head__actions",E(t,e))]),F(t,e),u("div.msg-app__convo__reply",[!1===e.relations.out||!1===e.relations.in?u("div.msg-app__convo__reply__block.text",{"data-icon":"k"},"This conversation is blocked."):e.postable?q(t,o):u("div.msg-app__convo__reply__block.text",{"data-icon":"k"},`${o.name} doesn't accept new messages.`)])])}function J(e){return u("div.msg-app__side__search",[e.data.me.kid?null:u("input",{placeholder:p("searchOrStartNewDiscussion"),oncreate:s=>{const o=s.dom;o.addEventListener("input",t((()=>e.searchInput(o.value.trim())),500))}})])}function K(t,e){return u("div.msg-app__search.msg-app__side__content.native_scroller",{oncreate:k((e=>N(e,t)),void 0,H)},[e.contacts[0]&&u("section",[u("h2",p("discussions")),u("div.msg-app__search__contacts",e.contacts.map((e=>j(t,e))))]),e.friends[0]&&u("section",[u("h2",p("friends")),u("div.msg-app__search__users",e.friends.map(Q))]),e.users[0]&&u("section",[u("h2",p("players")),u("div.msg-app__search__users",e.users.map(Q))])])}function Q(t){return u("div.msg-app__side__contact",{key:t.id,"data-userid":t.id},[u("div.msg-app__side__contact__user",[u("div.msg-app__side__contact__head",[l(Object.assign(Object.assign({},t),{username:t.name}))])])])}function W(t,e,s,o){return u("button.withIcon.binary_choice",{className:o,"data-icon":t,oncreate:C(s)},e)}var X={oncreate:D,oninit({attrs:t}){const n=t.id;n?e(n).then((t=>{this.ctrl=new MsgCtrl(t),o()})).catch((t=>{404===t.status?a().then((t=>{t.convo={user:{id:n,name:n.toLowerCase()},msgs:[],relations:{},postable:!0},this.ctrl=new MsgCtrl(t)})):(T(t),s.set("/inbox"))})):a().then((t=>{this.ctrl=new MsgCtrl(t),o()})).catch(T)},view(){const t=x(p("inbox")),e=function(t){var e;if(t){const s=null===(e=t.data.convo)||void 0===e?void 0:e.user.id;return u("main.box.msg-app",{className:`pane-${t.pane}`},[u("div.msg-app__side",{key:"side"},[J(t),t.search.result?K(t,t.search.result):u("div.msg-app__contacts.msg-app__side__content.native_scroller",{oncreate:k((e=>N(e,t)),void 0,H)},t.data.contacts.map((e=>j(t,e,s))))]),t.data.convo?z(t,t.data.convo):t.loading?u("div.msg-app__convo",{key:"convo-loading"},[u("div.msg-app__convo__head"),M.getVdom()]):u("div.msg-app__convo",{key:"convo-empty"})])}return M.getVdom()}(this.ctrl),s=(null==(n=this.ctrl)?void 0:n.confirmDelete)?w("go_or_cancel",(()=>`${p("delete")}?`),(()=>[W("L",p("cancel"),(()=>n.confirmDelete=null)),W("q",p("delete"),(()=>n.delete()))]),!0,(()=>{n.confirmDelete=null,o()})):null;var n;return S.free(t,e,null,s)}};export{X as default};
