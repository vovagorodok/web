import{a7 as t,m as a,r as i,k as e,o as n,p as s,z as r,q as o,b as d,a0 as l,aA as h,e as u,a8 as c,b7 as p,aR as v,C as g,B as m,by as f,a6 as z,bS as b,ba as y,aI as w,h as k,d as P,aY as M,cU as S,ad as C,a as _,c5 as x,bD as B,bk as N,H as T,cV as $,s as j,aP as U,I as V,aQ as F,aN as R,a9 as I,u as O}from"./main.js";import{l as L}from"./layout-26cca27d.js";import{B as A}from"./Board-25b97c43.js";import{s as J,l as Y,a as D}from"./axis-d343de69.js";import{d as G,c as q,s as X,t as E,l as H,m as W,i as K,b as Q,a as Z,f as tt,g as at,u as it,j as et,k as nt}from"./area-59c9c857.js";import{s as st,p as rt,a as ot,n as dt,v as lt,g as ht,b as ut,c as ct,r as pt,e as vt,d as gt,f as mt}from"./offlineService-1e2a3008.js";import{S as ft}from"./index-28ac80d9.js";import{s as zt,m as bt}from"./draughts-5f7918a7.js";var yt={controller(t){let e=!1,n=null;function s(t){"backbutton"!==t&&e&&a.backbutton.stack.pop(),e=!1}return{open:function(){a.backbutton.stack.push(s),e=!0;const r=d.get();r&&t.database.fetch(r.id,t.vm.variant).then((t=>{t&&(n={username:r.username,data:t.user},i())}))},close:s,isOpen:()=>e,user:()=>n,root:t}},view:a=>t("trainingMenu",void 0,(()=>function(t){const a=t.user();return t.root.data&&t.root.data.user&&e()?wt(t.root.data.user,t.root.vm.variant):null!==a&&e()?wt(a.data,t.root.vm.variant):null!==a?function(t,a){const i=t.data.rating;return n("div.training-offlineInfos",[n("p",["You are currently offline. Your last recorded rating as ",n("strong",t.username)," is ",n("strong",i),"."]),n("p","You still have ",n("strong",a.root.nbUnsolved)," saved puzzles to solve."),n("p","Puzzles are automatically downloaded by batches so you can solve them seamlessly while having bad network conditions or when you are offline."),n("p","Your puzzle history and rating will be updated as soon as you are back online.")])}(a,t):n("div.trainingMenuContent",[n("p",s("toTrackYourProgress")),n("p.signin",n("button.defaultButton",{oncreate:r(l.open)},[n("span.fa.fa-user"),s("signIn")]))])}(a)),a.isOpen(),a.close)};function wt(t,a){const i=t.rating;return[n("p.trainingRatingHeader",n.trust(s("yourPuzzleRatingX",`<strong>${i}</strong>`))),t.recent?n("div#training-graph.training-graph",{oncreate({dom:a}){!function(t,a){const i=Array.from(a.recent.map((t=>t[2]))),e=a.rating;void 0!==e&&i.push(e);const n=t.getBoundingClientRect(),r=i.map(((t,a)=>[a+1,t])),o={top:5,right:5,bottom:5,left:35},d=n.width-o.left-o.right,l=n.height-o.top-o.bottom,h=J(t).append("svg").attr("viewBox",`0 0 ${n.width} ${n.height}`).append("g").attr("transform","translate("+o.left+","+o.top+")"),u=r.map((t=>t[0])),c=Y().domain([Math.min.apply(null,u),Math.max.apply(null,u)]).rangeRound([0,d]),p=r.map((t=>t[1])),v=Y().domain([Math.min.apply(null,p)-10,Math.max.apply(null,p)+10]).rangeRound([l,0]),g=G().x((t=>c(t[0]))).y0(l).y1((t=>v(t[1]))),m=G().x((t=>c(t[0]))).y((t=>v(t[1]))),f=D(v).tickFormat((t=>String(t)));h.datum(r),h.append("g").attr("class","ticks").call(f).append("text").attr("class","legend").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("text-anchor","end").text(s("rating")),h.append("path").attr("class","path").attr("fill","steelblue").attr("stroke","steelblue").attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",0).attr("d",g),h.append("path").attr("class","line").attr("d",m)}(a,t)}}):null,Pt(t,a)]}function kt(t){const i=h(t),e=null==i?void 0:i.dataset.id,n=null==i?void 0:i.dataset.variant;e&&(n?a.set(`/training/${e}/variant/${n}`,!0):a.set(`/training/${e}`,!0))}function Pt(t,a){return n("div.puzzle-recents",{oncreate:o(kt,void 0,h)},t.recent.map((([t,i])=>n("button",{"data-id":t,"data-variant":a,className:i>0?"up":"down"},(i>0?"+":"")+i))))}var Mt={controller(t){let i=!1;function e(t){"backbutton"!==t&&i&&a.backbutton.stack.pop(),i=!1}const n={variant:u.training.variant()};return{root:t,open:function(){a.backbutton.stack.push(e),i=!0},close:e,isOpen:()=>i,s:n,setVariant(a){n.variant=a,t.vm.variant=a,e(),t.newPuzzle()}}},view:a=>t("trainingMenu",void 0,(()=>function(t){return n("div.trainingSettings",[n("div.action",[c.renderMultipleChoiceButton(s("puzzleVariant"),[{label:"Standard",value:"standard",dataIcon:"8"},{label:"Frisian",value:"frisian",dataIcon:"'"},{label:"Russian",value:"russian",dataIcon:""}],u.training.variant,!1,t.settings.setVariant)]),n("div.action.sync",[n("button",{disabled:!(e()&&d.isConnected()),oncreate:r(t.resync)},[n("span.fa.fa-random"),s("syncAndRefreshSavedPuzzles")])])])}(a.root)),a.isOpen(),a.close)};function St(t){return n("section#training_actions.actions_bar",[n("button.action_bar_button.training_action.fa.fa-area-chart",{oncreate:r(t.menu.open)}),n("button.action_bar_button.training_action.fa.fa-gear",{oncreate:r(t.settings.open)}),n("button.action_bar_button.training_action.fa.fa-share-alt",{oncreate:r(t.share,(()=>z.show({text:s("shareThisPuzzle"),duration:"short",position:"bottom"})))}),n("button.action_bar_button.training_action[data-icon=A]",{oncreate:r(t.goToAnalysis,(()=>z.show({text:s("analysis"),duration:"short",position:"bottom"}))),disabled:"view"!==t.vm.mode}),n("button.action_bar_button.training_action.fa.fa-backward",{oncreate:r(t.rewind,void 0,t.rewind),disabled:!t.canGoBackward()}),n("button.action_bar_button.training_action.fa.fa-forward",{oncreate:r(t.fastforward,void 0,t.fastforward),disabled:!t.canGoForward()})])}function Ct(t){return[n("button.li-button.training-control.retry",{oncreate:r(t.retry),className:t.vm.loading?"disabled":""},[n("span.fa.fa-refresh"),n("span",s("retryThisPuzzle"))]),n("button.li-button.training-control.continue",{oncreate:r(t.newPuzzle),className:t.vm.loading?"disabled":""},[n("span.fa.fa-play"),n("span",s("continueTraining"))])]}function _t(t){switch(t.vm.lastFeedback){case"init":return n("div.training-explanation",[n("div.player",[n("div.piece-no-square",{className:u.general.theme.piece()},n("piece.king."+t.data.puzzle.color)),n("div.training-instruction",[n("strong",s("yourTurn")),n("p",s("white"===t.data.puzzle.color?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]),xt(t)]);case"retry":return n("div.training-explanation",[n("div.player",[n("div.training-icon","!"),n("div.training-instruction",[n("strong",s("goodMove")),n("span",s("butYouCanDoBetter"))])]),xt(t)]);case"good":return n("div.training-explanation",[n("div.player",[n("div.training-icon.win","✓"),n("div.training-instruction",[n("strong",s("bestMove")),n("span",s("keepGoing"))])]),xt(t)]);case"fail":return n("div.training-explanation",[n("div.player",[n("div.training-icon.loss","✗"),n("div.training-instruction",[n("strong",s("puzzleFailed")),n("span",s("butYouCanKeepTrying"))])]),xt(t)])}}function xt(t){return t.vm.canViewSolution?n("button.fatButton",{oncreate:a=>{f(a.dom,1500,"0","0.8"),r(t.viewSolution)(a)}},s("viewTheSolution")):n("div.buttonPlaceholder","")}function Bt(t){return[n("p",t.getVotes()),n("div.buttons",[n("span.fa.fa-caret-up",{oncreate:r(t.upvote),className:!0===t.vm.voted?"voted":""}),n("span.fa.fa-caret-down",{oncreate:r(t.downvote),className:!1===t.vm.voted?"voted":""})])]}function Nt(t){return"win"===t.vm.lastFeedback?[n("div.training-half",[n("div.training-icon.win","✓"),n("strong",[s("victory")]),d.isConnected()?n("div.training-vote",Bt(t)):null]),n("div.training-half",Ct(t))]:[n("div.training-half",[n("strong","Puzzle complete!"),d.isConnected()?n("div.training-vote",Bt(t)):null]),n("div.training-half",Ct(t))]}function Tt(t){return"string"==typeof t}class TrainingCtrl{constructor(t,n){this.player=()=>this.data.puzzle.color,this.viewSolution=()=>{if(!this.vm.canViewSolution)return;this.sendResult(!1),this.vm.mode="view";const t=this.mergeSolution(this.data.puzzle.branch,this.data.puzzle.color),a=this.node.children[0];if(t)this.userJump(this.path.substr(0,this.path.length-1)+t.id.substr(1),!0);else if(a&&"good"===a.puzzle)this.userJump(this.path+a.id,!0);else{const t=E(this.mainline,(t=>"good"!==t.puzzle));t&&this.userJump(t+this.tree.nodeAtPath(t).children[0].id,!0)}i()},this.setPath=t=>{this.path=t,this.nodeList=this.tree.getNodeList(t),this.node=H(this.nodeList),this.mainline=W(this.tree.root)},this.jump=(t,a=!1)=>{const i=t!==this.path;this.setPath(t),this.updateBoard(),i&&a&&(this.node.san&&-1!==this.node.san.indexOf("x")?w.throttledCapture():w.throttledMove())},this.userJump=(t,a)=>{this.jump(t,a)},this.canGoForward=()=>!this.vm.initializing&&this.node.children.length>0,this.fastforward=()=>{if(0===this.node.children.length)return!1;const t=this.node.children[0];return this.userJump(this.path+t.id,!0),!0},this.canGoBackward=()=>!this.vm.moveValidationPending&&""!==this.path,this.resync=()=>{const t=d.get();if(e()&&t){if(this.vm.loading)return;this.vm.loading=!0,this.settings.close(),i();const a=t=>{this.vm.loading=!1,this.init(t),i()};st(this.database,t,this.vm.variant).then(a).catch((t=>{this.vm.loading=!1,i(),rt(t)}))}},this.rewind=()=>!!this.canGoBackward()&&(this.userJump(K(this.path),!1),!0),this.newPuzzle=()=>{if(this.vm.loading)return;this.vm.loading=!0,i();const t=t=>{this.vm.loading=!1,this.init(t),i()},a=d.get();a?ot(this.database,a,this.vm.variant).then(t).catch((t=>{this.vm.loading=!1,i(),rt(t)})):dt(this.vm.variant).then(t).catch(this.onXhrError)},this.retry=()=>{this.vm.loading||this.init(this.initialData)},this.upvote=()=>{this.vote(!0)},this.downvote=()=>{this.vote(!1)},this.vote=k((t=>{this.vm.voted=t,lt(this.data.puzzle.id,t,this.data.puzzle.variant.key).then((t=>{this.vm.vote=t[1],i()}))}),1e3),this.getVotes=()=>this.vm.vote,this.share=()=>{ft.share({url:`https://lidraughts.org/training/${this.data.puzzle.variant.key}/${this.data.puzzle.id}`})},this.goToAnalysis=()=>{const t=this.data.puzzle;e()&&"custom"!==t.gameId?a.set(`/analyse/online/${t.gameId}/${t.color}?ply=${t.initialPly}&curFen=${t.fen}&color=${t.color}&variant=${t.variant.key}}&fallback=1`):a.set(`/analyse/variant/${this.data.puzzle.variant.key}/fen/${encodeURIComponent(this.initialNode.fen)}?color=${t.color}&goBack=1`)},this.getNodeSituation=P((()=>{this.node&&!this.node.dests&&zt({variant:this.data.puzzle.variant.key,fen:this.node.fen,uci:this.node.uci,path:this.path,fullCapture:u.analyse.fullCapture()}).then((({situation:t,path:a})=>{this.tree.updateAt(a,(a=>{a.dests=t.dests,a.destsUci=t.destsUci,a.captLen=t.captureLength,a.end=t.end,a.draw=t.draw,a.player=t.player})),a===this.path&&(this.updateBoard(),i())})).catch((t=>{}))}),50),this.sendMove=(t,a,i)=>{const e={orig:t,dest:a,uci:i,variant:this.data.puzzle.variant.key,fen:this.node.fen,path:this.path,pdnMoves:this.node.pdnMoves,fullCapture:u.analyse.fullCapture()};this.sendMoveRequest(e,!0)},this.sendMoveRequest=(t,a=!1)=>{bt(t).then((({situation:t,path:e})=>{const n={id:t.id,ply:t.ply,fen:t.fen,uci:t.uci,children:[],dests:t.dests,destsUci:t.destsUci,captLen:t.captureLength,kingMoves:t.kingMoves,end:t.end,draw:t.draw,player:t.player,san:t.san,pdnMoves:t.pdnMoves};if(void 0===e)return;const s=this.tree.addNode(n,e);if(!s)return;const r=M(t.fen);a&&!r&&(this.vm.moveValidationPending=!0),this.jump(s,!a),i();if((this.node.ply%2==1?"white":"black")===this.data.puzzle.color){const t=function(t,a,i,e,n,s){if("view"===t)return null;if(!q(i,e))return null;const r=[];n.slice(X(e)+1).forEach((t=>{if(t.mergedNodes&&0!==t.mergedNodes.length)for(let a=0;a<t.mergedNodes.length;a++){const i=t.mergedNodes[a].uci;i&&r.push(i)}else t.uci&&r.push(t.uci)}));const o=r.reduce(((t,a)=>{if(t){for(;t&&!Tt(t)&&a.length>4;)t=t[a.slice(0,4)],a=a.slice(2);return Tt(t)?t:t[a]}}),s.lines);if(o){if(Tt(o))return a.puzzle=o,o;{const t=Object.keys(o)[0];if("win"===o[t])return a.puzzle="win","win";{((a.displayPly?a.displayPly:a.ply)%2==1?"white":"black")===s.color&&(a.puzzle="good");const e=b(t);return{variant:s.variant.key,orig:e[0],dest:e[1],fen:a.fen,path:i,fullCapture:u.analyse.fullCapture()}}}}{const t="fail";return a.puzzle=t,t}}(this.vm.mode,this.node,this.path,this.initialPath,this.nodeList,this.data.puzzle);t&&this.applyProgress(t,0!==r)}})).catch((t=>{}))},this.userMove=(t,a,i)=>{if(i?w.capture():w.move(),u.analyse.fullCapture()&&this.node.destsUci){const i=this.node.destsUci.find((i=>i.slice(0,2)===t&&i.slice(-2)===a));if(i)return void this.sendMove(t,a,i)}this.sendMove(t,a)},this.revertUserMove=t=>{setTimeout((()=>{this.vm.moveValidationPending=!1,this.userJump(K(t),!1),this.tree.deleteNodeAt(t),i()}),500)},this.applyProgress=(t,a)=>{if("fail"===t)this.vm.lastFeedback="fail",this.revertUserMove(this.path),"play"===this.vm.mode&&(this.vm.canViewSolution=!0,this.vm.mode="try",this.sendResult(!1));else if("retry"===t)this.vm.lastFeedback="retry",this.revertUserMove(this.path);else if("win"===t)this.vm.moveValidationPending=!1,"view"!==this.vm.mode&&("play"===this.vm.mode&&this.sendResult(!0),this.vm.lastFeedback="win",this.vm.mode="view");else if(void 0!==t.variant){this.vm.moveValidationPending=!1,this.vm.lastFeedback="good";const i=S(this.draughtsground.state),e=a?i:Math.max(500,i);setTimeout((()=>{this.sendMoveRequest(t)}),Math.max(300,e))}},this.sendResult=t=>{if(this.vm.resultSent)return;this.vm.resultSent=!0;const a=d.get(),n=this.data.puzzle.variant.key,s={id:this.data.puzzle.id,win:t,variant:n},r=()=>{pt(s).then((t=>{this.vm.voted=t.voted,this.data.user=t.user,i()})).catch((t=>{e()&&C(t),this.vm.resultSent=!1}))};a?ht(this.database,a,n).then((t=>{t.find((t=>t.puzzle.id===this.data.puzzle.id))?ut(this.database,a,s).then((t=>{t&&t.user&&(this.data.user=t.user,i())})):r()})):r()},this.onXhrError=t=>{this.vm.loading=!1,i(),C(t)},this.menu=yt.controller(this),this.database=n,this.init(t),this.settings=Mt.controller(this),_.afterLogin.add(this.retry)}isAlgebraic(){return 1===u.game.coordSystem()&&this.data.puzzle.variant.board&&"64"===this.data.puzzle.variant.board.key}coordSystem(){return this.isAlgebraic()?1:0}init(t){const e=t.puzzle.variant.key||"standard";u.training.variant(e),t.puzzle.variant.board||(t.puzzle.variant.board=y(e)),this.initialData=t,a.History.replaceState({puzzleId:t.puzzle.id},`/training/${t.puzzle.id}/variant/${e}`),this.vm={mode:"play",variant:e,initializing:!0,lastFeedback:"init",moveValidationPending:!1,loading:!1,canViewSolution:!1,resultSent:!1,voted:null,vote:t.puzzle.vote};const n=d.get();n&&ct(this.database,n,e).then((t=>{this.nbUnsolved=t,i()}));const s=JSON.parse(JSON.stringify(t)),r=s.game?Object.assign(Object.assign({},s.game),{variant:s.puzzle.variant}):void 0,o=Object.assign(Object.assign({},s),{game:r});this.data=o,this.tree=Q(this.data.game&&this.data.game.treeParts?Z([{fen:this.data.puzzle.fen,ply:this.data.puzzle.initialPly-1,id:"",children:[]},this.data.game.treeParts]):{id:"",ply:s.history.ply-1,fen:s.puzzle.fen,children:[{id:s.history.id,ply:s.history.ply,fen:s.history.fen,san:s.history.san,uci:s.history.uci,children:[]}]}),this.initialPath=tt(W(this.tree.root)),this.initialNode=this.tree.nodeAtPath(this.initialPath),this.setPath(K(this.initialPath)),this.updateBoard(),setTimeout((()=>{this.jump(this.initialPath,!0),this.vm.initializing=!1}),1e3),setTimeout((()=>{this.vm.canViewSolution=!0,i()}),5e3),i()}updateBoard(){const t=this.node,a=t.ply%2==0?"white":"black",i=x(t.dests),e=this.data.puzzle.variant.board||y(this.data.puzzle.variant.key),n={fen:t.fen,boardSize:e.size,variant:this.data.puzzle.variant.key,coordinates:u.game.coords(),coordSystem:this.coordSystem(),turnColor:a,orientation:this.data.puzzle.color,movableColor:this.gameOver()?null:this.data.puzzle.color,dests:i||null,captureLength:t.captLen,captureUci:u.analyse.fullCapture()&&this.node.destsUci&&this.node.destsUci.length?this.node.destsUci.concat():void 0,lastMove:t.uci?B(t.uci):null};this.draughtsground?this.draughtsground.set(n):this.draughtsground=new N(function(t,a){const i=u.game.pieceMove(),e=t.data.puzzle.variant.board||y(t.data.puzzle.variant.key);return{fen:t.data.puzzle.fen,boardSize:e.size,orientation:t.data.puzzle.color,coordinates:u.game.coords(),coordSystem:t.coordSystem(),turnColor:t.node.ply%2==0?"white":"black",highlight:{lastMove:u.game.highlights(),kingMoves:u.game.kingMoves()},movable:{free:!1,color:t.data.puzzle.color,showDests:u.game.pieceDestinations(),variant:t.data.puzzle.variant.key},events:{move:a},animation:{enabled:!0,duration:300},premovable:{enabled:!1,variant:t.data.puzzle.variant.key},draggable:{enabled:"drag"===i||"both"===i,distance:3,magnified:u.game.magnified()},selectable:{enabled:"tap"===i||"both"===i}}}(this,this.userMove)),i||this.getNodeSituation()}gameOver(){return!!this.node&&("view"===this.vm.mode||!!this.node.end)}mergeSolution(t,a){const i=t=>{"white"===a==((t.displayPly?t.displayPly:t.ply)%2==1)&&(t.puzzle="good")},e=at(t);it(e,i);const n=et(this.initialNode,e.id);let s;return n?(s=nt(n,e,t),s&&it(s,i)):this.initialNode.children.push(e),s}}const $t={};var jt={oninit({attrs:t}){const a="daily"===t.id,e=a?void 0:T(t.id)||$(t.id),n=a?"standard":t.variant||(e?"standard":u.training.variant())||"standard",s=u.training.supportedVariants.includes(n)?n:"standard",r=()=>{const t=d.get();t?ot(gt,t,s).catch((()=>dt(s))).then((t=>{this.ctrl=new TrainingCtrl(t,gt),$t.ctrl=this.ctrl})).catch(rt):dt(s).then((t=>{this.ctrl=new TrainingCtrl(t,gt),$t.ctrl=this.ctrl})).catch(C)},o=t=>{404===t.status?(z.show({text:"Puzzle not found.",duration:"short"}),r()):C(t)};e?$t.ctrl&&window.history.state.puzzleId===e?(this.ctrl=$t.ctrl,this.ctrl.updateBoard(),i()):vt(e,s).then((t=>{this.ctrl=new TrainingCtrl(t,gt),$t.ctrl=this.ctrl})).catch(o):a?mt().then((t=>{this.ctrl=new TrainingCtrl(t,gt),$t.ctrl=void 0})).catch(o):r(),j.createDefault(),U()},oncreate:V,onremove(){this.ctrl&&_.afterLogin.remove(this.ctrl.retry),F()},view({attrs:t}){const a=R()?"o-portrait":"o-landscape";return this.ctrl?L.board(function(t){const a=u.training.puzzleBufferLen;return t.vm.loading?p():v(n("div.main_header_title.withSub",[n("h1",[n(`span.withIcon[data-icon=${g(t.data.puzzle.variant.key)}]`),s("puzzleId",t.data.puzzle.id)]),n("h2.header-subTitle",[s("rating")," "+("view"===t.vm.mode?t.data.puzzle.rating:"?")," • ",m("playedXTimes",t.data.puzzle.attempts)].concat(e()?[]:[" • ",n("span.fa.fa-database"),`${t.nbUnsolved}/${a}`]))]))}(this.ctrl),function(t,a){const i=n(A,{variant:t.data.puzzle.variant.key,draughtsground:t.draughtsground});return n.fragment({key:a},[i,n("div.table.training-tableWrapper",[n("div.training-table.native_scroller.box","view"===t.vm.mode?Nt(t):_t(t)),St(t)])])}(this.ctrl,a),void 0,(i=this.ctrl,[yt.view(i.menu),Mt.view(i.settings)])):L.board(p(),[n("section.board_wrapper",[n(I,{fen:t.initFen||O,orientation:t.initColor||"white",variant:t.variant||"standard"})]),n("div.table.training-tableWrapper")],void 0);var i}};export{jt as default};
