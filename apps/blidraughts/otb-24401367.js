import{a7 as t,o as e,z as a,p as o,a8 as s,e as i,m as n,aJ as r,aw as l,a9 as c,ag as p,r as u,d as h,aI as d,A as m,aK as v,aL as f,aM as b,ai as y,aN as g,M as k,aO as w,k as P,a6 as _,s as C,aP as j,I as G,aQ as N,aR as M,u as F,aS as O}from"./main.js";import{s as x,g as S}from"./offlineGames-b5d74ab7.js";import{l as T}from"./layout-26cca27d.js";import{v as A}from"./roundView-c826907d.js";import{G as L}from"./GameTitle-898aeee2.js";import{S as R}from"./index-28ac80d9.js";import{i as E}from"./draughts-5f7918a7.js";import{g as I}from"./game-3e605d21.js";import{r as B,a as D,b as $,g as V,s as W,R as H,d as z,c as J,e as K,f as Q,h as U,i as X,j as q}from"./view-05bee3e3.js";import{c as Y,a as Z}from"./clockSet-8fd6c224.js";import{I as tt}from"./ImporterCtrl-5ddd0d2b.js";import{B as et}from"./Board-25b97c43.js";import"./CountdownTimer-ca9a10d1.js";import"./tournamentXhr-d3fb9e28.js";import"./notes-2c1d8afe.js";import"./chat-1f5c68bb.js";var at={controller(t){let e=!1;function a(t){"backbutton"!==t&&e&&n.backbutton.stack.pop(),e=!1}return{open:function(){n.backbutton.stack.push(a),e=!0},close:a,isOpen:function(){return e},root:t}},view:function(n){return n.isOpen()?t("offline_actions",void 0,(function(){return[B(n.root)].concat(D(n.root),$(n.root),function(t){return[e("div",[e("button[data-icon=A]",{oncreate:a(t.goToAnalysis)},o("analysis"))]),e("div.action",s.renderCheckbox(o("otbFlipPiecesAndInfoAfterMove"),"flipPieces",i.otb.flipPieces,(e=>V.changeOTBMode(t.draughtsground,e,i.otb.mirrorPieces())))),e("div.action",s.renderCheckbox(o("otbMirrorOpponentPiecesAndInfo"),"mirrorPieces",i.otb.mirrorPieces,(e=>V.changeOTBMode(t.draughtsground,i.otb.flipPieces(),e)),i.otb.flipPieces()))]}(n.root))}),n.isOpen(),n.close):null}},ot={controller(t){const e=p(!1);function a(t){"backbutton"!==t&&!0===e()&&n.backbutton.stack.pop(),e(!1)}return{open:function(){n.backbutton.stack.push(a),e(!0)},close:a,isOpen:e,root:t}},view:function(p){return p.isOpen()?t("new_offline_game",void 0,(function(){const t=i.otb.availableVariants,u=p.root.vm.setupFen?t.filter((t=>!r.has(t[1]))):t,h=i.otb.variant(),d=p.root.vm.setupFen&&r.has(h);return e("div",null,e("p",{className:"title"},o("createAGame")),e("div",{className:"action"},d?e("div",{className:"select_input disabled"},e("label",{for:"variant"},o("variant")),e("select",{disabled:!0,id:"variant"},e("option",{value:h,selected:!0},l(h).name))):e("div",{className:"select_input"},s.renderSelect("variant","variant",u,i.otb.variant)),p.root.vm.setupFen?e("div",{className:"from_position_wrapper"},e("p",null,o("fromPosition")),e("div",{className:"from_position"},e("div",{style:{width:"130px",height:"130px"},oncreate:a((()=>{p.root.vm.setupFen&&n.set(`/editor/${encodeURIComponent(p.root.vm.setupFen)}`)}))},e(c,{fen:p.root.vm.setupFen,variant:h,orientation:"white"})))):null,e("div",{className:"select_input"},s.renderSelect(o("clock"),"clock",i.otb.availableClocks,i.otb.clockType,!1,st)),Y(i.otb.clockType(),st)),e("div",{className:"popupActionWrapper"},e("button",{className:"defaultButton",oncreate:a((()=>{p.close(),p.root.startNewGame(i.otb.variant(),p.root.vm.setupFen,i.otb.clockType())}))},o("play"))))}),p.isOpen(),(()=>{p.root.vm.setupFen&&n.set("/otb"),p.close()})):null}};function st(){u()}var it={controller(t){let e=!1;function a(t){"backbutton"!==t&&e&&n.backbutton.stack.pop(),e=!1}return{open:function(){n.backbutton.stack.push(a),e=!0},close:a,isOpen:function(){return e},root:t,importer:tt()}},view:s=>t("OtbImportGamePopup",void 0,(()=>{const t=i.otb.whitePlayer,n=i.otb.blackPlayer;return e("div",[e("p",o("importGameStateWithPlayerNames")),e("form",[e("div.exchange",{oncreate:a((()=>{const e=t(),a=n();t(a),n(e)}))},e("span.fa.fa-exchange.fa-rotate-90")),e("div.importMeta.text_input_container",[e("label",o("white")),e("input[type=text]",{value:t(),oninput:h((e=>{const a=e.target.value.trim();t(a)}),300),onfocus(){this.select()},spellcheck:!1})]),e("div.importMeta.text_input_container",[e("label",o("black")),e("input[type=text]",{value:n(),oninput:h((t=>{const e=t.target.value.trim();n(e)}),300),onfocus(){this.select()},spellcheck:!1})])]),e("div.popupActionWrapper",[s.importer.importing()?e("div",[e("span.fa.fa-hourglass-half"),e("span","Importing...")]):e("button.popupAction.withIcon[data-icon=E]",{oncreate:a((()=>{var t;const e=i.otb.whitePlayer,a=i.otb.blackPlayer;null===(t=s.root.replay)||void 0===t||t.pdn(e(),a()).then((t=>{s.importer.importGame(t.pdn)}))}))},o("importGame"))])])}),s.isOpen(),s.close)};class OtbRound{constructor(t,e,a){this.goToAnalysis=()=>{this.replay&&n.set(`/analyse/offline/otb/${this.data.player.color}?ply=${this.replay.ply}&curFen=${this.replay.situation().fen}&variant=${this.data.game.variant.key}`)},this.save=()=>{this.replay&&x({data:this.data,situations:this.replay.situations,ply:this.replay.ply})},this.saveClock=()=>{this.clock&&this.clock.isRunning()&&this.clock.startStop(),this.save()},this.isClockEnabled=()=>!!this.clock&&void 0===this.clock.flagged()&&void 0!==this.clock.activeSide(),this.toggleClockPlay=()=>{this.clock&&this.isClockEnabled()&&this.clock.startStop()},this.sharePDN=()=>{var t;null===(t=this.replay)||void 0===t||t.pdn("White","Black").then((t=>R.share({text:t.pdn})))},this.userMove=(t,e)=>{var a;null===(a=this.replay)||void 0===a||a.addMove(t,e)},this.onMove=(t,e,a)=>{a?d.capture():d.move()},this.onFlag=t=>{const e={id:35,name:"outoftime"};W(this,e,"white"===t?"black":"white"),d.dong(),this.onGameEnd(e),this.save()},this.onReplayAdded=t=>{const e="white"===t.player?"black":"white";this.clock&&this.clock.clockHit(e),this.data.game.fen=t.fen,this.apply(t),W(this,t.status),I.finished(this.data)&&this.onGameEnd(t.status),this.save(),u()},this.onThreefoldRepetition=t=>{W(this,t),this.save(),this.onGameEnd(t)},this.onGameEnd=t=>{this.clock&&this.clock.isRunning()&&this.clock.startStop(),this.draughtsground.stop(t),setTimeout((()=>{this.actions.open(),u()}),500)},this.player=()=>{var t;return(null===(t=this.replay)||void 0===t?void 0:t.situation().player)||"white"},this.jump=(t,e)=>(this.draughtsground.cancelMove(),t<0||t>=this.replay.situations.length||(this.replay.ply=t,this.apply(this.replay.situation(),e)),!1),this.jumpNext=()=>this.jump(this.replay.ply+1,"redo"),this.jumpPrev=()=>this.jump(this.replay.ply-1,"undo"),this.jumpFirst=()=>this.jump(this.firstPly(),"undo"),this.jumpLast=()=>this.jump(this.lastPly(),"redo"),this.firstPly=()=>0,this.lastPly=()=>this.replay.situations.length-1,this.replaying=()=>this.replay.ply!==this.lastPly(),this.canDrop=()=>!0,this.setupFen=e,this.actions=at.controller(this),this.importGamePopup=it.controller(this),this.newGameMenu=ot.controller(this),this.vm={flip:!1,setupFen:e,setupVariant:a,savedFen:t?t.data.game.fen:void 0,savedVariant:t?t.data.game.variant.key:void 0},this.moveList=!!i.game.moveList(),e?(this.newGameMenu.isOpen(!0),a&&i.otb.variant(a),u()):t&&0!==t.ply||this.newGameMenu.open();const o=i.otb.variant();if(!e)if(t)try{this.init(t.data,t.situations,t.ply)}catch(t){this.startNewGame(o,void 0,i.otb.clockType())}else this.startNewGame(o,void 0,i.otb.clockType());this.setupListeners()}async setupListeners(){this.appStateListener=await m.addListener("appStateChange",(t=>{t.isActive||this.saveClock()}))}unload(){var t;null===(t=this.appStateListener)||void 0===t||t.remove(),this.saveClock()}init(t,e,a){this.actions.close(),this.data=t;const o=this.data.game.variant.key,s=this.data.game.initialFen;if(this.replay?this.replay.init(o,s,e,a):this.replay=new H(o,s,e,a,this.onReplayAdded,this.onThreefoldRepetition),t.offlineClock){const e=t.offlineClock.clockType;this.clock=Z[e](this.onFlag),this.clock.setState(t.offlineClock)}else this.clock=void 0;this.draughtsground?V.reload(this.draughtsground,this.data,this.replay.situation()):this.draughtsground=V.make(this.data,this.replay.situation(),this.userMove,this.onMove),u()}startNewGame(t,e,a){const o={variant:t,fen:e||v(t)},s=a&&"none"!==a?Z[a](this.onFlag):null;E(o).then((t=>{this.init(z({id:"offline_otb",variant:t.variant,initialFen:t.setup.fen,fen:t.setup.fen,player:t.setup.player,color:this.data&&f(this.data.player.color)||t.setup.player,pref:{centerPiece:!0},clock:s?s.getState():null,captureLength:t.setup.captureLength}),[t.setup],t.setup.ply)})).then((()=>{e&&(this.vm.setupFen=void 0,n.History.replaceState(void 0,"/otb"))}))}apply(t,e){if(t){this.clock&&this.clock.activeSide()!==t.player&&this.clock.toggleActiveSide();const a=t.uciMoves.length?t.uciMoves[t.uciMoves.length-1]:null;this.draughtsground.set({fen:t.fen,turnColor:t.player,lastMove:a?b(a):null,dests:t.dests,captureLength:t.captureLength,movableColor:t.player,shift:e})}}}function nt(t){return e("section",{className:"actions_bar"},e("button",{className:"action_bar_button fa fa-ellipsis-v",oncreate:a(t.actions.open)}),e("button",{className:"action_bar_button fa fa-plus-circle",oncreate:a((()=>{t.saveClock(),t.newGameMenu.open()}),(()=>_.show({text:o("createAGame"),duration:"short",position:"bottom"})))}),e("button",{className:"fa fa-share-alt action_bar_button",oncreate:a(t.sharePDN,(()=>_.show({text:o("sharePDN"),duration:"short",position:"bottom"})))}),t.clock?e("button",{className:"fa action_bar_button "+(t.clock.isRunning()?"fa-pause":"fa-play")+(t.isClockEnabled()?"":" disabled"),oncreate:a(t.toggleClockPlay,(()=>_.show({text:o("draughtsClock"),duration:"short",position:"bottom"})))}):null,P()?e("button",{className:"fa fa-cloud-upload action_bar_button",oncreate:a(t.importGamePopup.open,(()=>_.show({text:o("importGameOnLidraughts"),duration:"short",position:"bottom"})))}):null,q(t),X(t),U(t))}var rt={oninit({attrs:t}){C.createDefault(),S().then((e=>{this.round=new OtbRound(e,t.fen,t.variant),window.addEventListener("unload",this.round.saveClock)})),j()},oncreate:G,onremove(){N(),this.round&&(this.round.unload(),window.removeEventListener("unload",this.round.saveClock))},view({attrs:t}){let a,s;if(this.round&&this.round.data&&this.round.draughtsground)s=M(e(L,{data:this.round.data})),a=function(t,a){const s=i.otb.flipPieces(),n=i.otb.mirrorPieces(),r=y({otb:!0,mode_flip:s,mode_facing:!s&&n,turn_white:"white"===t.draughtsground.state.turnColor,turn_black:"black"===t.draughtsground.state.turnColor}),l=t.draughtsground.getMaterialDiff(),c=o(t.data.player.color),p=o(t.data.opponent.color),u=J(t),h=g(),d=k(),m=e(et,{variant:t.data.game.variant.key,draughtsground:t.draughtsground,wrapperClasses:r,customPieceTheme:a}),v=t.clock;return h?[w(d,h)?K(t):null,Q(t,p,l[t.data.opponent.color],"opponent",s,n,v),m,Q(t,c,l[t.data.player.color],"player",s,n,v),nt(t)]:[m,e("section",{className:"table"},Q(t,p,l[t.data.opponent.color],"opponent",s,n,v),u,nt(t),Q(t,c,l[t.data.player.color],"player",s,n,v))]}(this.round);else{const e=t.fen||F,i=t.variant||"standard",n=e?O(e):"white";s=M(o("playOfflineOverTheBoard")),a=A(e,n,i,void 0,void 0)}return T.board(s,a,void 0,this.round&&(n=this.round,[at.view(n.actions),ot.view(n.newGameMenu),it.view(n.importGamePopup)]),void 0,this.round&&this.round.data&&this.round.data.player.color||"white");var n}};export{rt as default};
