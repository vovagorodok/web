import{m as t,aZ as e,r as a,d as s,ad as i,ao as r,o,cv as n,z as c,af as d,p as l,v as h,h as u,q as p,ci as g,cD as m,cE as v,I as y,s as S,aR as f}from"./main.js";import{l as b}from"./layout-26cca27d.js";import{b as w,l as P}from"./studyXhr-5c18575b.js";class StudyIndexCtrl{constructor(r="all",o="popular",n){if(this.cat=r,this.order=o,this.q=n,this.initialized=!1,this.toggleSearch=()=>{this.state.showSearch=!this.state.showSearch},this.canCancelSearch=t=>{this.state.canCancelSearch=t},this.cancelSearch=()=>{this.q?t.setQueryParams({cat:this.cat,order:this.order},!0):this.state.showSearch=!1},this.onSearch=e=>{e.preventDefault(),e.stopPropagation();const a=e.target[0].value.trim();t.setQueryParams({q:a},!0)},this.onCatChange=e=>{const a=e.target.value;t.setQueryParams({cat:a},!0)},this.onOrderChange=e=>{const a=e.target.value;t.setQueryParams({order:a},!0)},this.onScroll=t=>{const e=t.target,a=e.firstChild,s=this.state.paginator,i=s&&s.nextPage;e.scrollTop+e.offsetHeight+50>a.offsetHeight&&!this.state.isLoading&&i&&i<40&&this.loadNextPage(i),this.state.scrollPos=e.scrollTop,this.saveState()},this.afterLoad=({dom:t})=>{this.cacheAvailable&&!this.initialized&&e((()=>{C&&(t.parentNode.scrollTop=C.scrollPos),this.initialized=!0}))},this.loadNextPage=t=>{this.state.isLoading=!0;(this.q?w(this.q,t):P(this.cat,this.order,t)).then((t=>{this.state.paginator=t.paginator,this.state.isLoading=!1,this.state.studies=this.state.studies.concat(t.paginator.currentPageResults.map(I)),this.saveState(),a()})),a()},this.saveState=s((()=>{C=this.state}),200),this.state={studies:[],paginator:void 0,scrollPos:0,showSearch:!!this.q,canCancelSearch:!!this.q,isLoading:!1,stateId:this.q||this.cat+this.order},this.cacheAvailable=!!C&&this.state.stateId===C.stateId,this.cacheAvailable)setTimeout((()=>{Object.assign(this.state,C),a()}),300);else{(this.q?w(this.q):P(this.cat,this.order)).then((t=>{this.state.studies=t.paginator.currentPageResults.map(I),this.state.paginator=t.paginator,a()})).catch(i)}}goToStudy(e){t.set(`/study/${e}`)}}let C;function I(t){return Object.assign(Object.assign({},t),{date:r(new Date(t.updatedAt))})}const q=[["all","allStudies"],["mine","myStudies"],["member","studiesIContributeTo"],["public","myPublicStudies"],["private","myPrivateStudies"],["likes","myFavoriteStudies"]],x=[["hot","hot"],["newest","dateAddedNewest"],["updated","dateAddedOldest"],["popular","mostPopular"]];function T(t){const e=t.state?t.state.studies:[];return o("div#scroller-wrapper.native_scroller.study-pagerScroller.box",{onscroll:u(t.onScroll,30),oncreate:p((e=>function(t,e){const a=v(e,".study-pagerItem"),s=null==a?void 0:a.dataset.id;s&&t.goToStudy(s)}(t,e)),void 0,m(".study-pagerItem"))},t.state.paginator?e.length?o("ul",{oncreate:t.afterLoad},[...e.map(((t,e)=>o(L,{study:t,index:e}))),t.state.isLoading?o("li.list_item.study-pagerItem","loading..."):[]]):o("div.study-pagerEmpty",l("noneYet")):o("div.study-pagerLoader",h.getVdom("monochrome")))}const L={onbeforeupdate:({attrs:t},{attrs:e})=>t.study!==e.study,view({attrs:t}){const{study:e,index:a}=t,s=e.owner?g(e.owner):"?";return o("li.list_item.study-pagerItem",{className:a%2==0?"even":"odd","data-id":e.id},[o("div.study-pagerItemTitle",[o("i[data-icon=4]"),o("div",[o("h2",e.name),o("h3",[o("i.fa",{className:e.liked?"fa-heart":"fa-heart-o"}),o("span",` ${e.likes} • ${s} • ${e.date}`)])])]),o("div.study-pagerItemBody",[o("ul.chapters",e.chapters.map((t=>o("li",[o("span.fa.fa-circle-o"),t])))),o("ul.members",e.members.filter((t=>null!==t.user)).map((t=>o("li.withIcon",{"data-icon":"w"===t.role?"":"v"},g(t.user)))))])])}};var j={oncreate:y,oninit({attrs:t}){S.createDefault(),this.ctrl=new StudyIndexCtrl(t.cat,t.order,t.q)},view(){const t=this.ctrl;return b.free(f(l("studyMenu")),function(t){return o("div.study-pagerWrapper",[o("div.study-pagerSubHeader.subHeader",[t.state.showSearch?o("form.study-pagerSearchWrapper",{onsubmit:t.onSearch},[o("div.inputWrapper",[o("input#studySearch[type=search]",{placeholder:"Search studies",autocapitalize:"off",autocomplete:"off",oncreate:n,value:t.q,oninput:s((e=>{const s=e.target.value.trim();t.canCancelSearch(s.length>0),a()}),200,{leading:!0,trailing:!0})}),t.state.canCancelSearch?o("div.cancel",{oncreate:c(t.cancelSearch)},d):null]),o("button",l("search"))]):o("div.study-pagerSelectWrapper",[o("div.categories",o("select.study-pagerSelect",{value:t.cat,onchange:t.onCatChange},q.map((t=>o("option",{key:t[0],value:t[0]},l(t[1])))))),o("div.orders",o("select.study-pagerSelect",{value:t.order,onchange:t.onOrderChange},x.map((t=>o("option",{key:t[0],value:t[0]},l(t[1]))))))]),o("div.study-pagerToggleSearch.fa.fa-search",{oncreate:c(t.toggleSearch)})]),T(t)])}(t))}};export{j as default};
