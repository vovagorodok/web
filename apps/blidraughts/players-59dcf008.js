import{at as e,r as a,m as t,d as s,ad as r,aR as n,o,p as c,z as i,e as l,q as d,aT as h,cB as u,cv as p,v as m,C as b,cC as f,G as g,s as y,H as v,I as _}from"./main.js";import{l as N}from"./layout-26cca27d.js";import{T as S,a as w}from"./TabView-6f41acb9.js";import{T}from"./game-3e605d21.js";class PlayersCtrl{constructor(n){this.isSearchOpen=!1,this.searchResults=[],this.onTabChange=e=>{const t=window.location.search.replace(/\?tab=\w+$/,"");try{window.history.replaceState(window.history.state,"",t+"?tab="+e)}catch(e){}this.currentTab=e,a()},this.closeSearch=e=>{"backbutton"!==e&&this.isSearchOpen&&t.backbutton.stack.pop(),this.isSearchOpen=!1},this.onSearchInput=e=>{const a=e.target.value.trim();/^[a-z0-9][\w-]{1,29}$/i.exec(a)&&a.length>=2&&this.searchXhr(a)},this.searchXhr=s((t=>{(async function(a){return(await e("/player/autocomplete?friend=1&object=1",{query:{term:a}})).result})(t).then((e=>{this.searchResults=e,a()}))}),300),this.goSearch=()=>{t.backbutton.stack.push(this.closeSearch),this.isSearchOpen=!0},this.goToProfile=e=>{t.set("/@/"+e)},this.currentTab=n||0,async function(){const a=await e("/player/online",{query:{nb:50}});return a.forEach((e=>e.online=!0)),a}().then((e=>{this.players=e,a()})).catch(r),e("/player").then((e=>{this.leaderboard=e,a()})).catch(r)}}function z(e){const a=[{id:"leaderboard",f:()=>function(e){const a=e.leaderboard;if(!a)return o("div",{className:"loader_container"},m.getVdom("monochrome"));const s=Object.keys(a).filter((e=>"online"!==e&&T(e))).map((e=>function(e,a){return o("section",{className:"leaderboard_section "+a},o("h3",{className:"leaderboard_title"},o("span",{className:"perfIcon","data-icon":b(a)}),f(a)),o("ul",{className:"leaderboard"},e[a].map((e=>function(e,a){return o("li",{className:"list_item leaderboard_player",oncreate:d((()=>t.set("/@/"+e.id)))},h(e),o("span",{className:"rating"},e.perfs[a].rating))}(e,a)))))}(a,e)));return o("div",{className:"native_scroller page leaderboard_wrapper"},s)}(e)},{id:"players",f:()=>function(e){return e.players?o("ul",{className:"playersSuggestion native_scroller page",oncreate:d(j,void 0,g)},e.players.map(k)):o("div",{className:"loader_container"},m.getVdom("monochrome"))}(e)}];return[o("div.tabs-nav-header.subHeader",o(S,{buttons:[{label:c("leaderboard")},{label:c("onlinePlayers")}],selectedIndex:e.currentTab,onTabChange:e.onTabChange})),o(w,{selectedIndex:e.currentTab,tabs:a,onTabChange:e.onTabChange})]}function j(e){const a=g(e);if(a){const e=a.dataset;e.id&&t.set("/@/"+e.id)}}function k(e,a){const t=a%2==0?"even":"odd";let s=0;Object.keys(e.perfs).forEach((a=>{"opening"!==a&&"puzzle"!==a&&"puzzlefrisian"!==a&&(s+=e.perfs[a].games)}));const r=Math.max(1,Math.floor(s/10)),n=Object.keys(e.perfs).reduce(((a,t)=>"opening"===t||"puzzle"===t||"puzzlefrisian"===t||e.perfs[t].games<r?a:!a||e.perfs[a].rating<e.perfs[t].rating?t:a),""),c=n?e.perfs[n]:void 0;return o("li",{className:`list_item playerSuggestion nav ${t}`,"data-id":e.id},h(e),c&&c.games?o("span",{className:"rating","data-icon":b(n)},c.rating,c.prov?"?":""):null)}var C={oninit({attrs:e}){y.createDefault(),this.ctrl=new PlayersCtrl(v(e.tab))},oncreate:_,view(){const e=this.ctrl,a=function(e){return n(o("div.players_main_header",[o("div.main_header_title",c("players")),o("button.main_header_button[data-icon=y]",{oncreate:i(e.goSearch)})]))}(e),t=z(e),s=function(e){if(!e.isSearchOpen)return null;const a=["modal","show",l.general.theme.background()].join(" ");return o("div",{id:"searchPlayersModal",className:a},o("header",{class:"main_header"},o("button",{className:"main_header_button",oncreate:i((()=>e.closeSearch()))},u),o("div",{className:"search_input allow_select"},o("input",{id:"searchPlayers",type:"search",placeholder:"Search players",oninput:e.onSearchInput,autocapitalize:"off",autocomplete:"off",oncreate:p}))),o("ul",{id:"playersSearchResults",className:"modal_content native_scroller"},e.searchResults.map(((a,t)=>o("li",{className:"list_item nav "+(t%2==0?"even":"odd"),key:a.id,oncreate:d((()=>e.goToProfile(a.id)))},h(Object.assign({username:a.name},a)))))))}(e);return N.free(a,t,void 0,s)}};export{C as default};
