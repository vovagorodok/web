import{at as e,bg as t,a7 as a,m as n,o as s,z as i,p as o,ai as r,v as l,bK as c,r as d,ad as h,b as u,e as p,bL as m,bM as v,bN as f,aL as g,bO as y,a8 as b,a6 as w,bP as x,U as k,G as M,q as C,ag as P,bQ as N,B as S,au as T,aB as _,ar as A,aZ as D,bR as I,aU as O,b2 as B,bS as z,aY as E,bT as $,b9 as F,bU as U,bV as j,bA as L,u as W,a9 as G,C as R,K as V,bW as H,bX as q,bY as J,bZ as X,bd as K,b_ as Q,bh as Y,d as Z,b$ as ee,bk as te,bm as ae,c0 as ne,c1 as se,s as ie,k as oe,aI as re,bF as le,c2 as ce,n as de,c3 as he,ba as ue,c4 as pe,bC as me,c5 as ve,aM as fe}from"./main.js";import{c as ge}from"./continuePopup-d2e303e3.js";import{g as ye,n as be,N as we}from"./notes-2c1d8afe.js";import{a as xe,T as ke}from"./TabView-6f41acb9.js";import{l as Me}from"./layout-26cca27d.js";import{c as Ce,C as Pe}from"./chat-1f5c68bb.js";import{d as Ne,B as Se,C as Te,D as _e,E as Ae,F as De,G as Ie,H as Oe,n as Be,g as ze,I as Ee,J as $e,K as Fe,L as Ue,b as je,M as Le,N as We,O as Ge,P as Re,Q as Ve,R as He}from"./game-3e605d21.js";import{h as qe,c as Je,d as Xe,m as Ke,i as Qe,l as Ye,r as Ze,b as et,a as tt,f as at,t as nt,e as st,w as it}from"./area-59c9c857.js";import{s as ot,l as rt,a as lt}from"./axis-d343de69.js";import{B as ct}from"./Board-25b97c43.js";import{p as dt,m as ht,s as ut}from"./draughts-5f7918a7.js";import{v as pt}from"./vibrate-985a16e3.js";import{S as mt}from"./index-28ac80d9.js";import{s as vt,a as ft}from"./studyXhr-5c18575b.js";function gt(t,a){return e(`/${t}/${a}/analysis`)}function yt(e){return void 0!==e.url}var bt={controller(e){let t=!1;function a(e){"backbutton"!==e&&t&&n.backbutton.stack.pop(),t=!1,s.showShareMenu=!1}const s={showShareMenu:!1,computingPDN:!1,computingPDNAnnotated:!1};return{open:function(){n.backbutton.stack.push(a),t=!0},close:a,isOpen:()=>t,root:e,s:s}},view:e=>a("analyse_menu",void 0,(()=>e.s.showShareMenu?function(e){return s("div.analyseMenu",s.fragment({key:"shareMenu"},[yt(e.data)?s("button",{oncreate:i((()=>{e.menu.close(),mt.share({url:Se(e.data)})}))},[o("shareGameURL")]):null,"offline"===e.source?s("button",{oncreate:i((()=>{!function(e){if(!e.menu.s.computingPDN){e.menu.s.computingPDN=!0;const t=e.tree.lastNode(),a="white"===e.data.player.color?"offline_ai"===e.data.game.id?u.appUser("Anonymous"):"Anonymous":"offline_ai"===e.data.game.id?e.data.opponent.username:"Anonymous",n="black"===e.data.player.color?"offline_ai"===e.data.game.id?u.appUser("Anonymous"):"Anonymous":"offline_ai"===e.data.game.id?e.data.opponent.username:"Anonymous";dt({variant:e.data.game.variant.key,algebraic:e.isAlgebraic(),initialFen:e.data.game.initialFen,pdnMoves:t.pdnMoves||[],finalSquare:!0,white:a,black:n}).then((t=>{e.menu.s.computingPDN=!1,e.menu.close(),d(),mt.share({text:t.pdn})})).catch((t=>{e.menu.s.computingPDN=!1,d()}))}}(e)}))},e.menu.s.computingPDN?l.getVdom("monochrome"):o("sharePDN")):null,"online"!==e.source||Ne(e.data)?null:s("button",{oncreate:i((()=>{wt(e,!1)}))},e.menu.s.computingPDNAnnotated?l.getVdom("monochrome"):o("shareAnnotatedPDN")),"online"!==e.source||Ne(e.data)?null:s("button",{oncreate:i((()=>{wt(e,!0)}))},e.menu.s.computingPDN?l.getVdom("monochrome"):o("shareRawPDN")),e.isOfflineOrNotPlayable()?s("button",{oncreate:i((()=>{e.menu.close(),mt.share({text:c(e.node.fen,e.isAlgebraic())})}))},o("shareFEN")):null]))}(e.root):function(e){return s("div.analyseMenu",s.fragment({key:"analyseMenu"},[s("button",{oncreate:i((()=>{e.menu.s.showShareMenu=!0}))},[s("span.fa.fa-share-alt"),o("shareAndExport")]),e.isOfflineOrNotPlayable()?s("button[data-icon=U]",{oncreate:i((()=>{e.menu.close(),e.continuePopup.open(e.node.fen,e.data.game.variant.key,e.data.player.color)}))},o("continueFromHere")):null,e.isOfflineOrNotPlayable()?s("button",{oncreate:i((()=>n.set(`/editor/variant/${encodeURIComponent(e.data.game.variant.key)}/fen/${encodeURIComponent(e.node.fen)}`)))},[s("span.fa.fa-pencil"),o("boardEditor")]):null,e.data.analysis?s("button",{oncreate:i((()=>{e.menu.close(),e.toggleRetro()})),disabled:!!e.retro},[s("span.fa.fa-play"),o("learnFromYourMistakes")]):null,e.ceval.allowed?s("button",{oncreate:i((()=>{e.menu.close(),e.togglePractice()}))},[s("span.fa.fa-bullseye"),o("practiceWithComputer")]):null,e.ceval.allowed?s("button",{className:r({on:e.showThreat}),oncreate:i((()=>{e.menu.close(),e.toggleShowThreat()}))},[s("span.fa.fa-crosshairs"),o("showThreat")]):null,e.notes?s("button",{oncreate:i((()=>{e.notes&&(e.menu.close(),e.notes.open())}))},[s("span.fa.fa-pencil"),o("notes")]):null]))}(e.root)),e.isOpen(),e.close)};function wt(e,t){(t&&!e.menu.s.computingPDN||!t&&!e.menu.s.computingPDNAnnotated)&&(t?e.menu.s.computingPDN=!0:e.menu.s.computingPDNAnnotated=!0,ye(e.data.game.id,e.isAlgebraic(),t).then((t=>{e.menu.s.computingPDN=!1,e.menu.s.computingPDNAnnotated=!1,e.menu.close(),d(),mt.share({text:t})})).catch((t=>{e.menu.s.computingPDN=!1,e.menu.s.computingPDNAnnotated=!1,d(),h(t)})))}function xt(e){(function(){const e="light"===p.general.theme.background()?"shepherd-theme-dark":"shepherd-theme-default";return m(`vendor/shepherd/css/${e}.css`).then((()=>m("vendor/shepherd/css/shepherd.css"))).then((()=>v("vendor/shepherd/js/tether.js"))).then((()=>v("vendor/shepherd/js/shepherd.min.js"))).then((()=>e))})().then((t=>{const a=new window.Shepherd.Tour({defaults:{classes:"shepherd-element "+t,showCancelLink:!0}});a.addStep("welcome",{title:"Welcome to lidraughts study!",text:"This is a shared analysis board.<br><br>Use it to analyse games,<br>discuss positions with friends,<br>and of course for draughts lessons!"}),a.addStep("members",{title:"Study members",text:"<i data-icon='v'></i> Spectators can view the study and talk in the chat.<br><br><i class='fa fa-user'></i> Contributors can make moves and update the study.<br><br>Studies are for now read-only in the application, so you must go to lidraughts.org to contribute to them. More features will come later in lidraughts app.",when:{"before-show":()=>{e.sideMenu.open()}}}),a.addStep("chapters",{title:"Study chapters",text:"A study can contain several chapters.<br>Each chapter has a distinct initial position and move tree.",when:{"before-show":()=>{e.sideMenu.open()}},buttons:[{text:"Done",action:a.next}]}),a.start()}))}var kt={controller(e){let t=!1;const a={showShareMenu:!1,loadingStudyPDN:!1,loadingChapterPDN:!1};function s(e){"backbutton"!==e&&t&&n.backbutton.stack.pop(),t=!1,a.showShareMenu=!1}return{open:function(){n.backbutton.stack.push(s),t=!0},close:s,isOpen:()=>t,root:e,s:a}},view:e=>a("analyse_menu",void 0,(()=>e.s.showShareMenu?function(e){function t(t){e.study.actionMenu.s.loadingChapterPDN=!1,e.study.actionMenu.s.loadingStudyPDN=!1,d(),mt.share({text:t})}function a(t){e.study.actionMenu.s.loadingChapterPDN=!1,e.study.actionMenu.s.loadingStudyPDN=!1,d(),h(t)}return s("div.analyseMenu",{key:"shareMenu"},[s("button",{oncreate:i((()=>{const t=Mt+`study/${e.study.data.id}`;mt.share({url:t})}))},[o("studyUrl")]),s("button",{oncreate:i((()=>{const t=Mt+`study/${e.study.data.id}/${e.study.data.chapter.id}`;mt.share({url:t})}))},[o("currentChapterUrl")]),s("button",{oncreate:i((()=>{e.study.actionMenu.s.loadingStudyPDN=!0,vt(e.study.data.id).then(t).catch(a)}))},e.study.actionMenu.s.loadingStudyPDN?l.getVdom("monochrome"):[o("studyPdn")]),s("button",{oncreate:i((()=>{e.study.actionMenu.s.loadingChapterPDN=!0,ft(e.study.data.id,e.study.data.chapter.id).then(t).catch(a)}))},e.study.actionMenu.s.loadingChapterPDN?l.getVdom("monochrome"):[o("chapterPdn")])])}(e.root):function(e){return s("div.analyseMenu",{key:"studyMenu"},[s("button",{oncreate:i((()=>{e.study.actionMenu.s.showShareMenu=!0}))},[s("span.fa.fa-share-alt"),o("shareAndExport")]),s("button",{oncreate:i(e.study.toggleLike)},[s.trust("&nbsp;"),s("span.fa",{className:e.study.data.liked?"fa-heart":"fa-heart-o"}),`${o("like")} (${e.study.data.likes})`]),e.study&&e.study.chat?s("button[data-icon=B]",{oncreate:i(e.settings.flip)},o("flipBoard")):null,s("button[data-icon=U]",{oncreate:i((()=>{e.menu.close(),e.continuePopup.open(e.node.fen,e.data.game.variant.key,e.data.player.color)}))},o("continueFromHere")),e.ceval.allowed?s("button",{oncreate:i((()=>{e.menu.close(),e.togglePractice()}))},[s("span.fa.fa-bullseye"),o("practiceWithComputer")]):null,s("button",{oncreate:i((()=>n.set(`/editor/variant/${encodeURIComponent(e.data.game.variant.key)}/fen/${encodeURIComponent(e.node.fen)}`)))},[s("span.fa.fa-pencil"),o("boardEditor")]),s("button",{oncreate:i((()=>{e.study.actionMenu.close(),xt(e.study)}))},[s("span.fa.fa-question-circle"),o("help")])])}(e.root)),e.isOpen(),e.close)};const Mt="https://lidraughts.org/";const Ct={view:({attrs:{text:e}})=>e.split("\n").map((e=>s.fragment({},[s.trust(f(e)),s("br")])))};var Pt={controller(e){let t=!1,a=p.analyse.cevalCores(),s=p.analyse.cevalHashSize();async function i(i){"backbutton"!==i&&t&&n.backbutton.stack.pop(),t=!1,p.analyse.cevalCores()!==a&&await e.ceval.setCores(p.analyse.cevalCores()),p.analyse.cevalHashSize()!==s&&await e.ceval.setHashSize(p.analyse.cevalHashSize())}const o={smallBoard:p.analyse.smallBoard(),showBestMove:p.analyse.showBestMove(),showComments:p.analyse.showComments(),flip:!1};return{root:e,open:function(){n.backbutton.stack.push(i),a=p.analyse.cevalCores(),s=p.analyse.cevalHashSize(),t=!0},close:i,isOpen:()=>t,s:o,toggleBoardSize(){const e=!o.smallBoard;p.analyse.smallBoard(e),o.smallBoard=e},toggleBestMove(){const e=!o.showBestMove;o.showBestMove=e},toggleComments(){const e=!o.showComments;o.showComments=e},flip(){o.flip=!o.flip,e.draughtsground.set({orientation:o.flip?g(e.orientation):e.orientation}),e.retro&&(e.retro=null,e.toggleRetro()),e.practice&&e.restartPractice()},cevalSetMultiPv(t){p.analyse.cevalMultiPvs(t),e.ceval.setMultiPv(t)},cevalToggleInfinite(){e.ceval.toggleInfinite()}}},view:e=>a("analyse_menu",void 0,(()=>function(e){const t=y(),a=window.deviceInfo.scanMaxMemory;return s("div.analyseSettings",[s("div.action",{className:!e.ceval.allowed||e.retro?"disabled":""},[b.renderCheckbox(o("toggleLocalEvaluation"),"allowCeval",p.analyse.enableCeval,(t=>{e.ceval.toggle(),t?e.initCeval():(e.ceval.destroy(),e.resetTabs(),e.retro&&(e.retro.close(),e.retro=null))}),!e.ceval.allowed||!!e.retro),s("small.caution",o("localEvalCaution"))]),e.study||e.ceval.allowed?s("div.action",[b.renderCheckbox(o("bestMoveArrow"),"showBestMove",p.analyse.showBestMove,e.settings.toggleBestMove)]):null,e.study||"online"===e.source&&yt(e.data)&&Te(e.data)?s("div.action",[b.renderCheckbox(o("keyShowOrHideComments"),"showComments",p.analyse.showComments,e.settings.toggleComments)]):null,s("div.action",[b.renderCheckbox(o("infiniteAnalysis"),"ceval.infinite",p.analyse.cevalInfinite,e.settings.cevalToggleInfinite,!e.ceval.allowed)]),t>1?s("div.action",[b.renderSlider(o("cpus"),"ceval.cores",1,t,1,p.analyse.cevalCores,void 0,!e.ceval.allowed)]):null,a>32?s("div.action",[b.renderSlider(o("memory"),"ceval.hashSize",16,a,16,p.analyse.cevalHashSize,void 0,!e.ceval.allowed)]):null])}(e.root)),e.isOpen(),e.close)};function Nt(e){const t=e.node,a=t.threat||t.ceval,n=p.analyse.cevalInfinite();return a?s("div.analyse-fixedBar.ceval-infos",{className:a.cloud?"cloud":""},[s("div.depth",[s("span",o("depthX",a.depth+(n||void 0===a.maxDepth?"":`/${a.maxDepth}`))),e.ceval.canGoDeeper()?s("button.fa.fa-plus-square",{oncreate:i(e.ceval.goDeeper,(()=>{w.show({text:o("goDeeper"),position:"center",duration:"short"})}))}):null]),void 0!==a.millis?s("div.time",[o("time")," ",St(a.millis)]):null,void 0!==a.knps?s("div.knps",["kn/s ",Math.round(a.knps)]):null,a.cloud?s("span.ceval-cloud","Cloud"):null]):null}function St(e){const t=Math.round(e/1e3);if(t<60)return`${t}s`;return`${Math.round(t/60)}min ${t%60}s`}function Tt(e){const t=e.ceval.getMultiPv(),a=e.node,n=a.threat||a.ceval;if(n&&!e.gameOver()){const i=n.pvs;return s("ul.ceval-pv_box.native_scroller",{oncreate:k((t=>function(e,t){const a=M(t),n=a&&a.dataset.uci;!e.showThreat&&n&&e.playUci(n)}(e,t)),void 0,M)},Array.from(Array(t).keys()).map((e=>{if(!i[e])return s("li.pv");const t=function(e,t,a,n){let s="W"===e.slice(0,1);t&&(s=!s);let i,o=1,r=!0,l=a.map((function(e){if(i="",s?i=o+". ":r&&(i=o+"... "),r=!1,-1!==e.indexOf("x")){const t=e.split("x");i+=t[0]+"x"+t[t.length-1]}else i+=e;return o++,s=!s,i})).join(" ");if(n){let e=2*n;n>0===s&&e--,a.length>=e&&(l=l.replace(/\+?$/,"#"))}return l}(a.fen,!1,i[e].moves,i[e].win);return s("li.ceval-pv",{"data-uci":x(i[e].moves[0]),className:e%2==0?"even":"odd"},[s("strong.ceval-pv_eval",void 0!==i[e].win?"#"+i[e].win:_e(i[e].cp)),s("div.ceval-pv-line",t)])})))}return e.gameOver()?s("div.ceval-pv_box.native_scroller.loading.gameOver",[s("i.withIcon[data-icon=]"),o("gameOver")]):s("div.ceval-pv_box.native_scroller.loading",At())}const _t={onbeforeupdate:({attrs:e})=>!e.ctrl.replaying,view({attrs:e}){const{ctrl:t}=e,a=t.node,n=t.showThreat&&t.node.threat||Ae({client:a.ceval,server:a.eval});if(!t.ceval.enabled()&&!n)return null;let i;return i=n&&void 0!==n.cp?_e(n.cp):n&&void 0!==n.win?"#"+n.win:t.gameOver()?"-":t.replaying?"":At(),s("div",{className:"ceval-curEval"},i)}};function At(){return s("div.spinner.fa.fa-hourglass-half")}var Dt={controller(e,t){const a=["lidraughts"];"standard"!==e.key&&"fromPosition"!==e.key||a.push("masters");const s=P(!1),i={db:{available:a,selected:a.length>1?p.analyse.explorer.db:function(){return a[0]}},rating:{available:p.analyse.explorer.availableRatings,selected:p.analyse.explorer.rating},speed:{available:p.analyse.explorer.availableSpeeds,selected:p.analyse.explorer.speed}};let o;function r(){return JSON.stringify([i.db.selected(),i.rating.selected(),i.speed.selected()])}function l(e){"backbutton"!==e&&s()&&n.backbutton.stack.pop(),s(!1),t(o!==r())}function c(e,t){-1===e().indexOf(t)?e(e().concat([t])):e().length>1&&e(e().filter((e=>e!==t)))}return{open:s,data:i,toggleOpen(){s()?l():(n.backbutton.stack.push(l),o=r(),s(!0))},toggleDb(e){i.db.selected(e)},toggleRating:e=>c(i.rating.selected,e),toggleSpeed:e=>c(i.speed.selected,e),fullHouse:()=>"masters"===i.db.selected()||i.rating.selected().length===i.rating.available.length&&i.speed.selected().length===i.speed.available.length,serialize:r}},view(e){const t=e.data;return[s("section.db",[s("label",o("database")),s("div.form-multipleChoice",t.db.available.map((a=>s("div",{className:t.db.selected()===a?"selected":"",oncreate:C((()=>e.toggleDb(a)))},a))))]),"masters"===t.db.selected()?s("div.masters.message",[s("i[data-icon=C]"),s("p",o("masterDbExplanation","2200","1952","2019"))]):s("div",[s("section.rating",[s("label",o("averageElo")),s("div.form-multipleChoice",t.rating.available.map((a=>s("div",{className:t.rating.selected().indexOf(a)>-1?"selected":"",oncreate:C((()=>e.toggleRating(a)))},a))))]),s("section.speed",[s("label",o("timeControl")),s("div.form-multipleChoice",t.speed.available.map((a=>s("div",{className:t.speed.selected().indexOf(a)>-1?"selected":"",oncreate:C((()=>e.toggleSpeed(a)))},a))))])]),s("section.save",s("button.text[data-icon=E]",{oncreate:C(e.toggleOpen)},o("allSet")))]}};const It={onbeforeupdate:({attrs:e},{attrs:t})=>e.data!==t.data,view({attrs:e}){const{ctrl:t,data:a}=e,n=function(e,t){return t.length?s("table",{className:"moves",oncreate:k((t=>function(e,t){const a=Bt(t),n=a&&a.dataset.uci;n&&e.playUci(n)}(e,t)),void 0,Bt)},s("thead",null,s("tr",null,s("th",{className:"explorerMove-move"},o("move")),s("th",{className:"explorerMove-games"},o("games")),s("th",{className:"explorerMove-result"},o("whiteDrawBlack")))),s("tbody",null,t.map((e=>s("tr",{key:e.uci,"data-uci":e.uci},s("td",{className:"explorerMove-move"},"P"===e.san[0]?e.san.slice(1):e.san),s("td",{className:"explorerMove-games"},e.white+e.draws+e.black),s("td",{className:"explorerMove-result"},function(e){const t=e.white+e.draws+e.black;function a(a){const n=e[a],i=100*n/t,o=Math.round(1e3*n/t)/10+"%";return 0===i?null:s("span",{className:"explorerBar "+a,style:{width:o}},i>12?Math.round(i)+(i>20?"%":""):null)}return["white","draws","black"].map(a)}(e))))))):null}(t,a.moves),i=zt(t,o("recentGames"),a.recentGames||[]),r=zt(t,o("topGames"),a.topGames||[]);return n||i||r?s("div",{className:"explorer-data"},n,r,i):Ot(t)}};function Ot(e){return s("div",{className:"explorer-data empty"},s("div",{className:"message"},s("h3",null,s("i",{className:"withIcon","data-icon":""}),o("noGameFound")),e.explorer.config.fullHouse()?null:s("p",null,o("maybeIncludeMoreGamesFromThePreferencesMenu"))))}function Bt(e){const t=e.target;return"TR"===t.tagName?t:t.closest("tr")}function zt(e,t,a){return e.explorer.withGames&&a.length?s("table",{className:"games",oncreate:k((t=>function(e,t){const a=e.draughtsground.state.orientation,s=Bt(t),i=s&&s.dataset.id;i&&"lidraughts"===e.explorer.config.data.db.selected()?n.set(`/analyse/online/${i}/${a}`):i&&N(i,a).then((e=>n.set(`/analyse/online/${e.game.id}/${a}`)))}(e,t)),void 0,Bt)},s("thead",null,s("tr",null,s("th",{colspan:"4"},t))),s("tbody",null,a.map((e=>{return s("tr",{key:e.id,"data-id":e.id},s("td",null,[e.white,e.black].map((e=>s("span",null,e.rating)))),s("td",null,[e.white,e.black].map((e=>s("span",null,e.name)))),s("td",null,(t=e.winner,p.game.draughtsResult()?"white"===t?s("result",{className:"white"},"2-0"):"black"===t?s("result",{className:"black"},"0-2"):s("result",{className:"draws"},"1-1"):"white"===t?s("result",{className:"white"},"1-0"):"black"===t?s("result",{className:"black"},"0-1"):s("result",{className:"draws"},"½-½"))),s("td",null,e.year));var t})))):null}function Et(e){return"standard"===e.data.game.variant.key||"fromPosition"===e.data.game.variant.key?o("openingExplorer"):o("xOpeningExplorer",e.data.game.variant.name)}function $t(e,t,a,n){const i=n.split(/\s/)[1];return a.length?[s("div",{className:"title"},t),s("table",{className:"explorerTablebase",oncreate:k((t=>function(e,t){const a=Bt(t),n=a&&a.dataset.uci;n&&e.playUci(n)}(e,t)),void 0,Bt)},s("tbody",null,a.map((e=>s("tr",{"data-uci":e.uci,key:e.uci},s("td",null,e.san),s("td",null,function(e,t){if(t.checkmate)return s("result."+Ft(e,t),o("checkmate"));if(t.variant_win)return s("result."+Ft(e,t),o("variantWin"));if(t.variant_loss)return s("result."+Ft(e,t),o("variantLoss"));if(t.insufficient_material)return s("result.draws",o("insufficientMaterial"));if(null===t.dtz)return null;if(0===t.dtz)return s("result.draws",o("draw"));if(t.zeroing){const a=-1!==t.san.indexOf("x");return s("result."+Ft(e,t),o(a?"capture":"pawnMove"))}return s("result."+Ft(e,t),{title:S("nextCaptureOrPawnMoveInXHalfMoves",Math.abs(t.dtz))},"DTZ "+Math.abs(t.dtz))}(i,e),function(e,t){return t.dtm?s("result."+Ft(e,t),{title:S("winInXHalfMoves",Math.abs(t.dtm))},"DTW "+Math.abs(t.dtm)):null}(i,e)))))))]:null}function Ft(e,t){return"w"===e[0]&&Number(t.wdl)<0||"b"===e[0]&&Number(t.wdl)>0?"white":"b"===e[0]&&Number(t.wdl)<0||"w"===e[0]&&Number(t.wdl)>0?"black":null}function Ut(e){return s("div.explorer-data.empty",[s("div.message",[s("h3",[s("i.withIcon[data-icon=]"),e])])])}function jt(e){if(!e.contextMenu)return null;const t=e.contextMenu,n=e.tree.nodeAtPath(t),s=e.tree.pathIsMainline(t);return a("analyse-cm",(()=>De(n,e.isAlgebraic())),(()=>[s?null:Lt("S",o("promoteVariation"),(()=>e.promote(t,!1))),s?null:Lt("E",o("makeMainLine"),(()=>e.promote(t,!0))),Lt("q",o("deleteFromHere"),(()=>e.deleteNode(t)))]),!0,(()=>{e.contextMenu=null,d()}))}function Lt(e,t,a){return s("button.withIcon",{"data-icon":e,oncreate:k(a)},t)}const Wt=6;function Gt(e,t){return!e.ctrl.settings.s.showComments||Ie(t.comments)?[]:t.comments.map((t=>"lidraughts"!==t.by||e.showComputer?s("comment",s(Ct,{text:t.text})):null)).filter((e=>!!e))}function Rt(e,t,a){const n=t.children,i=n[0];return i?a.isMainline?n[1]?Vt(e,n,a)||[Kt(e,i,{parentPath:a.parentPath,isMainline:!0,withIndex:a.withIndex}),Gt(e,i),s("interrupt",Ht(e,n.slice(1),{parentPath:a.parentPath,isMainline:!0})),Rt(e,i,{parentPath:a.parentPath+i.id,isMainline:!0,withIndex:!0})||[]]:qt(e,i,{parentPath:a.parentPath,isMainline:!0,withIndex:a.withIndex}):n[1]?Vt(e,n,a)||[Ht(e,n,a)]:qt(e,i,a):null}function Vt(e,t,a){return!t[1]||t[2]||qe(t[1],6)?null:qt(e,t[0],{parentPath:a.parentPath,isMainline:a.isMainline,inline:t[1]})}function Ht(e,t,a){return s("lines",t.map((t=>s("line",qt(e,t,{parentPath:a.parentPath,isMainline:!1,withIndex:!0,truncate:t.comp&&!Je(e.ctrl.path,a.parentPath+t.id)?Wt:void 0})))))}function qt(e,t,a){const n=a.parentPath+t.id,i=Gt(e,t);return 0===a.truncate?[s("move",{"data-path":n},"[...]")]:[Kt(e,t,a)].concat(i).concat(a.inline?function(e,t,a){return s("inline",qt(e,t,{withIndex:!0,parentPath:a.parentPath,isMainline:!1}))}(e,a.inline,a):null).concat(Rt(e,t,{parentPath:n,isMainline:a.isMainline,truncate:a.truncate?a.truncate-1:void 0,withIndex:!!i[0]})||[])}function Jt(e,t,a){const n=e.ctrl,s=!n.study&&a===n.initialPath&&Ne(n.data),i=e.showGlyphs&&t.glyphs?t.glyphs.map((e=>e.id)):[];return{current:a===n.path,currentPlayable:s,nongame:!s&&!!n.gamePath&&Je(a,n.gamePath)&&a!==n.gamePath,inaccuracy:i.includes(6),mistake:i.includes(2),blunder:i.includes(4)}}function Xt(e,t){return s("index",function(e,t){return Oe(e)+(t?e%2==1?".":"...":"")}(e,t))}function Kt(e,t,a){const n=a.parentPath+t.id,i=t.displayPly?t.displayPly:t.ply,o=[a.withIndex||1&i?Xt(i,!0):null,e.ctrl.isAlgebraic()?T(t.san):t.san];var l;return t.glyphs&&(l=t.glyphs,l.map((e=>s("glyph",e.symbol)))).forEach((e=>o.push(e))),s("move",{"data-path":n,className:r(Jt(e,t,n))},o)}var Qt={onbeforeupdate:({attrs:e})=>!e.ctrl.replaying,view({attrs:e}){const{ctrl:t,rightTabActive:a}=e;return s("div#replay.analyse-replay.native_scroller",{className:a?"rta":"",oncreate:k((e=>function(e,t){const a=Yt(t);a&&a.dataset.path&&e.jump(a.dataset.path)}(t,e)),(e=>{const a=Yt(e),n=a.dataset;a&&n.path&&(t.contextMenu=n.path,d())}),Yt,!1)},function(e){const t=e.tree.root,a={ctrl:e,truncateComments:!1,showComputer:e.settings.s.showComments,showGlyphs:!0,showEval:!0},n=Gt(a,t);return s("div.analyse-moveList",{className:"ios"===window.deviceInfo.platform?"ios":""},[n,Rt(a,t,{parentPath:"",isMainline:!0})||[]])}(t))}};function Yt(e){const t=e.target;return"MOVE"===t.tagName?t:_(t,"move")}function Zt(e){return s("eval",e)}function ea(e,t){return function(e){return Math.floor((e-1)/2)+1}(e)+(t?e%2==1?".":"...":"")}function ta(e,t){const a=Ae({client:t.ceval,server:t.eval})||{};return[s("san",e.algebraic?T(t.san):t.san)].concat(t.glyphs&&e.showGlyphs?(n=t.glyphs,n.map((e=>s("glyph",{title:e.name},e.symbol)))):[]).concat(e.showEval?void 0!==a.cp?[Zt(_e(a.cp))]:void 0!==a.win?[Zt("#"+a.win)]:[]:[]);var n}function aa(e,t){return t.uci?[(a=t.displayPly||t.ply,n=e.withDots,s("index",ea(a,n)))].concat(ta(e,t)):[s("span.init","Initial position")];var a,n}function na(e){const t=e.retro;if(!t)return;const a=t.vm.feedback;return s("div.analyse-training_box.analyse-retro_box.box",{className:t.vm.minimized?"minimized":""},[ca(t),s("div.analyse-training_feedback.native_scroller."+a,la(e,a))])}function sa(e){return s("div.choices",[s("button",{oncreate:i(e.viewSolution)},o("viewTheSolution")),s("button",{oncreate:i(e.nextMistake)},o("skipThisMove"))])}function ia(e){return s("div.li-button.retro-half.retro-continue",{oncreate:i(e.nextMistake)},[s("i[data-icon=G]"),o("next")])}function oa(e){const t=e.node(),a="antidraughts"===e.variant?3:8,n="antidraughts"===e.variant?10:18;return s("div.analyse-training_progress",s("div",{style:{width:`${t.ceval?100*Math.max(0,t.ceval.depth-a)/(n-a)+"%":0}`}}))}const ra={find:e=>[s("div.analyse-training_player",[s("div.piece-no-square",{className:e.pieceTheme},s("piece.king."+e.vm.color)),s("div.retro-instruction",[s("strong",[A("xWasPlayed",s("span",aa({withDots:!0,showGlyphs:!0,showEval:!1,algebraic:e.isAlgebraic()},e.vm.current.fault.node)))]),s("em",o("white"===e.vm.color?"findBetterMoveForWhite":"findBetterMoveForBlack")),sa(e)])])],offTrack:e=>[s("div.analyse-training_player",[s("div.retro-icon.off","!"),s("div.retro-instruction",[s("strong",o("youBrowsedAway")),s("div.choices.off",[s("button",{oncreate:i(e.jumpToCurrent)},o("resumeLearning"))])])])],fail:e=>[s("div.analyse-training_player",[s("div.retro-icon","✗"),s("div.retro-instruction",[s("strong",o("youCanDoBetter")),s("em",o("white"===e.vm.color?"tryAnotherMoveForWhite":"tryAnotherMoveForBlack")),sa(e)])])],win:e=>[s("div.retro-half.top",s("div.analyse-training_player",[s("div.retro-icon","✓"),s("div.retro-instruction",s("strong",o("goodMove")))])),ia(e)],view:e=>[s("div.retro-half.top",s("div.analyse-training_player",[s("div.retro-icon","✓"),s("div.retro-instruction",[s("strong",o("solution")),s("em",[s("strong",aa({withDots:!0,showEval:!1,algebraic:e.isAlgebraic()},e.vm.current.solution.node))])])])),ia(e)],eval:e=>[s("div.retro-half.top",s("div.analyse-training_player.center",[s("div.retro-instruction",[s("strong",o("evaluatingYourMove")),oa(e)])]))],end(e,t){if(!t())return[s("div.retro-half.top",s("div.analyse-training_player",[s("div.retro-icon",l.getVdom()),s("div.retro-instruction",o("waitingForAnalysis"))]))];const a=!e.completion()[1];return[s("div.analyse-training_player",[s("div.piece-no-square",{className:e.pieceTheme},s("piece.king."+e.vm.color)),s("div.retro-instruction",[s("em",o(a?"white"===e.vm.color?"noMistakesFoundForWhite":"noMistakesFoundForBlack":"white"===e.vm.color?"doneReviewingWhiteMistakes":"doneReviewingBlackMistakes")),s("div.choices.end",[a?null:s("button",{oncreate:i(e.reset)},o("doItAgain")),s("button",{oncreate:i(e.flip)},o("white"===e.vm.color?"reviewBlackMistakes":"reviewWhiteMistakes"))])])])]}};function la(e,t){const a=e.retro,n=a.vm.current,s=e.node;return!a.isSolving()||!n||e.path===n.prev.path||s.displayPly&&s.displayPly!==s.ply&&e.path.length>1&&e.path.slice(0,e.path.length-2)===n.prev.path?"find"===t?n?ra.find(a):ra.end(a,e.hasFullComputerAnalysis):ra[t](a):ra.offTrack(a)}function ca(e){const t=e.completion();return s("div.titleWrapper",[s("div.title",o("learnFromYourMistakes")),s("div.mistakeNb",Math.min(t[0]+1,t[1])+" / "+t[1]),s("div.actions",[s("button.window-button",{oncreate:i(e.toggleWindow)},s("span.fa",{className:e.vm.minimized?"fa-window-maximize":"fa-window-minimize"})),s("button.window-button",{oncreate:i(e.close)},s("span.fa.fa-window-close"))])])}function da(e,t){return e.best?A("goodMove"===e.verdict?"anotherWasX":"bestWasX",s("move",{oncreate:i(t.playCommentBest)},e.best.san)):[]}function ha(e){return s("div.analyse-training_player.off",[s("div.icon.off","!"),s("div.analyse-training_box_instruction",[s("strong",o("youBrowsedAway")),s("div.choices",[s("button",{oncreate:i(e.resume)},o("resumePractice"))])])])}function ua(e,t,a){const n="checkmate"===a,i=n&&"antidraughts"!==e.data.game.variant.key?g(e.turnColor()):e.turnColor();return s("div.analyse-training_player",[i?s("div.piece-no-square",{className:t.pieceTheme},s("piece.king."+i)):s("div.icon.off","!"),s("div.analyse-training_box_instruction",[n?null:s("strong",o(a)),s("em",n?s("color",o("white"===i?"whiteWinsGame":"blackWinsGame")):o("theGameIsADraw"))])])}const pa=8;function ma(e,t){const a=e.ceval?100*Math.max(0,e.ceval.depth-pa)/(t-pa)+"%":0;return s("div.analyse-training_progress",s("div",{style:`width: ${a}`}))}function va(e,t){const a=t.hinting();return s("div.analyse-training_player.running",[s("div.piece-no-square",{className:t.pieceTheme},s("piece.king."+e.turnColor())),s("div.analyse-training_box_instruction",(t.isMyTurn()?[s("strong",o("yourTurn"))]:[s("strong",o("computerThinking")),ma(t.currentNode(),t.playableDepth())]).concat(s("div.choices",[t.isMyTurn()?s("button",{oncreate:i(t.hint)},o(a?"piece"===a.mode?"seeBestMove":"hideBestMove":"getAHint")):""])))])}function fa(e,t){return s("div.titleWrapper",[s("div.title",o("practiceWithComputer")),s("div.actions",[s("button.window-button",{oncreate:i(t.toggleWindow)},s("span.fa",{className:t.minimized()?"fa-window-maximize":"fa-window-minimize"})),s("button.window-button",{oncreate:i(e.togglePractice)},s("span.fa.fa-window-close"))])])}function ga(e){const t=e.practice;if(!t)return;const a=t.comment(),n=t.running(),i=t.currentNode().threefold?"threefoldRepetition":e.gameOver();return s("div.analyse-practice_box.analyse-training_box.box."+(a?a.verdict:"no-verdict"),{className:t.minimized()?"minimized":""},[fa(e,t),s("div.analyse-training_feedback.native_scroller",n?i?ua(e,t,i):va(e,t):ha(t)),n?s("div.comment",a?[s("span.verdict",o(a.verdict))," "].concat(da(a,t)):[t.isMyTurn()||i?"":s("span.wait",o("evaluatingYourMove"))]):n?s("div.comment"):null])}function ya(e,t){const a=e.chapter.tags.find((e=>e[0].toLowerCase()===t));return a&&a[1]}function ba(e,t,a){const n=t.data.game.division,s=e.getBoundingClientRect(),i=ot(e).append("svg").attr("viewBox",`0 0 ${s.width} ${s.height}`),r=Ke(t.tree.root).slice(1).reduce(((e,t)=>{const a=1&t.ply;let n;if(t.eval&&t.eval.win)n=t.eval.win>0?1/0:-1/0;else if(t.san&&t.san.indexOf("#")>0)n=1===a?1/0:-1/0;else{if(!t.eval||void 0===t.eval.cp)return e;n=t.eval.cp}const s={acpl:2/(1+Math.exp(-.004*n))-1};return e.concat([s])}),[]);const l=10,c=10,d=10,h=10,u=s.width-h-c,p=s.height-l-d,m=i.append("g").attr("transform","translate("+h+","+l+")");function v(e,t){m.append("line").attr("class","division "+t).attr("x1",e).attr("x2",e).attr("y1",b(-1)).attr("y2",b(1)),m.append("text").attr("class","chart-legend").attr("transform","rotate(90)").attr("y",-e).attr("dy","-0.4em").text(o(t))}const f=t.data.treeParts[0].ply||0;function g(e){if(m.selectAll(".dot").remove(),null!==e){const t=e-1-f,a=r[t];a&&m.append("circle").attr("class","dot").attr("cx",y(t)).attr("cy",b(a.acpl)).attr("r",3)}}const y=rt().domain([0,r.length]).rangeRound([0,u]),b=rt().domain([-1,1]).rangeRound([p,0]),w=Xe().x(((e,t)=>y(t))).y((e=>b(e.acpl))),x=Xe().x(((e,t)=>y(t))).y1((e=>e.acpl>=0?b(e.acpl):b(0)));return m.datum(r),m.append("line").attr("class","zeroline").attr("x1",0).attr("x2",u).attr("y1",b(0)).attr("y2",b(0)),m.append("clipPath").attr("id","clip-below").append("path").attr("d",x.y0((e=>b(e.acpl)))),m.append("clipPath").attr("id","clip-above").append("path").attr("d",x.y0(b(0))),m.append("path").attr("class","area above").attr("clip-path","url(#clip-above)").attr("d",x),m.append("path").attr("class","area below").attr("clip-path","url(#clip-below)").attr("d",x.y0((e=>e.acpl<=0?b(e.acpl):b(0)))),m.append("path").attr("class","line").attr("d",w),n&&(n.middle||n.end)&&(v(y(0),"opening"),n.middle&&v(y(n.middle),"middlegame"),n.end&&v(y(n.end),"endgame")),g(a),g}function wa(e,t,a,n){const s=t.game.division,i=e.getBoundingClientRect(),r=ot(e).append("svg").attr("viewBox",`0 0 ${i.width} ${i.height}`),l=10,c=10,d=10,h=25,u=i.width-h-c,p=i.height-l-d,m=r.append("g").attr("transform","translate("+h+","+l+")"),{max:v,series:f}=function(e,t){const a={white:[],black:[]},n="correspondence"===e.game.speed,s=e.treeParts,i=Math.pow(Math.log(3),2);let o=0,r=-1,l=0;const c=t.slice(0);let d=0,h="";for(let e=0;e<c.length;e++){const t=s[e+1+d];if(o=t?t.ply:o+1,o!==r||e+1===c.length){o===r&&o++,r=o;let n=t&&t.san?t.san:"-";0!==h.length&&t&&(n=h+n.slice(n.indexOf("x")+1),h="");const s=!!(1&o),d=Math.pow(Math.log(.005*Math.min(c[e],12e4)+3),2)-i;l=Math.max(d,l);const u={ply:o,y:s?d:-d};s?a.white.push(u):a.black.push(u)}else 0===h.length&&t&&t.san&&(h=t.san.slice(0,t.san.indexOf("x")+1)),n||(c[e+1]+=c[e],c.splice(e,1)),e--,d++}return{max:l,series:a}}(t,a);function g(e,t){m.append("line").attr("class","division "+t).attr("x1",e).attr("x2",e).attr("y1",w(-v)).attr("y2",w(v)),m.append("text").attr("class","chart-legend").attr("transform","rotate(90)").attr("y",-e).attr("dy","-0.4em").text(o(t))}function y(e){if(m.selectAll(".dot").remove(),null!==e){const t=!!(1&e)?f.white.find((t=>t.ply===e)):f.black.find((t=>t.ply===e));t&&m.append("circle").attr("class","dot").attr("cx",b(e)).attr("cy",w(t.y)).attr("r",3)}}const b=rt().domain([0,f.white.length+f.black.length]).rangeRound([0,u]),w=rt().domain([-v,v]).rangeRound([p,0]),x=Xe().x((e=>b(e.ply))).y((e=>w(e.y))),k=Xe().x((e=>b(e.ply))).y0(w(0)).y1((e=>w(e.y))),M=Math.max(...a)/100,C=rt().domain([-M,M]).rangeRound([p,0]),P=lt(C).tickFormat((e=>String(Math.abs(e))));return m.append("g").call(P).append("text").attr("class","legend").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("text-anchor","end").text("Seconds"),m.append("path").datum(f.white).attr("class","area above").attr("d",k),m.append("path").datum(f.black).attr("class","area below").attr("d",k),m.append("path").attr("class","line").datum(f.white).attr("d",x),m.append("path").attr("class","line").datum(f.black).attr("d",x),s&&(s.middle||s.end)&&(s.middle&&g(b(s.middle),"middlegame"),s.end&&g(b(s.end),"endgame")),y(n),y}function xa(e){return s("div.analyse-computerAnalysis",[s("strong.title",o("computerAnalysis")),e.analysisProgress?s("div.analyse-gameAnalysis_chartPlaceholder",l.getVdom("monochrome")):s("div.analyse-chart",{oncreate({dom:t}){D((()=>{this.updateCurPly=ba(t,e,e.node.ply)}))},onupdate({dom:t}){this.updateCurPly?D((()=>{this.updateCurPly(e.onMainline?e.node.ply:null)})):D((()=>{const a=t;for(;a.lastElementChild;)a.removeChild(a.lastElementChild);this.updateCurPly=ba(a,e,e.node.ply)}))}}),s(ka,{d:e.data,analysis:e.data.analysis,study:e.study&&e.study.data})])}const ka={onbeforeupdate:({attrs:e},{attrs:t})=>!I(e.analysis,t.analysis),view({attrs:e}){const{d:t,analysis:a,study:n}=e;return s("div.analyse-evalSummary",["white","black"].map((e=>{const i=Be(t,e),r=n?ya(n,e)||o("anonymous"):O(i);return s("table",[s("thead",s("tr",[s("th",s("span.color-icon."+e)),s("td",[r,i?B(i):null])])),s("tbody",[Na.map((t=>{const n=a&&a[e][t[0]];return s("tr",[s("th",n),s("td",o(t[1]))])})),s("tr",[s("th",a&&a[e].acpl),s("td",o("averageCentipieceLoss"))])])])})))}};function Ma(e){return s("div.analyse-computerAnalysis.request",[e.analysisProgress?s("div.analyse-requestProgress",[s("span",o("waitingForAnalysis")),l.getVdom("monochrome")]):s("button.fatButton",{oncreate:k((()=>{return(a=e.data.game.id,t(`/${a}/request-analysis`,{method:"POST"},!0)).then((()=>{e.analysisProgress=!0,d()})).catch(h);var a}))},[o("requestAComputerAnalysis")])])}function Ca(e){return s("div.analyse-computerAnalysis.request",e.mainline.length<5?s("p",o("theChapterIsTooShortToBeAnalysed")):e.study.canContribute()?[s("p",[o("getAFullComputerAnalysis"),s("br"),o("makeSureTheChapterIsComplete")]),e.analysisProgress?s("div.analyse-requestProgress",[s("span",o("waitingForAnalysis")),l.getVdom("monochrome")]):s("button.fatButton",{oncreate:k((()=>{e.socket.send("requestAnalysis",e.study.data.chapter.id),e.analysisProgress=!0,d()}))},[o("requestAComputerAnalysis")])]:s("p",o("onlyContributorsCanRequestAnalysis")))}function Pa(e,t){return s("div.analyse-moveTimes",[s("strong.title",o("moveTimes")),s("div.analyse-chart",{oncreate({dom:a}){setTimeout((()=>{this.updateCurPly=wa(a,e.data,t,e.node.ply)}),200)},onupdate(){this.updateCurPly&&D((()=>{e.onMainline?this.updateCurPly(e.node.ply):this.updateCurPly(null)}))}})])}const Na=[["inaccuracy","inaccuracies"],["mistake","mistakes"],["blunder","blunders"]];var Sa={onbeforeupdate:({attrs:e},{attrs:t})=>e.color!==t.color||!e.ctrl.replaying,view({attrs:e}){const{ctrl:t,color:a}=e,n=t.node,i=n.clock;if(void 0===i)return;const o=t.tree.getParentClock(n,t.path);let r,l;const c=n.ply%2==0;c?(r=o,l=i):(r=i,l=o);return s("span.analyse-clock",{className:("white"===a?c:!c)?"current":""},function(e){if(void 0===e)return s("span.time",["-"]);const t=new Date(10*e),a=t.getUTCMilliseconds(),n=":",i=Ta(t.getUTCMinutes())+n+Ta(t.getUTCSeconds());if(e>=36e4)return s("span.time",[Math.floor(e/36e4)+n+i]);const o=Math.floor(a/100).toString();return s("span.time",[i,s("tenths","."+o)])}("white"===a?r:l))}};function Ta(e){return(e<10?"0":"")+e}function _a(e,t){return function(e,t){return"white"===e?t:-t}(e,function(e){return void 0!==e.win?function(e){const t=100*(21-Math.min(10,Math.abs(e)));return Da(t*(e>0?1:-1))}(e.win):(t=e.cp,Da(Math.min(Math.max(-1e3,t),1e3)));var t}(t))}function Aa(e,t,a){return(_a(e,t)-_a(e,a))/2}function Da(e){return 2/(1+Math.exp(-.004*e))-1}function Ia(e){return s("div.analyse-boardWrapper",[Oa(e,e.topColor()),s(ct,{variant:e.data.game.variant.key,draughtsground:e.draughtsground,shapes:Ba(e),clearableShapes:e.node.shapes,wrapperClasses:e.settings.s.smallBoard?"halfsize":"",canClearShapes:!0}),Oa(e,e.bottomColor())])}function Oa(e,t){const a=e.playerName(t),n="Anonymous"===a||a===o("anonymous");if(e.synthetic&&n)return null;if(e.study&&n||!e.study&&e.synthetic)return null;const i=e.study&&e.study.data;let r,l,c;if(i)r=ya(i,`${t}title`),l=ya(i,`${t}elo`),c=function(e,t){switch(ya(e,"result")){case"1-0":return t?"1":"0";case"0-1":return t?"0":"1";case"1/2-1/2":return"1/2";default:return}}(i,"white"===t);else if(ze.finished(e.data)){const a=e.data.game.winner;c=p.game.draughtsResult()?void 0===a?"1":a===t?"2":"0":void 0===a?"½":a===t?"1":"0"}const d=e.node.clock;return s("div.analyse-player_bar",{className:e.settings.s.smallBoard?"halfsize":""},[s("div.info",n?s.trust("&nbsp"):[c?s("span.result",c):null,s("span.name",(r?r+" ":"")+a+(l?` (${l})`:""))]),d?s("div.player_bar_clock",[s(Sa,{ctrl:e,color:t})]):null])}function Ba(e){const t=e.data.game.player,a=e.node&&e.node.ceval,n=e.node&&e.node.eval,s=e.node&&e.node.threat;let i=[],o=[],r=[];if(e.practice){const t=e.practice.hinting();t&&(i="move"===t.mode?za(t.uci,"paleBlue"):[{orig:z(t.uci)[0],brush:"paleBlue_2"}])}if(!e.retro&&!e.practice&&e.settings.s.showBestMove){let s=e.nextNodeBest()||a&&a.best;const r=e.node.displayPly&&e.node.displayPly!==e.node.ply&&e.nodeList.length>1;if(!s){const t=r?e.nodeList[e.nodeList.length-2].ceval:void 0;if(r&&t&&-1!==t.pvs[0].moves[0].indexOf("x")&&e.node.uci){const a=e.node.uci.match(/.{1,2}/g);if(a){const e=a.slice(0,a.length-1).map((e=>parseInt(e).toString())).join("x");s=t.pvs[0].moves[0].slice(e.length+1)}}else a&&(s=a.pvs[0].moves[0])}if(s){const e=s.split("x").length;i=za(s,e>4?"paleBlue_3":"paleBlue",e>4?"paleBlue_2":"")}!r&&a&&a.pvs.length>1&&a.pvs.slice(1).forEach((e=>{const n=Aa(t,a.pvs[0],e);if(n>=0&&n<.2){const t=Math.round(12-50*n);i=i.concat(za(e.moves[0],"paleBlue"+t))}})),n&&n.best&&(o=za(n.best,"paleGreen"))}if(!e.retro&&!e.practice&&e.showThreat&&s){const e=s.pvs[0].moves[0].split("x").length;r=za(s.pvs[0].moves[0],e>1?"paleRed":"paleRed3")}const l=e.retro&&e.retro.showBadNode(),c=l&&l.uci?za(l.uci,"paleRed2"):[];return[...o,...i,...r,...c]}function za(e,t,a){const n=z(x(e));if(1===n.length)return[{orig:n[0],brush:t}];const s=new Array;for(let e=0;e<n.length-1;e++)s.push({orig:n[e],dest:n[e+1],brush:a&&0===e?a:t});return s}const Ea=[{name:"fast",delay:1e3},{name:"slow",delay:5e3}],$a={name:"realtimeReplay",delay:"realtime"},Fa={name:"byCPL",delay:"cpl"};function Ua(e,t){return s("section",{className:"actions_bar analyse_actions_bar"},s("button",{className:"action_bar_button fa "+(e.retroGlowing?"fa-play glow":"fa-list"),oncreate:i(e.study?e.study.actionMenu.open:e.menu.open)}),s("button",{className:"action_bar_button fa fa-gear",oncreate:i(e.settings.open)}),e.study&&e.study.chat?null:s("button",{className:"action_bar_button","data-icon":"B",oncreate:i(e.settings.flip)}),e.study&&e.study.chat?s("button",{className:"action_bar_button fa fa-comments withChip",oncreate:i(e.study.chat.open)},e.study.chat.nbUnread>0?s("span",{className:"chip"},e.study.chat.nbUnread<=99?e.study.chat.nbUnread:99):null):null,t?s("button",{className:"action_bar_button fa fa-"+(e.settings.s.smallBoard?"expand":"compress"),oncreate:i(e.settings.toggleBoardSize,(()=>w.show({text:"Expand/compress board",duration:"short",position:"bottom"})))}):null,s("button",{className:"action_bar_button fa fa-backward",oncreate:i(e.stoprewind,void 0,e.rewind)}),s("button",{className:"action_bar_button fa fa-forward",disabled:!!e.retro,oncreate:i(e.stopff,void 0,e.fastforward)}),e.study?s("button",{className:"action_bar_button fa fa-bars",oncreate:i(e.study.sideMenu.open)}):null)}function ja(e){return e.reduce(((e,t)=>e.set(Ga(t),t)),new Map)}function La(e){for(const t of e)for(const e of t)E(e.fen)&&(e.displayPly=e.ply+1);return e}function Wa(e){if(e.length<=1)return e.length;let t=1;for(let a=1;a<e.length;a++){const n=e[a].displayPly||e[a].ply,s=e[a-1].displayPly||e[a-1].ply;n&&s&&n>s&&t++}return t}function Ga(e){return e.map((e=>e.ply+":"+e.uci)).join(",")}class ForecastCtrl{constructor(e){var t;this.focusKey=null,this.loading=!1,this.skipSteps=0,this._minimized=!1;const a=e.forecast;this._lines=ja(La((null==a?void 0:a.steps)||[]));const n=null==a?void 0:a.onMyTurn;this.isMyTurn=!!n,this._gameId=e.game.id,this._playerId=(null===(t=e.player)||void 0===t?void 0:t.id)||null}truncate(e){let t=e;const a=this.isMyTurn?1:0;for(;t.length&&Wa(t)%2!==a;)t=t.slice(0,-1);return t.slice(0,30)}truncateNodes(e){const t=this.isMyTurn?1:0;return(e.length%2!==t?e.slice(0,-1):e).slice(0,30)}isCandidate(e){const t=this.truncate(e);if(!this.isLongEnough(t))return!1;for(const e of this._lines.values())if(this.isPrefix(e,t))return!1;return!0}removeForecast(e){this._lines.delete(e),this.focusKey=null,this.save()}add(e){const t=this.truncate(e);this.isCandidate(t)&&(this._lines.set(Ga(t),t),this.fixAll(),this.save())}save(){const t=this._playerId,a=this._gameId;!this.isMyTurn&&t&&(this.loading=!0,d(),function(t,a,n){return e(`/${t}${a}/forecasts`,{method:"POST",body:JSON.stringify(n)})}(a,t,this.lines).then((e=>{e.reload?this.reloadToLastPly():(this.loading=!1,this._lines=ja(La(e.steps||[])),d())})))}playAndSave(t){const a=this._playerId,n=this._gameId;if(!this.isMyTurn||!a)return;const s=this.findStartingWithNode(t).filter((e=>e.length>0)).map((e=>e.slice(1)));this.loading=!0,d(),function(t,a,n,s){return e(`/${t}${a}/forecasts/${n.uci}`,{method:"POST",body:JSON.stringify(s)})}(n,a,t,s).then((e=>{e.reload?this.reloadToLastPly():(this.loading=!1,this._lines=ja(La(e.steps||[])),d())}))}findStartingWithNode(e){return this.lines.filter((t=>this.isPrefix(t,[e])))}reloadToLastPly(){n.deleteQueryParam("ply",!0)}get lines(){return Array.from(this._lines.values())}isPrefix(e,t){return e.length>=t.length&&Ga(e).startsWith(Ga(t))}collides(e,t){let a=0;for(let n=0,s=Math.min(e.length,t.length);n<s;n++){if(e[n].uci!==t[n].uci)return this.isMyTurn?0!==a&&a%2==0:a%2==1;e[n].displayPly&&e[n].displayPly!==e[n].ply||a++}return!1}toggleMinimized(){this._minimized=!this._minimized}get minimized(){return this._minimized}isLongEnough(e){return e.length>=(this.isMyTurn?1:2)}fixAll(){for(const[e,t]of this._lines.entries())for(const[a,n]of this._lines.entries())if(e!==a&&this.isPrefix(n,t)||this.collides(t,n)){this._lines.delete(e);break}}}function Ra(e){const t=e.forecast;if(!t||e.synthetic||!Ne(e.data))return null;const a=Ha(e,t),n=t.isCandidate(a);return s("div.analyse-training_box.analyse-forecast_box.box",{className:t.minimized?"minimized":"",oncreate:i((()=>{t.focusKey=null}))},[Xa(t),s("div.forecasts-wrapper.native_scroller",[s("div.forecasts-list",[...t.lines.map((a=>{const n=Ga(a);return s("div.forecast[data-icon=G]",{key:n,oncreate:i((e=>{e.stopPropagation(),t.focusKey=n}))},[s("sans",qa(a,e.isAlgebraic())),t.focusKey===n?s("span.fa.fa-times-circle.delete",{oncreate:i((e=>{e.stopPropagation(),t.removeForecast(n)}))}):null])}))]),s("div.add",{className:n?"enabled":"","data-icon":n?"O":"",oncreate:i((()=>{const a=Ha(e,t);t.add(a)}))},[n?s("div",[s("span",o("addCurrentVariation")),s("sans",qa(a,e.isAlgebraic()))]):s("span",o("playVariationToCreateConditionalPremoves"))]),Ja(e,a),t.loading?s("div.spinner_overlay",s("div.spinner.fa.fa-hourglass-half")):null])])}function Va(e){return"0"===e.slice(0,1)?e.slice(1):e}function Ha(e,t){const a=e.tree.getCurrentNodesAfterPly(e.nodeList,e.mainline,Math.max(0,e.data.game.turns-1)),n=[];let s,i=[],o=0;for(let t=0;t<a.length;t++){const n=a[t];if((n.displayPly||n.ply)>e.data.game.turns){i=a.slice(t);break}s=n.fen}if(!i)return n;for(const a of t.truncateNodes(i)){if(a.uci&&a.uci.length>=6&&s){let i=a.uci,r=i.slice(0,2);const l=$(s),c=l[r],d=e.data.game.variant.board.size;for(;i.length>=4;){delete l[r];const e=i.slice(2,4),h=F(r,d),u=F(e,d),p=U(l,d,h[0],h[1],u[0],u[1]);if(!p)break;const m=l[p];if(l[p]={role:"king"===m.role?"ghostking":"ghostman",color:m.color},l[e]=c,o++,o>t.skipSteps){const t=4===i.length&&!E(a.fen),o=a.displayPly||a.ply;n.push({ply:t?o:o-1,displayPly:o,fen:4===i.length?a.fen:s.slice(0,2)+j(l),uci:i.slice(0,4),san:Va(r)+"x"+Va(e)})}i=i.slice(2),r=e}}else o++,o>t.skipSteps&&n.push({ply:a.ply,displayPly:E(a.fen)?a.ply+1:void 0,fen:a.fen,uci:a.uci,san:a.san});n.length&&(s=n[n.length-1].fen)}return n}function qa(e,t){return e[0]?(e[0].san||(e=e.slice(1)),e[0]?function(e){const t=[],a=e[0].displayPly||e[0].ply;let n=-1;return a%2==0&&(n=Math.floor((a+1)/2),t.push({index:n,black:e[0].san,white:null}),e=e.slice(1)),e.forEach((e=>{const a=e.displayPly||e.ply;if(0===a)return;const s=(a+1)/2;if(s!==n&&a%2==1)t.push({index:s,white:e.san,black:null}),n=s;else{const n=t[t.length-1];a%2==1?e.san.includes("x")?n.white+=e.san.slice(e.san.indexOf("x")):n.white+=` ${e.san}`:n.black?e.san.includes("x")?n.black+=e.san.slice(e.san.indexOf("x")):n.black+=` ${e.san}`:n.black=e.san}})),t}(e).map((({black:e,white:a,index:n})=>s("move",[s("index",n+(a?".":"...")),a?s("san",t?T(a):a):null,e?s("san",t?T(e):e):null]))):[]):[]}function Ja(e,t){var a;if(!(null===(a=e.forecast)||void 0===a?void 0:a.isMyTurn))return;const n=t[0];if(!n)return;const r=e.forecast.findStartingWithNode(n);if(!r.length)return;const l=r.filter((e=>e.length>1)).length;return s("div.on-my-turn",s("button.defaultButton",{oncreate:i((()=>e.forecast.playAndSave(n)))},[s("span.fa.fa-check"),s("span",[s("strong",o("playX",t[0].san))," ",l?s("span",S("andSaveNbPremoveLines",l)):null])]))}function Xa(e){return s("div.titleWrapper",[s("div.title",[o("conditionalPremoves"),e.lines.length>0?` (${e.lines.length})`:null]),s("div.actions",[s("button.window-button",{oncreate:i((()=>e.toggleMinimized()))},s("span.fa",{className:e.minimized?"fa-window-maximize":"fa-window-minimize"}))])])}function Ka(e,t,a,n){const i=p.analyse.smallBoard();return Me.board(L(),[en(t||"white",i,c(a,!1)||W,n||"standard"),s("div.analyse-tableWrapper",l.getVdom("monochrome")),e?s("section.analyse_actions_bar"):null])}function Qa(e,t){const a=e.availableTabs();return s.fragment({key:"size"+e.settings.s.smallBoard},[Ia(e),s("div.analyse-tableWrapper",[sn(e,a),t?null:Ua(e,t)]),t?Ua(e,t):null])}function Ya(e){return[e.study?kt.view(e.study.actionMenu):bt.view(e.menu),e.study&&e.study.chat?Ce(e.study.chat):null,Pt.view(e.settings),e.notes?be(e.notes):null,ge.view(e.continuePopup),jt(e)]}function Za(e){const t=e.data.game.variant.key,a=R(t);let i=p.analyse.availableVariants;return"fromPosition"===t&&(i=i.concat([["From position","fromPosition"]])),s("div.select_input.main_header-selector.header-subTitle",[s("label",{for:"variant_selector"},s(`i[data-icon=${a}]`)),s("select",{id:"variant_selector",value:t,onchange:e=>{const t=e.target.value;p.analyse.syntheticVariant(t),n.set(`/analyse/variant/${t}`)}},i.map((e=>s("option",{key:e[1],value:e[1]},e[0]))))])}function en(e,t,a,n){return s("section.board_wrapper.analyse-boardWrapper",{className:t?"halfsize ":""},s(G,{orientation:e,fen:a,variant:n}))}function tn(e,t){const a=e.currentTab(t),n=t.map((t=>{var a;return"comments"===t.id&&e.node.comments&&e.node.comments.length>0?Object.assign(Object.assign({},t),{chip:e.node.comments.length}):"forecasts"===t.id&&(null===(a=e.forecast)||void 0===a?void 0:a.lines)&&e.forecast.lines.length>0?Object.assign(Object.assign({},t),{chip:e.forecast.lines.length}):t}));return s("div.analyse-header",["ceval"!==a.id?s(_t,{ctrl:e}):null,s("div.analyse-tabs",[s("div.tab-title",an(e,a)),s(ke,{buttons:n,selectedIndex:e.currentTabIndex(t),onTabChange:e.onTabChange,wrapperClass:"analyse"})])])}function an(e,t){const a=o(t.title);let n;if("moves"===t.id){const t=function(e){const t=e.tree.getOpening(e.nodeList)||e.data.game.opening;if(t)return s("div",[s("strong",t.code),t.name?" "+t.name:""])}(e);n=[t||a]}else n="ceval"===t.id?[s("span",e.ceval.getEngineName()),e.ceval.isSearching()?s("div.ceval-spinner",s("span.fa.fa-spinner.fa-pulse")):null]:"explorer"===t.id?[Et(e)]:[a];return s.fragment({},n)}const nn={infos:function(e){const t=e.data.player,a=e.data.opponent;return t&&a?s("div",{className:"analyse-gameInfos native_scroller"},s("div",{className:"analyseOpponent li-button",oncreate:k((()=>t.user&&n.set(`/@/${t.user.id}/`)))},s("div",{className:"analysePlayerName"},s("span",{className:"color-icon "+t.color}),O(t,!0),B(t),t.berserk?s("span",{"data-icon":"`"}):null)),s("div",{className:"analyseOpponent li-button",oncreate:k((()=>a.user&&n.set(`/@/${a.user.id}/`)))},s("div",{className:"analysePlayerName"},s("span",{className:"color-icon "+a.color}),O(a,!0),B(a),a.berserk?s("span",{"data-icon":"`"}):null)),s("div",{className:"gameInfos"},e.formattedDate?e.formattedDate:null,"import"===e.data.game.source&&e.data.game.importedBy?s("div",null,"Imported by ",e.data.game.importedBy):null),ze.finished(e.data)?function(e){const t=Be(e.data,e.data.game.winner);return s("div",{className:"status"},ze.toLabel(e.data.game.status.name,e.data.game.winner,e.data.game.variant.key),t?("mate"!==e.data.game.status.name?". ":"")+o("white"===t.color?"whiteIsVictorious":"blackIsVictorious")+".":null)}(e):null,e.data.tournament?s("div",{className:"analyse-tournamentInfo li-button",oncreate:k((()=>e.data.tournament&&n.set(`/tournament/${e.data.tournament.id}`)))},s("span",{className:"fa fa-trophy"}),e.data.tournament.name+" Arena"):null,s("h2",{className:"analyse-tabContentTitle"},o("replayMode")),function(e){const t=e.data,a="correspondence"!==t.game.speed&&t.game.moveCentis&&0!==t.game.moveCentis.length,n=[...Ea,...a?[$a]:[],...t.analysis?[Fa]:[]];return s("div.analyse-autoplay",n.map((t=>s("button.buttonMetal",{oncreate:i((()=>e.autoplay.toggle(t.delay)))},o(t.name)))))}(e)):null},moves:function(e){return s("div.analyse-replayWrapper",[s(Qt,{ctrl:e,rightTabActive:!1})])},explorer:function(e){const t=e.explorer.current(),a=e.explorer.config,n=a.open(),l=!n&&e.explorer.loading(),c=r({explorerTable:!0,loading:l}),d=e.tree.getOpening(e.nodeList)||e.data.game.opening;return s("div",{id:"explorerTable",className:c},t&&t.isOpening?s("div",{className:"explorer-fixedTitle"},s("span",null,d?d.code+(d.name?" "+d.name:""):""),n||t&&t.isOpening?s("div",{className:"toconf","data-icon":n?"L":"%",oncreate:i(a.toggleOpen)}):null):null,l?s("div",{className:"spinner_overlay"},s("div",{className:"spinner fa fa-hourglass-half"})):null,n?function(e){return s("div.explorerConfig",{},Dt.view(e.explorer.config))}(e):null,!n&&e.explorer.failing()?s("div.explorer-data.empty",{},s("div.failing.message",[s("h3",[s("i.withIcon[data-icon=,]"),"Oops, sorry!"]),s("p","The explorer is temporarily"),s("p","out of service. Try again soon!")])):null,n||e.explorer.failing()?null:function(e){const t=e.explorer.current();if(t&&function(e){return!!e.isOpening}(t))return s(It,{data:t,ctrl:e});if(t&&function(e){return!!e.tablebase}(t)){const a=t.moves;return a.length?s("div",{className:"explorer-data"},$t(e,o("winning"),a.filter((e=>-2===e.wdl)),t.fen),$t(e,o("unknown"),a.filter((e=>null===e.wdl)),t.fen),$t(e,o("winPreventedBy50MoveRule"),a.filter((e=>-1===e.wdl)),t.fen),$t(e,o("drawn"),a.filter((e=>0===e.wdl)),t.fen),$t(e,o("lossSavedBy50MoveRule"),a.filter((e=>1===e.wdl)),t.fen),$t(e,o("losing"),a.filter((e=>2===e.wdl)),t.fen)):t.checkmate?Ut(o("checkmate")):t.variant_win||t.variant_loss?Ut(o("variantEnding")):Ot(e)}return s("div",null)}(e))},analysis:function(e){const t=e.data;return s("div.analyse-gameAnalysis.native_scroller",[t.analysis?xa(e):e.study?Ca(e):Ma(e),t.game.moveCentis?Pa(e,t.game.moveCentis):null])},ceval:function(e){return e.ceval.enabled()?s("div.ceval-Wrapper",[Nt(e),Tt(e)]):s("div.ceval-notEnabled","Computer eval is disabled")},pdnTags:function(e){const t=e.study;return t?s("div.native_scroller",[s("table.study-tags",[s("tbody",t.data.chapter.tags.map((([e,t])=>s("tr.study-tag",[s("th",e),s("td",s.trust(f(t)))]))))])]):s("div","oops! nothing to see here")},comments:function(e){const t=e.node.comments||[];return s("div.native_scroller.study-comments",t.map((e=>s("div.study-comment",[s("div.by",("string"==typeof e.by?e.by:e.by.name)+":"),s("div",s(Ct,{text:e.text}))]))))}};function sn(e,t){const a=e.retro||e.practice||e.forecast;return s("div.analyse-table.box",[tn(e,t),s(xe,{className:"analyse-tabsContent"+(a?" withTrainingBox":""),selectedIndex:e.currentTabIndex(t),tabs:t.map((t=>({id:t.id,f:()=>nn[t.id](e)}))),onTabChange:e.onTabChange,boardView:!0}),e.retro?na(e):null,e.practice?ga(e):null,e.forecast?Ra(e):null])}class Autoplay{constructor(e){this.ctrl=e,this.mergedCentis=[];const t=e.getChartData(),a=t.game.moveCentis,n=t.treeParts;if(a&&n.length){let e=0;for(const t of n.slice(1)){if((null==t?void 0:t.mergedNodes)&&t.mergedNodes.length>1){let n=0;for(let s=0;s<t.mergedNodes.length&&e<a.length;s++)n+=a[e],e++;this.mergedCentis.push(n)}else this.mergedCentis.push(a[e]),e++;if(e>=a.length)break}}}move(){return this.ctrl.canGoForward()?(this.ctrl.next(),d(),!0):(this.stop(),d(),!1)}evalToCp(e){return e.eval?e.eval.win?e.eval.win>0?990:-990:e.eval.cp:(e.displayPly||e.ply)%2?990:-990}nextDelay(){if("string"!=typeof this.delay||this.ctrl.onMainline){if("realtime"===this.delay){if(this.ctrl.node.ply<2)return 1e3;if(!this.mergedCentis.length)return 1500;return 10*this.mergedCentis[this.ctrl.node.ply-this.ctrl.tree.root.ply]+50||2e3}if("cpl"===this.delay){const e=30;if(this.ctrl.node.ply>=this.ctrl.mainline.length-1)return 0;const t=this.evalToCp(this.ctrl.node),a=this.evalToCp(this.ctrl.node.children[0]);return Math.max(500,Math.min(1e4,Math.abs(t-a)*e))}return this.delay}return 1500}schedule(){this.timeoutId=setTimeout((()=>{this.move()&&this.schedule()}),this.nextDelay())}start(e){this.delay=e,this.stop(),this.schedule()}stop(){clearTimeout(this.timeoutId),this.timeoutId=void 0}toggle(e){this.active(e)?this.stop():(this.active()||this.move()||this.ctrl.jump(""),this.start(e))}active(e){return!(e&&e!==this.delay||!this.timeoutId)}}function on(){const e={state:"pending"};return e.promise=new Promise(((t,a)=>{e.resolve=a=>{e.state="fulfilled",t(a)},e.reject=()=>{e.state="rejected",a()}})),e}const rn=new RegExp(""+/^info depth=(\d+) mean-depth=\S+ /.source+/score=(\S+) nodes=(\d+) /.source+/(?:time=(\S+) )?(?:nps=\S+ )?/.source+/pv="?([0-9\-xX\s]+)"?/.source);class ScanClient{constructor(e,t,a){this.variant=e,this.uciCache={},this.expectedPvs=1,this.startQueue=[],this.stopped=!1,this.engineName="Scan",this.init=async()=>{try{window.addEventListener("scan",this.listener,{passive:!0});const e=await this.scan.start();this.engineName=e.engineName,"web"!==V.getPlatform()&&await this.scan.setOption("threads",this.n_threads)}catch(e){}},this.setThreads=e=>(this.n_threads=e,this.scan.setOption("threads",this.n_threads)),this.start=e=>{this.stop(),this.startQueue.push(e),clearTimeout(this.stopTimeoutId);const t=new Promise(((e,t)=>{this.stopTimeoutId=setTimeout(t,1e4)}));return Promise.race([this.ready.promise,t]).then(this.search).catch((()=>this.reset().then(this.search)))},this.stop=async()=>{if(!this.stopped)return this.stopped=!0,this.scan.send("stop")},this.exit=()=>(window.removeEventListener("scan",this.listener,!1),this.scan.exit()),this.reset=()=>this.exit().then(this.init),this.search=async()=>{const e=this.startQueue.pop();if(e){this.work=e,this.curEval=void 0,this.expectedPvs=1,this.stopped=!1,this.startQueue=[],this.ready=on();let t=`pos pos=${H(e.initialFen)}${0!==e.moves.length?' moves="'+e.moves.join(" ")+'"':""}`;if(this.frisianVariant){const a=q(e.initialFen);let n="";(null==a?void 0:a.white.key)&&(null==a?void 0:a.white.count)&&(n+=`W${a.white.key}=${a.white.count}`),(null==a?void 0:a.black.key)&&(null==a?void 0:a.black.count)&&(n&&(n+=" "),n+=`B${a.black.key}=${a.black.count}`),n&&(t+=` wolf="${n}"`)}await this.scan.send(t),e.maxDepth>=99?await this.scan.send("level infinite"):await this.scan.send(`level depth=${e.maxDepth}`),await this.scan.send("go analyze")}},this.listener=e=>{this.processOutput(e.output)},this.scan=new J(e,a),this.n_threads=t,this.frisianVariant="frisian"===e||"frysk"===e,this.ready=on(),this.ready.resolve()}isSearching(){return"pending"===this.ready.state}processOutput(e){var t;if("string"!=typeof e)return;if(0===e.indexOf("done")&&(this.ready.resolve(),null===(t=this.work)||void 0===t||t.emit()),this.stopped||void 0===this.work)return;const a=rn.exec(e);if(!a)return;const n=parseInt(a[1]),s=parseInt(a[3]),i=1e3*parseFloat(a[4])||0,o=X(this.work.currentFen,a[5],this.frisianVariant,this.uciCache);let r,l=Math.round(100*parseFloat(a[2]));if(Math.abs(l)>9e3){const e=l>0?1e4-l:-(1e4+l);r=Math.round((e+e%2)/2)}else if(Math.abs(l)>8e3){const e=l>0?9e3-l:-(9e3+l);r=Math.round((e+e%2)/2)}this.expectedPvs<1&&(this.expectedPvs=1);const c=this.work.threatMode?0:1;this.work.ply%2===c&&(r?r=-r:l=-l);const d={moves:o,cp:r?void 0:l,win:r||void 0,depth:n};this.curEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:n,knps:i?s/i:0,nodes:s,cp:d.cp,win:d.win,pvs:[d],millis:i},1===this.expectedPvs&&this.curEval&&this.work.emit(this.curEval)}}class CevalCtrl{constructor(e,t){this.opts=e,this.emit=t,this.minDepth=6,this.initialized=!1,this.started=!1,this.isDeeper=!1,this.lastStarted=void 0,this.curEval=void 0,this.init=()=>this.engine.init().then((()=>{this.initialized=!0})),this.cevalMaxDepth="antidraughts"===this.opts.variant?p.analyse.cevalMaxDepthAnti:p.analyse.cevalMaxDepthNormal,this.restart=async()=>{this.lastStarted&&(await this.engine.stop(),await this.start(this.lastStarted.threatMode,this.lastStarted.path,this.lastStarted.nodes,!1,this.isDeeper))},this.destroy=async()=>{if(this.initialized)return this.engine.exit().then((()=>{this.initialized=!1,this.started=!1})).catch((()=>{this.initialized=!1,this.started=!1}))},this.stop=()=>{this.enabled()&&this.started&&(this.engine.stop(),this.started=!1)},this.toggle=()=>{this.isEnabled=!this.isEnabled},this.disable=()=>{this.isEnabled=!1},this.setCores=e=>(this.opts.cores=e,this.engine.setThreads(e).then(this.restart)),this.setHashSize=async e=>(this.opts.hashSize=e,this.destroy().then((()=>(this.engine=new ScanClient(this.opts.variant,this.opts.cores,this.opts.hashSize),this.init().then(this.restart))))),this.toggleInfinite=()=>{this.opts.infinite=!this.opts.infinite,this.restart()},this.goDeeper=()=>{this.lastStarted&&this.start(this.lastStarted.threatMode,this.lastStarted.path,this.lastStarted.nodes,!1,!0)},this.onEmit=(e,t)=>{var a,n;t&&(a=t.pvs,n=e.ply%2==0?"white":"black",a.sort(((e,t)=>_a(n,t)-_a(n,e))),cn(t,this.opts.variant),this.curEval=t),this.emit(e.path,t,e.threatMode)},this.allowed=e.allowed,this.isEnabled=p.analyse.enableCeval(),this.engine=new ScanClient(e.variant,e.cores,e.hashSize)}enabled(){return this.opts.allowed&&this.isEnabled}async start(e,t,a,n,s){if(!this.enabled())return;this.isDeeper=s;const i=this.effectiveMaxDepth(n),o=a[a.length-1],r=e?o.threat:o.ceval;if(r&&r.depth>=i)return;const l={initialFen:a[0].fen,currentFen:o.fen,moves:[],maxDepth:i,path:t,ply:o.ply,multiPv:1,threatMode:e,emit:e=>{this.enabled()&&this.onEmit(l,e)}};if(e){const e=(o.ply%2==1?"W":"B")+o.fen.slice(1);l.currentFen=e,l.initialFen=e}else for(let e=1;e<a.length;e++){const t=a[e];-1!==t.san.indexOf("x")?(l.moves=[],l.initialFen=t.fen):l.moves.push(ln(t))}this.curEval=void 0,await this.engine.start(l),this.started=!0,this.lastStarted={threatMode:e,path:t,nodes:a}}isInit(){return this.initialized}isSearching(){return this.engine.isSearching()}setMultiPv(e){this.opts.multiPv=e,this.restart()}getMultiPv(){return 1}curDepth(){return this.curEval?this.curEval.depth:0}canGoDeeper(){return this.curDepth()<99&&!this.isDeeper&&!this.engine.isSearching()}getEngineName(){return this.engine.engineName}effectiveMaxDepth(e=!1){return e||this.isDeeper||this.opts.infinite?99:this.cevalMaxDepth()}}function ln(e){if(!e.uci)return"";const t=z(e.uci);return t.length>2?t.join("x"):`${t[0]}-${t[t.length-1]}`}const cn=(()=>{const e=[],t=[];return(a,n)=>{if(!((e,t)=>e.knps&&e.depth>=t&&void 0!==e.cp&&Math.abs(e.cp)<500&&e.fen.split(",").length-1>=10)(a,"antidraughts"===n?3:14))return;const s="antidraughts"===n?t:e;if(s.push(a.knps),s.length>9){const e=function(e){e.sort(((e,t)=>e-t));const t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(s)||0;let t;"antidraughts"===n?(t=6,e>1e3&&(t=7),e>3e3&&(t=8),e>5e3&&(t=9),e>8e3&&(t=10),e>11e3&&(t=11),e>14e3&&(t=12),p.analyse.cevalMaxDepthAnti()!==t&&p.analyse.cevalMaxDepthAnti(t)):(t=18,e>500&&(t=19),e>1e3&&(t=20),e>3e3&&(t=21),e>5e3&&(t=22),e>7e3&&(t=23),e>9e3&&(t=24),e>11e3&&(t=25),e>13e3&&(t=26),e>15e3&&(t=27),p.analyse.cevalMaxDepthNormal()!==t&&p.analyse.cevalMaxDepthNormal(t)),s.length>40&&s.shift()}}})();function dn(e){return!!e.children.find((function(e){return!!e.comp}))}function hn(e){return e.split(" ").slice(0,4).join(" ")}function un(e){let t=[];const a=[];let n=[];const s={current:null,feedback:"find",minimized:!1,color:e.bottomColor()};function i(e){return n.includes(e)}function o(){const n="white"===e.bottomColor()?1:0;return t=function(e,t){const a=[];for(let n=1;n<e.length;n++){const s=e[n],i=e[n-1];t(s)&&s.eval&&i.eval&&Math.abs(Aa("white",i.eval,s.eval))>.075&&dn(i)&&a.push(s)}return a}(e.mainline,(e=>e.ply%2===n&&!a.includes(e.ply))),t.find((e=>!i(e.ply)))}function r(){s.feedback="find";const t=o();if(!t)return s.current=null,d();const a={node:t,path:e.mainlinePathToPly(t.ply)},n=Qe(a.path),i={node:e.tree.nodeAtPath(n),path:n},r=i.node.children.find((e=>!!e.comp));s.current={fault:a,prev:i,solution:{node:r,path:n+r.id},openingUcis:[]},e.data.game,e.userJump(i.path),d()}function l(t){const a=e.data.game.variant.key,n=Ee(t.fen)>10?0:"antidraughts"===a?1:2,s=n+("antidraughts"===a?10:21),i=n+("antidraughts"===a?6:16);return!!t.ceval&&(t.ceval.depth>=s||t.ceval.depth>=i&&!!t.ceval.millis&&t.ceval.millis>7e3)}function c(){const t=e.node,a=s.current;if(l(t)&&!e.ceval.isDeeper&&e.stopCevalImmediately(),a&&"eval"===s.feedback&&a.fault.node.ply===t.ply&&l(t)){Aa(s.color,t.ceval,a.prev.node.eval)>-.035?h():u()}}function h(){s.feedback="win",d()}function u(){s.feedback="fail";const t={node:e.node,path:e.path};e.userJump(s.current.prev.path),!e.tree.pathIsMainline(t.path)&&Ie(t.node.children)&&e.tree.deleteNodeAt(t.path),d()}function m(){const e=s.feedback;return"find"===e||"fail"===e}function v(){n=[],r()}return{vm:s,isPlySolved:i,onJump:function(){const t=e.node,a=s.feedback,n=s.current;n&&("eval"!==a||n.fault.node.ply===t.ply?m()&&n.fault.node.ply===t.ply&&(n.openingUcis.some((e=>t.uci===e))||t.comp?h():t.eval?u():(s.feedback="eval",e.ceval.enabled()||(e.ceval.toggle(),e.initCeval()),c())):s.feedback="find")},jumpToCurrent:r,nextMistake:function(){n.push(s.current.fault.node.ply),r()},viewSolution:function(){s.feedback="view",e.userJump(s.current.solution.path)},hideComputerLine:function(e){return e.ply%2==0!=("white"===s.color)&&!i(e.ply)},showBadNode:function(){const t=s.current;if(t&&m()&&t.prev.path===e.path)return t.fault.node},onCeval:c,onMergeAnalysisData:function(){m()&&!s.current&&r()},isSolving:m,isAlgebraic:()=>e.isAlgebraic(),completion:()=>[n.length,t.length],flip(){e.settings.flip(),s.color=e.bottomColor(),v()},reset:v,pieceTheme:p.general.theme.piece(),close:e.toggleRetro,toggleWindow(){s.minimized=!s.minimized},node:()=>e.node,variant:e.data.game.variant.key}}function pn(e,t){const a=e.data.game.variant.key,n=P(!1),s=P(!0),i=P(null),o=P(null),r=P(!1);function l(){e.ceval.enabled()||(e.ceval.toggle(),e.initCeval())}function c(t,a,n=0){if(e.gameOver(t)||t.tbhit)return!0;const s=t.ceval,i="antidraughts"===a?7:15,o="antidraughts"===a?6:13;return!!s&&(s.depth+n>=i||s.depth>=o&&Number(s.millis)>3e3)}function h(e){return e&&(e.winner?{win:"white"===e.winner?10:-10}:{cp:0})}function u(e){return e.tbhit&&e.tbhit.best||e.ceval&&x(e.ceval.pvs[0].moves[0])}function m(e){return e.tbhit&&e.tbhit.best||e.ceval&&Q(e.ceval.pvs[0].moves[0])}function v(t,a,n){let s,i;const o=e.gameOver(a);if("checkmate"===o)s="goodMove";else{const n=h(a.tbhit)||(a.threefold||"draw"===o?{cp:0}:a.ceval),r=h(t.tbhit)||t.ceval,l=-Aa(e.bottomColor(),n,r);i=u(t),i===a.uci&&(i=null),s=i?l<.025?"goodMove":l<.06?"inaccuracy":l<.14?"mistake":"blunder":"goodMove"}return{prev:t,node:a,path:n,verdict:s,best:i?{uci:i,san:m(t)}:void 0}}function f(){return e.turnColor()===e.bottomColor()}function g(){const n=e.node;if(!s())return i(null),d();if(!$e(a,n.fen)||Fe(n.tbhit))if(l(),f()){const e=o();e&&(e.uci=u(n)||e.uci)}else{if(i(null),n.san&&c(n,a)){const t=e.tree.parentNode(e.path);if(c(t,a,1))i(v(t,n,e.path));else{const t=e.tree.parentNode(Qe(e.path));c(t,a,1)&&i(v(t,n,e.path))}}!r()&&function(e,a){const n=e.ceval,s="antidraughts"===a?7:15,i=!!n&&(n.depth>=Math.min(n.maxDepth||99,t())||n.depth>=s&&(n.cloud||Number(n.millis)>5e3));return i&&n&&n.depth<50?!!(n.cloud||!n.millis||n.millis>500):i}(n,a)?(e.playUci(u(n)),r(!0)):d()}}function y(){l(),$e(a,e.node.fen)?e.explorer.fetchTablebaseHit(e.node.fen).then((t=>{t&&e.node.fen===t.fen&&(e.node.tbhit=t),g()})).catch((()=>{Fe(e.node.tbhit)||(e.node.tbhit=null),g()})):g()}function b(t){s(!0),t?(i(null),e.jump("")):y(),d()}return K(y),{onCeval:g,onJump(){r(!1),o(null),function(e,t){if(void 0!==t.threefold)return;const a=hn(t.fen);let n=0;for(const t in e)hn(e[t].fen)===a&&n++;t.threefold=n>2}(e.nodeList,e.node),y()},isMyTurn:f,comment:i,running:s,hinting:o,resume:b,playableDepth:t,reset(){i(null),o(null)},preUserJump(e,t){e!==t&&(s(!1),i(null))},postUserJump(e,t){e!==t&&f()&&b()},onUserMove(){s(!0)},playCommentBest(){const t=i();t&&(e.jump(Qe(t.path)),t.best&&e.playUci(t.best.uci))},hint(){const t=e.node.ceval?x(e.node.ceval.pvs[0].moves[0]):null,a=o();!t||a&&"move"===a.mode?o(null):o({mode:a?"move":"piece",uci:t}),d()},currentNode:()=>e.node,bottomColor:e.bottomColor,pieceTheme:p.general.theme.piece(),minimized:n,toggleWindow(){n(!n())}}}const mn="https://explorer.lidraughts.org",vn="https://tablebase.lidraughts.org";function fn(t,a,n,s){let i;const o={fen:a,moves:12};return s||(o.topGames=0,o.recentGames=0),"masters"===n.db?i="/master":(i="/lidraughts",o.variant=t,o["speeds[]"]=n.speeds,o["ratings[]"]=n.ratings),e(mn+i,{headers:{Accept:"application/json, text/*","X-Requested-With":"__delete",[Y]:"__delete"},credentials:"omit",query:o})}function gn(t,a,n){return e(vn+"/"+t,{headers:{Accept:"application/json, text/*","X-Requested-With":"__delete",[Y]:"__delete"},credentials:"omit",query:{fen:a},timeout:n})}function yn(e,t){const a=P(!0),n=P(!1),s=P({moves:[]});let i={};function o(e,t){i[e]=t,s(t)}const r=!!(Ue(e.data)||je(e.data)||e.data.game.offline),l="fromPosition"===e.data.game.variant.key?"standard":e.data.game.variant.key,c=Dt.controller(e.data.game.variant,(function(e){e&&(i={},f())})),h=Z((()=>{const e=document.getElementById("explorerTable");e&&(e.scrollTop=0)}),200);function u(){a(!1),n(!0),d()}const p=Z((e=>{const t={db:c.data.db.selected(),speeds:c.data.speed.selected(),ratings:c.data.rating.selected()};return fn(l,e,t,r).then((t=>{t.isOpening=!0,t.fen=e,o(e,t),a(!1),n(!1),d()})).catch(u)}),1e3,{leading:!0,trailing:!0}),m=Z((e=>gn(l,e).then((t=>{t.tablebase=!0,t.fen=e,o(e,t),a(!1),n(!1),d()})).catch(u)),500,{leading:!0,trailing:!0});const v={isOpening:!0,moves:[]};function f(){if("explorer"!==e.currentTab(e.availableTabs()).id)return;const t=e.node;t.ply>50&&!Le(l,t.fen)&&o(t.fen,v);const c=i[t.fen];var u;c?(s(c),a(!1),n(!1)):(a(!0),u=t.fen,r&&Le(l,u)?m(u):p(u)),d(),h()}return{allowed:t,setStep:f,loading:a,failing:n,config:c,withGames:r,current:s,fetchMasterOpening:function(){const e={};return function(t){return e[t]?Promise.resolve(e[t]):fn("standard",t,{db:"masters"},!1).then((a=>(e[t]=a,a)))}}(),fetchTablebaseHit:e=>gn(l,e,2e3).then((t=>{const a=t.moves[0];if(a&&null==a.dtz)throw"unknown tablebase position";return{fen:e,best:a&&a.uci,winner:t.checkmate?g(ee(e)):bn(e,a)}}))}}function bn(e,t){const a=e.split(" ")[1];return"w"===a[0]&&t.wdl<0||"b"===a[0]&&t.wdl>0?"white":"b"===a[0]&&t.wdl<0||"w"===a[0]&&t.wdl>0?"black":void 0}var wn={make:(e,t,a)=>new te(function(e,t,a){const n=p.game.pieceMove();return{variant:e.variant,fen:e.fen,boardSize:e.boardSize,lastMove:e.lastMove,turnColor:e.turnColor,captureLength:e.captureLength,orientation:t,coordinates:p.game.coords(),coordSystem:e.coordSystem,otb:e.otb,movable:{free:!1,color:e.movableColor,dests:e.dests,showDests:p.game.pieceDestinations(),variant:e.variant,captureUci:e.captureUci},draggable:{enabled:"drag"===n||"both"===n,magnified:p.game.magnified()},selectable:{enabled:"tap"===n||"both"===n},events:{move:a},premovable:{enabled:!1},highlight:{lastMove:p.game.highlights(),kingMoves:p.game.kingMoves()},animation:{enabled:!!p.game.animations(),duration:ae(p.game.animations())}}}(e,t,a)),promote(e,t){const a={},n=e.state.pieces[t];n&&"man"===n.role&&(a[t]={color:n.color,role:"king"},e.setPieces(a))}};function xn(e){return{analysisProgress(t){e.mergeAnalysisData(t)},evalHit(t){e.evalCache.onCloudEval(t)},fen(t){e.forecast&&t.id===e.data.game.id&&0!==Ye(e.mainline).fen.indexOf(t.fen)&&e.forecast.reloadToLastPly()}}}const kn={id:"infos",title:"gameInformation",className:"fa fa-info-circle"},Mn={id:"moves",title:"movesPlayed",className:"fa fa-list-alt"},Cn={id:"ceval",title:"Scan",className:"fa fa-cogs"},Pn={id:"explorer",title:"openingExplorerAndTablebase",className:"fa fa-book"},Nn={id:"analysis",title:"gameAnalysis",className:"fa fa-area-chart"},Sn={id:"pdnTags",title:"pdnTags",className:"fa fa-tags"},Tn={id:"comments",title:"comments",className:"fa fa-comment-o"};class StudyCtrl{constructor(e,t){this.data=e,this.rootCtrl=t,this.toggleLike=()=>{this.rootCtrl.socket.send("like",{liked:!this.data.liked})},this.toggleShowComments=()=>{this.vm.showComments=!this.vm.showComments},this.actionMenu=kt.controller(this.rootCtrl),this.sideMenu=new se("right","studyMenu","studyMenu-backdrop"),this.analyseCtrl=t,e.features.chat&&e.chat&&u.isConnected()&&(this.chat=new Pe(t.socket,e.id,e.chat.lines,void 0,e.chat.writeable,u.isShadowban(),"Study")),this.vm={showComments:!1},null===p.study.tour()&&(xt(this),p.study.tour(window.deviceInfo.appVersion))}canContribute(){const e=u.getUserId(),t=e&&this.data.members[e];return!!t&&"w"===t.role}createSocket(){return ie.createStudy(this.data.id,(e=this,Object.assign(Object.assign({},xn(e.rootCtrl)),{liking(t){e.data.likes=t.l.likes,t.w&&t.w.s===ne()&&(e.data.liked=t.l.me),d()},message(t){e.chat&&e.chat.append(t)}})));var e}}class AnalyseCtrl{constructor(e,t,a,s,i,o,r){this.data=e,this.source=a,this.orientation=s,this.shouldGoBack=i,this.onMainline=!0,this.contextMenu=null,this.replaying=!1,this.analysisProgress=!1,this.retroGlowing=!1,this.showThreat=!1,this._currentTabIndex=0,this.canDrop=()=>!1,this.player=()=>this.data.game.player,this.availableTabs=()=>{let e=[Mn];return this.study&&this.study.data.chapter.tags.length>0&&(e=[Sn,...e]),this.synthetic||(e=[kn,...e]),this.study&&(e=[...e,Tn]),this.retro||this.practice||!this.ceval.enabled()||(e=[...e,Cn]),(this.study||yt(this.data)&&Te(this.data))&&(e=[...e,Nn]),oe()&&this.explorer.allowed&&(e=[...e,Pn]),e},this.currentTabIndex=e=>this._currentTabIndex>e.length-1?e.length-1:this._currentTabIndex,this.currentTab=e=>e[this.currentTabIndex(e)],this.onTabChange=e=>{this._currentTabIndex=e;const t=this.currentTab(this.availableTabs());this.updateHref(),"moves"===t.id?this.debouncedScroll():"explorer"===t.id&&this.explorer.setStep(),d()},this.resetTabs=()=>this.onTabChange(this.currentTabIndex(this.availableTabs())),this.setPath=e=>{this.path=e,this.nodeList=this.tree.getNodeList(e),this.node=Ye(this.nodeList),this.mainline=Ke(this.tree.root),this.onMainline=this.tree.pathIsMainline(e)},this.initCeval=()=>{this.ceval.enabled()&&(this.ceval.isInit()?this.debouncedStartCeval():this.ceval.init().then(this.debouncedStartCeval))},this.startCeval=()=>{if(this.ceval.enabled())if(this.canUseCeval()){const e=this.nodeList.length>0&&this.node.displayPly&&this.node.displayPly!==this.node.ply,t=e?this.path.slice(2):this.path,a=e?this.nodeList.slice(1):this.nodeList,n=!(!this.retro&&!this.practice);this.ceval.start(this.showThreat,t,a,n,!1),this.evalCache.fetch(t,n?1:this.ceval.getMultiPv())}else this.stopCevalImmediately()},this.stopCevalImmediately=()=>{this.ceval.stop(),this.debouncedStartCeval.cancel()},this.toggleRetro=e=>{this.retro?("backbutton"!==e&&n.backbutton.stack.pop(),this.retro=null,p.analyse.enableCeval()?this.startCeval():this.ceval.disable()):(this.stopCevalImmediately(),this.practice&&(this.practice=null),this.retro=un(this),n.backbutton.stack.push(this.toggleRetro),this.retro.jumpToCurrent())},this.practiceDepth=()=>{const e=this.data.game.variant.key,t="antidraughts"===e?8:20,a=Ee(this.node.fen);return a<=5?"antidraughts"===e?t+2:"frisian"===e||"frysk"===e?t+8:t+5:a<=10?"antidraughts"===e?t+1:"frisian"===e||"frysk"===e?t+5:t+3:t},this.togglePractice=()=>{this.practice||!this.ceval.allowed?this.practice=null:(this.retro&&(this.retro=null),this.practice=pn(this,this.practiceDepth))},this.toggleShowThreat=()=>{this.ceval.allowed&&(this.ceval.enabled()||this.ceval.toggle(),this.showThreat=!this.showThreat,this.startCeval())},this.debouncedScroll=Z((()=>We(document.getElementById("replay"))),200),this.jump=(e,t)=>{const a=e!==this.path,n=this.node.displayPly?this.node.displayPly:this.node.ply;this.setPath(e),this.updateBoard(Math.abs(n-(this.node.displayPly?this.node.displayPly:this.node.ply))>1,void 0!==t?"forward"===t?"redo":"undo":void 0),this.fetchOpening(),this.node&&this.node.san&&"forward"===t&&(-1!==this.node.san.indexOf("x")?re.throttledCapture():re.throttledMove()),this.ceval.stop(),this.debouncedExplorerSetStep(),this.updateHref(),a&&(this.retro&&this.retro.onJump(),this.practice&&this.practice.onJump(),this.debouncedStartCeval())},this.userJump=(e,t)=>{if(this.autoplay.stop(),this.practice){const a=this.path;this.practice.preUserJump(a,e),this.jump(e,t),this.practice.postUserJump(a,this.path)}else this.jump(e,t)},this.jumpToMain=e=>{this.userJump(this.mainlinePathToPly(e))},this.jumpToIndex=e=>{this.jumpToMain(e+1+(this.data.game.startedAtTurn||0))},this.canGoForward=()=>this.node.children.length>0,this.next=()=>{if(!this.canGoForward())return!1;const e=this.node.children[0];return e&&this.userJump(this.path+e.id,"forward"),!0},this.fastforward=()=>{this.replaying=!0;const e=this.next();return e||(this.replaying=!1,this.debouncedScroll()),e},this.stopff=()=>{this.replaying=!1,this.next(),this.debouncedScroll()},this.rewind=()=>{this.replaying=!0;const e=this.prev();return e||(this.replaying=!1,this.debouncedScroll()),e},this.stoprewind=()=>{this.replaying=!1,this.prev(),this.debouncedScroll()},this.toggleBookmark=()=>le(this.data.game.id).then((()=>{this.data.bookmarked=!this.data.bookmarked,d()})).catch(h),this.playUci=e=>{const t=z(e);this.sendMove(t[0],t[t.length-1],t.length>2?e:void 0),this.explorer.loading(!0)},this.canUseCeval=()=>!this.gameOver(),this.hasAnyComputerAnalysis=()=>this.data.analysis||this.ceval.enabled(),this.hasFullComputerAnalysis=()=>this.isFullAnalysis(this.mainline),this.isOfflineOrNotPlayable=()=>"offline"===this.source||!(!this.study||!this.study.data)||!Ne(this.data),this.unload=()=>{this.autoplay.stop(),this.ceval&&this.ceval.destroy()},this._deleteNode=e=>{this.tree.deleteNodeAt(e),this.contextMenu=null,Je(this.path,e)?this.userJump(Qe(e)):this.jump(this.path)},this.updateHref=Z((()=>{n.setQueryParams({tabId:this.currentTab(this.availableTabs()).id,ply:String(this.node.ply),curFen:this.node.fen,variant:this.data.game.variant.key})}),200),this.canEvalGet=e=>e.ply<15,this.sendMove=(e,t,a)=>{const n={orig:e,dest:t,uci:a,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path,fullCapture:p.analyse.fullCapture()};this.practice&&this.practice.onUserMove(),ht(n).then(this.addNode).catch((e=>{}))},this.userMove=(e,t,a)=>{if(a?re.capture():re.move(),p.analyse.fullCapture()&&this.node.destsUci){const a=this.node.destsUci.find((a=>a.slice(0,2)===e&&a.slice(-2)===t));if(a)return void this.sendMove(e,t,a)}this.sendMove(e,t)},this.addNode=({situation:e,path:t})=>{const a=this.node,n={id:e.id,ply:e.ply,fen:e.fen,children:[],dests:e.dests,destsUci:e.destsUci,drops:e.drops,captLen:e.captureLength,end:e.end,draw:e.draw,player:e.player,uci:e.uci,san:e.san,pdnMoves:a&&a.pdnMoves?a.pdnMoves.concat(e.pdnMoves):e.pdnMoves};if(void 0===t)return;const s=this.tree.addNode(n,t);s&&(this.jump(s),this.debouncedScroll(),d())},this.onCevalMsg=(e,t,a)=>{t?this.tree.updateAt(e,(n=>{if(n.fen===t.fen||a){if(a){const e=t;!n.threat||Ge(e,n.threat)||n.threat.maxDepth<e.maxDepth?n.threat=e:t.knps&&(n.threat.knps=t.knps)}else!n.ceval||Ge(t,n.ceval)?n.ceval=t:t.cloud||(n.ceval.cloud&&this.ceval.isDeeper?n.ceval=t:(t.knps&&(n.ceval.knps=t.knps),t.maxDepth>n.ceval.maxDepth&&(n.ceval.maxDepth=t.maxDepth)));n.ceval&&n.ceval.pvs.length>0&&(n.ceval.best=n.ceval.pvs[0].moves[0]),e===this.path&&(this.retro&&this.retro.onCeval(),this.practice&&this.practice.onCeval(),t.cloud&&t.depth>=this.ceval.effectiveMaxDepth()&&this.ceval.stop(),d())}})):"ceval"===this.currentTab(this.availableTabs()).id&&d()},this.debouncedStartCeval=Z(this.startCeval,500,{trailing:!0}),this.getNodeSituation=Z((()=>{this.node&&!this.node.dests&&ut({variant:this.data.game.variant.key,fen:this.node.fen,uci:this.node.uci,path:this.path,fullCapture:p.analyse.fullCapture()}).then((({situation:e,path:t})=>{this.tree.updateAt(t,(t=>{t.dests=e.dests,t.destsUci=e.destsUci,t.captLen=e.captureLength,t.end=e.end,t.draw=e.draw,t.player=e.player})),t===this.path&&(this.updateBoard(),d(),this.gameOver()&&this.stopCevalImmediately())})).catch((e=>{}))}),50),this.fetchOpening=Z((()=>{if(oe()&&this.node&&void 0===this.node.opening&&this.node.ply<=20&&this.node.ply>0&&ce.has(this.data.game.variant.key)){const e={fen:this.node.fen,path:this.path},t=this.data.game.variant.key;"standard"!==t&&(e.variant=t),this.tree.updateAt(this.path,(t=>{t.opening=null,this.socket.ask("opening","opening",e).then((e=>{e.opening&&e.path&&(t.opening=e.opening,e.path===this.path&&d())})).catch(de)}))}}),50),this.synthetic=Ue(e),this.ongoing=!this.synthetic&&Ne(e),this.initialPath=Ze,this.study=void 0!==t?new StudyCtrl(t,this):void 0,this.forecast=e.forecast?new ForecastCtrl(e):void 0,this._currentTabIndex=this.study&&0!==this.study.data.chapter.tags.length||!this.synthetic?1:0,-1===p.analyse.supportedVariants.indexOf(this.data.game.variant.key)&&(w.show({text:`Analysis board does not support ${this.data.game.variant.name} variant.`,position:"center",duration:"short"}),n.set("/")),this.tree=et(tt(this.data.treeParts)),this.settings=Pt.controller(this),this.menu=bt.controller(this),this.continuePopup=ge.controller(),this.autoplay=new Autoplay(this),this.notes=u.isConnected()&&"correspondence"===this.data.game.speed?new we(this.data):null,this.retro=null,this.practice=null;const l=(()=>{const e=this.data.game.variant.key;if(!Re.includes(e))return!1;const t=this.study&&this.study.data;return!(t&&!t.chapter.features.computer&&!t.chapter.practice)&&(!(this.data.game.initialFen&&!he(this.data.game.initialFen,ue(e).size))&&this.isOfflineOrNotPlayable())})();this.ceval=new CevalCtrl({allowed:l,variant:this.data.game.variant.key,multiPv:1,cores:p.analyse.cevalCores(),hashSize:p.analyse.cevalHashSize(),infinite:p.analyse.cevalInfinite()},this.onCevalMsg);//!this.study || this.study.data.chapter.features.explorer
this.explorer=yn(this,!1),this.debouncedExplorerSetStep=Z(this.explorer.setStep,ae(p.game.animations())+50);const c=void 0!==o?o:this.tree.lastPly();this.gamePath=this.synthetic||this.ongoing?void 0:at(Ke(this.tree.root));const m=Ke(this.tree.root);if(this.initialPath=nt(m,(e=>e.ply<=c)),this.setPath(this.initialPath),this.forecast&&this.data.game.turns){this.initialPath||(this.initialPath=nt(this.mainline,(e=>e.ply<=this.data.game.turns)));const e=this.tree.getNodeList(this.initialPath),t=this.tree.getCurrentNodesAfterPly(e,this.mainline,this.data.game.turns);let a=0;for(const e of t)a+=e.uci?(e.uci.length-2)/2:1;this.forecast.skipSteps=a}if(this.data.game.createdAt&&(this.formattedDate=pe(new Date(this.data.game.createdAt))),this.study?this.socket=this.study.createSocket():!this.data.analysis&&u.isConnected()&&yt(this.data)&&Te(this.data)&&void 0!==this.data.url&&void 0!==this.data.player.version?this.socket=ie.createGame(this.data.url.socket,this.data.player.version,xn(this),this.data.url.round):this.socket=ie.createAnalysis(xn(this)),this.synthetic||setTimeout((()=>{this.socket.send("startWatching",this.data.game.id)}),1e3),this.evalCache=function({variant:e,canGet:t,getNode:a,receive:n,socketIface:s}){const i=new Set;return{fetch(n,o){const r=a();if(r.ceval&&r.ceval.cloud||!t(r))return;if(i.has(r.fen))return;i.add(r.fen);const l={fen:r.fen,path:n};"standard"!==e&&(l.variant=e),o>1&&(l.mpv=o),s.send("evalGet",l)},onCloudEval(e){n(e.path,function(e){const t={fen:e.fen,nodes:1e3*e.knodes,depth:e.depth,pvs:e.pvs.map((e=>{const t={moves:e.moves.split(" ")};return void 0!==e.cp?t.cp=e.cp:t.win=e.win,t})),cloud:!0};return void 0!==t.pvs[0].cp?t.cp=t.pvs[0].cp:t.win=t.pvs[0].win,t.cloud=!0,t}(e))}}}({variant:this.data.game.variant.key,canGet:this.canEvalGet,getNode:()=>this.node,receive:this.onCevalMsg,socketIface:this.socket}),this.updateBoard(),r){const e=this.currentTabIndex(this.availableTabs()),t=this.availableTabs().findIndex((e=>e.id===r));t>=0&&e!==t&&this.onTabChange(t)}"explorer"===this.currentTab(this.availableTabs()).id&&this.debouncedExplorerSetStep(),setTimeout(this.debouncedScroll,250),setTimeout(this.initCeval,1e3)}playerName(e){const t=Be(this.data,e);return this.study?ya(this.study.data,e)||o("anonymous"):O(t)}topColor(){return g(this.bottomColor())}bottomColor(){return this.settings.s.flip?g(this.data.orientation):this.data.orientation}turnColor(){return Ve(this.node.ply)}promote(e,t){this.tree.promoteAt(e,t),this.contextMenu=null,this.jump(e)}deleteNode(e){const t=this.tree.nodeAtPath(e);if(!t)return;const a=st(t);a.nodes>=10||a.comments>0?me.confirm({title:"Confirm",message:`Delete ${a.nodes} move(s)`+(a.comments?` and ${a.comments} comment(s)`:"")+"?"}).then((()=>this._deleteNode(e))):this._deleteNode(e)}restartPractice(){this.practice=null,this.togglePractice()}getChartData(){const e=this.data;return{analysis:e.analysis,game:e.game,player:e.player,opponent:e.opponent,treeParts:Ke(this.tree.root)}}mergeAnalysisData(e){this.analysisProgress||(this.analysisProgress=!0,d()),this.tree.merge(e.tree),this.data.analysis=e.analysis;const t=Ke(e.tree);this.isFullAnalysis(t)&&(this.analysisProgress=!1,this.retroGlowing=!0,setTimeout((()=>{this.retroGlowing=!1,d()}),8e3),re.dong(),pt.quick(),d()),this.retro&&this.retro.onMergeAnalysisData(),d()}gameOver(e){const t=e||this.node;return!(!(null==t?void 0:t.end)||""!==t.dests&&!He(t.dests))&&(t.draw?"draw":"checkmate")}pickUci(e,t){return t?e&&e.uci&&e.uci.length>t.length&&e.uci.slice(0,2)===t.slice(0,2)&&e.uci.slice(e.uci.length-2)===t.slice(t.length-2)?e.uci:t:void 0}nextNodeBest(){return it(this.node,(e=>e.eval?this.pickUci(this.node.children.find((function(e){return!!e.comp})),e.eval.best):void 0))}mainlinePathToPly(e){return nt(this.mainline,(t=>(t.displayPly?t.displayPly:t.ply)<=e))}isFullAnalysis(e){let t=0;for(let a=0;a<e.length-2;a++){if(!(a>0&&e[a].ply===e[a-1].ply)){if(t++,t>200)return!0;const n=e[a].eval;if(!n||!Object.keys(n).length)return!1}}return!0}prev(){return this.userJump(Qe(this.path),"backward"),!0}isAlgebraic(){const e=this.data.game.variant.board||ue(this.data.game.variant.key);return 1===p.game.coordSystem()&&"64"===e.key}coordSystem(){return this.isAlgebraic()?1:0}updateBoard(e=!1,t){const a=this.node,n=Ve(a.ply),s=ve(a.dests),i=this.data.game.variant.board||ue(this.data.game.variant.key),o={variant:this.data.game.variant.key,fen:a.fen,boardSize:i.size,coordinates:p.game.coords(),coordSystem:this.coordSystem(),turnColor:n,orientation:this.settings.s.flip?g(this.orientation):this.orientation,movableColor:this.gameOver()?null:n,dests:s||null,captureLength:a.captLen,captureUci:p.analyse.fullCapture()&&this.node.destsUci&&this.node.destsUci.length?this.node.destsUci.concat():void 0,lastMove:a.uci?fe(a.uci):null,otb:!0,shift:t};this.cgConfig=o,this.data.game.player=n,this.draughtsground?this.draughtsground.set(o,e):this.draughtsground=wn.make(o,this.orientation,this.userMove),s||this.getNodeSituation()}}export{AnalyseCtrl as A,Qa as a,gt as g,Ka as l,Ya as o,Za as r};
