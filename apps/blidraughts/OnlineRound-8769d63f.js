import{bk as t,bD as e,aY as s,e as a,bl as i,r as o,aI as n,h as r,s as h,a6 as c,p as l,m as d,bE as p,k as m,b as u,aQ as g,bF as v,ad as k,a as b,A as f,bG as y,bH as w,K as M,bI as T}from"./main.js";import{v as C}from"./vibrate-985a16e3.js";import{o as D,w as S,d as A,x,y as P,z as L,A as R,n as I,g as j}from"./game-3e605d21.js";import{C as F}from"./chat-1f5c68bb.js";import{a as U,r as O,N as B}from"./notes-2c1d8afe.js";import{f as V,d as z,m as G,e as E}from"./roundView-c826907d.js";class TransientMove{constructor(t){this.ctrl=t,this.register=()=>{this.current=setTimeout(this.expire,1e4)},this.clear=()=>{clearTimeout(this.current)},this.expire=()=>{this.ctrl.reloadGameData()}}}function N(t,n,r=!1,h){const c=h&&null!==h.uci?e(h.uci):t.game.lastMove?e(t.game.lastMove):null,l=h?(h.ply-(0===s(h.fen)?0:1))%2==0?"white":"black":t.game.player,d=a.game.pieceMove();return{variant:t.game.variant.key,fen:n,boardSize:t.game.variant.board.size,orientation:i(t,r),turnColor:l,captureLength:t.captureLength,lastMove:c,coordinates:a.game.coords(),coordSystem:1===a.game.coordSystem()&&"64"===t.game.variant.board.key?1:0,highlight:{lastMove:a.game.highlights(),kingMoves:a.game.kingMoves()&&("frisian"===t.game.variant.key||"frysk"===t.game.variant.key)},movable:{free:!1,color:D(t)?t.player.color:null,dests:D(t)?S(t.possibleMoves):{},variant:t.game.variant.key,showDests:a.game.pieceDestinations()},animation:{enabled:!!a.game.animations(),duration:t.pref.animationDuration},premovable:{enabled:t.pref.enablePremove,showDests:a.game.pieceDestinations(),variant:t.game.variant.key,events:{set:()=>o(),unset:o}},predroppable:{enabled:!1,events:{set:()=>o(),unset:o}},draggable:{enabled:"drag"===d||"both"===d,distance:3,magnified:a.game.magnified(),preventDefault:!0},selectable:{enabled:"tap"===d||"both"===d}}}var W={make:function(e,s,a,i,o){const n=N(e,s,void 0,o);return n.movable.events={after:a},n.events={move:i},n.viewOnly=e.player.spectator,new t(n)},reload:function(t,e,s,a,i){t.reconfigure(N(e,s,a,i))},promote:function(t,e){const s={},a=t.state.pieces[e];a&&"man"===a.role&&(s[e]={color:a.color,role:"king"},t.setPieces(s))}};class ClockCtrl{constructor(t,e){this.opts=e,this.emergSound={play:n.lowtime,delay:2e4,playable:{white:!0,black:!0}},this.elements={white:null,black:null},this.setClock=(t,e,s,a=0)=>{const i=A(t)&&(x(t)>1||t.clock.running),o=10*a;this.times={white:1e3*e,black:1e3*s,activeColor:i?t.game.player:void 0,lastUpdate:performance.now()+o},i&&this.scheduleTick(this.times[t.game.player],o)},this.addTime=(t,e)=>{this.times[t]+=10*e},this.stopClock=()=>{const t=this.times.activeColor;if(t){const e=this.elapsed();this.times[t]=Math.max(0,this.times[t]-e),this.times.activeColor=void 0}},this.millisOf=t=>this.times.activeColor===t?Math.max(0,this.times[t]-this.elapsed()):this.times[t],this.isRunning=()=>void 0!==this.times.activeColor,this.unload=()=>{clearTimeout(this.tickTimeoutID),this.times.activeColor=void 0},this.scheduleTick=(t,e)=>{void 0!==this.tickTimeoutID&&clearTimeout(this.tickTimeoutID),this.tickTimeoutID=setTimeout(this.tick,t%(this.showTenths(t)?100:500)+1+e)},this.tick=()=>{this.tickTimeoutID=void 0;const t=this.times.activeColor;if(!t)return;const e=performance.now(),s=Math.max(0,this.times[t]-this.elapsed(e));this.scheduleTick(s,0),0===s?this.opts.onFlag():this.updateElement(t,s),this.opts.soundColor===t&&(this.emergSound.playable[t]?s<this.emergMs&&!(e<this.emergSound.next)&&(this.emergSound.play(),this.emergSound.next=e+this.emergSound.delay,this.emergSound.playable[t]=!1):s>1.5*this.emergMs&&(this.emergSound.playable[t]=!0))},this.elapsed=(t=performance.now())=>Math.max(0,t-this.times.lastUpdate);const s=t.clock;if(0===e.showTenths)this.showTenths=()=>!1;else{const t=1===e.showTenths?1e4:36e5;this.showTenths=e=>e<t}this.emergMs=1e3*Math.min(60,Math.max(10,.125*s.initial)),this.setClock(t,s.white,s.black)}updateElement(t,e){const s=this.elements[t];if(s){const a=this.showTenths(e),i=V(e,a,this.times.activeColor===t);a?s.innerHTML=i:s.textContent=i,e<this.emergMs?s.classList.add("emerg"):s.classList.remove("emerg")}}}class CorresClockCtrl{constructor(t,e){this.lastUpdate={white:t.white,black:t.black,at:Date.now()},this.els={black:null,white:null},this.data=t,this.onFlag=e}setLastUpdate(t){this.lastUpdate.white=t.white,this.lastUpdate.black=t.black,this.lastUpdate.at=Date.now()}update(t,e){this.data.white=t,this.data.black=e,this.setLastUpdate(this.data)}tick(t){this.data[t]=Math.max(0,this.lastUpdate[t]-(Date.now()-this.lastUpdate.at)/1e3),0===this.data[t]&&this.onFlag();const e=1e3*this.data[t],s=this.els[t];s&&(s.textContent=z(e))}}class RoundSocket{constructor(t,e){this.ctrl=t,this.moreTime=r((()=>{this.iface.send("moretime")}),300),this.outoftime=function(t,e,s){let a,i=0;return(...o)=>{const n=performance.now()-i,r=()=>{a=void 0,i=performance.now(),t*=e,s(...o)};a&&clearTimeout(a),n>t?r():a=setTimeout(r,t-n)}}(500,1.1,(()=>{this.iface.send("flag",this.ctrl.data.game.player)})),this.berserk=r((()=>{this.iface.send("berserk",null,{ackable:!0})}),200);const s={takebackOffers(e){!t.data.player.proposingTakeback&&e[t.data.player.color]&&(n.dong(),C.quick()),!t.data.opponent.proposingTakeback&&e[t.data.opponent.color]&&(n.dong(),C.quick()),t.data.player.proposingTakeback=e[t.data.player.color],t.data.opponent.proposingTakeback=e[t.data.opponent.color],o()},move(e){e.isMove=!0,t.apiMove(e),o()},drop(e){e.isDrop=!0,t.apiMove(e),o()},clockInc(e){t.clock&&(t.clock.addTime(e.color,e.time),o())},cclock(e){t.data.correspondence&&t.correspondenceClock&&(t.data.correspondence.white=e.white,t.data.correspondence.black=e.black,t.correspondenceClock.update(e.white,e.black),o())},checkCount(e){const s="white"===t.data.player.color;t.data.player.checks=s?e.white:e.black,t.data.opponent.checks=s?e.black:e.white,o()},berserk(e){t.setBerserk(e)},redirect(t){h.redirectToGame(t)},reload:function(e){e&&e.t&&s[e.t]?s[e.t](e.d):t.reloadGameData()},endData(e){t.endWithData(e),o()},rematchOffer(e){t.data.player.offeringRematch=e===t.data.player.color;(t.data.opponent.offeringRematch=e===t.data.opponent.color)&&c.show({text:l("yourOpponentWantsToPlayANewGameWithYou"),position:"center",duration:"short"}),o()},rematchTaken(e){t.data.game.rematch=e},drawOffer(e){t.data.player.offeringDraw=e===t.data.player.color;(t.data.opponent.offeringDraw=e===t.data.opponent.color)&&c.show({text:l("yourOpponentOffersADraw"),position:"center",duration:"short"}),o()},gone(e){t.data.opponent.ai||"correspondence"===t.data.game.speed||(P(t.data,t.data.opponent.color,e),t.chat&&t.chat.showing||o())},message(e){t.chat&&t.chat.append(e)},tvSelect(s){t.data.tv&&s.channel===t.data.tv&&e&&e()},crowd(e){L(t.data,"white",e.white),L(t.data,"black",e.black),t.data.watchers=e.watchers,t.chat&&t.chat.showing||o()}};this.iface=h.createGame(t.data.url.socket,t.data.player.version,s,t.data.url.round,t.data.userTV)}}class OnlineRound{constructor(t,r,l,f=!1,y,w,M){this.goingBack=t,this.id=r,this.onFeatured=y,this.isAlgebraic=()=>1===a.game.coordSystem()&&"64"===this.data.game.variant.board.key,this.coordSystem=()=>this.isAlgebraic()?1:0,this.zenAvailable=()=>!this.data.player.spectator&&A(this.data),this.isZen=()=>this.zenAvailable()&&this.zenModeEnabled,this.toggleZenMode=()=>{this.zenModeEnabled=!this.zenModeEnabled,o()},this.goToAnalysis=()=>{const t=this.data;d.set(`/analyse/online/${t.game.id}/${i(t)}?ply=${this.vm.ply}&curFen=${t.game.fen}&variant=${t.game.variant.key}`)},this.openUserPopup=(t,e)=>{if(void 0===this.score){const t=this.data;if(!t||!t.player.user||!t.opponent.user)return;U(t.player.user.id,t.opponent.user.id).then((t=>{this.score=t,o()}))}this.vm.miniUser[t].data||p(e).then((e=>{this.vm.miniUser[t].data=e,o()})).catch((()=>{this.vm.miniUser[t].showing=!1,o()})),this.vm.miniUser[t].showing=!0},this.closeUserPopup=t=>{this.vm.miniUser[t].showing=!1},this.showActions=()=>{d.backbutton.stack.push(this.hideActions),this.vm.showingActions=!0,this.vm.showingShareActions=!1},this.showShareActions=()=>{this.vm.showingShareActions=!0},this.hideActions=t=>{"backbutton"!==t&&this.vm.showingActions&&d.backbutton.stack.pop(),this.vm.showingActions=!1,this.vm.showingShareActions=!1},this.flip=()=>{this.vm.flip=!this.vm.flip,this.data.tv?this.vm.flip?d.set("/tv?flip=1",!0):d.set("/tv",!0):this.draughtsground.set({orientation:i(this.data,this.vm.flip)})},this.canOfferDraw=()=>R(this.data)&&(this.lastDrawOfferAtPly||-99)<this.vm.ply-20,this.offerDraw=()=>{this.canOfferDraw()&&(this.lastDrawOfferAtPly=this.vm.ply,this.socket.iface.send("draw-yes",null))},this.canDrop=()=>!this.replaying()&&D(this.data),this.jump=(t,a)=>{if(t<this.firstPly()||t>this.lastPly())return!1;const i=Math.abs(t-this.vm.ply),o=this.replaying(),r=t>this.vm.ply;this.vm.ply=t;const h=this.plyStep(t),c=s(h.fen),l={variant:this.data.game.variant.key,fen:h.fen,lastMove:h.uci?e(h.uci):null,turnColor:(this.vm.ply-(0===c?0:1))%2==0?"white":"black",shiftView:a};return this.replaying()||(l.movableColor=D(this.data)?this.data.player.color:null,l.dests=S(this.data.possibleMoves),l.captureLength=this.data.captureLength),this.draughtsground.set(l,i>1),!o&&this.replaying()&&this.draughtsground.stop(),h.san&&r&&(-1!==h.san.indexOf("x")?n.throttledCapture():n.throttledMove()),!0},this.userJump=t=>{this.cancelMove(),this.draughtsground.selectSquare(null),this.jump(t)},this.jumpNext=()=>this.jump(this.vm.ply+1,"redo"),this.jumpPrev=()=>this.jump(this.vm.ply-1,"undo"),this.jumpFirst=()=>this.jump(this.firstPly(),"undo"),this.jumpLast=()=>this.jump(this.lastPly(),"redo"),this.cancelMove=t=>{"backbutton"!==t&&d.backbutton.stack.pop(),this.vm.moveToSubmit=null,this.vm.dropToSubmit=null,this.jump(this.vm.ply)},this.submitMove=t=>{t&&(this.vm.moveToSubmit||this.vm.dropToSubmit)&&!this.vm.submitFeedback?(this.vm.moveToSubmit?this.actualSendMove(this.vm.moveToSubmit):this.vm.dropToSubmit&&this.actualSendMove(this.vm.dropToSubmit),"correspondence"!==this.data.game.speed||m()||c.show({text:"You need to be connected to Internet to send your move.",position:"bottom",duration:"short"}),this.vm.moveToSubmit=null,this.vm.dropToSubmit=null,this.vm.submitFeedback=[this.data.game.turns,performance.now()]):this.cancelMove()},this.onReload=t=>{t.steps=G(t.steps),t.steps.length!==this.data.steps.length&&(this.vm.ply=t.steps[t.steps.length-1].ply),this.chat&&this.chat.onReload(t.chat),this.data.tv&&(t.tv=this.data.tv),this.data.userTV&&(t.userTV=this.data.userTV),this.setData(t),this.makeCorrespondenceClock(),this.clock&&this.data.clock&&this.clock.setClock(this.data,this.data.clock.white,this.data.clock.black),this.lastMoveMillis=void 0,this.replaying()||W.reload(this.draughtsground,this.data,t.game.fen,this.vm.flip,this.plyStep(this.vm.ply)),o()},this.reloadGameData=(t=!1)=>{Promise.all([O(this),h.getVersion()]).then((([e,s])=>{null===s||s>e.player.version?t?d.reload():this.reloadGameData(!0):this.onReload(e)})).catch(d.reload)},this.endWithData=t=>{const e=this.data;e.game.winner=t.winner,e.game.status=t.status,e.game.boosted=t.boosted,e.opponent.offeringDraw=!1,this.userJump(this.lastPly()),this.draughtsground.stop(t.status),this.vm.submitFeedback&&(this.vm.submitFeedback=void 0),t.ratingDiff&&(e.player.ratingDiff=t.ratingDiff[e.player.color],e.opponent.ratingDiff=t.ratingDiff[e.opponent.color]),this.clock&&t.clock&&this.clock.setClock(e,.01*t.clock.wc,.01*t.clock.bc),e.game.turns>1&&(n.dong(),e.player.color===e.game.winner?C.good():C.bad()),this.data.player.spectator||(u.backgroundRefresh(),g(),c.show({text:this.gameStatus(),position:"center",duration:"short"})),this.score},this.toggleBookmark=()=>v(this.data.game.id).then((()=>{this.data.bookmarked=!this.data.bookmarked,o()})).catch(k),this.correspondenceClockTick=()=>{this.correspondenceClock&&A(this.data)&&this.correspondenceClock.tick(this.data.game.player)},this.userMove=(t,e,s)=>{const a=!!s.premove;this.sendMove(t,e,a)},this.onMove=(t,e,s)=>{s?(n.capture(),this.data.player.spectator||C.heavy()):(n.move(),this.data.player.spectator||C.tap())},this.onResume=()=>{this.blur=!0,O(this).then((t=>{h.setVersion(t.player.version),this.onReload(t)}))},l.steps=G(l.steps),this.setData(l),this.data.userTV=w,this.zenModeEnabled=a.game.zenMode(),this.blur=!1,this.vm={ply:this.lastPly(),flip:f,miniUser:{player:{showing:!1,data:null},opponent:{showing:!1,data:null}},clockPosition:a.game.clockPosition()||"right",showCaptured:!!this.data.pref.showCaptured,moveList:a.game.moveList(),showingActions:!1,showingShareActions:!1,confirmResign:!1,confirmDraw:!1,goneBerserk:{[this.data.player.color]:!!this.data.player.berserk,[this.data.opponent.color]:!!this.data.opponent.berserk},moveToSubmit:null,dropToSubmit:null,tClockEl:null,offlineWatcher:!m()},this.socket=new RoundSocket(this,this.onFeatured),this.chat=u.isKidMode()||!u.isConnected()||this.data.tv||!this.data.player.spectator&&(this.data.game.tournamentId||this.data.opponent.ai)?null:new F(this.socket.iface,this.data.game.id,this.data.chat||[],this.data.player.spectator?void 0:this.data.player,u.isConnected()||"friend"===this.data.game.source,u.isShadowban(),"correspondence"===this.data.game.speed?"Corres":"Game"),this.notes="correspondence"===this.data.game.speed?new B(this.data):null,this.draughtsground=W.make(this.data,l.game.fen,this.userMove,this.onMove,this.plyStep(this.vm.ply)),this.clock=this.data.clock?new ClockCtrl(this.data,{onFlag:this.socket.outoftime,soundColor:this.data.player.spectator||!this.data.pref.clockSound?null:this.data.player.color,showTenths:this.data.pref.clockTenths}):null,this.makeCorrespondenceClock(),this.correspondenceClock&&(this.clockIntervId=setInterval(this.correspondenceClockTick,6e3)),this.setupListeners(),b.gameBackButton.add((()=>{0!==d.backbutton.stack.length||D(this.data)||d.backHistory()})),this.transientMove=new TransientMove(this),void 0!==M&&this.jump(M),o()}async setupListeners(){this.appStateListener=await f.addListener("appStateChange",(t=>{t.isActive&&this.onResume()}))}replaying(){return this.vm.ply!==this.lastPly()}firstPly(){return this.data.steps[0].ply}lastPly(){return this.data.steps[this.data.steps.length-1].ply}plyStep(t){return this.data.steps[t-this.firstPly()]}isClockRunning(){return!!this.data.clock&&A(this.data)&&(this.data.game.turns-this.data.game.startedAtTurn>1||this.data.clock.running)}sendMove(t,e,s=!1){const a={u:t+e},i=this.getBlurAndReset();this.data.pref.submitMove&&!s?(d.backbutton.stack.push(this.cancelMove),this.vm.moveToSubmit=a,o()):(this.actualSendMove(a,s,i),"correspondence"!==this.data.game.speed||m()||c.show({text:"You need to be connected to Internet to send your move.",position:"bottom",duration:"short"}))}sendNewPiece(t,e,s){const a={role:t,pos:e},i=this.getBlurAndReset();this.data.pref.submitMove&&!s?setTimeout((()=>{d.backbutton.stack.push(this.cancelMove),this.vm.dropToSubmit=a,o()}),this.data.pref.animationDuration||0):this.actualSendMove(a,s,i)}getBlurAndReset(){return!!this.blur&&(this.blur=!1,!0)}apiMove(t){const a=this.data,i=D(a),r=s(t.fen);if(i&&(this.lastMoveMillis=performance.now()),this.vm.submitFeedback&&(this.vm.submitFeedback[0]+1===t.ply||this.vm.submitFeedback[0]===t.ply&&r)){const t="correspondence"===this.data.game.speed?Math.max(500-(performance.now()-this.vm.submitFeedback[1]),0):0;setTimeout((()=>{this.vm.submitFeedback=void 0,i&&(n.confirmation(),C.tap()),o()}),t)}a.game.turns=t.ply,a.game.player=t.ply%2==0?"white":"black";const h=t.ply%2==0?"black":"white",c="white"===a.player.color?a.player:a.opponent,l="black"===a.player.color?a.player:a.opponent,d=a.player.color===a.game.player,p="frisian"===a.game.variant.key||"frysk"===a.game.variant.key;t.status&&(a.game.status=t.status),t.winner&&(a.game.winner=t.winner);const m=c.offeringDraw,g=l.offeringDraw;if(!m&&t.wDraw&&(n.dong(),C.warn()),!g&&t.bDraw&&(n.dong(),C.warn()),c.offeringDraw=t.wDraw,l.offeringDraw=t.bDraw,a.possibleMoves=d?t.dests:void 0,a.captureLength=t.captLen,!this.replaying()){this.vm.ply=a.game.turns+(r>0?1:0);const s={turnColor:a.game.player,dests:i?S(a.possibleMoves):{},captureLength:a.captureLength,kingMoves:t.fen&&p?y.readKingMoves(t.fen):void 0};if(function(t){return t.isMove}(t)){const a=e(t.uci);this.draughtsground.apiMove(a[0],a[1],{},s,0===r)}else(function(t){return t.isDrop})(t)&&this.draughtsground.apiNewPiece({role:t.role,color:h},w(t.uci),s)}if(this.draughtsground.setLastPromotion(t.promotion?t.promotion.pieceClass:void 0),t.clock){const e=t.clock;if(this.clock){const t=i&&d?0:e.lag||1;this.clock.setClock(a,e.white,e.black,t)}else this.correspondenceClock&&this.correspondenceClock.update(e.white,e.black)}a.game.threefold=!!t.threefold,E(a.steps,{ply:a.game.turns,fen:t.fen,san:t.san,uci:t.uci}),L(a,h,!0),this.data.expiration&&(this.data.steps.length>2?this.data.expiration=void 0:this.data.expiration.movedAt=Date.now()),i&&h===a.player.color&&this.transientMove.clear(),this.replaying()||h===a.player.color||!this.draughtsground.state.premovable.current&&!this.draughtsground.state.predroppable.current||setTimeout((()=>{this.draughtsground.playPremove()}),1),"correspondence"===this.data.game.speed&&u.refresh().then((()=>{"ios"===M.getPlatform()&&T.setNumber({badge:u.myTurnGames().length})}))}gameStatus(){const t=I(this.data,this.data.game.winner);return j.toLabel(this.data.game.status.name,this.data.game.winner,this.data.game.variant.key)+(t?("mate"!==this.data.game.status.name?". ":"")+l("white"===t.color?"whiteIsVictorious":"blackIsVictorious")+".":"")}goBerserk(){this.socket.berserk(),n.berserk()}setBerserk(t){this.vm.goneBerserk[t]||(this.vm.goneBerserk[t]=!0,t!==this.data.player.color&&n.berserk(),o())}unload(){var t;this.transientMove.clear(),this.clock&&this.clock.unload(),clearInterval(this.clockIntervId),null===(t=this.appStateListener)||void 0===t||t.remove(),b.gameBackButton.removeAll()}acceptTakeback(){this.draughtsground.cancelPremove(),this.socket.iface.send("takeback-yes")}makeCorrespondenceClock(){this.data.correspondence&&!this.correspondenceClock&&(this.correspondenceClock=new CorresClockCtrl(this.data.correspondence,this.socket.outoftime))}actualSendMove(t,e=!1,s=!1){var a;const i=e?0:void 0!==this.lastMoveMillis?performance.now()-this.lastMoveMillis:void 0,n={ackable:!0,withLag:!(!this.clock||void 0!==i&&this.isClockRunning()),millis:i,blur:s};null===(a=this.clock)||void 0===a||a.stopClock(),o(),void 0!==t.u?this.socket.iface.send("move",t,n):function(t){return void 0!==t.role}(t)&&this.socket.iface.send("drop",t,n),this.transientMove.register()}setData(t){t.expiration&&(t.expiration.movedAt=Date.now()-t.expiration.idleMillis),this.data=t}}export{OnlineRound as O};
