import{o as e,B as a,v as t,q as s,h as r,G as o,m as n,e as l,d as i,r as c,cf as d,cg as m,ad as u,ao as g,aZ as p,bF as f,a6 as h,p as b,bz as v,b as k,ch as y,s as P,aq as G,aR as N,an as F}from"./main.js";import{l as I}from"./layout-26cca27d.js";import{G as T}from"./GameItem-86ec5af2.js";import{i as x}from"./game-3e605d21.js";function w(l){return e("div",{className:"userGamesWrapper"},e("div",{className:"select_input select_games_filter"},e("label",{htmlFor:"filterGames"}),e("select",{id:"filterGames",onchange:l.onFilterChange},l.scrollState.availableFilters.map((t=>e("option",{value:t.key,selected:l.scrollState.currentFilter===t.key},a(t.label,t.count)))))),function(a){const{games:l,paginator:i}=a.scrollState;return e("div",{id:"scroller-wrapper",className:"native_scroller userGame-scroller box",oncreate:s((e=>function(e,a){var t;const s=function(e){const a=e.target;return"BUTTON"===a.tagName?a:void 0}(a),r=null===(t=a.target)||void 0===t?void 0:t.closest(".tournament"),l=o(a),i=null==l?void 0:l.dataset.id,c=null==l?void 0:l.dataset.pid;if(i&&s)e.toggleBookmark(i);else if(r){const e=r.dataset.id;e&&n.set(`/tournament/${e}`)}else i&&e.goToGame(i,c)}(a,e)),void 0,o),onscroll:r(a.onScroll,30)},i?e("ul",{className:"userGames",oncreate:a.onGamesLoaded},l.map(((t,s)=>e(T,{key:t.id,g:t,index:s,boardTheme:a.boardTheme,userId:a.scrollState.userId}))),a.scrollState.isLoadingNextPage?e("li",{className:"list_item loadingNext"},"loading..."):null):e("div",{className:"loader_container"},t.getVdom("monochrome")))}(l))}const S={all:"nbGames",rated:"nbRated",win:"nbWins",loss:"nbLosses",draw:"nbDraws",bookmark:"nbBookmarks",me:"nbGamesWithYou",import:"nbImportedGames",playing:"nbPlaying"};let j;function B(e,a){let t=!1;const s=j&&e===j.userId,r=l.general.theme.board(),o={userId:e,user:void 0,availableFilters:[],currentFilter:a||"all",games:[],paginator:void 0,isLoadingNextPage:!1,scrollPos:0};function y(e){return e.paginator&&e.paginator.currentPageResults&&e.paginator.currentPageResults.forEach((e=>{e.date=g(new Date(e.timestamp))})),e}const P=i((()=>{j=o}),200),G=e=>{o.paginator=e.paginator,o.games=e.paginator.currentPageResults,setTimeout((()=>{const e=document.getElementById("scroller-wrapper");e&&(e.scrollTop=0)}),50),c()};return s?setTimeout((()=>{Object.assign(o,j),c()}),300):Promise.all([d(o.userId,o.currentFilter,1,!1).then(y),m(o.userId,!1)]).then((([e,a])=>{(e=>{o.user=e;const a=Object.keys(e.count).filter((a=>Object.prototype.hasOwnProperty.call(S,a)&&("all"===a||e.count[a]>0))).map((e=>({key:e,label:S[e],count:o.user?o.user.count[e]:0})));o.availableFilters=a})(a),G(e)})).catch((e=>{u(e)})),{scrollState:o,onScroll:e=>{const a=e.target,t=a.firstChild,s=o.paginator,r=s&&s.nextPage;var n;a.scrollTop+a.offsetHeight+50>t.offsetHeight&&!o.isLoadingNextPage&&r&&r<40&&(n=r,o.isLoadingNextPage=!0,d(o.userId,o.currentFilter,n).then(y).then((e=>{o.paginator=e.paginator,o.isLoadingNextPage=!1,o.games=o.games.concat(e.paginator.currentPageResults),P(),c()})),c()),o.scrollPos=a.scrollTop,P()},onGamesLoaded:({dom:e})=>{s&&!t&&p((()=>{e.parentNode.scrollTop=j.scrollPos,t=!0}))},onFilterChange:e=>{o.currentFilter=e.target.value,d(o.userId,o.currentFilter,1,!0).then(y).then(G)},toggleBookmark:e=>{f(e).then((()=>{const a=o.games.findIndex((a=>a.id===e)),t=o.games[a];if(t){const e=Object.assign({},t,{bookmarked:!t.bookmarked});o.games[a]=e,c()}})).catch(u)},boardTheme:r,goToGame:(a,t)=>{const s=o.games.find((e=>e.id===a));if(s){if(!x(s.variant.key))return void h.show({text:b("unsupportedVariant",s.variant.name),position:"center",duration:"short"});const r=s.players.white.user,o=r&&r.id===e?"white":"black";v.set(s.id,{fen:s.fen,orientation:o,variant:s.variant.key});k.getUserId()===e&&void 0!==t?n.set(`/game/${a}${t}?goingBack=1`):n.set(`/analyse/online/${a}/${o}?curFen=${s.fen}&variant=${s.variant.key}&slide=1`)}}}}const L={oncreate:y,oninit(e){P.createDefault(),this.ctrl=B(e.attrs.id,e.attrs.filter)},view(e){const{id:a,username:t,title:s,patron:r}=e.attrs,o=this.ctrl.scrollState.user,n=o?G(o.online,o.patron,o.username,o.title):G(void 0,Boolean(r),t||a,s),l=N(null,F(n));return I.free(l,w(this.ctrl))}};export{L as default};
