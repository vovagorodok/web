import{a7 as t,e,o as a,a8 as i,p as n,z as s,m as o,aJ as r,aw as l,a9 as h,ag as p,aN as u,M as d,aO as c,r as v,b6 as m,aI as g,aL as f,bp as y,aM as b,aS as M,bq as w,s as N,aP as j,I as x,aQ as k,aR as O,u as F}from"./main.js";import{a as G,b as T}from"./offlineGames-b5d74ab7.js";import{l as S}from"./layout-26cca27d.js";import{v as L}from"./roundView-c826907d.js";import{G as A}from"./GameTitle-898aeee2.js";import{B as P}from"./Board-25b97c43.js";import{r as _,a as C,b as E,e as R,f as D,k as I,c as V,s as $,R as B,g as q,d as z}from"./view-05bee3e3.js";import{d as H,g as J}from"./game-3e605d21.js";import{S as Q}from"./index-28ac80d9.js";import{i as U}from"./draughts-5f7918a7.js";import{v as W}from"./vibrate-985a16e3.js";import"./CountdownTimer-ca9a10d1.js";import"./tournamentXhr-d3fb9e28.js";import"./notes-2c1d8afe.js";import"./chat-1f5c68bb.js";function X(){const t=e.ai.availableOpponents.map((t=>["aiNameLevelAiLevel",t[1],t[0],t[1]]));return a("div.select_input",i.renderSelect("opponent","opponent",t,e.ai.opponent))}var K={controller:function(t){let e=!1;function a(t){"backbutton"!==t&&e&&o.backbutton.stack.pop(),e=!1}return{open:function(){o.backbutton.stack.push(a),e=!0},close:a,isOpen:()=>e,root:t}},view:e=>t("offline_actions",void 0,(()=>[_(e.root)].concat(C(e.root),E(e.root),function(t){return H(t.data)?a("button[data-icon=b]",{oncreate:s((()=>{t.actions.close(),t.resign()}))},n("resign")):null}(e.root),function(t){return[a("button[data-icon=A]",{oncreate:s(t.goToAnalysis)},n("analysis")),a("div.action.opponentSelector",[X()])]}(e.root))),e.isOpen(),e.close)};const Y=[["white","white"],["black","black"],["randomColor","random"]];var Z={controller(t){const e=p(!1);function a(t){"backbutton"!==t&&!0===e()&&o.backbutton.stack.pop(),e(!1)}return{open:function(){o.backbutton.stack.push(a),e(!0)},close:a,isOpen:e,root:t}},view:p=>p.isOpen()?t("new_offline_game",void 0,(function(){const t=e.ai.availableVariants,u=p.root.vm.setupFen?t.filter((t=>!r.has(t[1]))):t,d=e.ai.variant(),c=p.root.vm.setupFen&&r.has(d),v=e.ai.color(),m="random"!==v?v:"white";return a("div",null,a("p",{className:"title"},n("createAGame")),a("div",{className:"action"},X(),a("div",{className:"select_input"},i.renderSelect("side","color",Y,e.ai.color)),c?a("div",{className:"select_input disabled"},a("label",{for:"variant"},n("variant")),a("select",{disabled:!0,id:"variant"},a("option",{value:d,selected:!0},l(d).name))):a("div",{className:"select_input"},i.renderSelect("variant","variant",u,e.ai.variant)),p.root.vm.setupFen?a("div",{className:"from_position_wrapper"},a("p",null,n("fromPosition")),a("div",{className:"from_position"},a("div",{style:{width:"130px",height:"130px"},oncreate:s((()=>{p.root.vm.setupFen&&o.set(`/editor/${encodeURIComponent(p.root.vm.setupFen)}`)}))},a(h,{fen:p.root.vm.setupFen,variant:d,orientation:m})))):null),a("div",{className:"popupActionWrapper"},a("button",{className:"defaultButton",oncreate:s((()=>{p.root.startNewGame(e.ai.variant(),p.root.vm.setupFen)}))},n("play"))))}),p.isOpen(),(()=>{p.root.vm.setupFen&&o.set("/ai"),p.close()})):null};class AiRound{constructor(t,a,i,n){if(this.goToAnalysis=()=>{this.replay&&o.set(`/analyse/offline/ai/${this.data.player.color}?ply=${this.replay.ply}&curFen=${this.replay.situation().fen}`)},this.sharePDN=()=>{var t;null===(t=this.replay)||void 0===t||t.pdn(this.white(),this.black()).then((t=>Q.share({text:t.pdn})))},this.playerName=()=>this.data.player.username,this.onEngineMove=t=>{var e;let a=t.indexOf("-");-1===a&&(a=t.indexOf("x"));const i=t.indexOf("x",a+1),n=t.slice(0,a),s=t.slice(a+1,-1===i?t.length:i),o=1===n.length?"0"+n:n,r=1===s.length?"0"+s:s;this.vm.engineSearching=!1,this.draughtsground.apiMove(o,r),null===(e=this.replay)||void 0===e||e.addMove(o,r),v(),this.engineNextMove=-1!==i?setTimeout((()=>this.onEngineMove(t.slice(a+1))),600):void 0},this.engineMove=()=>{this.vm.engineSearching=!0;const t=this.replay.situation(),e=this.replay.lastCaptureFen();setTimeout((()=>{const a=this.getOpponent().level;this.data.opponent.name=m({ai:a});let i=[];for(let e=0;e<t.pdnMoves.length;e++)-1!==t.pdnMoves[e].indexOf("x")?i=[]:i.push(t.uciMoves[e]);this.engine.init().then((()=>this.engine.search(a,e||this.data.game.initialFen,t.fen,i)))}),500)},this.isEngineToMove=()=>{const t=this.replay.situation();return!t.end&&t.player!==this.data.player.color},this.userMove=(t,e)=>{var a;null===(a=this.replay)||void 0===a||a.addMove(t,e)},this.onMove=(t,e,a)=>{a?g.capture():g.move(),W.tap()},this.onReplayAdded=t=>{this.data.game.fen=t.fen,this.apply(t),$(this,t.status),J.finished(this.data)?this.onGameEnd(t.status):!this.engineNextMove&&this.isEngineToMove()&&this.engineMove(),this.save(),v()},this.onThreefoldRepetition=t=>{$(this,t),this.save(),this.onGameEnd(t)},this.onGameEnd=t=>{this.engineNextMove&&(clearTimeout(this.engineNextMove),this.engineNextMove=void 0),this.draughtsground.stop(t),setTimeout((()=>{this.actions.open(),v()}),500)},this.resign=()=>{const t={id:31,name:"resign"};$(this,t,f(this.data.player.color)),this.save(),this.onGameEnd(t)},this.firstPly=()=>this.data.player.color===f(this.firstPlayerColor())?1:0,this.lastPly=()=>this.replay.situations.length-1,this.jump=(t,e)=>(this.draughtsground.cancelMove(),this.replay.ply===t||t<0||t>=this.replay.situations.length||(this.replay.ply=t,this.apply(this.replay.situation(),e)),!1),this.jumpFirst=()=>this.jump(this.firstPly(),"undo"),this.jumpPrev=()=>{const t=this.replay.ply;if(this.data.player.color===f(this.firstPlayerColor())){const e=t%2==0?1:2;return this.jump(t-e,"undo")}{const e=t%2==0?2:1;return this.jump(t-e,"undo")}},this.jumpNext=()=>{const t=this.replay.ply;return this.jump(t+(t+2>=this.replay.situations.length?1:2),"redo")},this.jumpLast=()=>this.jump(this.lastPly(),"redo"),this.canDrop=()=>!0,this.actions=K.controller(this),this.newGameMenu=Z.controller(this),this.moveList=!!e.game.moveList(),this.vm={engineSearching:!1,setupFen:a,setupVariant:i,savedFen:t?t.data.game.fen:void 0,savedVariant:t?t.data.game.variant.key:void 0},a)this.newGameMenu.isOpen(!0),n&&e.ai.color(n),i&&e.ai.variant(i),v();else{const a=e.ai.variant();if(t)try{this.init(t.data,t.situations,t.ply)}catch(t){this.startNewGame(a)}else this.startNewGame(a)}}init(t,e,a){this.newGameMenu.close(),this.actions.close(),this.data=t;const i=this.data.game.variant.key,n=this.data.game.initialFen;this.replay?this.replay.init(i,n,e,a):this.replay=new B(i,n,e,a,this.onReplayAdded,this.onThreefoldRepetition),this.draughtsground?q.reload(this.draughtsground,this.data,this.replay.situation()):this.draughtsground=q.make(this.data,this.replay.situation(),this.userMove,this.onMove),this.engine&&this.engine.variant===i?this.engine.newGame().then((()=>{this.isEngineToMove()&&this.engineMove()})):(this.engine&&(this.engine.exit(),this.engine=void 0),this.engine=new y(this,i),this.engine.init().then((()=>{this.isEngineToMove()&&this.engineMove()}))),this.save(),v()}startNewGame(t,e,a,i){this.engineNextMove&&(clearTimeout(this.engineNextMove),this.engineNextMove=void 0);const n={variant:t};e&&(n.fen=e),U(n).then((t=>{this.init(z({id:"offline_ai",variant:t.variant,initialFen:t.setup.fen,fen:t.setup.fen,color:i||tt(),player:t.setup.player,captureLength:t.setup.captureLength||0}),[t.setup],t.setup.ply)})).then((()=>{e&&(this.vm.setupFen=void 0,o.History.replaceState(void 0,"/ai"))}))}save(){this.replay&&G({data:this.data,situations:this.replay.situations,ply:this.replay.ply})}white(){return"white"===this.data.player.color?this.data.player.username:this.getOpponent().name}black(){return"black"===this.data.player.color?this.data.player.username:this.getOpponent().name}getOpponent(){const t=e.ai.opponent(),a=e.ai.availableOpponents.find((e=>e[1]===t)),i=a&&a.length&&a[0]||"Scan";return{name:n("aiNameLevelAiLevel",i,t),level:parseInt(t)||1}}player(){return this.data.player.color}apply(t,e){if(t){const a=t.uciMoves.length?t.uciMoves[t.uciMoves.length-1]:null;this.draughtsground.set({fen:t.fen,turnColor:t.player,lastMove:a?b(a):null,dests:t.dests,captureLength:t.captureLength||0,movableColor:t.player===this.data.player.color?t.player:null,shift:e})}}firstPlayerColor(){return M(this.data.game.initialFen)}}function tt(){let t=e.ai.color();return"random"===t&&(t=w(0,2)>1?"white":"black"),t}var et={oninit({attrs:t}){N.createDefault(),T().then((e=>{const a=t.fen,i=t.variant,n=t.color;this.round=new AiRound(e,a,i,n)})),j()},oncreate:x,onremove(){var t;k(),this.round&&(null===(t=this.round.engine)||void 0===t||t.exit())},view({attrs:t}){let e,i;if(this.round&&this.round.data&&this.round.draughtsground&&this.round.engine)i=O(a(A,{data:this.round.data})),e=function(t){const e=t.draughtsground.getMaterialDiff(),i=u(),n=d(),s=a("h2",null,t.getOpponent().name,t.vm.engineSearching?a("span",{className:"engineSpinner fa fa-hourglass-half"}):null),o=a(P,{variant:t.data.game.variant.key,draughtsground:t.draughtsground});return i?[c(n,i)?R(t):null,D(t,s,e[t.data.opponent.color],"opponent"),o,D(t,t.playerName(),e[t.data.player.color],"player"),I(t)]:[o,a("section",{className:"table offline"},D(t,s,e[t.data.opponent.color],"opponent"),V(t),I(t),D(t,t.playerName(),e[t.data.player.color],"player"))]}(this.round);else{const a=t.fen||F,s=t.variant||"standard",o=M(a);i=O(n("playOfflineComputer")),e=L(a,o,s,void 0)}return S.board(i,e,void 0,this.round&&(s=this.round,[K.view(s.actions),Z.view(s.newGameMenu)]));var s}};export{et as default};
