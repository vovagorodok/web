import{bk as t,e,ba as a,bl as i,aM as n,bm as s,b as o,p as r,bn as l,aK as c,aL as u,aY as d,a6 as p,o as h,z as f,q as m,a_ as g,aX as v,ai as b,au as y}from"./main.js";import{o as M,g as k,l as _,d as w,q as N}from"./game-3e605d21.js";import{m as P,d as S,t as T,p as x}from"./draughts-5f7918a7.js";import{r as A,a as D,b as C,g as j,o as F}from"./roundView-c826907d.js";function L(t,o){const r=o.uciMoves.length?o.uciMoves[o.uciMoves.length-1]:null,l=e.game.pieceMove(),c=a(t.game.variant.key);return{variant:t.game.variant.key,fen:o.fen,boardSize:c.size,orientation:i(t),turnColor:o.player,lastMove:r?n(r):null,captureLength:t.captureLength||o.captureLength,otb:"offline_otb"===t.game.id,coordinates:e.game.coords(),coordSystem:1===e.game.coordSystem()&&"64"===c.key?1:0,otbMode:e.otb.flipPieces()?"flip":e.otb.mirrorPieces()?"facing":"none",highlight:{lastMove:e.game.highlights(),kingMoves:e.game.kingMoves()},movable:{free:!1,color:M(t)?o.player:null,showDests:e.game.pieceDestinations(),variant:t.game.variant.key,dests:o.dests},animation:{enabled:!!e.game.animations(),duration:s(e.game.animations())},premovable:{enabled:!1},draggable:{enabled:"drag"===l||"both"===l,centerPiece:t.pref.centerPiece,distance:3,magnified:e.game.magnified()},selectable:{enabled:"tap"===l||"both"===l}}}var R={make:function(e,a,i,n){const s=L(e,a);return s.movable.events={after:i},s.events={move:n},new t(s)},reload:function(t,e,a){t.reconfigure(L(e,a))},promote:function(t,e){const a={},i=t.state.pieces[e];i&&"man"===i.role&&(a[e]={color:i.color,role:"king"},t.setPieces(a))},end:function(t){t.stop()},changeOTBMode:function(t,e,a){t.setOtbMode(e?"flip":a?"facing":"none")}};function O(t){const a=t.color||"white",i={color:a,username:"offline_ai"===t.id?o.appUser(r(a)):r(a),spectator:!1},n=t.variant||l("standard"),d=c(n.key);return{game:{id:t.id,offline:!0,variant:n,initialFen:t.initialFen||d,source:"offline",fen:t.fen||d,player:t.player||"white",turns:0,startedAtTurn:0,status:{id:20,name:"created"},speed:"unlimited",createdAt:Date.now()},player:i,opponent:{color:u(a),username:r(u(a))},pref:{animationDuration:s(e.game.animations()),centerPiece:t.pref&&t.pref.centerPiece||!1},steps:[],captureLength:t.captureLength,offlineClock:t.clock}}function U(t,e,a){var i;const n=null===(i=t.replay)||void 0===i?void 0:i.situation();t.data.game.status=e||{id:20,name:"started"},t.data.game.winner=a||(null==n?void 0:n.winner)}class Replay{constructor(t,i,n,s,o,l){this.situation=()=>{let t=this.situations.length-1;for(;t>=0&&this.displayPly(this.situations[t])!==this.ply;)t--;return this.situations[t]},this.isAlgebraic=()=>1===e.game.coordSystem()&&"64"===a(this.variant).key,this.coordSystem=()=>this.isAlgebraic()?1:0,this.displayPly=t=>d(t.fen)?t.ply+1:t.ply,this.lastCaptureFen=()=>{for(let t=this.situations.length-1;t>=0;t--){const e=this.situations[t].pdnMoves;if(e.length&&-1!==e[e.length-1].indexOf("x"))return this.situations[t].fen}},this.addMove=(t,e)=>{const a=this.situation(),i="russian"!==a.variant&&"brazilian"!==a.variant||!a.kingMoves?void 0:a.kingMoves;P({variant:this.variant,fen:a.fen,pdnMoves:a.pdnMoves,uciMoves:a.uciMoves,orig:t,dest:e,kingmovesWhite:i&&i.white,kingmovesBlack:i&&i.black}).then(this.addMoveOrDrop).catch(console.error.bind(console))},this.addDrop=(t,e)=>{const a=this.situation();S({variant:this.variant,fen:a.fen,pdnMoves:a.pdnMoves,uciMoves:a.uciMoves,role:t,pos:e}).then(this.addMoveOrDrop).catch(console.error.bind(console))},this.claimDraw=()=>{const t=this.situation();T({variant:this.variant,initialFen:this.initialFen,pdnMoves:t.pdnMoves,finalSquare:!0}).then((t=>{t.threefoldRepetition?this.onThreefoldRepetition(t.status):p.show({text:r("incorrectThreefoldClaim"),position:"center",duration:"short"})})).catch(console.error.bind(console))},this.pdn=(t,e)=>{const a=this.situation();return x({variant:this.variant,algebraic:this.isAlgebraic(),initialFen:this.initialFen,pdnMoves:a.pdnMoves,finalSquare:!0,white:t,black:e})},this.addMoveOrDrop=t=>{this.ply=this.displayPly(t.situation);const e=this.situations[this.situations.length-1];if(this.situations.length&&this.ply<=this.displayPly(e)){if(d(e.fen)){const a=e.uci,i=e.san;if(t.situation.uci&&a&&a.slice(a.length-2)===t.situation.uci.slice(0,2)&&(t.situation.uci=a.slice(0,a.length-2)+t.situation.uci,t.situation.id=e.id.slice(0,1)+t.situation.id.slice(1),t.situation.uciMoves=t.situation.uciMoves.slice(0,t.situation.uciMoves.length-2).concat(t.situation.uci)),t.situation.san&&i){const e=i.indexOf("x"),a=t.situation.san.indexOf("x");-1!==e&&-1!==a&&i.slice(e+1)===t.situation.san.slice(0,a)&&(t.situation.san=i.slice(0,e)+t.situation.san.slice(a),t.situation.pdnMoves=t.situation.pdnMoves.slice(0,t.situation.pdnMoves.length-2).concat(t.situation.san))}}let a=1;for(;this.ply<this.situations[this.situations.length-a].ply;)a++;this.situations=this.situations.slice(0,this.situations.length-a)}this.situations.push(t.situation),this.onReplayAdded(this.situation())},this.init(t,i,n,s),this.onReplayAdded=o,this.onThreefoldRepetition=l}init(t,e,a,i){this.variant=t,this.initialFen=e,this.situations=a,this.ply=i||0}}function z(t,e,a,i,n,s,o){const r=("player"===i?t.data.player:t.data.opponent).color,l=["playTable","offline",i,void 0!==n?n?"mode_flip":s?"mode_facing":"":"",t.draughtsground.state.turnColor===t.data.player.color?"player_turn":"opponent_turn"].join(" ");return h("section",{id:i+"_info",className:l},h("div",{className:"antagonistInfos offline"},h("div",{className:"antagonistUser"},e),h("div",{className:"ratingAndMaterial"},A(a))),o?function(t,e){const a=t.activeSide(),i=t.getTime(e),n=a===e,s="stage"===t.clockType?t.getMoves(e):null;return h("div",{className:b({clock:!0,outoftime:!i,running:n,offlineClock:!0,stageClock:!!s})},[et(i,n),s?h("div.clockMoves","Moves: "+s):null])}(o,r):null)}function q(t){return h("section",{className:"actions_bar"},h("button",{className:"action_bar_button fa fa-list",oncreate:f(t.actions.open)}),h("button",{className:"action_bar_button fa fa-plus-circle",oncreate:f(t.newGameMenu.open,(()=>p.show({text:r("createAGame"),duration:"short",position:"bottom"})))}),h("button",{className:"fa fa-share-alt action_bar_button",oncreate:f(t.sharePDN,(()=>p.show({text:r("sharePDN"),duration:"short",position:"bottom"})))}),h("button",{className:"action_bar_button","data-icon":"A",oncreate:f(t.goToAnalysis)}),K(t),X(t),E(t))}function G(t){if(!t.replay)return null;if(k.finished(t.data)){const e=_(t.data),a=t.data.game.winner,i=k.toLabel(t.data.game.status.name,t.data.game.winner,t.data.game.variant.key)+(a?("mate"!==t.data.game.status.name?". ":"")+r("white"===a?"whiteIsVictorious":"blackIsVictorious")+".":"");return h("div",{className:"result"},e,h("br",null),h("em",{className:"resultStatus"},i))}return null}function I(t){return w(t.data)&&N(t.data)?h("button[data-icon=2].draw-yes",{oncreate:f((()=>{var e;return null===(e=t.replay)||void 0===e?void 0:e.claimDraw()}))},r("threefoldRepetition")):null}function V(t){return k.finished(t.data)?[h("div",[h("button",{oncreate:f((()=>{t.actions.close(),t.newGameMenu.open()}))},[h("span.fa.fa-plus-circle"),r("createAGame")])])]:null}function B(t){return t.replay?h("div.replay.box",{oncreate:e=>{setTimeout((()=>D(e.dom)),100),m((e=>F(t,e)),void 0,j)(e)},onupdate:t=>D(t.dom)},J(t.replay)):null}function H(t){return t.replay&&t.moveList?h("div.replay_inline",{oncreate:e=>{setTimeout((()=>C(e.dom)),100),g((e=>F(t,e)),void 0,j)(e)},onupdate:t=>C(t.dom)},J(t.replay)):null}function K(t){const e=t.draughtsground.state.peripheral,a=!e.isSynchronized&&e.isSettable;return v.features().setState?h("button.action_bar_button.fa.fa-magic",{oncreate:f(v.onCentralSetState),className:b({disabled:!a})}):null}function W(t){return t.replay&&t.replay.ply>t.firstPly()}function X(t){return t.replay?h("button.action_bar_button.fa.fa-chevron-left",{oncreate:f((()=>{W(t)&&t.jumpPrev()}),(()=>{W(t)&&t.jumpFirst()})),className:b({disabled:!W(t)})}):null}function Y(t){return t.replay&&t.replay.ply<t.lastPly()}function E(t){return t.replay?h("button.action_bar_button.fa.fa-chevron-right",{oncreate:f((()=>{Y(t)&&t.jumpNext()}),(()=>{Y(t)&&t.jumpLast()})),className:b({disabled:!Y(t)})}):null}function J(t){return t.situations.filter((t=>void 0!==t.san)).map((e=>{return h("move.replayMove",{className:e.ply===t.ply?"current":"","data-ply":e.ply},[1&e.ply?h("index",(a=e.ply,i=!0,h("index",Q(a,i)))):null,t.isAlgebraic()?y(e.san):e.san]);var a,i}))}function Q(t,e){return function(t){return Math.floor((t-1)/2)+1}(t)+(e?t%2==1?".":"...":"")}function Z(t){return(t<10?"0":"")+t}const $=":",tt=" ";function et(t,e=!1){const a=new Date(t),i=a.getUTCMilliseconds(),n=Z(a.getUTCMinutes()),s=Z(a.getUTCSeconds());if(t>=36e5){return Z(a.getUTCHours())+(e&&i<500?tt:$)+n}if(t<1e4){const t=Math.floor(i/100).toString();return[n+$+s,h("tenths","."+t)]}return n+$+s}export{Replay as R,I as a,V as b,B as c,O as d,H as e,z as f,R as g,E as h,X as i,K as j,q as k,G as r,U as s};
