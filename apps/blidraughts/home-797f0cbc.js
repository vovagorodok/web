import{f as e,d as t,r as a,i as n,s as i,l as s,a as r,g as o,b as l,n as c,t as d,Z as u,c as h,e as m,h as f,j as p,k as v,N as g,A as b,m as y,o as w,p as k,q as _,u as z,v as T,w as C,x as P,y as S,z as N,B as G,C as L,D as M,E as x,F as I,G as O,H as j,I as D,J as B,K as F}from"./main.js";import{p as W,l as A}from"./layout-26cca27d.js";import{makeTimeline as V,renderTimelineEntry as E,timelineOnTap as R}from"./timeline-1fba8e10.js";import{l as $,d as q}from"./offlineService-1e2a3008.js";import{f as H}from"./game-3e605d21.js";import{M as Y}from"./miniBoard-94d39b51.js";import{T as K,a as U}from"./TabView-6f41acb9.js";import{r as J}from"./tournamentsListView-8232f8ea.js";import"./CountdownTimer-ca9a10d1.js";import"./tournamentXhr-d3fb9e28.js";class HomeCtrl{constructor(g){this.isScrolling=!1,this.afterScroll=t((()=>{this.isScrolling=!1,a()}),200),this.onScroll=()=>{this.isScrolling=!0,this.afterScroll()},this.redrawIfNotScrolling=()=>{this.isScrolling||a()},this.socketSend=(e,t)=>{this.socket&&this.socket.send(e,t)},this.unload=()=>{var e,t;null===(e=this.networkListener)||void 0===e||e.remove(),null===(t=this.appStateListener)||void 0===t||t.remove()},this.init=()=>{var t;if(n()){this.socket=i.createLobby("homeLobby",(()=>{this.reloadCorresPool(),this.getFeatured()}),{redirect:i.redirectToGame,reload_seeks:this.reloadCorresPool,resync:()=>s().then((e=>{i.setVersion(e.lobby.version)})),n:(e,t)=>{r.homePong.dispatch(t)},featured:()=>{this.getFeatured()},fen:e=>{this.featuredGame&&this.featuredGame.id===e.id&&(this.featuredGame.fen=e.fen,this.featuredGame.lastMove=e.lm,this.featuredGame.c={black:e.bc,white:e.wc},a())},finish:e=>{this.featuredGame&&this.featuredGame.id===e.id&&(this.featuredGame.finished=!0,"b"===e.win?this.featuredGame.winner="black":"w"===e.win&&(this.featuredGame.winner="white"),a())}});const n=o("/tournament/featured");n&&(this.featuredTournaments=n.data.featured);const u=o("/timeline");u&&(this.timelineData=V(u.data)),Promise.all([e(30,"/tournament/featured",void 0),null===(t=l.refresh())||void 0===t?void 0:t.then((()=>l.isKidMode()||!l.isConnected()?Promise.resolve([]):e(15,"/api/streamer/featured",void 0)))]).then((e=>{const[t,n]=e;this.featuredTournaments=t.featured,this.featuredStreamers=n,a()})).catch(c),e(60,"/training/daily",void 0).then((e=>{this.dailyPuzzle=e,a()})).catch(c),(!u||Date.now()>=u.expires)&&d(8,!0).then((e=>{this.timelineData=V(e),a()})).catch((()=>{this.timelineData={entries:[],users:{}}}))}},this.loadOfflinePuzzle=()=>{const e=l.get();e&&$(q,e,e.prefs.puzzleVariant||"standard").then((e=>{this.offlinePuzzle=e,a()}))},this.onTabChange=e=>{const t=window.location.search.replace(/\?tab=\w+$/,"");try{window.history.replaceState(window.history.state,"",t+"?tab="+e)}catch(e){}this.selectedTab=e,1===this.selectedTab&&this.reloadCorresPool(),a()},this.cancelCorresSeek=e=>{const t=document.getElementById(e);t&&u(t,"opacity","0",300,"ease-out").then((()=>this.socketSend("cancelSeek",e))).catch(console.log.bind(console))},this.joinCorresSeek=e=>{this.socketSend("joinSeek",e)},this.reloadCorresPool=()=>{1===this.selectedTab&&h(!1).then((e=>{this.corresPool=function(e){const t=l.getUserId();t&&e.sort(((e,a)=>X(e)===t?-1:X(a)===t?1:0));return[...e.map((e=>[e,(X(e)===t?e.id:e.username)+e.mode+e.perf.key+e.days+e.color])).filter((([e,t],a,n)=>n.map((e=>e[1])).indexOf(t)===a)).map((([e])=>e))]}(e).filter((e=>m.game.supportedVariants.includes(e.variant.key))).sort(((e,t)=>e.rating>t.rating?-1:1)),this.redrawIfNotScrolling()}))},this.getFeatured=f((()=>{p("best",!1).then((e=>{const t=Z(e.opponent),a=Z(e.player);this.featuredGame={c:e.clock?{white:Math.round(e.clock.white),black:Math.round(e.clock.black)}:void 0,black:"white"===e.game.player?t:a,orientation:e.orientation,fen:e.game.fen,variant:e.game.variant.key,id:e.game.id,lastMove:e.game.lastMove,white:"white"===e.game.player?a:t,finished:H(e.game.status)},this.featuredGame.finished&&(this.featuredGame.winner=e.game.winner),this.socketSend("startWatching",e.game.id),this.redrawIfNotScrolling()}))}),1e3),this.corresPool=[],this.selectedTab=g||0,this.isConnected=v(),this.isConnected?this.init():this.loadOfflinePuzzle(),this.setupListeners(),r.afterLogin.add(this.init),r.afterLogout.add(this.init)}async setupListeners(){this.networkListener=await g.addListener("networkStatusChange",(e=>{e.connected!==this.isConnected&&(this.isConnected=e.connected,e.connected&&this.init())})),this.appStateListener=await b.addListener("appStateChange",(e=>{e.isActive&&this.init()}))}}function X(e){return e.username.toLowerCase()}function Z(e){var t,a;return{name:(null===(t=e.user)||void 0===t?void 0:t.displayName)||e.name||e.username||(null===(a=e.user)||void 0===a?void 0:a.username)||"",rating:e.rating||0,ratingDiff:e.ratingDiff||0,berserk:e.berserk,title:e.user&&e.user.title}}function Q(e){return v()?function(e){var t;const a=null===(t=l.get())||void 0===t?void 0:t.playban,n=a&&new Date(a.date+6e4*a.mins);return w("div",{className:"home"},n&&(n.valueOf()-Date.now())/1e3>1?(i=n,w("div",{className:"home-playbanInfo"},w("h2",null,k("sorry")),w("p",null,k("weHadToTimeYouOutForAWhile")),w("br",null),w("p",null,w.trust(k("timeoutExpires",`<strong>${C(i)}</strong>`))),w("h2",null,k("why")),w("p",null,k("pleasantDraughtsExperience"),w("br",null),k("goodPractice"),w("br",null),k("potentialProblem")),w("h2",null,k("howToAvoidThis")),w("ul",null,w("li",null,k("playEveryGame")),w("li",null,k("tryToWin")),w("li",null,k("resignLostGames"))),w("br",null),w("p",null,k("temporaryInconvenience"),w("br",null),k("wishYouGreatGames"),w("br",null),k("thankYouForReading")))):function(e){const t=[{id:"quick",f:()=>S((()=>M.openRealTime("custom")))},{id:"corres",f:()=>function(e){return w("div.corresPoolWrapper.native_scroller",[w("table.corres_seeks",[w("thead",[w("tr",[w("th",""),w("th",k("player")),w("th",k("rating")),w("th",k("time")),w("th",k("mode"))])]),w("tbody",e.corresPool.map((t=>function(e,t){const a=t.username.toLowerCase()===l.getUserId()?"cancelCorresSeek":"joinCorresSeek",n=""===t.color?"random":"white"===t.color?"white":"black";return w("tr",{key:"seek"+t.id,id:t.id,className:"corres_seek "+a,oncreate:_((()=>e[a](t.id)))},[w("td",w("span.color-icon."+n)),w("td",t.username),w("td",t.rating+(t.provisional?"?":"")),w("td",t.days?G("nbDays",t.days):"∞"),w("td",w("span.withIcon",{"data-icon":L(t.perf.key)},k(1===t.mode?"rated":"casual")))])}(e,t))))]),w("div.corres_create",[w("button.defaultButton",{oncreate:N(M.openCorrespondence)},k("createAGame"))])])}(e)}];return w("div.home__lobby",[w(K,{buttons:[{label:k("quickPairing")},{label:k("correspondence")}],selectedIndex:e.selectedTab,onTabChange:e.onTabChange,wrapperClass:"homeSetup",withBottomBorder:!0}),w(U,{selectedIndex:e.selectedTab,tabs:t,onTabChange:e.onTabChange,className:"home__setupTabView"})])}(e),function(e){return w("div",{className:"home__start"},w("div",{className:"home__buttons"},w("button",{className:"buttonMetal",oncreate:_((()=>M.openRealTime("custom")))},k("createAGame")),w("button",{className:"buttonMetal",oncreate:_((()=>x.open()))},k("playWithAFriend")),w("button",{className:"buttonMetal",oncreate:_(W.open)},k("playWithTheMachine"))),w(ee,{ctrl:e}))}(e),w("div",{className:"home__side"},function(e){var t;return(null===(t=e.featuredStreamers)||void 0===t?void 0:t.length)?w("ul.home__streamers",e.featuredStreamers.map((e=>{const t=e.user.title||"",a=t.endsWith("-64")?t.slice(0,t.length-3):t;return w("li.home__streamer",{oncreate:_((()=>I(e.url)))},[w("strong[data-icon=]",(a?a+" ":"")+e.user.name),w("span.status"," "+e.status)])}))):null}(e),function(e){var t;return(null===(t=e.featuredTournaments)||void 0===t?void 0:t.length)?w("div",{className:"home__tournament"},J(e.featuredTournaments)):null}(e),function(e){const t=e.timelineData;if(void 0===t)return w("section",{className:"home__timeline loading"},T.getVdom("monochrome"));if(0===t.entries.length)return w("section",{className:"home__timeline"});return w("section",{className:"home__timeline"},w("ul",{oncreate:_(R,void 0,O)},t.entries.map((e=>E(e,t.users)))),w("div",{className:"more"},w("button",{oncreate:_((()=>y.set("/timeline")))},k("more")," »")))}(e)),function(e){const t=e.featuredGame,a=t?{fixed:!1,fen:t.fen,variant:t.variant,orientation:t.orientation,lastMove:t.lastMove,link:()=>{m.tv.channel("best"),y.set("/tv")},gameObj:t}:{fixed:!1,orientation:"white",fen:z,variant:"standard"};return w("section",{className:"home__featured"},w(Y,a))}(e),function(e){const t=e.dailyPuzzle,a=t&&(t.history?t.history:t.puzzle);a&&t&&t.puzzle&&(a.id=t.puzzle.id,a.color=t.puzzle.color,a.variant=t.puzzle.variant);const n=a?{fixed:!0,fen:a.fen,variant:a.variant.key,orientation:a.color,lastMove:a.uci,link:()=>y.set(`/training/${a.id}?initFen=${a.fen}&initColor=${a.color}`),topText:k("puzzleOfTheDay"),bottomText:"white"===a.color?k("whitePlays"):k("blackPlays")}:{fixed:!0,orientation:"white",fen:z,variant:"standard"};return w("section",{className:"home__miniPuzzle"},w(Y,n))}(e));var i}(e):function(e){const t=e.offlinePuzzle,a=t?{fixed:!0,fen:t.puzzle.fen,variant:t.puzzle.variant.key,orientation:t.puzzle.color,link:()=>y.set("/training")}:null;return w("div",{className:"homeOfflineWrapper"+(a?" withBoard":"")},w("div",{className:"home homeOffline"},w("section",{className:"playOffline"},w("h2",null,k("playOffline")),w("button",{className:"fatButton",oncreate:_((()=>y.set("/ai")))},k("playOfflineComputer")),w("button",{className:"fatButton",oncreate:_((()=>y.set("/otb")))},k("playOfflineOverTheBoard"))),a?w("section",{className:"home__miniPuzzle"},w("h2",{className:"homeTitle"},k("training")),w(Y,a)):void 0))}(e)}const ee={oncreate({attrs:e}){const t=te(e.ctrl,"#nb_games_in_play > strong",8,i.getCurrentPingInterval),a=te(e.ctrl,"#nb_connected_players > strong",10,i.getCurrentPingInterval);this.render=e=>{a(e.d),setTimeout((()=>{t(e.r)}),i.getCurrentPingInterval()/2)},r.homePong.add(this.render)},onremove(){r.homePong.remove(this.render)},view:()=>w("div.home__stats",[w("div#nb_connected_players",w.trust(k("nbPlayers:other","<strong>?</strong>"))),w("div#nb_games_in_play",w.trust(k("nbGamesInPlay:other","<strong>?</strong>")))])};function te(e,t,a,n){let i,s;function r(t,n,i,r){const o=P(Math.round((n*(a-1-r)+i*(r+1))/a));t&&o!==s&&(e.isScrolling||(t.textContent=o,s=o))}let o=[];return function(e,s){const l=document.querySelector(t);if(!l||!e&&0!==e)return;s&&(a=Math.abs(s)),o.forEach(clearTimeout),o=[];const c=0===i?0:i||e;i=e;const d=Math.abs(n()/a);for(let t=0;t<a;t++)o.push(setTimeout((()=>r(l,c,e,t)),Math.round(t*d)))}}var ae={oninit({attrs:e}){this.ctrl=new HomeCtrl(j(e.tab)),r.sessionRestored.add(this.ctrl.loadOfflinePuzzle)},oncreate:D,onremove(){i.destroy(),this.ctrl.unload(),r.afterLogin.remove(this.ctrl.init),r.afterLogout.remove(this.ctrl.init),r.sessionRestored.remove(this.ctrl.loadOfflinePuzzle)},view(){const e=B("lidraughts.org");return A.free(e,Q(this.ctrl),void 0,void 0,"ios"===F.getPlatform()?this.ctrl.onScroll:void 0)}};export{ae as default};
