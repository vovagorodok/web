import{o as t,p as a,B as e,z as n,bb as s,af as o,be as i,m as r,q as l,cW as c,ay as m,cX as u,ag as d,r as h,ad as p,cY as f,a7 as g,cv as v,a8 as b,e as N,b as w,aE as k,aF as y,ar as P,a6 as C,aB as M,h as I,s as _,ao as B,A as O,ch as T,J as j,an as L,cZ as F,c_ as S}from"./main.js";import{l as x}from"./layout-26cca27d.js";import{i as A}from"./game-3e605d21.js";import{p as D,j as R,w as W,l as $,r as V,t as q}from"./tournamentXhr-d3fb9e28.js";import{S as J}from"./index-28ac80d9.js";import{M as X}from"./miniBoard-94d39b51.js";import{C as E}from"./CountdownTimer-ca9a10d1.js";import{c as H,C as Q}from"./chat-1f5c68bb.js";var U={controller(t){let a=!1;function e(t){"backbutton"!==t&&a&&r.backbutton.stack.pop(),a=!1}return{open:function(){r.backbutton.stack.push(e),a=!0},close:e,isOpen:()=>a,root:t}},view:function(r){if(!r.isOpen())return null;return r.root.tournament?t("div",{className:"modal",id:"tournamentFaqModal",oncreate:i},t("header",null,t("button",{className:"modal_close",oncreate:n(s(r.close,"tournamentFaqModal"))},o),t("h2",null,a("tournamentFAQ"))),t("div",{className:"modal_content"},t("div",{className:"tournamentFaq"},t("p",null,a("willBeNotified")),t("h2",null,a("isItRated")),t("p",null,a("someRated")),t("h2",null,a("howAreScoresCalculated")),t("p",null,a("howAreScoresCalculatedAnswer")),t("h2",null,a("berserk")),t("p",null,a("berserkAnswer")),t("h2",null,a("howIsTheWinnerDecided")),t("p",null,a("howIsTheWinnerDecidedAnswer")),t("h2",null,a("howDoesPairingWork")),t("p",null,a("howDoesPairingWorkAnswer")),t("h2",null,a("howDoesItEnd")),t("p",null,a("howDoesItEndAnswer")),t("h2",null,a("otherRules")),t("p",null,a("thereIsACountdown")),t("p",null,e("drawingWithinNbMoves",10))))):null}},z={controller(t){let a=!1;const e=d(null);function n(t){"backbutton"!==t&&a&&r.backbutton.stack.pop(),a=!1}return{open:function(s){D(t.tournament.id,s).then((t=>{e(t),r.backbutton.stack.push(c(n,"tournamentPlayerInfoModal")),a=!0,h()})).catch(p)},close:n,isOpen:()=>a,root:t,playerData:e}},view:function(e){if(!e.isOpen())return null;if(!e.root.tournament)return null;const s=e.playerData();if(!s)return null;const i=s.player,d=s.pairings,h=d.length?(d.reduce(((t,a)=>t+a.op.rating),0)/d.length).toFixed(0):"0";const p=i.id||i.name.toLowerCase();return t("div",{className:"modal tournamentInfoModal",id:"tournamentPlayerInfoModal",oncreate:u},t("header",null,t("button",{className:"modal_close",oncreate:n(c(e.close,"tournamentPlayerInfoModal"))},o),t("h2",{className:"tournamentModalHeader",oncreate:n((()=>r.set("/@/"+p)))},i.rank+". ",m(i.title),i.name+" ("+i.rating+") ")),t("div",{className:"modal_content"},t("div",{className:"tournamentPlayerInfo"},t("table",{className:"tournamentModalStats"},t("tr",null,t("td",{className:"statName"},a("gamesPlayed")),t("td",{className:"statData"},i.nb.game)),t("tr",null,t("td",{className:"statName"},a("winRate")),t("td",{className:"statData"},i.nb.game?(i.nb.win/i.nb.game*100).toFixed(0)+"%":"0%")),t("tr",null,t("td",{className:"statName"},a("berserkRate")),t("td",{className:"statData"},i.nb.game?(i.nb.berserk/i.nb.game*100).toFixed(0)+"%":"0%")),t("tr",null,t("td",{className:"statName"},a("averageOpponent")),t("td",{className:"statData"},h)),t("tr",{className:i.performance?"":"invisible"},t("td",{className:"statName"},a("performance")),t("td",{className:"statData"},i.performance)))),t("div",{className:"tournamentPlayerGames"},t("table",{className:"tournamentModalTable",oncreate:l((t=>{const a=f(t);if(a){const t=a.dataset.id,e=a.dataset.color;r.set(`/game/${t}?color=${e}&goingBack=1`)}}),void 0,f)},d.map((function(a,e){let n,s="oppOutcome";return void 0===a.score||null===a.score?n="*":Array.isArray(a.score)?(n=a.score[0],2===a.score[1]?s+=" streak":3===a.score[1]&&(s+=" double")):n=a.score,t("tr",{className:"list_item","data-id":a.id,"data-color":a.color,key:a.id},t("td",{className:"oppRank"}," ",d.length-e," "),t("td",{className:"oppName"}," ",m(a.op.title),a.op.name," "),t("td",{className:"oppRating"}," ",a.op.rating," "),t("td",{className:"oppColor"}," ",t("span",{className:"color-icon "+a.color}," ")," "),t("td",{className:s}," ",n," "))}))))))}},G={controller(t){let a=!1;const e=d(null);function n(t){"backbutton"!==t&&a&&r.backbutton.stack.pop(),a=!1}return{open:function(t){r.backbutton.stack.push(c(n,"tournamentTeamInfoModal")),e(t),a=!0,h()},close:n,isOpen:()=>a,root:t,teamId:e}},view:function(a){if(!a.isOpen())return null;const e=a.root.tournament,s=a.teamId();if(!(e&&e.teamBattle&&e.teamStanding&&s))return null;const i=e.teamBattle.teams[s],r=e.teamStanding.find((t=>t.id===s));if(!i||!r)return null;return t("div.modal.tournamentInfoModal",{id:"tournamentTeamInfoModal",oncreate:u},[t("header",[t("buton.modal_close",{oncreate:n(c(a.close,"tournamentTeamInfoModal"))},[o]),t("h2.tournamentModalHeader",[t("span",[r.rank+". "]),t("span.ttc-"+a.root.teamColorMap[s],[i+" "]),t("span",["("+r.score+")"])])]),t("div.modal_content",[t("div.tournamentTeamPlayers",[t("table.tournamentModalTable",[r.players.map((function(a,e){return t("tr.list_item.bglight",{key:a.user.id},[t("td.teamPlayerRank",e+1),t("td.teamPlayerName",a.user.name),t("td.teamPlayerScore",a.score)])}))])])])])}};let Y,Z=!1;var K={open:function(t){r.backbutton.stack.push(tt),Z=!0,Y=t},close:tt,view:()=>g("tournament_addtl_info_popup",void 0,(()=>function(){const e=Y.tournament,n=e.teamBattle,s=n?n.joinWith.map((t=>[n.teams[t],t])).filter((t=>t[0])):[];return t("form",{id:"tournamentPasswordForm",class:"tournamentForm",onsubmit:function(t){return t.preventDefault(),function(t){const a=t[0].elements,e=a[0].value,n=a[1].value;Y.join(e,n),tt()}(t.target)}},t("fieldset",null,t("div",{className:"select_input no_arrow_after"+(e.private?"":" notVisible")},t("div",{className:"text_input_container"},t("label",null,a("password"),": "),t("input",{type:"text",id:"tournamentPassword",className:"passwordField",autocapitalize:"off",autocomplete:"off",oncreate:v}))),t("div",{className:"select_input no_arrow_after"+(e.teamBattle?"":" notVisible")},b.renderSelect("team","team",s,N.tournament.join.lastTeam,!1))),t("div",{className:"popupActionWrapper"},t("button",{className:"popupAction",type:"submit"},t("span",{className:"fa fa-check"}),a("join"))))}()),Z,tt)};function tt(t){"backbutton"!==t&&Z&&r.backbutton.stack.pop(),Z=!1}function at(e){const s=e.tournament;if(!s)return null;const o="https://lidraughts.org/tournament/"+s.id;return t("div",{className:"actions_bar"},t("button",{key:"faqButton",className:"action_bar_button fa fa-question-circle",oncreate:n(e.faqCtrl.open,(()=>C.show({text:a("tournamentFAQ"),duration:"short",position:"bottom"})))}),t("button",{key:"shareButton",className:"action_bar_button fa fa-share-alt",oncreate:n((()=>J.share({url:o})),(()=>C.show({text:a("shareUrl"),duration:"short",position:"bottom"})))}),e.chat&&w.isConnected()?t("button",{key:"chatButton",className:"action_bar_button fa fa-comments withChip",oncreate:n(e.chat.open,(()=>C.show({text:a("chatRoom"),duration:"short",position:"bottom"})))},e.chat.nbUnread>0?t("span",{className:"chip"},e.chat.nbUnread<=99?e.chat.nbUnread:99):null):t.fragment({key:"noChat"},[]),e.hasJoined?function(e){const s=e.tournament;if(s.isFinished||N.game.supportedVariants.indexOf(s.variant)<0)return t.fragment({key:"noWithdrawButton"},[]);return t("button",{key:"withdrawButton",className:"action_bar_button fa fa-flag",oncreate:n(e.withdraw,(()=>C.show({text:a("withdraw"),duration:"short",position:"bottom"})))})}(e):function(e){const s=e.tournament;if(!w.isConnected()||s.isFinished||N.game.supportedVariants.indexOf(s.variant)<0||!s.verdicts.accepted||s.teamBattle&&0===s.teamBattle.joinWith.length)return t.fragment({key:"noJoinButton"},[]);const o=()=>!e.tournament.private&&!e.tournament.teamBattle||e.tournament.me?e.join():K.open(e);return t("button",{key:"joinButton",className:"action_bar_button fa fa-play",oncreate:n(o,(()=>C.show({text:a("join"),duration:"short",position:"bottom"})))})}(e))}function et(a,e){return void 0===a?null:[e?e+" ":null,t(E,{seconds:a})]}function nt(e,n){var s,o,i,r,c;return t("div",{className:"tournamentHeader"},function(a){const e=a.perf.name,n=k(a.clock);return t("div",{className:"tournamentTimeInfo"},t("strong",{className:"tournamentInfo withIcon","data-icon":a.perf.icon},e+" • "+n+" • "+y(a.minutes)))}(e),function(a,e){const n=a?a.description:e;return n?t("div",{className:"tournamentSpotlightInfo"},n):null}(e.spotlight,e.description),function(e,n){return t("div",{className:"tournamentCreatorInfo"},"lidraughts"===e.createdBy?a("tournamentOfficial"):a("by",e.createdBy)," • ",n)}(e,n.startsAt),e.verdicts.list.length>0?function(a){const e=["tournamentConditions",w.isConnected()?"":"anonymous",a.accepted?"accepted":"rejected"].join(" ");return t("div",{className:e},t("span",{className:"withIcon","data-icon":"7"}),t("div",{className:"conditions_list"},a.list.map((a=>t("p",{className:"condition "+("ok"===a.verdict?"accepted":"rejected")},a.condition)))))}(e.verdicts):null,(i=e.berserkable,r=e.streakable,c=null===(s=e.spotlight)||void 0===s?void 0:s.drawLimit,i&&r&&void 0===c?null:t("div",{className:"tournamentSettings"},void 0===c?null:t("div",{className:"setting"},t("span",{className:"withIcon","data-icon":"2"}),t("p",null,c?a("drawOffersAfterX",c):a("drawOffersNotAllowed"))),i?null:t("div",{className:"setting"},t("span",{className:"withIcon","data-icon":"`"}),t("p",null,a("noBerserkAllowed"))),r?null:t("div",{className:"setting"},t("span",{className:"withIcon","data-icon":"Q"}),t("p",null,a("noArenaStreaks"))))),function(e){const n=e.position,s=e.openingTable;if(s)return n&&"random"!==n.fen?s.url?t("div",{className:"tournamentPositionInfo"},t("div",{className:"withLink",oncreate:l((()=>window.open(s.url,"_blank")))},s.name),a("opening")," ",t("strong",null,n.code),n.name?": "+n.name:""):t("div",{className:"tournamentPositionInfo"},s.name+": "+n.code+(n.name?" "+n.name:"")):s.url?t("div",{className:"tournamentPositionInfo"},P("randomOpeningFromX",t("span",{className:"withLink",oncreate:l((()=>window.open(s.url,"_blank")))},s.name))):t("div",{className:"tournamentPositionInfo"},a("randomOpeningFromX",s.name));if(n)return t("div",{className:"tournamentPositionInfo"+(n.wikiPath?" withLink":""),oncreate:l((()=>n.wikiPath&&window.open(`https://en.wikipedia.org/wiki/${n.wikiPath}`,"_blank")))},n.code+(n.name?" "+n.name:""));return null}(e),(o=e).isFinished||!o.teamBattle||o.teamBattle.joinWith.length>0?null:t("div",{className:"tournamentNoTeam"},t("span",{className:"withIcon","data-icon":"7"}),t("p",null,a("youMustJoinOneOfTheseTeams"))))}function st(t){const a=t.target;return a.classList.contains("list_item")?a:M(a,".list_item")}function ot(a){const e=a.tournament,s=a.currentPageResults,o=a.page,i=s.length>0?s[0].rank:0,r=s.length>0?s[s.length-1].rank:0,l=o>1,c=o<e.nbPlayers/10,u=w.get(),d=u?u.username.toLowerCase():"",h=e.teamBattle;return t("div",{className:"tournamentLeaderboard"},t("ul",{className:"tournamentStandings box"+(a.isLoadingPage?" loading":""),oncreate:n((t=>function(t,a){var e;const n=null===(e=st(a).dataset.player)||void 0===e?void 0:e.toLowerCase();n&&t.playerInfoCtrl.open(n)}(a,t)),void 0,void 0,st)},s.map(((e,n)=>function(a,e,n,s,o){const i=n%2==0?"even":"odd",r=e.id||e.name.toLowerCase(),l=r===a,c=null!=s?s:0;return t("li",{key:r,"data-player":r,className:`list_item tournament-list-item ${i}`+(l?" tournament-me":"")},t("div",{className:"tournamentIdentity"},t("span",{className:"flagRank","data-icon":!0===e.withdraw?"b":""}," ",!0===e.withdraw?"":`${e.rank}.`,"   "),t("span",{className:"playerName"},m(e.title),`${e.name} (${e.rating}${e.provisional?"?":""})`),t("span",{className:`playerTeam ttc-${c}`}," ",null!=o?o:""," ")),t("div",{className:"tournamentPoints "+(e.sheet.fire?"on-fire":"off-fire"),"data-icon":"Q"},e.score))}(d,e,n,e.team?a.teamColorMap[e.team]:0,e.team&&h?h.teams[e.team]:"")))),t("div",{className:"navigationButtons"+(s.length<1?" invisible":"")},it("W",!a.isLoadingPage&&l,a.first),it("Y",!a.isLoadingPage&&l,a.prev),t("span",{class:"pageInfo"}," ",i+"-"+r+" / "+e.nbPlayers," "),it("X",!a.isLoadingPage&&c,a.next),it("V",!a.isLoadingPage&&c,a.last),e.me?t("button",{className:"navigationButton tournament-me"+(a.focusOnMe?" activated":""),"data-icon":"7",oncreate:n(a.toggleFocusOnMe)},t("span",null,"Me")):null))}function it(a,e,s){return t("button.navigationButton",{"data-icon":a,oncreate:n(s),disabled:!e})}function rt(a){const e=a.tournament,n=e.featured;return n?t("div",{className:"tournamentGames"},t("div",{className:"tournamentMiniBoard"},t(X,{fixed:!1,fen:n.fen,variant:e.variant,lastMove:n.lastMove,orientation:n.orientation,link:()=>r.set(`/tournament/${e.id}/game/${n.id}?color=${n.orientation}&goingBack=1`),gameObj:n}))):null}function lt(e){if(!e)return null;const s=e.rank,o=e.id||e.name.toLowerCase();return t("div",{className:"place"+s},t("div",{className:"trophy"}," "),t("div",{className:"username",oncreate:n((()=>r.set("/@/"+o)))},m(e.title),e.name),t("div",{className:"rating"}," ",e.rating," "),t("table",{className:"stats"},t("tr",null,t("td",{className:"statName"},a("performance")),t("td",{className:"statData"},e.performance)),t("tr",null,t("td",{className:"statName"},a("gamesPlayed")),t("td",{className:"statData"},e.nb.game)),t("tr",null,t("td",{className:"statName"},a("winRate")),t("td",{className:"statData"},(e.nb.win/e.nb.game*100).toFixed(0)+"%")),t("tr",null,t("td",{className:"statName"},a("berserkRate")),t("td",{className:"statData"},(e.nb.berserk/e.nb.game*100).toFixed(0)+"%"))))}function ct(a){const e=a.tournament,s=e.teamBattle,o=e.teamStanding;return s&&o?t("div",{className:"tournamentTeamLeaderboard"},t("ul",{className:"tournamentTeamStandings box",oncreate:n((t=>function(t,a){const e=mt(a),n=e.dataset.team;n&&t.teamInfoCtrl.open(n)}(a,t)),void 0,void 0,mt)},o.map(((e,n)=>function(a,e,n,s){if(!a)return null;const o=e||0,i=s%2==0?"even":"odd";return t("li",{key:n.id,"data-team":n.id,className:`list_item tournament-list-item ${i}`},t("div",{className:"tournamentIdentity"},t("span",null," ",n.rank+".","   "),t("span",{className:"ttc-"+o}," ",a," ")),t("div",{className:"tournamentPoints"},n.score))}(s.teams[e.id],a.teamColorMap[e.id],e,n))))):null}function mt(t){const a=t.target;return a.classList.contains("list_item")?a:M(a,".list_item")}class TournamentCtrl{constructor(t){var a,e;this.page=1,this.hasJoined=!1,this.focusOnMe=!1,this.isLoadingPage=!1,this.pagesCache={},this.join=I(((t,a)=>{R(this.tournament.id,t,a).then((()=>{this.hasJoined=!0,this.focusOnMe=!0,h()})).catch((t=>{null!=t.body&&"error"in t.body?C.show({text:t.body.error,duration:"short"}):p(t)}))}),1e3),this.withdraw=I((()=>{W(this.tournament.id).then((()=>{this.hasJoined=!1,this.focusOnMe=!1,h()})).catch(p)}),1e3),this.reload=function(t){let a,e;return function(...n){const s=this,o=()=>{e=void 0,a=t.apply(s,n).then((()=>{a=void 0,e&&e()})).catch((()=>{a=void 0,e&&e()}))};a?e=o:o()}}((a=()=>5e3+Math.floor(1e3*Math.random()),e=()=>V(this.id,this.focusOnMe?void 0:this.page).then(this.onReload).catch(p),function(...t){const n=this;return new Promise((s=>{e.apply(n,t).then((()=>setTimeout(s,a()))).catch((()=>setTimeout(s,a())))}))})),this.loadPage=I((t=>{$(this.id,t).then((t=>{this.isLoadingPage=!1,this.page===t.page?this.loadCurrentPage(t):this.setPageCache(t),h()})).catch((t=>{this.isLoadingPage=!1,p(t)}))}),1e3),this.first=()=>{this.page>1&&this.userSetPage(1)},this.prev=()=>{this.page>1&&this.userSetPage(this.page-1)},this.next=()=>{const t=this.tournament.nbPlayers;this.page<t/10&&this.userSetPage(this.page+1)},this.last=()=>{const t=this.tournament.nbPlayers;this.page<t/10&&this.userSetPage(Math.ceil(t/10))},this.toggleFocusOnMe=()=>{this.tournament.me&&(this.focusOnMe=!this.focusOnMe,this.focusOnMe&&this.scrollToMe(),h())},this.myPage=()=>this.tournament.me?Math.floor((this.tournament.me.rank-1)/10)+1:void 0,this.unload=()=>{var t;null===(t=this.appStateListener)||void 0===t||t.remove()},this.scrollToMe=()=>{const t=this.myPage();void 0!==t&&t!==this.page&&this.setPage(t)},this.onReload=t=>{const a=this.tournament;!t.featured||a&&a.featured&&t.featured.id===a.featured.id||this.socketIface.send("startWatching",t.featured.id),this.tournament=Object.assign(Object.assign(Object.assign({},this.tournament),t),{me:t.me}),this.setPageCache(t.standing),void 0!==this.pagesCache[this.page]&&(this.currentPageResults=this.pagesCache[this.page]),this.hasJoined=!(!t.me||t.me.withdraw),this.focusOnMe&&this.scrollToMe(),t.socketVersion&&_.setVersion(t.socketVersion),this.teamColorMap=t.teamBattle?this.createTeamColorMap(t.teamBattle):{};const e=t.teamBattle;e&&!e.joinWith.includes(N.tournament.join.lastTeam())&&e.joinWith.length>0&&N.tournament.join.lastTeam(e.joinWith[0]),h()},this.id=t.id,this.faqCtrl=U.controller(this),this.playerInfoCtrl=z.controller(this),this.teamInfoCtrl=G.controller(this),this.tournament=t,this.startsAt=B(new Date(t.startsAt)),this.page=this.tournament.standing.page,this.loadCurrentPage(this.tournament.standing),this.hasJoined=!(!t.me||t.me.withdraw),this.focusOnMe=function(t){return!(!t.me||t.me.withdraw)}(this.tournament),this.scrollToMe();const n=t.featured?t.featured.id:void 0;var s;this.socketIface=_.createTournament(this.id,this.tournament.socketVersion,{reload:(s=this).reload,resync:s.reload,redirect(t){r.set("/tournament/"+s.tournament.id+"/game/"+t,!0)},fen(t){const a=s.tournament.featured;a&&a.id===t.id&&(a.fen=t.fen,a.lastMove=t.lm,h())},message(t){s.chat&&s.chat.append(t)}},n),t.chat&&w.isConnected()&&(this.chat=new Q(this.socketIface,t.id,t.chat.lines,void 0,t.chat.writeable,w.isShadowban(),"Tournament")),this.setupListeners(),this.teamColorMap=t.teamBattle?this.createTeamColorMap(t.teamBattle):{},h()}async setupListeners(){this.appStateListener=await O.addListener("appStateChange",(t=>{t.isActive&&this.reload()}))}userSetPage(t){this.isLoadingPage||(this.focusOnMe=!1,this.setPage(t))}setPage(t){this.page=t;const a=this.pagesCache[this.page];a?this.currentPageResults=a:this.isLoadingPage=!0,this.loadPage(t),h()}setPageCache(t){this.pagesCache[t.page]=t.players}loadCurrentPage(t){this.setPageCache(t),this.currentPageResults=t.players}createTeamColorMap(t){return Object.keys(t.teams).reduce(((t,a,e)=>Object.assign(Object.assign({},t),{[a]:e})),{})}}var ut={oninit({attrs:t}){q(t.id).then((t=>{this.ctrl=new TournamentCtrl(t)})).catch((t=>{404===t.status?(this.notFound=!0,h()):p(t)}))},oncreate:T,onremove(){_.destroy(),this.ctrl&&this.ctrl.unload()},view(){if(this.notFound)return x.free(j(null,L(a("tournamentNotFound"))),t("div.tournamentNotFound",[t("p",a("tournamentDoesNotExist")),t("p",a("tournamentMayHaveBeenCanceled"))]));if(!this.ctrl)return x.free(F(),null);const e=this.ctrl.tournament;if(e&&!A(e.variant))return C.show({text:a("unsupportedVariant",e.variant),position:"center",duration:"short"}),void r.set("/");const n=j(null,L(t("div.main_header_title.withSub",[t("h1",[t("span.fa.fa-trophy"),this.ctrl.tournament.fullName]),t("h2.header-subTitle.tournament-subtTitle",e.isFinished||e.isStarted?et(e.secondsToFinish,""):et(e.secondsToStart,a("startingIn")))]))),s=function(a){const e=a.tournament;return e?t("div.tournamentContainer.native_scroller.page",{className:(e.podium?"finished ":"")+(e.teamBattle?"teamBattle":"")},[nt(e,a),e.podium&&!e.teamBattle?(n=e.podium,t("div",{className:"podium"},lt(n[1]),lt(n[0]),lt(n[2]))):null,e.teamBattle?ct(a):null,ot(a),e.featured?rt(a):null]):null;var n}(this.ctrl),o=at(this.ctrl),i=[...(l=this.ctrl,[U.view(l.faqCtrl),z.view(l.playerInfoCtrl),G.view(l.teamInfoCtrl),l.chat?H(l.chat):null]),K.view()].filter(S);var l;return x.free(n,s,o,i)}};export{ut as default};
