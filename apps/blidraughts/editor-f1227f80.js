import{a7 as t,m as e,o,p as a,aK as n,c7 as i,r,co as s,e as d,bn as c,d as u,c6 as l,cp as h,cq as p,bK as m,a6 as v,aX as b,bG as g,ag as f,bk as y,cr as F,aR as P,aN as k,cs as w,z as _,s as C,aP as x,I as E,aQ as S}from"./main.js";import{s as A}from"./draughts-5f7918a7.js";import{c as B}from"./continuePopup-d2e303e3.js";import{S as I}from"./index-28ac80d9.js";import{B as O}from"./Board-25b97c43.js";import{l as N}from"./layout-26cca27d.js";var R=function(t){let o=!1;function a(t){"backbutton"!==t&&o&&e.backbutton.stack.pop(),o=!1}return{open:function(){e.backbutton.stack.push(a),o=!0},close:a,isOpen:()=>o,root:t}},U=function(e){return t("editorMenu",void 0,(()=>function(t){return o("div.editorMenu",[j(t)])}(e.root)),e.isOpen(),e.close)};function j(t){const e=t.computeFen(!1);return o("div.editorSelectors",[o("div.select_input",[o("label",{for:"select_editor_positions"},"Positions"),o("select.positions",{id:"select_editor_positions",onchange(e){t.loadNewFen(e.target.value)}},[(s=a("setTheBoard"),d=[z(e,{name:"-- Position --",fen:"",code:""}),t.extraPositions.map((t=>z(e,t)))],o("optgroup",{label:s},d))])]),o("div.select_input",[o("label",{for:"select_editor_color"},a("side")),o("select",{id:"select_editor_color",value:t.data.editor.color(),onchange(e){t.setColor(e.target.value)}},[o("option[value=w]",a("whitePlays")),o("option[value=b]",a("blackPlays"))])]),o("div.select_input",[o("label",{for:"select_editor_variant"},a("variant")),o("select",{id:"select_editor_variant",value:t.data.game.variant.key(),onchange(e){const o=t.getVariant(),a=o.board.size,s=n(o.key),d=i(t.computeFen(!1),s);t.data.game.variant.key(e.target.value),t.updatePosition();const c=t.getVariant(),u=c.board.size,l=n(c.key);(a!==u||d&&!i(s,l))&&(t.draughtsground.reconfigure(t.makeConfig(l)),r())}},[o("option[value=standard]","Standard"),o("option[value=frisian]","Frisian"),o("option[value=frysk]","Frysk!"),o("option[value=antidraughts]","Antidraughts"),o("option[value=breakthrough]","Breakthrough"),o("option[value=russian]","Russian"),o("option[value=brazilian]","Brazilian")])])]);var s,d}function z(t,e,a=!1){return o("option",{value:e.fen,selected:t===e.fen},(a?e.code+" ":"")+(e.name||""))}var D=function(t){let o=!1;function a(t){"backbutton"!==t&&o&&e.backbutton.stack.pop(),o=!1}return{open:function(){e.backbutton.stack.push(a),o=!0},close:a,isOpen:()=>o,root:t}},H=function(e){return t("pasteFenPopup",void 0,(()=>o("form",{onsubmit(t){t.preventDefault();const o=t.target[0],a=o.value;a&&a.length&&e.root.loadNewFen(s(o.value))}},[o("input[type=text]",{placeholder:a("pasteTheFenStringHere")}),o("button[data-icon=E].withIcon.popupAction",a("loadPosition"))])),e.isOpen(),e.close)};class EditorCtrl{constructor(t,o){this.makeConfig=t=>({fen:t,boardSize:this.getVariant().board.size,orientation:"white",edit:!0,coordinates:d.game.coords(),coordSystem:this.coordSystem(),movable:{free:!0,color:"both"},highlight:{lastMove:!1,kingMoves:d.game.kingMoves()},animation:{duration:300},premovable:{enabled:!1},draggable:{magnified:d.game.magnified(),deleteOnDropOff:!0},events:{change:()=>{this.data.editor.halfmove("0"),this.data.editor.moves("1"),this.updatePosition()}}}),this.isAlgebraic=()=>1===d.game.coordSystem()&&"64"===this.getVariant().board.key,this.coordSystem=()=>this.isAlgebraic()?1:0,this.getVariant=()=>c(this.data.game.variant.key()),this.setPlayable=(t,e)=>A({variant:e,fen:t}).then((({situation:t})=>{this.data.playable=t.playable})),this.updatePosition=u((()=>{const t=this.computeFen(!1),e=this.data.game.variant.key();if(l(t,e)){const o=`/editor/variant/${encodeURIComponent(e)}/fen/${encodeURIComponent(t)}`;try{window.history.replaceState(window.history.state,"","?="+o)}catch(t){}this.setPlayable(t,e).then(r)}}),250),this.onstart=t=>function(t,e){if(e.touches&&e.touches.length>1)return;const o=e.target.getAttribute("data-role"),a=e.target.getAttribute("data-color");if(!o||!a)return;e.stopPropagation(),e.preventDefault();const n={role:o,color:a};t.draughtsground.dragNewPiece(e,n,!0)}(this,t),this.onmove=t=>h(this.draughtsground,t),this.onend=t=>p(this.draughtsground,t),this.editorOnCreate=t=>{if(!t.dom)return;const e=document.getElementById("boardEditor");e&&(e.addEventListener("touchstart",this.onstart),e.addEventListener("touchmove",this.onmove),e.addEventListener("touchend",this.onend))},this.editorOnRemove=()=>{const t=document.getElementById("boardEditor");t&&(t.removeEventListener("touchstart",this.onstart),t.removeEventListener("touchmove",this.onmove),t.removeEventListener("touchend",this.onend))},this.setColor=t=>{this.data.editor.color(t),this.updatePosition()},this.computeFen=(t,e=!1)=>{const o=this.data.editor,a=o.color().toUpperCase()+":"+this.draughtsground.getFen(t);return e?a:a+":H"+o.halfmove()+":F"+o.moves()},this.loadNewFen=t=>{if(!t)return;const o=this.data.game.variant.key();t="init"===t?n(o):m(t,!1),l(t,o)?e.set(`/editor/variant/${encodeURIComponent(o)}/fen/${encodeURIComponent(t)}`,!0):v.show({text:a("invalidFen"),position:"center",duration:"short"})},this.loadPeripheralFen=()=>{const t=b.state();this.loadNewFen(g.convertPeripheralPiecesToFen(t.peripheral.pieces))},this.goToAnalyse=()=>{const t=this.computeFen(!1),o=this.data.game.variant.key();A({variant:o,fen:t}).then((({situation:n})=>{n.playable?e.set(`/analyse/variant/${encodeURIComponent(o)}/fen/${encodeURIComponent(t)}`):v.show({text:a("invalidFen"),position:"center",duration:"short"})}))},this.continueFromHere=()=>{const t=this.computeFen(!1),e=this.data.game.variant.key();"standard"!==e?v.show({text:"You can't continue from a variant position",position:"center",duration:"long"}):A({variant:e,fen:t}).then((({situation:o})=>{o.playable?this.continuePopup.open(t,e):v.show({text:a("invalidFen"),position:"center",duration:"short"})}))};const i=t?m(t,!1):"W:W31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50:B1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20:H0:F1";this.menu=R(this),this.pasteFenPopup=D(this),this.continuePopup=B.controller(),this.data={editor:this.readFen(i),game:{variant:{key:f(o||"standard")}},playable:!0},this.setPlayable(i,o||"standard").then(r),this.extraPositions=[{fen:"init",name:a("startPosition")},{fen:"W:W:B",name:a("clearBoard")}],this.draughtsground=new y(this.makeConfig(i))}readFen(t){const e=F(t);return{color:f(e.color),halfmove:f(e.halfmove.toString()),moves:f(e.moves.toString())}}}function L(t,e,a){return o("div",{className:["sparePieces",a,"orientation-"+e,t].join(" ")},o("div.sparePiecesInner",["king","man"].map((e=>o("div.sparePiece",o("piece",{className:t+" "+e,"data-color":t,"data-role":e}))))))}function $(t){return o("section.actions_bar",[k()||!w()?o("button.action_bar_button.fa.fa-gear",{oncreate:_(t.menu.open)}):null,o("button.action_bar_button[data-icon=B]",{oncreate:_(t.draughtsground.toggleOrientation)}),o("button.action_bar_button[data-icon=U]",{disabled:!t.data.playable,oncreate:_(t.continueFromHere,(()=>v.show({text:a("continueFromHere"),duration:"short",position:"bottom"})))}),o("button.action_bar_button[data-icon=A]",{disabled:!t.data.playable,oncreate:_(t.goToAnalyse,(()=>v.show({text:a("analysis"),duration:"short",position:"bottom"})))}),b.features().getState?o("button.action_bar_button.fa.fa-clone",{disabled:!b.state().peripheral.isGettable,oncreate:_(t.loadPeripheralFen,(()=>v.show({text:a("loadAPositionFromDevice"),duration:"short",position:"bottom"})))}):null,o("button.action_bar_button.fa.fa-upload",{oncreate:_(t.pasteFenPopup.open,(()=>v.show({text:a("loadAPositionFromFen"),duration:"short",position:"bottom"})))}),o("button.action_bar_button.fa.fa-share-alt",{oncreate:_((()=>I.share({text:t.computeFen(t.isAlgebraic(),!0)})),(()=>v.show({text:a("shareFEN"),duration:"short",position:"bottom"})))})])}const M={oninit({attrs:t}){C.createDefault(),x(),this.editor=new EditorCtrl(t.fen,"fromPosition"===t.variant?"standard":t.variant)},oncreate:E,onremove(){S()},view(){return function(t){const e=t.draughtsground.state.orientation,n="white"===e?"black":"white",i=o(O,{variant:t.data.game.variant.key(),draughtsground:t.draughtsground,wrapperClasses:"editor-board"});return N.board(P(a("boardEditor")),[i,o("div.editor-wrapper",[o("div#boardEditor.editor-table.box",{className:d.general.theme.piece(),oncreate:t.editorOnCreate,onremove:t.editorOnRemove},[o("div.editor-piecesDrawer",[L(n,e,"left"),L(e,e,"right")])]),$(t)])],void 0,[U(t.menu),B.view(t.continuePopup),H(t.pasteFenPopup)])}(this.editor)}};export{M as default};
