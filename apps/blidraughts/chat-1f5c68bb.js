import{m as t,bb as e,bc as s,r as n,bd as i,as as a,o,z as r,af as l,p as h,be as c,ai as u,ay as d,bf as g}from"./main.js";class Chat{constructor(i,a,o,r,l,h,c){this.socket=i,this.id=a,this.player=r,this.writeable=l,this.isShadowban=h,this.storeKey=c,this.open=()=>{t.backbutton.stack.push(e(this.close,"chat")),this.showing=!0,this.nbUnread=0},this.close=e=>{s.hide(),"backbutton"!==e&&this.showing&&t.backbutton.stack.pop(),this.showing=!1,this.nbUnread=0,this.storeNbLinesRead()},this.onReload=t=>{void 0!==t&&(this.lines=t,this.checkUnreadFromStorage())},this.append=t=>{this.lines.push(t),"lidraughts"!==t.u&&this.nbUnread++,n()},this.isLegitMsg=t=>{return!t.d&&(!t.r||this.isShadowban)&&(e=t.t,!/draughts-bot/.test(e));var e},this.showing=!1,this.lines=o,this.inputValue="",this.nbUnread=0,this.checkUnreadFromStorage()}selectLines(){let t;const e=[];return this.lines.forEach((s=>{var n,i;!this.isLegitMsg(s)||t&&(i=s,(n=t).d&&i.d&&n.u===i.u)||e.push(s),t=s})),e}nbLines(){return this.lines.filter(this.isLegitMsg).length}checkUnreadFromStorage(){(async function(t,e){var s;return await y(t),null===(s=f[t].readCounts)||void 0===s?void 0:s.get(e)})(this.storeKey,this.id).then((t=>{const e=t||0,s=this.nbLines();void 0!==this.lines&&e<s&&(this.nbUnread=this.nbUnread+(s-e),n())}))}storeNbLinesRead(){const t=this.nbLines();t>0&&i((()=>{!async function(t,e,s){await y(t);const n=f[t];n.readCounts&&(n.readCounts.set(e,s),a.set(n.key,n.readCounts.toJSON()))}(this.storeKey,this.id,t)}))}}function p(t,s){return t.showing?o("div#chat.modal",{oncreate:c},[o("header",[o("button.modal_close",{oncreate:r(e(t.close,"chat"))},l),o("h2",s||h("chatRoom"))]),o("div#chat_content.modal_content.chat_content",[o("ul.chat_scroller.native_scroller",{oncreate:({dom:e})=>b(t,e),onupdate:({dom:e})=>b(t,e)},t.selectLines().map(((e,s,n)=>void 0!==t.player?function(t,e,s,n){const i="lidraughts"===e.u,a=e.c?e.c===t.color:t.user&&e.u===t.user.username;let r=!0;const l=n[s+1];let h;l&&(h=l.c?l.c===t.color:t.user&&l.u===t.user.username);void 0!==h&&(r=h!==a);return o("li.chat_msg.allow_select",{className:u({system:i,player:!!a,opponent:!i&&!a,close_balloon:r})},e.t)}(t.player,e,s,n):function(t){const e="lidraughts"===t.u;let s=t.n||t.u;if(s.length>14){const t=s.indexOf(" ");t>2&&(s=s.slice(0,1)+"."+s.slice(t)),s=s.slice(0,14)}return o("li.spectator_chat_msg.allow_select",{className:u({system:e})},e?t.t:[d(t.title),o("strong",s),o.trust("&nbsp;"),o.trust("&nbsp;"),o("span",t.t)])}(e)))),o("form.chat_form",{onsubmit(e){e.preventDefault();const s=e.target[0];s.focus();const n=s.value.trim();if(!m(n))return;t.inputValue="",s.setAttribute("rows","1"),s.style.paddingTop="8px",t.socket.send("talk",n);const i=document.getElementById("chat_send");return i&&i.classList.add("disabled"),!1}},[o("textarea#chat_input.chat_input",{placeholder:t.writeable?h("talkInChat"):h("chatIsDisabled"),disabled:!t.writeable,rows:1,maxlength:140,value:t.inputValue,style:{lineHeight:"18px",margin:"8px 0 8px 10px",paddingTop:"8px"},oninput(e){const s=e.target;s.value.length>140&&(s.value=s.value.substr(0,140)),t.inputValue=s.value;const n=window.getComputedStyle(s),i=parseInt(n.lineHeight||"18",10),a=function(t,e){const s=t.style.height,n=t.scrollHeight,i=t.style.overflow;let a=t.offsetHeight;if(a>=n&&(t.style.height=a+e+"px",t.style.overflow="hidden",n<t.scrollHeight)){for(;t.offsetHeight>=t.scrollHeight;)t.style.height=(a-=e)+"px";for(;t.offsetHeight<t.scrollHeight;)t.style.height=a+++"px";return t.style.height=s,t.style.overflow=i,a}return n}(s,i),o=Math.ceil(a/i),r=o<=1?1:o>5?5:o-1;s.setAttribute("rows",String(r)),s.style.paddingTop=1===r?"8px":"0";const l=document.getElementById("chat_send");l&&(m(t.inputValue)?l.classList.remove("disabled"):l.classList.add("disabled"))}}),o("button#chat_send.chat_send.fa.fa-telegram.disabled")])])]):null}function b(t,e){if(t.lines.length>5){(0===e.scrollTop||e.scrollTop>e.scrollHeight-e.clientHeight-100)&&(e.scrollTop=999999,setTimeout((()=>e.scrollTop=999999),300))}}function m(t){return!!t&&t.trim().length<=140}const f={Corres:{key:"corresChat"},Game:{key:"gameChat"},Study:{key:"studyChat"},Tournament:{key:"tourChat"}};function y(t){const e=f[t];return e.readCounts?Promise.resolve():a.get(e.key).then((t=>{e.readCounts=t?new g(100,t):new g(100)}))}export{Chat as C,p as c};
